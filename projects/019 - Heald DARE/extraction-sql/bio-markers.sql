--┌────────────────┐
--│ Biomarker file │
--└────────────────┘

------------------------ RDE CHECK ---------------------
-- George Tilston  - 16 March 2022 - via pull request --
--------------------------------------------------------

-- Cohort is patients included in the DARE study. The below queries produce the data
-- that is required for each patient. However, a filter needs to be applied to only
-- provide this data for patients in the DARE study. Adrian Heald will provide GraphNet
-- with a list of NHS numbers, then they will execute the below but filtered to the list
-- of NHS numbers.

-- We assume that a temporary table will exist as follows:
-- CREATE TABLE #DAREPatients (NhsNo NVARCHAR(30));

-- For each patient in the DARE cohort, this produces all biomarker readings
-- since 2018-01-01.

--Just want the output, not the messages
SET NOCOUNT ON;

--Create DARECohort Table
SELECT SUBSTRING(REPLACE(NHSNo, ' ', ''),1,3) + ' ' + SUBSTRING(REPLACE(NHSNo, ' ', ''),4,3) + ' ' + SUBSTRING(REPLACE(NHSNo, ' ', ''),7,4) 'NHSNo' INTO #DAREPatients FROM [dbo].[DARECohort]

-- Set the start date
DECLARE @StartDate datetime;
SET @StartDate = '2018-01-01';

-- Get link ids of patients
SELECT DISTINCT FK_Patient_Link_ID INTO #Patients
FROM SharedCare.Patient p
INNER JOIN #DAREPatients dp ON dp.NhsNo = p.NhsNo;

-- Get lookup between nhs number and fk_patient_link_id
SELECT DISTINCT p.NhsNo, p.FK_Patient_Link_ID INTO #NhsNoToLinkId
FROM SharedCare.Patient p
INNER JOIN #DAREPatients dp ON dp.NhsNo = p.NhsNo;

-- >>> Codesets required... Inserting the code set code
--
--┌────────────────────┐
--│ Clinical code sets │
--└────────────────────┘

-- OBJECTIVE: To populate temporary tables with the existing clinical code sets.
--            See the [SQL-generation-process.md](SQL-generation-process.md) for more details.

-- INPUT: No pre-requisites

-- OUTPUT: Five temp tables as follows:
--  #AllCodes (Concept, Version, Code)
--  #CodeSets (FK_Reference_Coding_ID, Concept)
--  #SnomedSets (FK_Reference_SnomedCT_ID, FK_SNOMED_ID)
--  #VersionedCodeSets (FK_Reference_Coding_ID, Concept, Version)
--  #VersionedSnomedSets (FK_Reference_SnomedCT_ID, Version, FK_SNOMED_ID)

--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
--!!! DO NOT EDIT THIS FILE MANUALLY !!!
--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

IF OBJECT_ID('tempdb..#AllCodes') IS NOT NULL DROP TABLE #AllCodes;
CREATE TABLE #AllCodes (
  [Concept] [varchar](255) NOT NULL,
  [Version] INT NOT NULL,
  [Code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
  [description] [varchar] (255) NULL 
);

IF OBJECT_ID('tempdb..#codesreadv2') IS NOT NULL DROP TABLE #codesreadv2;
CREATE TABLE #codesreadv2 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesreadv2
VALUES ('bmi',1,'22K..',NULL,'Body Mass Index'),('bmi',1,'22K..00',NULL,'Body Mass Index'),('bmi',1,'22KE.',NULL,'Obese class III (body mass index equal to or greater than 40.0)'),('bmi',1,'22KE.00',NULL,'Obese class III (body mass index equal to or greater than 40.0)'),('bmi',1,'22KD.',NULL,'Obese class II (body mass index 35.0 - 39.9)'),('bmi',1,'22KD.00',NULL,'Obese class II (body mass index 35.0 - 39.9)'),('bmi',1,'22KC.',NULL,'Obese class I (body mass index 30.0 - 34.9)'),('bmi',1,'22KC.00',NULL,'Obese class I (body mass index 30.0 - 34.9)'),('bmi',1,'22KB.',NULL,'Baseline body mass index'),('bmi',1,'22KB.00',NULL,'Baseline body mass index'),('bmi',1,'22KA.',NULL,'Target body mass index'),('bmi',1,'22KA.00',NULL,'Target body mass index'),('bmi',1,'22K9.',NULL,'Body mass index centile'),('bmi',1,'22K9.00',NULL,'Body mass index centile'),('bmi',1,'22K9K',NULL,'Downs syndrome body mass index centile'),('bmi',1,'22K9K00',NULL,'Downs syndrome body mass index centile'),('bmi',1,'22K9J',NULL,'Child body mass index greater than 99.6th centile'),('bmi',1,'22K9J00',NULL,'Child body mass index greater than 99.6th centile'),('bmi',1,'22K9H',NULL,'Child body mass index 98.1st-99.6th centile'),('bmi',1,'22K9H00',NULL,'Child body mass index 98.1st-99.6th centile'),('bmi',1,'22K9G',NULL,'Child body mass index on 98th centile'),('bmi',1,'22K9G00',NULL,'Child body mass index on 98th centile'),('bmi',1,'22K9F',NULL,'Child body mass index 92nd-97th centile'),('bmi',1,'22K9F00',NULL,'Child body mass index 92nd-97th centile'),('bmi',1,'22K9E',NULL,'Child body mass index on 91st centile'),('bmi',1,'22K9E00',NULL,'Child body mass index on 91st centile'),('bmi',1,'22K9D',NULL,'Child body mass index 76th-90th centile'),('bmi',1,'22K9D00',NULL,'Child body mass index 76th-90th centile'),('bmi',1,'22K9C',NULL,'Child body mass index on 75th centile'),('bmi',1,'22K9C00',NULL,'Child body mass index on 75th centile'),('bmi',1,'22K9B',NULL,'Child body mass index 51st-74th centile'),('bmi',1,'22K9B00',NULL,'Child body mass index 51st-74th centile'),('bmi',1,'22K9A',NULL,'Child body mass index on 50th centile'),('bmi',1,'22K9A00',NULL,'Child body mass index on 50th centile'),('bmi',1,'22K99',NULL,'Child body mass index 26th-49th centile'),('bmi',1,'22K9900',NULL,'Child body mass index 26th-49th centile'),('bmi',1,'22K98',NULL,'Child body mass index on 25th centile'),('bmi',1,'22K9800',NULL,'Child body mass index on 25th centile'),('bmi',1,'22K97',NULL,'Child body mass index 10th-24th centile'),('bmi',1,'22K9700',NULL,'Child body mass index 10th-24th centile'),('bmi',1,'22K96',NULL,'Child body mass index on 9th centile'),('bmi',1,'22K9600',NULL,'Child body mass index on 9th centile'),('bmi',1,'22K95',NULL,'Child body mass index 3rd-8th centile'),('bmi',1,'22K9500',NULL,'Child body mass index 3rd-8th centile'),('bmi',1,'22K94',NULL,'Child body mass index on 2nd centile'),('bmi',1,'22K9400',NULL,'Child body mass index on 2nd centile'),('bmi',1,'22K93',NULL,'Child body mass index 0.4th-1.9th centile'),('bmi',1,'22K9300',NULL,'Child body mass index 0.4th-1.9th centile'),('bmi',1,'22K92',NULL,'Child body mass index less than 0.4th centile'),('bmi',1,'22K9200',NULL,'Child body mass index less than 0.4th centile'),('bmi',1,'22K91',NULL,'Child body mass index centile'),('bmi',1,'22K9100',NULL,'Child body mass index centile'),('bmi',1,'22K90',NULL,'Baseline body mass index centile'),('bmi',1,'22K9000',NULL,'Baseline body mass index centile'),('bmi',1,'22K8.',NULL,'Body mass index 20-24 - normal'),('bmi',1,'22K8.00',NULL,'Body mass index 20-24 - normal'),('bmi',1,'22K7.',NULL,'Body mass index 40+ - severely obese'),('bmi',1,'22K7.00',NULL,'Body mass index 40+ - severely obese'),('bmi',1,'22K6.',NULL,'Body mass index less than 20'),('bmi',1,'22K6.00',NULL,'Body mass index less than 20'),('bmi',1,'22K5.',NULL,'Body mass index 30+ - obesity'),('bmi',1,'22K5.00',NULL,'Body mass index 30+ - obesity'),('bmi',1,'22K4.',NULL,'Body mass index index 25-29 - overweight'),('bmi',1,'22K4.00',NULL,'Body mass index index 25-29 - overweight'),('bmi',1,'22K3.',NULL,'Body Mass Index low K/M2'),('bmi',1,'22K3.00',NULL,'Body Mass Index low K/M2'),('bmi',1,'22K2.',NULL,'Body Mass Index high K/M2'),('bmi',1,'22K2.00',NULL,'Body Mass Index high K/M2'),('bmi',1,'22K1.',NULL,'Body Mass Index normal K/M2'),('bmi',1,'22K1.00',NULL,'Body Mass Index normal K/M2'),('bmi',1,'C3808',NULL,'Childhood obesity'),('bmi',1,'C380800',NULL,'Childhood obesity'),('bmi',2,'22K..',NULL,'Body Mass Index'),('bmi',2,'22K..00',NULL,'Body Mass Index');
INSERT INTO #codesreadv2
VALUES ('cholesterol',1,'44P..',NULL,'Serum cholesterol'),('cholesterol',1,'44P..00',NULL,'Serum cholesterol'),('cholesterol',1,'44PZ.',NULL,'Serum cholesterol NOS'),('cholesterol',1,'44PZ.00',NULL,'Serum cholesterol NOS'),('cholesterol',1,'44PL.',NULL,'Non HDL cholesterol level'),('cholesterol',1,'44PL.00',NULL,'Non HDL cholesterol level'),('cholesterol',1,'44PL1',NULL,'Estimated serum non-high density lipoprotein cholesterol level'),('cholesterol',1,'44PL100',NULL,'Estimated serum non-high density lipoprotein cholesterol level'),('cholesterol',1,'44PL0',NULL,'Serum non high density lipoprotein cholesterol level'),('cholesterol',1,'44PL000',NULL,'Serum non high density lipoprotein cholesterol level'),('cholesterol',1,'44PK.',NULL,'Serum fasting total cholesterol'),('cholesterol',1,'44PK.00',NULL,'Serum fasting total cholesterol'),('cholesterol',1,'44PJ.',NULL,'Serum total cholesterol level'),('cholesterol',1,'44PJ.00',NULL,'Serum total cholesterol level'),('cholesterol',1,'44PI.',NULL,'Calculated LDL cholesterol level'),('cholesterol',1,'44PI.00',NULL,'Calculated LDL cholesterol level'),('cholesterol',1,'44PH.',NULL,'Total cholesterol measurement'),('cholesterol',1,'44PH.00',NULL,'Total cholesterol measurement'),('cholesterol',1,'44PG.',NULL,'HDL : total cholesterol ratio'),('cholesterol',1,'44PG.00',NULL,'HDL : total cholesterol ratio'),('cholesterol',1,'44PF.',NULL,'Total cholesterol:HDL ratio'),('cholesterol',1,'44PF.00',NULL,'Total cholesterol:HDL ratio'),('cholesterol',1,'44PE.',NULL,'Serum random LDL cholesterol level'),('cholesterol',1,'44PE.00',NULL,'Serum random LDL cholesterol level'),('cholesterol',1,'44PD.',NULL,'Serum fasting LDL cholesterol level'),('cholesterol',1,'44PD.00',NULL,'Serum fasting LDL cholesterol level'),('cholesterol',1,'44PC.',NULL,'Serum random HDL cholesterol level'),('cholesterol',1,'44PC.00',NULL,'Serum random HDL cholesterol level'),('cholesterol',1,'44PB.',NULL,'Serum fasting HDL cholesterol level'),('cholesterol',1,'44PB.00',NULL,'Serum fasting HDL cholesterol level'),('cholesterol',1,'44P9.',NULL,'Serum cholesterol studies'),('cholesterol',1,'44P9.00',NULL,'Serum cholesterol studies'),('cholesterol',1,'44P8.',NULL,'Serum HDL:non-HDL cholesterol ratio'),('cholesterol',1,'44P8.00',NULL,'Serum HDL:non-HDL cholesterol ratio'),('cholesterol',1,'44P7.',NULL,'Serum VLDL cholesterol level'),('cholesterol',1,'44P7.00',NULL,'Serum VLDL cholesterol level'),('cholesterol',1,'44P6.',NULL,'Serum LDL cholesterol level'),('cholesterol',1,'44P6.00',NULL,'Serum LDL cholesterol level'),('cholesterol',1,'44P5.',NULL,'Serum HDL cholesterol level'),('cholesterol',1,'44P5.00',NULL,'Serum HDL cholesterol level'),('cholesterol',1,'44P4.',NULL,'Serum cholesterol very high'),('cholesterol',1,'44P4.00',NULL,'Serum cholesterol very high'),('cholesterol',1,'44P3.',NULL,'Serum cholesterol raised'),('cholesterol',1,'44P3.00',NULL,'Serum cholesterol raised'),('cholesterol',1,'44P2.',NULL,'Serum cholesterol borderline'),('cholesterol',1,'44P2.00',NULL,'Serum cholesterol borderline'),('cholesterol',1,'44P1.',NULL,'Serum cholesterol normal'),('cholesterol',1,'44P1.00',NULL,'Serum cholesterol normal'),('cholesterol',1,'44PA.',NULL,'HDL : LDL ratio'),('cholesterol',1,'44PA.00',NULL,'HDL : LDL ratio'),('cholesterol',1,'44lM.',NULL,'Plasma LDL/HDL ratio'),('cholesterol',1,'44lM.00',NULL,'Plasma LDL/HDL ratio'),('cholesterol',1,'44lL.',NULL,'Serum LDL/HDL ratio'),('cholesterol',1,'44lL.00',NULL,'Serum LDL/HDL ratio'),('cholesterol',1,'44lK.',NULL,'Plasma cholesterol/VLDL ratio'),('cholesterol',1,'44lK.00',NULL,'Plasma cholesterol/VLDL ratio'),('cholesterol',1,'44lJ.',NULL,'Serum cholesterol/VLDL ratio'),('cholesterol',1,'44lJ.00',NULL,'Serum cholesterol/VLDL ratio'),('cholesterol',1,'44lI.',NULL,'Plasma cholesterol/LDL ratio'),('cholesterol',1,'44lI.00',NULL,'Plasma cholesterol/LDL ratio'),('cholesterol',1,'44lH.',NULL,'Serum cholesterol/LDL ratio'),('cholesterol',1,'44lH.00',NULL,'Serum cholesterol/LDL ratio'),('cholesterol',1,'44lG.',NULL,'Plasma cholesterol/HDL ratio'),('cholesterol',1,'44lG.00',NULL,'Plasma cholesterol/HDL ratio'),('cholesterol',1,'44lF.',NULL,'Serum cholesterol/HDL ratio'),('cholesterol',1,'44lF.00',NULL,'Serum cholesterol/HDL ratio'),('cholesterol',1,'44l2.',NULL,'Cholesterol/HDL ratio'),('cholesterol',1,'44l2.00',NULL,'Cholesterol/HDL ratio'),('cholesterol',1,'44dB.',NULL,'Plasma LDL cholesterol level'),('cholesterol',1,'44dB.00',NULL,'Plasma LDL cholesterol level'),('cholesterol',1,'44dA.',NULL,'Plasma HDL cholesterol level'),('cholesterol',1,'44dA.00',NULL,'Plasma HDL cholesterol level'),('cholesterol',1,'44d5.',NULL,'Plasma fasting LDL cholesterol level'),('cholesterol',1,'44d5.00',NULL,'Plasma fasting LDL cholesterol level'),('cholesterol',1,'44d4.',NULL,'Plasma random LDL cholesterol level'),('cholesterol',1,'44d4.00',NULL,'Plasma random LDL cholesterol level'),('cholesterol',1,'44d3.',NULL,'Plasma fasting HDL cholesterol level'),('cholesterol',1,'44d3.00',NULL,'Plasma fasting HDL cholesterol level'),('cholesterol',1,'44d2.',NULL,'Plasma random HDL cholesterol level'),('cholesterol',1,'44d2.00',NULL,'Plasma random HDL cholesterol level'),('cholesterol',1,'44R4.',NULL,'Lipoprotein electroph. - LDL'),('cholesterol',1,'44R4.00',NULL,'Lipoprotein electroph. - LDL'),('cholesterol',1,'44R3.',NULL,'Lipoprotein electroph. - HDL'),('cholesterol',1,'44R3.00',NULL,'Lipoprotein electroph. - HDL'),('cholesterol',1,'662a.',NULL,'Pre-treatment serum cholesterol level'),('cholesterol',1,'662a.00',NULL,'Pre-treatment serum cholesterol level'),('cholesterol',1,'44OE.',NULL,'Plasma total cholesterol level'),('cholesterol',1,'44OE.00',NULL,'Plasma total cholesterol level'),('cholesterol',1,'44lzY',NULL,'Serum high density lipoprotein cholesterol:triglyceride ratio'),('cholesterol',1,'44lzY00',NULL,'Serum high density lipoprotein cholesterol:triglyceride ratio'),('cholesterol',1,'4I3O.',NULL,'Fluid sample cholesterol level'),('cholesterol',1,'4I3O.00',NULL,'Fluid sample cholesterol level'),('cholesterol',2,'44P..',NULL,'Serum cholesterol'),('cholesterol',2,'44P..00',NULL,'Serum cholesterol'),('cholesterol',2,'44PZ.',NULL,'Serum cholesterol NOS'),('cholesterol',2,'44PZ.00',NULL,'Serum cholesterol NOS'),('cholesterol',2,'44PJ.',NULL,'Serum total cholesterol level'),('cholesterol',2,'44PJ.00',NULL,'Serum total cholesterol level'),('cholesterol',2,'44PH.',NULL,'Total cholesterol measurement'),('cholesterol',2,'44PH.00',NULL,'Total cholesterol measurement');
INSERT INTO #codesreadv2
VALUES ('egfr',1,'451E.',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'451E.00',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'451G.',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'451G.00',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'451K.',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'451K.00',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'451M.',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451M.00',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451N.',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451N.00',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres');
INSERT INTO #codesreadv2
VALUES ('hba1c',1,'42c..',NULL,'HbA1 - diabetic control'),('hba1c',1,'42c..00',NULL,'HbA1 - diabetic control'),('hba1c',1,'42c3.',NULL,'HbA1 level (DCCT aligned)'),('hba1c',1,'42c3.00',NULL,'HbA1 level (DCCT aligned)'),('hba1c',1,'42c2.',NULL,'HbA1 > 10% - bad control'),('hba1c',1,'42c2.00',NULL,'HbA1 > 10% - bad control'),('hba1c',1,'42c1.',NULL,'HbA1 7 - 10% - borderline control'),('hba1c',1,'42c1.00',NULL,'HbA1 7 - 10% - borderline control'),('hba1c',1,'42c0.',NULL,'HbA1 < 7% - good control'),('hba1c',1,'42c0.00',NULL,'HbA1 < 7% - good control'),('hba1c',1,'42W..',NULL,'Hb. A1C - diabetic control'),('hba1c',1,'42W..00',NULL,'Hb. A1C - diabetic control'),('hba1c',1,'42WZ.',NULL,'Hb. A1C - diabetic control NOS'),('hba1c',1,'42WZ.00',NULL,'Hb. A1C - diabetic control NOS'),('hba1c',1,'42W3.',NULL,'Hb. A1C > 10% - bad control'),('hba1c',1,'42W3.00',NULL,'Hb. A1C > 10% - bad control'),('hba1c',1,'42W2.',NULL,'Hb. A1C 7-10% - borderline'),('hba1c',1,'42W2.00',NULL,'Hb. A1C 7-10% - borderline'),('hba1c',1,'42W1.',NULL,'Hb. A1C < 7% - good control'),('hba1c',1,'42W1.00',NULL,'Hb. A1C < 7% - good control'),('hba1c',1,'42W5.',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',1,'42W5.00',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',1,'42W51',NULL,'HbA1c (haemoglobin A1c) level (monitoring ranges) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W5100',NULL,'HbA1c (haemoglobin A1c) level (monitoring ranges) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W50',NULL,'HbA1c (haemoglobin A1c) level (diagnostic reference range) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W5000',NULL,'HbA1c (haemoglobin A1c) level (diagnostic reference range) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W4.',NULL,'HbA1c level (DCCT aligned)'),('hba1c',1,'42W4.00',NULL,'HbA1c level (DCCT aligned)'),('hba1c',1,'44TL.',NULL,'Total glycosylated haemoglobin level'),('hba1c',1,'44TL.00',NULL,'Total glycosylated haemoglobin level'),('hba1c',1,'44TB.',NULL,'Haemoglobin A1c level'),('hba1c',1,'44TB.00',NULL,'Haemoglobin A1c level'),('hba1c',1,'44TB1',NULL,'Haemoglobin A1c (monitoring ranges)'),('hba1c',1,'44TB100',NULL,'Haemoglobin A1c (monitoring ranges)'),('hba1c',1,'44TB0',NULL,'Haemoglobin A1c (diagnostic reference range)'),('hba1c',1,'44TB000',NULL,'Haemoglobin A1c (diagnostic reference range)'),('hba1c',2,'42W5.',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W5.00',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W4.',NULL,'HbA1c level (DCCT aligned)'),('hba1c',2,'42W4.00',NULL,'HbA1c level (DCCT aligned)');
INSERT INTO #codesreadv2
VALUES ('hdl-cholesterol',1,'44PC.',NULL,'Serum random HDL cholesterol level'),('hdl-cholesterol',1,'44PC.00',NULL,'Serum random HDL cholesterol level'),('hdl-cholesterol',1,'44P5.',NULL,'Serum HDL cholesterol level'),('hdl-cholesterol',1,'44P5.00',NULL,'Serum HDL cholesterol level'),('hdl-cholesterol',1,'44dA.',NULL,'Plasma HDL cholesterol level'),('hdl-cholesterol',1,'44dA.00',NULL,'Plasma HDL cholesterol level');
INSERT INTO #codesreadv2
VALUES ('ldl-cholesterol',1,'44PI.',NULL,'Calculated LDL cholesterol level'),('ldl-cholesterol',1,'44PI.00',NULL,'Calculated LDL cholesterol level'),('ldl-cholesterol',1,'44P6.',NULL,'Serum LDL cholesterol level'),('ldl-cholesterol',1,'44P6.00',NULL,'Serum LDL cholesterol level'),('ldl-cholesterol',1,'44dB.',NULL,'Plasma LDL cholesterol level'),('ldl-cholesterol',1,'44dB.00',NULL,'Plasma LDL cholesterol level');
INSERT INTO #codesreadv2
VALUES ('sex-hormone-binding-globulin',1,'44CD.',NULL,'Serum sex hormone binding globulin level'),('sex-hormone-binding-globulin',1,'44CD.00',NULL,'Serum sex hormone binding globulin level');
INSERT INTO #codesreadv2
VALUES ('testosterone',1,'4473.',NULL,'Serum testosterone'),('testosterone',1,'4473.00',NULL,'Serum testosterone'),('testosterone',1,'447G.',NULL,'Plasma testosterone level'),('testosterone',1,'447G.00',NULL,'Plasma testosterone level');
INSERT INTO #codesreadv2
VALUES ('vitamin-d',1,'4QB4.',NULL,'Vitamin D level'),('vitamin-d',1,'4QB4.00',NULL,'Vitamin D level'),('vitamin-d',1,'44LA.',NULL,'Serum vitamin D'),('vitamin-d',1,'44LA.00',NULL,'Serum vitamin D'),('vitamin-d',1,'4QB44',NULL,'Combined total vitamin D2 and D3 level'),('vitamin-d',1,'4QB4400',NULL,'Combined total vitamin D2 and D3 level'),('vitamin-d',1,'4QB45',NULL,'25-Hydroxyvitamin D level'),('vitamin-d',1,'4QB4500',NULL,'25-Hydroxyvitamin D level'),('vitamin-d',1,'4QB46',NULL,'Total 25-hydroxyvitamin D level'),('vitamin-d',1,'4QB4600',NULL,'Total 25-hydroxyvitamin D level'),('vitamin-d',1,'4QB47',NULL,'Serum total 25-hydroxy vitamin D level'),('vitamin-d',1,'4QB4700',NULL,'Serum total 25-hydroxy vitamin D level')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesreadv2;

IF OBJECT_ID('tempdb..#codesctv3') IS NOT NULL DROP TABLE #codesctv3;
CREATE TABLE #codesctv3 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesctv3
VALUES ('bmi',1,'22K..',NULL,'Body Mass Index'),('bmi',1,'22K1.',NULL,'Body Mass Index normal K/M2'),('bmi',1,'22K2.',NULL,'Body Mass Index high K/M2'),('bmi',1,'22K3.',NULL,'Body Mass Index low K/M2'),('bmi',1,'22K4.',NULL,'Body mass index index 25-29 - overweight'),('bmi',1,'22K5.',NULL,'Body mass index 30+ - obesity'),('bmi',1,'X76CO',NULL,'Quetelet index'),('bmi',1,'Xa7wG',NULL,'Observation of body mass index'),('bmi',1,'Xaa0k',NULL,'Childhood obesity'),('bmi',1,'Xaatm',NULL,'Child BMI centile'),('bmi',1,'Xabdn',NULL,'Downs syndrome BMI centile'),('bmi',1,'XabHx',NULL,'Obese class I (BMI 30.0-34.9)'),('bmi',1,'XabHy',NULL,'Obese class II (BMI 35.0-39.9)'),('bmi',1,'XabHz',NULL,'Obese cls III (BMI eq/gr 40.0)'),('bmi',1,'XabSe',NULL,'Child BMI < 0.4th centile'),('bmi',1,'XabSf',NULL,'Child BMI 0.4th-1.9th centile'),('bmi',1,'XabSg',NULL,'Child BMI on 2nd centile'),('bmi',1,'XabSh',NULL,'Child BMI 3rd-8th centile'),('bmi',1,'XabSj',NULL,'Child BMI on 9th centile'),('bmi',1,'XabSk',NULL,'Child BMI 10th-24th centile'),('bmi',1,'XabSl',NULL,'Child BMI on 25th centile'),('bmi',1,'XabSm',NULL,'Child BMI 26th-49th centile'),('bmi',1,'XabSn',NULL,'Child BMI on 50th centile'),('bmi',1,'XabTe',NULL,'Child BMI on 75th centile'),('bmi',1,'XabTf',NULL,'Child BMI 76th-90th centile'),('bmi',1,'XabTg',NULL,'Child BMI on 91st centile'),('bmi',1,'XabTh',NULL,'Child BMI 92nd-97th centile'),('bmi',1,'XabTi',NULL,'Child BMI on 98th centile'),('bmi',1,'XabTj',NULL,'Child BMI 98.1-99.6 centile'),('bmi',1,'XabTk',NULL,'Child BMI > 99.6th centile'),('bmi',1,'XabTZ',NULL,'Child BMI 51st-74th centile'),('bmi',1,'XaCDR',NULL,'Body mass index less than 20'),('bmi',1,'XaJJH',NULL,'BMI 40+ - severely obese'),('bmi',1,'XaJqk',NULL,'Body mass index 20-24 - normal'),('bmi',1,'XaVwA',NULL,'Body mass index centile'),('bmi',1,'XaZck',NULL,'Baseline BMI centile'),('bmi',1,'XaZcl',NULL,'Baseline body mass index'),('bmi',2,'22K..',NULL,'Body Mass Index');
INSERT INTO #codesctv3
VALUES ('cholesterol',1,'X772L',NULL,'Cholesterol level'),('cholesterol',1,'X772M',NULL,'High density lipoprot chol lev'),('cholesterol',1,'X772N',NULL,'LDL-Low dens lipoprot chol lev'),('cholesterol',1,'X773m',NULL,'Percentage chol as ester'),('cholesterol',1,'X773W',NULL,'HDL/LDL ratio'),('cholesterol',1,'X80J1',NULL,'HDL - High density lipoprotein'),('cholesterol',1,'X80Nb',NULL,'Hi density lipoprot subfrac 2'),('cholesterol',1,'X80Nc',NULL,'Hi density lipoprot subfrac 3'),('cholesterol',1,'X80Ne',NULL,'LDL - Low density lipoprotein'),('cholesterol',1,'X80NT',NULL,'Free cholesterol'),('cholesterol',1,'X80NU',NULL,'Cholesterol ester'),('cholesterol',1,'XabE1',NULL,'Se non HDL cholesterol level'),('cholesterol',1,'XabT0',NULL,'Estim serum non-HDL cholest lv'),('cholesterol',1,'Xabub',NULL,'Se HDL chol:triglyceride ratio'),('cholesterol',1,'XaEil',NULL,'Hi dens lipoprt/tot chol ratio'),('cholesterol',1,'XaERR',NULL,'Cholesterol/HDL ratio'),('cholesterol',1,'XaEUp',NULL,'Lipoprotein cholesterol ratio'),('cholesterol',1,'XaEUq',NULL,'Serum cholesterol/HDL ratio'),('cholesterol',1,'XaEUr',NULL,'Plasma cholesterol/HDL ratio'),('cholesterol',1,'XaEUs',NULL,'Serum cholesterol/LDL ratio'),('cholesterol',1,'XaEUt',NULL,'Plasma cholesterol/LDL ratio'),('cholesterol',1,'XaEUu',NULL,'Serum cholesterol/VLDL ratio'),('cholesterol',1,'XaEUv',NULL,'Plasma cholesterol/VLDL ratio'),('cholesterol',1,'XaEVQ',NULL,'Serum LDL/HDL ratio'),('cholesterol',1,'XaEVr',NULL,'Plasma HDL cholesterol level'),('cholesterol',1,'XaEVR',NULL,'Plasma LDL/HDL ratio'),('cholesterol',1,'XaEVs',NULL,'Plasma LDL cholesterol level'),('cholesterol',1,'XaFs9',NULL,'Fasting cholesterol level'),('cholesterol',1,'XaIp4',NULL,'Calculated LDL cholesterol lev'),('cholesterol',1,'XaIqd',NULL,'Pre-treatmnt serum cholest lev'),('cholesterol',1,'XaIRd',NULL,'Plasma total cholesterol level'),('cholesterol',1,'XaIYp',NULL,'Fluid sample cholesterol level'),('cholesterol',1,'XaJe9',NULL,'Serum total cholesterol level'),('cholesterol',1,'XaLux',NULL,'Serum fastng total cholesterol'),('cholesterol',1,'XaN3z',NULL,'Non HDL cholesterol level'),('cholesterol',1,'XE28o',NULL,'HDL : LDL ratio'),('cholesterol',1,'XE2eD',NULL,'Serum cholesterol'),('cholesterol',1,'XE2mn',NULL,'Ser HDL/non-HDL cholest ratio'),('cholesterol',1,'XSK14',NULL,'Total cholesterol measurement'),('cholesterol',1,'44P..',NULL,'Serum cholesterol'),('cholesterol',1,'44PZ.',NULL,'Serum cholesterol NOS'),('cholesterol',1,'44PL.',NULL,'Non HDL cholesterol level'),('cholesterol',1,'44PL1',NULL,'Estimated serum non-high density lipoprotein cholesterol level'),('cholesterol',1,'44PL0',NULL,'Serum non high density lipoprotein cholesterol level'),('cholesterol',1,'44PK.',NULL,'Serum fasting total cholesterol'),('cholesterol',1,'44PJ.',NULL,'Serum total cholesterol level'),('cholesterol',1,'44PI.',NULL,'Calculated LDL cholesterol level'),('cholesterol',1,'44PH.',NULL,'Total cholesterol measurement'),('cholesterol',1,'44PG.',NULL,'HDL : total cholesterol ratio'),('cholesterol',1,'44PF.',NULL,'Total cholesterol:HDL ratio'),('cholesterol',1,'44PE.',NULL,'Serum random LDL cholesterol level'),('cholesterol',1,'44PD.',NULL,'Serum fasting LDL cholesterol level'),('cholesterol',1,'44PC.',NULL,'Serum random HDL cholesterol level'),('cholesterol',1,'44PB.',NULL,'Serum fasting HDL cholesterol level'),('cholesterol',1,'44P9.',NULL,'Serum cholesterol studies'),('cholesterol',1,'44P8.',NULL,'Serum HDL:non-HDL cholesterol ratio'),('cholesterol',1,'44P7.',NULL,'Serum VLDL cholesterol level'),('cholesterol',1,'44P6.',NULL,'Serum LDL cholesterol level'),('cholesterol',1,'44P5.',NULL,'Serum HDL cholesterol level'),('cholesterol',1,'44P4.',NULL,'Serum cholesterol very high'),('cholesterol',1,'44P3.',NULL,'Serum cholesterol raised'),('cholesterol',1,'44P2.',NULL,'Serum cholesterol borderline'),('cholesterol',1,'44P1.',NULL,'Serum cholesterol normal'),('cholesterol',1,'44PA.',NULL,'HDL : LDL ratio'),('cholesterol',1,'44lM.',NULL,'Plasma LDL/HDL ratio'),('cholesterol',1,'44lL.',NULL,'Serum LDL/HDL ratio'),('cholesterol',1,'44lK.',NULL,'Plasma cholesterol/VLDL ratio'),('cholesterol',1,'44lJ.',NULL,'Serum cholesterol/VLDL ratio'),('cholesterol',1,'44lI.',NULL,'Plasma cholesterol/LDL ratio'),('cholesterol',1,'44lH.',NULL,'Serum cholesterol/LDL ratio'),('cholesterol',1,'44lG.',NULL,'Plasma cholesterol/HDL ratio'),('cholesterol',1,'44lF.',NULL,'Serum cholesterol/HDL ratio'),('cholesterol',1,'44l2.',NULL,'Cholesterol/HDL ratio'),('cholesterol',1,'44dB.',NULL,'Plasma LDL cholesterol level'),('cholesterol',1,'44dA.',NULL,'Plasma HDL cholesterol level'),('cholesterol',1,'44d5.',NULL,'Plasma fasting LDL cholesterol level'),('cholesterol',1,'44d4.',NULL,'Plasma random LDL cholesterol level'),('cholesterol',1,'44d3.',NULL,'Plasma fasting HDL cholesterol level'),('cholesterol',1,'44d2.',NULL,'Plasma random HDL cholesterol level'),('cholesterol',1,'44R4.',NULL,'LDL - electrophoresis'),('cholesterol',1,'44R4.',NULL,'Lipoprotein electroph. - LDL'),('cholesterol',1,'44R3.',NULL,'HDL - electrophoresis'),('cholesterol',1,'44R3.',NULL,'Lipoprotein electroph. - HDL'),('cholesterol',1,'662a.',NULL,'Pre-treatment serum cholesterol level'),('cholesterol',1,'44OE.',NULL,'Plasma total cholesterol level'),('cholesterol',1,'44lzY',NULL,'Serum high density lipoprotein cholesterol:triglyceride ratio'),('cholesterol',1,'4I3O.',NULL,'Fluid sample cholesterol level'),('cholesterol',2,'XSK14',NULL,'Total cholesterol measurement'),('cholesterol',2,'44PH.',NULL,'Total cholesterol measurement'),('cholesterol',2,'44PJ.',NULL,'Serum total cholesterol level'),('cholesterol',2,'44P..',NULL,'Serum cholesterol'),('cholesterol',2,'44PZ.',NULL,'Serum cholesterol NOS'),('cholesterol',2,'XE2eD',NULL,'Serum cholesterol'),('cholesterol',2,'XaJe9',NULL,'Serum total cholesterol level');
INSERT INTO #codesctv3
VALUES ('egfr',1,'X70kK',NULL,'Tc99m-DTPA clearance - GFR'),('egfr',1,'X70kL',NULL,'Cr51- EDTA clearance - GFR'),('egfr',1,'X90kf',NULL,'With GFR'),('egfr',1,'XaK8y',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'XaMDA',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'XaZpN',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'XacUJ',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'XacUK',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres');
INSERT INTO #codesctv3
VALUES ('hba1c',1,'X772q',NULL,'Haemoglobin A1c level'),('hba1c',1,'XE24t',NULL,'Hb. A1C - diabetic control'),('hba1c',1,'42W1.',NULL,'Hb. A1C < 7% - good control'),('hba1c',1,'42W2.',NULL,'Hb. A1C 7-10% - borderline'),('hba1c',1,'42W3.',NULL,'Hb. A1C > 10% - bad control'),('hba1c',1,'42WZ.',NULL,'Hb. A1C - diabetic control NOS'),('hba1c',1,'X80U4',NULL,'Glycosylat haemoglobin-c frac'),('hba1c',1,'XaCES',NULL,'HbA1 - diabetic control'),('hba1c',1,'XaCET',NULL,'HbA1 <7% - good control'),('hba1c',1,'XaCEV',NULL,'HbA1 >10% - bad control'),('hba1c',1,'XaCEU',NULL,'HbA1 7-10% - borderline contrl'),('hba1c',1,'XaERp',NULL,'HbA1c level (DCCT aligned)'),('hba1c',1,'XaPbt',NULL,'HbA1c levl - IFCC standardised'),('hba1c',1,'XabrE',NULL,'HbA1c (diagnostic refrn range)'),('hba1c',1,'XabrF',NULL,'HbA1c (monitoring ranges)'),('hba1c',1,'Xaezd',NULL,'HbA1c(diagnos ref rnge)IFCC st'),('hba1c',1,'Xaeze',NULL,'HbA1c(monitoring rnges)IFCC st'),('hba1c',1,'42W..',NULL,'Hb. A1C - diabetic control'),('hba1c',1,'42W5.',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',1,'42W51',NULL,'HbA1c (haemoglobin A1c) level (monitoring ranges) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W50',NULL,'HbA1c (haemoglobin A1c) level (diagnostic reference range) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W4.',NULL,'HbA1c level (DCCT aligned)'),('hba1c',1,'44TB.',NULL,'Haemoglobin A1c level'),('hba1c',1,'44TB1',NULL,'Haemoglobin A1c (monitoring ranges)'),('hba1c',1,'44TB0',NULL,'Haemoglobin A1c (diagnostic reference range)'),('hba1c',2,'XaERp',NULL,'HbA1c level (DCCT aligned)'),('hba1c',2,'XaPbt',NULL,'HbA1c levl - IFCC standardised'),('hba1c',2,'42W5.',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W4.',NULL,'HbA1c level (DCCT aligned)');
INSERT INTO #codesctv3
VALUES ('hdl-cholesterol',1,'44P5.',NULL,'Serum HDL cholesterol level'),('hdl-cholesterol',1,'44PC.',NULL,'Ser random HDL cholesterol lev'),('hdl-cholesterol',1,'XaEVr',NULL,'Plasma HDL cholesterol level');
INSERT INTO #codesctv3
VALUES ('ldl-cholesterol',1,'44P6.',NULL,'Serum LDL cholesterol level'),('ldl-cholesterol',1,'XaIp4',NULL,'Calculated LDL cholesterol lev'),('ldl-cholesterol',1,'XaEVs',NULL,'Plasma LDL cholesterol level');
INSERT INTO #codesctv3
VALUES ('sex-hormone-binding-globulin',1,'44CD.',NULL,'Serum sex hormone binding globulin level');
INSERT INTO #codesctv3
VALUES ('testosterone',1,'XE2dr',NULL,'Serum testosterone level'),('testosterone',1,'4473.',NULL,'Serum testosterone'),('testosterone',1,'XaItQ',NULL,'Plasma testosterone level');
INSERT INTO #codesctv3
VALUES ('vitamin-d',1,'44LA.',NULL,'Serum vitamin D'),('vitamin-d',1,'Xabo0',NULL,'Serum total 25-OH vit D level'),('vitamin-d',1,'XaY6m',NULL,'Total 25-hydroxyvitamin D levl'),('vitamin-d',1,'XE2e7',NULL,'Serum vitamin D level'),('vitamin-d',1,'XaXhN',NULL,'Vitamin D level'),('vitamin-d',1,'XaXhT',NULL,'Combined total vit D2 + D3 lvl'),('vitamin-d',1,'XaXm0',NULL,'25-Hydroxyvitamin D level')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesctv3;

IF OBJECT_ID('tempdb..#codessnomed') IS NOT NULL DROP TABLE #codessnomed;
CREATE TABLE #codessnomed (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codessnomed
VALUES ('bmi',1,'6497000',NULL,'Decreased body mass index (finding)'),('bmi',1,'35425004',NULL,'Normal body mass index (finding)'),('bmi',1,'48499001',NULL,'Increased body mass index (finding)'),('bmi',1,'162863004',NULL,'Body mass index 25-29 - overweight'),('bmi',1,'162864005',NULL,'BMI 30+ - obesity'),('bmi',1,'301331008',NULL,'Observation of body mass index'),('bmi',1,'310252000',NULL,'BMI less than 20'),('bmi',1,'408512008',NULL,'Body mass index 40+ - morbidly obese'),('bmi',1,'412768003',NULL,'Body mass index 20-24 - normal'),('bmi',1,'427090001',NULL,'Body mass index less than 16.5'),('bmi',1,'450451007',NULL,'Childhood overweight BMI greater than 85 percentile'),('bmi',1,'722595002',NULL,'Overweight in adulthood with BMI of 25 or more but less than 30'),('bmi',1,'920141000000102',NULL,'Child BMI (body mass index) less than 0.4th centile'),('bmi',1,'920161000000101',NULL,'Child BMI (body mass index) 0.4th-1.9th centile'),('bmi',1,'920181000000105',NULL,'Child BMI (body mass index) on 2nd centile'),('bmi',1,'920201000000109',NULL,'Child BMI (body mass index) 3rd-8th centile'),('bmi',1,'920231000000103',NULL,'Child BMI (body mass index) on 9th centile'),('bmi',1,'920251000000105',NULL,'Child BMI (body mass index) 10th-24th centile'),('bmi',1,'920271000000101',NULL,'Child BMI (body mass index) on 25th centile'),('bmi',1,'920291000000102',NULL,'Child BMI (body mass index) 26th-49th centile'),('bmi',1,'920311000000101',NULL,'Child BMI (body mass index) on 50th centile'),('bmi',1,'920841000000108',NULL,'Child BMI (body mass index) 51st-74th centile'),('bmi',1,'920931000000108',NULL,'Child BMI (body mass index) on 75th centile'),('bmi',1,'920951000000101',NULL,'Child BMI (body mass index) 76th-90th centile'),('bmi',1,'920971000000105',NULL,'Child BMI (body mass index) on 91st centile'),('bmi',1,'920991000000109',NULL,'Child BMI (body mass index) 92nd-97th centile'),('bmi',1,'921011000000105',NULL,'Child BMI (body mass index) on 98th centile'),('bmi',1,'921031000000102',NULL,'Child BMI (body mass index) 98.1st-99.6th centile'),('bmi',1,'921051000000109',NULL,'Child BMI (body mass index) greater than 99.6th centile'),('bmi',1,'914721000000105',NULL,'Obese class I (body mass index 30.0 - 34.9)'),('bmi',1,'914731000000107',NULL,'Obese class II (body mass index 35.0 - 39.9)'),('bmi',1,'914741000000103',NULL,'Obese class III (body mass index equal to or greater than 40.0)'),('bmi',1,'443371000124107',NULL,'Body mass index 30.00 to 34.99'),('bmi',1,'443381000124105',NULL,'Body mass index 35.00 to 39.99'),('bmi',1,'60621009',NULL,'Quetelet index'),('bmi',1,'846931000000101',NULL,'Baseline BMI (body mass index)'),('bmi',1,'852451000000103',NULL,'Maximum body mass index (observable entity)'),('bmi',1,'852461000000100',NULL,'Minimum body mass index (observable entity)'),('bmi',1,'446974000',NULL,'Body mass index centile'),('bmi',1,'846911000000109',NULL,'Baseline BMI (body mass index) centile'),('bmi',1,'896691000000102',NULL,'Child BMI (body mass index) centile'),('bmi',1,'926011000000101',NULL,'Downs syndrome BMI (body mass index) centile'),('bmi',1,'722562008',NULL,'Foetal or neonatal effect or suspected effect of maternal obesity with adult body mass index 30 or greater but less than 40'),('bmi',1,'722563003',NULL,'Foetal or neonatal effect of maternal obesity with adult body mass index equal to or greater than 40'),('bmi',1,'705131003',NULL,'Child at risk for overweight body mass index greater than 85 percentile'),('bmi',1,'43991000119102',NULL,'History of childhood obesity BMI 95-100 percentile'),('bmi',1,'698094009',NULL,'Calculation of body mass index'),('bmi',1,'444862003',NULL,'Childhood obesity BMI 95-100 percentile'),('bmi',2,'301331008',NULL,'Finding of body mass index (finding)');
INSERT INTO #codessnomed
VALUES ('cholesterol',1,'13067005',NULL,'Cholesteryl esters measurement (procedure)'),('cholesterol',1,'17888004',NULL,'High density lipoprotein measurement (procedure)'),('cholesterol',1,'28036006',NULL,'High density lipoprotein cholesterol level'),('cholesterol',1,'77068002',NULL,'Cholesterol measurement (procedure)'),('cholesterol',1,'104583003',NULL,'High density lipoprotein/total cholesterol ratio measurement'),('cholesterol',1,'104584009',NULL,'Intermediate density lipoprotein cholesterol measurement'),('cholesterol',1,'104585005',NULL,'Very low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'104586006',NULL,'Cholesterol/triglyceride ratio measurement (procedure)'),('cholesterol',1,'104594004',NULL,'Cholesterol esterase measurement (procedure)'),('cholesterol',1,'104777003',NULL,'Lecithin cholesterol acyltransferase measurement (procedure)'),('cholesterol',1,'104781003',NULL,'Lipids, cholesterol measurement (procedure)'),('cholesterol',1,'104990004',NULL,'Triglyceride and ester in high density lipoprotein measurement (procedure)'),('cholesterol',1,'104992007',NULL,'Triglyceride and ester in low density lipoprotein measurement'),('cholesterol',1,'113079009',NULL,'Low density lipoprotein cholesterol level'),('cholesterol',1,'121751004',NULL,'Cholesterol sulfate measurement (procedure)'),('cholesterol',1,'121868005',NULL,'Total cholesterol measurement (procedure)'),('cholesterol',1,'166832000',NULL,'Serum high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166833005',NULL,'Serum low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166834004',NULL,'Serum very low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166838001',NULL,'Serum fasting high density lipoprotein cholesterol measurement'),('cholesterol',1,'166839009',NULL,'Serum random high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166840006',NULL,'Serum fasting low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166841005',NULL,'Serum random low density lipoprotein cholesterol measurement'),('cholesterol',1,'166842003',NULL,'Total cholesterol:high density lipoprotein ratio measurement'),('cholesterol',1,'167072001',NULL,'Plasma random high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'167073006',NULL,'Plasma fasting high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'167074000',NULL,'Plasma random low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'167075004',NULL,'Plasma fasting low density lipoprotein cholesterol measurement'),('cholesterol',1,'250743005',NULL,'HDL/LDL ratio'),('cholesterol',1,'250759005',NULL,'Measurement of percentage cholesterol as ester (procedure)'),('cholesterol',1,'271059008',NULL,'Serum high density lipoprotein/non-high density lipoprotein cholesterol ratio measurement (procedure)'),('cholesterol',1,'313811003',NULL,'Cholesterol/High density lipoprotein ratio measurement'),('cholesterol',1,'313988001',NULL,'Lipoprotein cholesterol ratio measurement (procedure)'),('cholesterol',1,'313989009',NULL,'Serum cholesterol/high density lipoprotein ratio measurement'),('cholesterol',1,'313990000',NULL,'Plasma cholesterol/high density lipoprotein ratio measurement'),('cholesterol',1,'313991001',NULL,'Serum cholesterol/low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'313992008',NULL,'Plasma cholesterol/low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'313993003',NULL,'Serum cholesterol/very low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'313994009',NULL,'Plasma cholesterol/very low density lipoprotein ratio measurement'),('cholesterol',1,'314012003',NULL,'Serum low density lipoprotein/high density lipoprotein ratio measurement'),('cholesterol',1,'314013008',NULL,'Plasma low density lipoprotein/high density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'314035000',NULL,'Plasma high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'314036004',NULL,'Plasma low density lipoprotein cholesterol measurement'),('cholesterol',1,'315017003',NULL,'Fasting cholesterol level (procedure)'),('cholesterol',1,'390956002',NULL,'Plasma total cholesterol level'),('cholesterol',1,'391291008',NULL,'Fluid sample cholesterol level'),('cholesterol',1,'395065005',NULL,'Calculated low density lipoprotein cholesterol level (procedure)'),('cholesterol',1,'395153009',NULL,'Pre-treatment serum cholesterol level'),('cholesterol',1,'412808005',NULL,'Serum total cholesterol level'),('cholesterol',1,'443915001',NULL,'Measurement of total cholesterol and triglycerides'),('cholesterol',1,'789381000000104',NULL,'Cholesterol/phospholipid ratio measurement (procedure)'),('cholesterol',1,'195861000000108',NULL,'Cholesterol content measurement (procedure)'),('cholesterol',1,'293821000000103',NULL,'Non high density lipoprotein cholesterol level'),('cholesterol',1,'194351000000100',NULL,'Cholesterol/low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'194361000000102',NULL,'Cholesterol/very low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'247801000000106',NULL,'Serum fasting total cholesterol'),('cholesterol',1,'194801000000108',NULL,'High density lipoprotein/non-high density lipoprotein cholesterol ratio measurement (procedure)'),('cholesterol',1,'912151000000109',NULL,'Serum non high density lipoprotein cholesterol level'),('cholesterol',1,'920471000000100',NULL,'Estimated serum non-high density lipoprotein cholesterol level'),('cholesterol',1,'1006191000000106',NULL,'Serum non HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1102851000000101',NULL,'Estimated serum non high density lipoprotein cholesterol level (observable entity)'),('cholesterol',1,'1030411000000101',NULL,'Non HDL cholesterol level'),('cholesterol',1,'1005681000000107',NULL,'Serum HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1015271000000109',NULL,'Serum HDL (high density lipoprotein):non-HDL (high density lipoprotein) cholesterol ratio'),('cholesterol',1,'1015681000000109',NULL,'Serum cholesterol/HDL (high density lipoprotein) ratio'),('cholesterol',1,'1015741000000109',NULL,'Serum LDL (low density lipoprotein)/HDL (high density lipoprotein) ratio'),('cholesterol',1,'1015751000000107',NULL,'Plasma LDL/HDL (low density lipoprotein/high density lipoprotein) ratio'),('cholesterol',1,'1010581000000101',NULL,'Plasma HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1015701000000106',NULL,'Serum cholesterol/LDL (low density lipoprotein) ratio'),('cholesterol',1,'1015711000000108',NULL,'Plasma cholesterol/LDL (low density lipoprotein) ratio'),('cholesterol',1,'1010591000000104',NULL,'Plasma LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1014501000000104',NULL,'Calculated LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1022191000000100',NULL,'Serum LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1003441000000101',NULL,'Serum VLDL (very low density lipoprotein) cholesterol level'),('cholesterol',1,'1015721000000102',NULL,'Serum cholesterol/VLDL (very low density lipoprotein) ratio'),('cholesterol',1,'1015731000000100',NULL,'Plasma cholesterol/VLDL (very low density lipoprotein) ratio'),('cholesterol',1,'1024231000000104',NULL,'Fluid sample cholesterol level'),('cholesterol',1,'1031421000000101',NULL,'High density lipoprotein/total cholesterol ratio'),('cholesterol',1,'1026451000000102',NULL,'Serum fasting HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1026461000000104',NULL,'Serum random HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1107681000000108',NULL,'HDL (high density lipoprotein) cholesterol molar concentration in serum'),('cholesterol',1,'1028831000000106',NULL,'Plasma random HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1028841000000102',NULL,'Plasma fasting HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1107661000000104',NULL,'HDL (high density lipoprotein) cholesterol molar concentration in plasma'),('cholesterol',1,'1028861000000101',NULL,'Plasma fasting LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1028851000000104',NULL,'Plasma random LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1026471000000106',NULL,'Serum fasting LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1026481000000108',NULL,'Serum random LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1015691000000106',NULL,'Plasma cholesterol/HDL (high density lipoprotein) ratio'),('cholesterol',1,'994351000000103',NULL,'Serum total cholesterol level'),('cholesterol',1,'1005671000000105',NULL,'Serum cholesterol level'),('cholesterol',1,'1017161000000104',NULL,'Plasma total cholesterol level'),('cholesterol',1,'1107731000000104',NULL,'Ratio of high density lipoprotein cholesterol to total cholesterol in plasma (observable entity)'),('cholesterol',1,'1107741000000108',NULL,'Ratio of high density lipoprotein cholesterol to total cholesterol in serum (observable entity)'),('cholesterol',1,'1028551000000102',NULL,'Total cholesterol:HDL (high density lipoprotein) ratio'),('cholesterol',1,'1029071000000109',NULL,'HDL/LDL ratio'),('cholesterol',1,'1083861000000102',NULL,'Serum HDL (high density lipoprotein) cholesterol/triglyceride ratio'),('cholesterol',1,'1083761000000106',NULL,'Serum fasting total cholesterol level (observable entity)'),('cholesterol',1,'1106541000000101',NULL,'Cholesterol molar concentration in serum'),('cholesterol',1,'1106531000000105',NULL,'Cholesterol molar concentration in plasma'),('cholesterol',1,'9422000',NULL,'Alpha-lipoprotein'),('cholesterol',1,'9556009',NULL,'Acyl CoA cholesterol acyltransferase'),
('cholesterol',1,'22244007',NULL,'LDL - Low density lipoprotein'),('cholesterol',1,'73427004',NULL,'Cholesterol ester'),('cholesterol',1,'88557001',NULL,'LCAT - Lecithin cholesterol acyltransferase'),('cholesterol',1,'102741009',NULL,'Free cholesterol'),('cholesterol',1,'115332003',NULL,'High density lipoprotein subfraction 2'),('cholesterol',1,'115333008',NULL,'High density lipoprotein subfraction 3'),('cholesterol',1,'416724002',NULL,'Cholesterol derivative'),('cholesterol',1,'707084003',NULL,'HDL cholesterol 2'),('cholesterol',1,'707086001',NULL,'HDL cholesterol 2a'),('cholesterol',1,'707091000',NULL,'IDL cholesterol 1'),('cholesterol',1,'707092007',NULL,'IDL cholesterol 2'),('cholesterol',1,'707093002',NULL,'LDL cholesterol pattern A'),('cholesterol',1,'707094008',NULL,'LDL cholesterol pattern BI'),('cholesterol',1,'707095009',NULL,'LDL cholesterol pattern BII'),('cholesterol',1,'707096005',NULL,'LDL cholesterol, acetylated'),('cholesterol',1,'707097001',NULL,'LDL cholesterol, narrow density'),('cholesterol',1,'707098006',NULL,'Cholesterol in lipoprotein a'),('cholesterol',1,'707099003',NULL,'VLDL cholesterol 3'),('cholesterol',1,'707100006',NULL,'VLDL cholesterol, acetylated'),('cholesterol',1,'707101005',NULL,'VLDL cholesterol, beta'),('cholesterol',1,'707124003',NULL,'HDL cholesterol 2b'),('cholesterol',1,'707125002',NULL,'HDL cholesterol 3'),('cholesterol',1,'707126001',NULL,'HDL cholesterol 3a'),('cholesterol',1,'707127005',NULL,'HDL cholesterol 3c'),('cholesterol',1,'707128000',NULL,'HDL cholesterol 3b'),('cholesterol',1,'712626002',NULL,'Cholesterol in chylomicrons'),('cholesterol',1,'13644009',NULL,'High cholesterol'),('cholesterol',1,'124055002',NULL,'Decreased cholesterol esters (finding)'),('cholesterol',1,'166828006',NULL,'Serum cholesterol normal (finding)'),('cholesterol',1,'166830008',NULL,'Serum cholesterol raised (finding)'),('cholesterol',1,'166831007',NULL,'Serum cholesterol very high (finding)'),('cholesterol',1,'365793008',NULL,'Finding of cholesterol level'),('cholesterol',1,'365794002',NULL,'Finding of serum cholesterol level'),('cholesterol',1,'370992007',NULL,'High blood cholesterol/triglycerides'),('cholesterol',1,'398036000',NULL,'Low density lipoprotein catabolic defect'),('cholesterol',1,'442234001',NULL,'Serum cholesterol borderline high (finding)'),('cholesterol',1,'442350007',NULL,'Serum cholesterol borderline low (finding)'),('cholesterol',1,'445445006',NULL,'Raised low density lipoprotein cholesterol'),('cholesterol',1,'67991000119104',NULL,'Serum cholesterol abnormal (finding)'),('cholesterol',1,'850981000000101',NULL,'Cholesterol level (observable entity)'),('cholesterol',1,'852401000000104',NULL,'Maximum cholesterol level (observable entity)'),('cholesterol',1,'852411000000102',NULL,'Minimum cholesterol level (observable entity)'),('cholesterol',1,'853681000000104',NULL,'Total cholesterol level (observable entity)'),('cholesterol',1,'404670008',NULL,'Hollenhorst plaque'),('cholesterol',1,'166854003',NULL,'Lipoprotein electrophoresis - High density lipoprotein (procedure)'),('cholesterol',1,'166855002',NULL,'Lipoprotein electrophoresis - Low density lipoprotein'),('cholesterol',1,'124054003',NULL,'Increased cholesterol esters (finding)'),('cholesterol',1,'439953004',NULL,'Elevated cholesterol/high density lipoprotein ratio'),('cholesterol',1,'102857004',NULL,'Urinary crystal, cholesterol (finding)'),('cholesterol',1,'939391000000100',NULL,'Serum high density lipoprotein cholesterol:triglyceride ratio'),('cholesterol',2,'1005671000000105',NULL,'Serum cholesterol level'),('cholesterol',2,'412808005',NULL,'Serum total cholesterol level'),('cholesterol',2,'121868005',NULL,'Total cholesterol measurement (procedure)'),('cholesterol',2,'994351000000103',NULL,'Serum total cholesterol level');
INSERT INTO #codessnomed
VALUES ('egfr',1,'1011481000000105',NULL,'eGFR (estimated glomerular filtration rate) using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'1011491000000107',NULL,'eGFR (estimated glomerular filtration rate) using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'1020291000000106',NULL,'GFR (glomerular filtration rate) calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'1107411000000104',NULL,'eGFR (estimated glomerular filtration rate) by laboratory calculation'),('egfr',1,'241373003',NULL,'Technetium-99m-diethylenetriamine pentaacetic acid clearance - glomerular filtration rate (procedure)'),('egfr',1,'262300005',NULL,'With glomerular filtration rate'),('egfr',1,'737105002',NULL,'GFR (glomerular filtration rate) calculation technique'),('egfr',1,'80274001',NULL,'Glomerular filtration rate (observable entity)'),('egfr',1,'996231000000108',NULL,'GFR (glomerular filtration rate) calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin');
INSERT INTO #codessnomed
VALUES ('hba1c',1,'1019431000000105',NULL,'HbA1c level (Diabetes Control and Complications Trial aligned)'),('hba1c',1,'1003671000000109',NULL,'Haemoglobin A1c level'),('hba1c',1,'1049301000000100',NULL,'HbA1c (haemoglobin A1c) level (diagnostic reference range) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'1049321000000109',NULL,'HbA1c (haemoglobin A1c) level (monitoring ranges) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'1107481000000106',NULL,'HbA1c (haemoglobin A1c) molar concentration in blood'),('hba1c',1,'999791000000106',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',1,'1010941000000103',NULL,'Haemoglobin A1c (monitoring ranges)'),('hba1c',1,'1010951000000100',NULL,'Haemoglobin A1c (diagnostic reference range)'),('hba1c',1,'165679005',NULL,'Haemoglobin A1c (HbA1c) less than 7% indicating good diabetic control'),('hba1c',1,'165680008',NULL,'Haemoglobin A1c (HbA1c) between 7%-10% indicating borderline diabetic control'),('hba1c',1,'165681007',NULL,'Hemoglobin A1c (HbA1c) greater than 10% indicating poor diabetic control'),('hba1c',1,'365845005',NULL,'Haemoglobin A1C - diabetic control finding'),('hba1c',1,'444751005',NULL,'High hemoglobin A1c level'),('hba1c',1,'43396009',NULL,'Hemoglobin A1c measurement (procedure)'),('hba1c',1,'313835008',NULL,'Hemoglobin A1c measurement aligned to the Diabetes Control and Complications Trial'),('hba1c',1,'371981000000106',NULL,'Hb A1c (Haemoglobin A1c) level - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'444257008',NULL,'Calculation of estimated average glucose based on haemoglobin A1c'),('hba1c',1,'269823000',NULL,'Haemoglobin A1C - diabetic control interpretation'),('hba1c',1,'443911005',NULL,'Ordinal level of hemoglobin A1c'),('hba1c',1,'733830002',NULL,'HbA1c - Glycated haemoglobin-A1c'),('hba1c',2,'1019431000000105',NULL,'HbA1c level (Diabetes Control and Complications Trial aligned)'),('hba1c',2,'999791000000106',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised');
INSERT INTO #codessnomed
VALUES ('hdl-cholesterol',1,'1005681000000107',NULL,'Serum high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1010581000000101',NULL,'Plasma high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1026461000000104',NULL,'Serum random high density lipoprotein cholesterol level (observable entity)');
INSERT INTO #codessnomed
VALUES ('ldl-cholesterol',1,'1010591000000104',NULL,'Plasma low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1014501000000104',NULL,'Calculated low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1022191000000100',NULL,'Serum low density lipoprotein cholesterol level (observable entity)');
INSERT INTO #codessnomed
VALUES ('sex-hormone-binding-globulin',1,'999661000000105',NULL,'Serum sex hormone binding globulin level (observable entity)');
INSERT INTO #codessnomed
VALUES ('testosterone',1,'270973006',NULL,'Serum testosterone measurement (procedure)'),('testosterone',1,'995571000000101',NULL,'Plasma testosterone level (observable entity)'),('testosterone',1,'997161000000108',NULL,'Serum testosterone level (observable entity)');
INSERT INTO #codessnomed
VALUES ('vitamin-d',1,'1007991000000105',NULL,'Serum total 25-hydroxy vitamin D level (observable entity)'),('vitamin-d',1,'1029801000000105',NULL,'Total 25-hydroxyvitamin D level (observable entity)'),('vitamin-d',1,'1031181000000107',NULL,'Serum vitamin D level (observable entity)'),('vitamin-d',1,'12199005',NULL,'Vitamin D, 25-hydroxy measurement (procedure)'),('vitamin-d',1,'270990000',NULL,'Serum vitamin D measurement (procedure)'),('vitamin-d',1,'83729008',NULL,'Vitamin D measurement (procedure)'),('vitamin-d',1,'996641000000102',NULL,'Combined total vitamin D2 and D3 level (observable entity)')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codessnomed;

IF OBJECT_ID('tempdb..#codesemis') IS NOT NULL DROP TABLE #codesemis;
CREATE TABLE #codesemis (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesemis
VALUES ('bmi',1,'EMISNQBM1',NULL,'BMI centile')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesemis;


IF OBJECT_ID('tempdb..#TempRefCodes') IS NOT NULL DROP TABLE #TempRefCodes;
CREATE TABLE #TempRefCodes (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, version INT NOT NULL, [description] VARCHAR(255));

-- Read v2 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcr.concept, dcr.[version], dcr.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesreadv2 dcr on dcr.code = rc.MainCode
WHERE CodingType='ReadCodeV2'
AND (dcr.term IS NULL OR dcr.term = rc.Term)
and PK_Reference_Coding_ID != -1;

-- CTV3 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcc.concept, dcc.[version], dcc.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesctv3 dcc on dcc.code = rc.MainCode
WHERE CodingType='CTV3'
and PK_Reference_Coding_ID != -1;

-- EMIS codes with a FK Reference Coding ID
INSERT INTO #TempRefCodes
SELECT FK_Reference_Coding_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID != -1;

IF OBJECT_ID('tempdb..#TempSNOMEDRefCodes') IS NOT NULL DROP TABLE #TempSNOMEDRefCodes;
CREATE TABLE #TempSNOMEDRefCodes (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [version] INT NOT NULL, [description] VARCHAR(255));

-- SNOMED codes
INSERT INTO #TempSNOMEDRefCodes
SELECT PK_Reference_SnomedCT_ID, dcs.concept, dcs.[version], dcs.[description]
FROM SharedCare.Reference_SnomedCT rs
INNER JOIN #codessnomed dcs on dcs.code = rs.ConceptID;

-- EMIS codes with a FK SNOMED ID but without a FK Reference Coding ID
INSERT INTO #TempSNOMEDRefCodes
SELECT FK_Reference_SnomedCT_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID = -1
AND FK_Reference_SnomedCT_ID != -1;

-- De-duped tables
IF OBJECT_ID('tempdb..#CodeSets') IS NOT NULL DROP TABLE #CodeSets;
CREATE TABLE #CodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#SnomedSets') IS NOT NULL DROP TABLE #SnomedSets;
CREATE TABLE #SnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedCodeSets') IS NOT NULL DROP TABLE #VersionedCodeSets;
CREATE TABLE #VersionedCodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedSnomedSets') IS NOT NULL DROP TABLE #VersionedSnomedSets;
CREATE TABLE #VersionedSnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

INSERT INTO #VersionedCodeSets
SELECT DISTINCT * FROM #TempRefCodes;

INSERT INTO #VersionedSnomedSets
SELECT DISTINCT * FROM #TempSNOMEDRefCodes;

INSERT INTO #CodeSets
SELECT FK_Reference_Coding_ID, c.concept, [description]
FROM #VersionedCodeSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedCodeSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

INSERT INTO #SnomedSets
SELECT FK_Reference_SnomedCT_ID, c.concept, [description]
FROM #VersionedSnomedSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedSnomedSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

-- >>> Following code sets injected: bmi v2/hba1c v2/cholesterol v2/ldl-cholesterol v1/hdl-cholesterol v1/vitamin-d v1/testosterone v1/sex-hormone-binding-globulin v1/egfr v1

-- First lets get all the measurements in one place to improve query speed later on
IF OBJECT_ID('tempdb..#biomarkerValues') IS NOT NULL DROP TABLE #biomarkerValues;
SELECT 
	FK_Patient_Link_ID,
	CAST(EventDate AS DATE) AS EventDate,
	FK_Reference_Coding_ID,
	FK_Reference_SnomedCT_ID,
	[Value]
INTO #biomarkerValues
FROM SharedCare.GP_Events
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets)
)
AND FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
AND EventDate >= @StartDate
AND UPPER([Value]) NOT LIKE '%[A-Z]%' -- Remove any value that contains text. The only valid character is "e" in scientific notation e.g. 2e17 - but none of these values will be in that range
AND [Value] IS NOT NULL
AND [Value] != '0'; -- In theory none of these markers should have a 0 value so this is a sensible default to exclude

-- Get all biomarker values for the cohort
IF OBJECT_ID('tempdb..#biomarkers') IS NOT NULL DROP TABLE #biomarkers;
CREATE TABLE #biomarkers (
	FK_Patient_Link_ID BIGINT,
	Label VARCHAR(32),
	EventDate DATE,
	[Value] NVARCHAR(128)
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'bmi' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'bmi' AND [Version] = 2)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'bmi' AND [Version] = 2))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'hba1c' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'hba1c' AND [Version] = 2)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'hba1c' AND [Version] = 2))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'cholesterol' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'cholesterol' AND [Version] = 2)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'cholesterol' AND [Version] = 2))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'ldl-cholesterol' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'ldl-cholesterol' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'ldl-cholesterol' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'hdl-cholesterol' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'hdl-cholesterol' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'hdl-cholesterol' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'vitamin-d' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'vitamin-d' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'vitamin-d' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'testosterone' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'testosterone' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'testosterone' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'sex-hormone-binding-globulin' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'sex-hormone-binding-globulin' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'sex-hormone-binding-globulin' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'egfr' AS Label, EventDate, [Value]
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'egfr' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'egfr' AND [Version] = 1))
);

-- Final output
SELECT NhsNo, Label, EventDate, [Value] FROM #biomarkers b
INNER JOIN #NhsNoToLinkId n on n.FK_Patient_Link_ID = b.FK_Patient_Link_ID
ORDER BY NhsNo, EventDate;