--┌────────────────┐
--│ Biomarker file │
--└────────────────┘

------------------------ RDE CHECK ---------------------
-- George Tilston  - 16 March 2022 - via pull request --
--------------------------------------------------------

-- Richard Williams - changes at 7th October 2022
-- PI requested:
--		- Removing the date restriction in order to get all possible trend data
--		-	Adding blood pressure and triglycerides

-- Richard Williams - changes at 2nd October 2024
-- PI requested: 
--	alanine-aminotransferase
--	alkaline-phosphatase
--	bilirubin
--	albumin
--	gamma-glutamyl-transferase
--	aspartate-aminotransferase

-- Cohort is patients included in the DARE study. The below queries produce the data
-- that is required for each patient. However, a filter needs to be applied to only
-- provide this data for patients in the DARE study. Adrian Heald will provide GraphNet
-- with a list of NHS numbers, then they will execute the below but filtered to the list
-- of NHS numbers.

-- We assume that a temporary table will exist as follows:
-- CREATE TABLE #DAREPatients (NhsNo NVARCHAR(30));

--Just want the output, not the messages
SET NOCOUNT ON;

--Create DARECohort Table
SELECT SUBSTRING(REPLACE(NHSNo, ' ', ''),1,3) + ' ' + SUBSTRING(REPLACE(NHSNo, ' ', ''),4,3) + ' ' + SUBSTRING(REPLACE(NHSNo, ' ', ''),7,4) 'NHSNo' INTO #DAREPatients FROM [dbo].[DARECohort]

-- Set the start date
--DECLARE @StartDate datetime;
--SET @StartDate = '2018-01-01';

-- Get link ids of patients
SELECT DISTINCT FK_Patient_Link_ID INTO #Patients
FROM SharedCare.Patient p
INNER JOIN #DAREPatients dp ON dp.NhsNo = p.NhsNo;

-- Get lookup between nhs number and fk_patient_link_id
SELECT DISTINCT p.NhsNo, p.FK_Patient_Link_ID INTO #NhsNoToLinkId
FROM SharedCare.Patient p
INNER JOIN #DAREPatients dp ON dp.NhsNo = p.NhsNo;

-- >>> Codesets required... Inserting the code set code
--
--┌────────────────────┐
--│ Clinical code sets │
--└────────────────────┘

-- OBJECTIVE: To populate temporary tables with the existing clinical code sets.
--            See the [SQL-generation-process.md](SQL-generation-process.md) for more details.

-- INPUT: No pre-requisites

-- OUTPUT: Five temp tables as follows:
--  #AllCodes (Concept, Version, Code)
--  #CodeSets (FK_Reference_Coding_ID, Concept)
--  #SnomedSets (FK_Reference_SnomedCT_ID, FK_SNOMED_ID)
--  #VersionedCodeSets (FK_Reference_Coding_ID, Concept, Version)
--  #VersionedSnomedSets (FK_Reference_SnomedCT_ID, Version, FK_SNOMED_ID)

--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
--!!! DO NOT EDIT THIS FILE MANUALLY !!!
--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

--#region Clinical code sets

IF OBJECT_ID('tempdb..#AllCodes') IS NOT NULL DROP TABLE #AllCodes;
CREATE TABLE #AllCodes (
  [Concept] [varchar](255) NOT NULL,
  [Version] INT NOT NULL,
  [Code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
  [description] [varchar] (255) NULL 
);

IF OBJECT_ID('tempdb..#codesreadv2') IS NOT NULL DROP TABLE #codesreadv2;
CREATE TABLE #codesreadv2 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesreadv2
VALUES ('bmi',2,'22K..',NULL,'Body Mass Index'),('bmi',2,'22K..00',NULL,'Body Mass Index'),('bmi',2,'22KB.',NULL,'Baseline body mass index'),('bmi',2,'22KB.00',NULL,'Baseline body mass index');
INSERT INTO #codesreadv2
VALUES ('alanine-aminotransferase',1,'44G3.',NULL,'ALT/SGPT serum level'),('alanine-aminotransferase',1,'44G3.00',NULL,'ALT/SGPT serum level'),('alanine-aminotransferase',1,'44GB.',NULL,'Serum alanine aminotransferase level'),('alanine-aminotransferase',1,'44GB.00',NULL,'Serum alanine aminotransferase level'),('alanine-aminotransferase',1,'44G..','11','ALT - blood level'),('alanine-aminotransferase',1,'44G..','11','ALT - blood level');
INSERT INTO #codesreadv2
VALUES ('albumin',1,'44M4.',NULL,'Serum albumin'),('albumin',1,'44M4.00',NULL,'Serum albumin');
INSERT INTO #codesreadv2
VALUES ('alkaline-phosphatase',1,'44F..',NULL,'Serum alkaline phosphatase'),('alkaline-phosphatase',1,'44F..00',NULL,'Serum alkaline phosphatase'),('alkaline-phosphatase',1,'44F3.',NULL,'Total alkaline phosphatase'),('alkaline-phosphatase',1,'44F3.00',NULL,'Total alkaline phosphatase'),('alkaline-phosphatase',1,'44FZ.',NULL,'Serum alkaline phosphatase NOS'),('alkaline-phosphatase',1,'44FZ.00',NULL,'Serum alkaline phosphatase NOS');
INSERT INTO #codesreadv2
VALUES ('aspartate-aminotransferase',1,'44HB.',NULL,'AST serum level'),('aspartate-aminotransferase',1,'44HB.00',NULL,'AST serum level'),('aspartate-aminotransferase',1,'44H5.',NULL,'AST - aspartate transam.(SGOT)'),('aspartate-aminotransferase',1,'44H5.00',NULL,'AST - aspartate transam.(SGOT)'),('aspartate-aminotransferase',1,'44HC.',NULL,'Plasma aspartate transaminase level'),('aspartate-aminotransferase',1,'44HC.00',NULL,'Plasma aspartate transaminase level');
INSERT INTO #codesreadv2
VALUES ('bilirubin',1,'Xa972',NULL,'Bilirubin level'),('bilirubin',1,'Xa97200',NULL,'Bilirubin level'),('bilirubin',1,'XaX4X',NULL,'Conjugated bilirubin level'),('bilirubin',1,'XaX4X00',NULL,'Conjugated bilirubin level'),('bilirubin',1,'XaERv',NULL,'Plasma conjugated bilirubin level'),('bilirubin',1,'XaERv00',NULL,'Plasma conjugated bilirubin level'),('bilirubin',1,'XaESA',NULL,'Serum conjugated bilirubin level'),('bilirubin',1,'XaESA00',NULL,'Serum conjugated bilirubin level'),('bilirubin',1,'44E5.',NULL,'Indirect (unconj.) bilirubin'),('bilirubin',1,'44E5.00',NULL,'Indirect (unconj.) bilirubin'),('bilirubin',1,'XaERw',NULL,'Serum unconjugated bilirubin level'),('bilirubin',1,'XaERw00',NULL,'Serum unconjugated bilirubin level'),('bilirubin',1,'XaES7',NULL,'Plasma unconjugated bilirubin level'),('bilirubin',1,'XaES700',NULL,'Plasma unconjugated bilirubin level'),('bilirubin',1,'44E..',NULL,'Serum bilirubin level'),('bilirubin',1,'44E..00',NULL,'Serum bilirubin level'),('bilirubin',1,'44E4.',NULL,'Direct (conjugated) bilirubin'),('bilirubin',1,'44E4.00',NULL,'Direct (conjugated) bilirubin'),('bilirubin',1,'XaERu',NULL,'Serum total bilirubin level'),('bilirubin',1,'XaERu00',NULL,'Serum total bilirubin level'),('bilirubin',1,'44E8.',NULL,'Plasma conjugated bilirubin level'),('bilirubin',1,'44E8.00',NULL,'Plasma conjugated bilirubin level'),('bilirubin',1,'44EA.',NULL,'Plasma unconjugated bilirubin level'),('bilirubin',1,'44EA.00',NULL,'Plasma unconjugated bilirubin level'),('bilirubin',1,'44EB.',NULL,'Serum conjugated bilirubin level'),('bilirubin',1,'44EB.00',NULL,'Serum conjugated bilirubin level'),('bilirubin',1,'44EC.',NULL,'Serum total bilirubin level'),('bilirubin',1,'44EC.00',NULL,'Serum total bilirubin level'),('bilirubin',1,'44ED.',NULL,'Serum unconjugated bilirubin level'),('bilirubin',1,'44ED.00',NULL,'Serum unconjugated bilirubin level'),('bilirubin',1,'4QCE.',NULL,'Bilirubin level'),('bilirubin',1,'4QCE.00',NULL,'Bilirubin level'),('bilirubin',1,'4QCE1',NULL,'Conjugated bilirubin level'),('bilirubin',1,'4QCE100',NULL,'Conjugated bilirubin level');
INSERT INTO #codesreadv2
VALUES ('cholesterol',2,'44P..',NULL,'Serum cholesterol'),('cholesterol',2,'44P..00',NULL,'Serum cholesterol'),('cholesterol',2,'44PZ.',NULL,'Serum cholesterol NOS'),('cholesterol',2,'44PZ.00',NULL,'Serum cholesterol NOS'),('cholesterol',2,'44PJ.',NULL,'Serum total cholesterol level'),('cholesterol',2,'44PJ.00',NULL,'Serum total cholesterol level'),('cholesterol',2,'44PH.',NULL,'Total cholesterol measurement'),('cholesterol',2,'44PH.00',NULL,'Total cholesterol measurement'),('cholesterol',2,'44OE.',NULL,'Plasma total cholesterol level'),('cholesterol',2,'44OE.00',NULL,'Plasma total cholesterol level'),('cholesterol',2,'44PK.',NULL,'Serum fasting total cholesterol'),('cholesterol',2,'44PK.00',NULL,'Serum fasting total cholesterol');
INSERT INTO #codesreadv2
VALUES ('diastolic-blood-pressure',1,'246o1',NULL,'Non-invasive central diastolic blood pressure'),('diastolic-blood-pressure',1,'246o100',NULL,'Non-invasive central diastolic blood pressure'),('diastolic-blood-pressure',1,'246n0',NULL,'Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'246n000',NULL,'Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'246m.',NULL,'Average diastolic blood pressure'),('diastolic-blood-pressure',1,'246m.00',NULL,'Average diastolic blood pressure'),('diastolic-blood-pressure',1,'246f.',NULL,'Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'246f.00',NULL,'Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'246c.',NULL,'Average home diastolic blood pressure'),('diastolic-blood-pressure',1,'246c.00',NULL,'Average home diastolic blood pressure'),('diastolic-blood-pressure',1,'246a.',NULL,'Average night interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246a.00',NULL,'Average night interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246X.',NULL,'Average day interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246X.00',NULL,'Average day interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246V.',NULL,'Average 24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'246V.00',NULL,'Average 24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'246T.',NULL,'Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'246T.00',NULL,'Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'246R.',NULL,'Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'246R.00',NULL,'Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'246P.',NULL,'Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'246P.00',NULL,'Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'246A.',NULL,'O/E - Diastolic BP reading'),('diastolic-blood-pressure',1,'246A.00',NULL,'O/E - Diastolic BP reading');
INSERT INTO #codesreadv2
VALUES ('egfr',1,'451E.',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'451E.00',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'451G.',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'451G.00',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'451K.',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'451K.00',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'451M.',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451M.00',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451N.',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451N.00',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451F.',NULL,'Glomerular filtration rate'),('egfr',1,'451F.00',NULL,'Glomerular filtration rate');
INSERT INTO #codesreadv2
VALUES ('gamma-glutamyl-transferase',1,'44G7.',NULL,'Plasma gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'44G7.00',NULL,'Plasma gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'44G9.',NULL,'Serum gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'44G9.00',NULL,'Serum gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'44G4.',NULL,'Gamma - G.T. level'),('gamma-glutamyl-transferase',1,'44G4.00',NULL,'Gamma - G.T. level');
INSERT INTO #codesreadv2
VALUES ('hba1c',2,'42W5.',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W5.00',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W4.',NULL,'HbA1c level (DCCT aligned)'),('hba1c',2,'42W4.00',NULL,'HbA1c level (DCCT aligned)');
INSERT INTO #codesreadv2
VALUES ('hdl-cholesterol',1,'44PC.',NULL,'Serum random HDL cholesterol level'),('hdl-cholesterol',1,'44PC.00',NULL,'Serum random HDL cholesterol level'),('hdl-cholesterol',1,'44P5.',NULL,'Serum HDL cholesterol level'),('hdl-cholesterol',1,'44P5.00',NULL,'Serum HDL cholesterol level'),('hdl-cholesterol',1,'44dA.',NULL,'Plasma HDL cholesterol level'),('hdl-cholesterol',1,'44dA.00',NULL,'Plasma HDL cholesterol level'),('hdl-cholesterol',1,'44d2.',NULL,'Plasma random HDL cholesterol level'),('hdl-cholesterol',1,'44d2.00',NULL,'Plasma random HDL cholesterol level'),('hdl-cholesterol',1,'44d3.',NULL,'Plasma fasting HDL cholesterol level'),('hdl-cholesterol',1,'44d3.00',NULL,'Plasma fasting HDL cholesterol level'),('hdl-cholesterol',1,'44PB.',NULL,'Serum fasting HDL cholesterol level'),('hdl-cholesterol',1,'44PB.00',NULL,'Serum fasting HDL cholesterol level');
INSERT INTO #codesreadv2
VALUES ('ldl-cholesterol',1,'44PI.',NULL,'Calculated LDL cholesterol level'),('ldl-cholesterol',1,'44PI.00',NULL,'Calculated LDL cholesterol level'),('ldl-cholesterol',1,'44P6.',NULL,'Serum LDL cholesterol level'),('ldl-cholesterol',1,'44P6.00',NULL,'Serum LDL cholesterol level'),('ldl-cholesterol',1,'44dB.',NULL,'Plasma LDL cholesterol level'),('ldl-cholesterol',1,'44dB.00',NULL,'Plasma LDL cholesterol level'),('ldl-cholesterol',1,'44d4.',NULL,'Plasma random LDL cholesterol level'),('ldl-cholesterol',1,'44d4.00',NULL,'Plasma random LDL cholesterol level'),('ldl-cholesterol',1,'44d5.',NULL,'Plasma fasting LDL cholesterol level'),('ldl-cholesterol',1,'44d5.00',NULL,'Plasma fasting LDL cholesterol level'),('ldl-cholesterol',1,'44PD.',NULL,'Serum fasting LDL cholesterol level'),('ldl-cholesterol',1,'44PD.00',NULL,'Serum fasting LDL cholesterol level'),('ldl-cholesterol',1,'44PE.',NULL,'Serum random LDL cholesterol level'),('ldl-cholesterol',1,'44PE.00',NULL,'Serum random LDL cholesterol level');
INSERT INTO #codesreadv2
VALUES ('sex-hormone-binding-globulin',1,'44CD.',NULL,'Serum sex hormone binding globulin level'),('sex-hormone-binding-globulin',1,'44CD.00',NULL,'Serum sex hormone binding globulin level');
INSERT INTO #codesreadv2
VALUES ('systolic-blood-pressure',1,'246o0',NULL,'Non-invasive central systolic blood pressure'),('systolic-blood-pressure',1,'246o000',NULL,'Non-invasive central systolic blood pressure'),('systolic-blood-pressure',1,'246n1',NULL,'Baseline systolic blood pressure'),('systolic-blood-pressure',1,'246n100',NULL,'Baseline systolic blood pressure'),('systolic-blood-pressure',1,'246l.',NULL,'Average systolic blood pressure'),('systolic-blood-pressure',1,'246l.00',NULL,'Average systolic blood pressure'),('systolic-blood-pressure',1,'246e.',NULL,'Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'246e.00',NULL,'Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'246d.',NULL,'Average home systolic blood pressure'),('systolic-blood-pressure',1,'246d.00',NULL,'Average home systolic blood pressure'),('systolic-blood-pressure',1,'246b.',NULL,'Average night interval systolic blood pressure'),('systolic-blood-pressure',1,'246b.00',NULL,'Average night interval systolic blood pressure'),('systolic-blood-pressure',1,'246Y.',NULL,'Average day interval systolic blood pressure'),('systolic-blood-pressure',1,'246Y.00',NULL,'Average day interval systolic blood pressure'),('systolic-blood-pressure',1,'246W.',NULL,'Average 24 hour systolic blood pressure'),('systolic-blood-pressure',1,'246W.00',NULL,'Average 24 hour systolic blood pressure'),('systolic-blood-pressure',1,'246S.',NULL,'Lying systolic blood pressure'),('systolic-blood-pressure',1,'246S.00',NULL,'Lying systolic blood pressure'),('systolic-blood-pressure',1,'246Q.',NULL,'Sitting systolic blood pressure'),('systolic-blood-pressure',1,'246Q.00',NULL,'Sitting systolic blood pressure'),('systolic-blood-pressure',1,'246N.',NULL,'Standing systolic blood pressure'),('systolic-blood-pressure',1,'246N.00',NULL,'Standing systolic blood pressure'),('systolic-blood-pressure',1,'2469.',NULL,'O/E - Systolic BP reading'),('systolic-blood-pressure',1,'2469.00',NULL,'O/E - Systolic BP reading');
INSERT INTO #codesreadv2
VALUES ('testosterone',1,'4473.',NULL,'Serum testosterone'),('testosterone',1,'4473.00',NULL,'Serum testosterone'),('testosterone',1,'447G.',NULL,'Plasma testosterone level'),('testosterone',1,'447G.00',NULL,'Plasma testosterone level');
INSERT INTO #codesreadv2
VALUES ('triglycerides',1,'44Q..',NULL,'Serum triglycerides'),('triglycerides',1,'44Q..00',NULL,'Serum triglycerides'),('triglycerides',1,'44Q4.',NULL,'Serum fasting triglyceride level'),('triglycerides',1,'44Q4.00',NULL,'Serum fasting triglyceride level'),('triglycerides',1,'44Q5.',NULL,'Serum random triglyceride level'),('triglycerides',1,'44Q5.00',NULL,'Serum random triglyceride level'),('triglycerides',1,'44QZ.',NULL,'Serum triglycerides NOS'),('triglycerides',1,'44QZ.00',NULL,'Serum triglycerides NOS'),('triglycerides',1,'44e..',NULL,'Plasma triglyceride level'),('triglycerides',1,'44e..00',NULL,'Plasma triglyceride level'),('triglycerides',1,'44e0.',NULL,'Plasma random triglyceride level'),('triglycerides',1,'44e0.00',NULL,'Plasma random triglyceride level'),('triglycerides',1,'44e1.',NULL,'Plasma fasting triglyceride level'),('triglycerides',1,'44e1.00',NULL,'Plasma fasting triglyceride level'),('triglycerides',1,'4QA1.',NULL,'Triglyceride level'),('triglycerides',1,'4QA1.00',NULL,'Triglyceride level');
INSERT INTO #codesreadv2
VALUES ('urinary-albumin-creatinine-ratio',1,'46TC.',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TC.00',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'44J7.',NULL,'Albumin / creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'44J7.00',NULL,'Albumin / creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TD.',NULL,'Urine microalbumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TD.00',NULL,'Urine microalbumin:creatinine ratio');
INSERT INTO #codesreadv2
VALUES ('vitamin-d',1,'4QB4.',NULL,'Vitamin D level'),('vitamin-d',1,'4QB4.00',NULL,'Vitamin D level'),('vitamin-d',1,'44LA.',NULL,'Serum vitamin D'),('vitamin-d',1,'44LA.00',NULL,'Serum vitamin D'),('vitamin-d',1,'4QB44',NULL,'Combined total vitamin D2 and D3 level'),('vitamin-d',1,'4QB4400',NULL,'Combined total vitamin D2 and D3 level'),('vitamin-d',1,'4QB45',NULL,'25-Hydroxyvitamin D level'),('vitamin-d',1,'4QB4500',NULL,'25-Hydroxyvitamin D level'),('vitamin-d',1,'4QB46',NULL,'Total 25-hydroxyvitamin D level'),('vitamin-d',1,'4QB4600',NULL,'Total 25-hydroxyvitamin D level'),('vitamin-d',1,'4QB47',NULL,'Serum total 25-hydroxy vitamin D level'),('vitamin-d',1,'4QB4700',NULL,'Serum total 25-hydroxy vitamin D level')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesreadv2;

IF OBJECT_ID('tempdb..#codesctv3') IS NOT NULL DROP TABLE #codesctv3;
CREATE TABLE #codesctv3 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesctv3
VALUES ('bmi',2,'22K..',NULL,'Body Mass Index'),('bmi',2,'X76CO',NULL,'Quetelet index'),('bmi',2,'Xa7wG',NULL,'Observation of body mass index'),('bmi',2,'XaZcl',NULL,'Baseline body mass index');
INSERT INTO #codesctv3
VALUES ('alanine-aminotransferase',1,'44G3.',NULL,'ALT/SGPT serum level'),('alanine-aminotransferase',1,'44G..',NULL,'Liver enzymes (& blood level [ALT] or [SGPT])'),('alanine-aminotransferase',1,'XaLJx',NULL,'Serum alanine aminotransferase level'),('alanine-aminotransferase',1,'X771f',NULL,'ALT - blood level'),('alanine-aminotransferase',1,'X771e',NULL,'SGPT - blood level'),('alanine-aminotransferase',1,'X771d',NULL,'Alanine transaminase level'),('alanine-aminotransferase',1,'XE25P',NULL,'Liver enzyme levels');
INSERT INTO #codesctv3
VALUES ('albumin',1,'XE2eA',NULL,'Serum albumin'),('albumin',1,'XE2eA',NULL,'Serum albumin level'),('albumin',1,'44M4.',NULL,'Serum albumin');
INSERT INTO #codesctv3
VALUES ('alkaline-phosphatase',1,'XE2px',NULL,'Serum alkaline phosphatase'),('alkaline-phosphatase',1,'XE2px',NULL,'Serum alkaline phosphatase level'),('alkaline-phosphatase',1,'44F3.',NULL,'Alkaline phosphatase level'),('alkaline-phosphatase',1,'44FZ.',NULL,'Serum alkaline phosphatase NOS'),('alkaline-phosphatase',1,'44F..',NULL,'Serum alkaline phosphatase');
INSERT INTO #codesctv3
VALUES ('aspartate-aminotransferase',1,'X771i',NULL,'AST serum level'),('aspartate-aminotransferase',1,'XaES6',NULL,'Plasma aspartate transaminase level'),('aspartate-aminotransferase',1,'XE25Q',NULL,'Aspartate transaminase level');
INSERT INTO #codesctv3
VALUES ('bilirubin',1,'Xa972',NULL,'Bilirubin level'),('bilirubin',1,'XaX4X',NULL,'Conjugated bilirubin level'),('bilirubin',1,'XaERv',NULL,'Plasma conjugated bilirubin level'),('bilirubin',1,'XaESA',NULL,'Serum conjugated bilirubin level'),('bilirubin',1,'44E5.',NULL,'Unconjugated bilirubin level'),('bilirubin',1,'XaERw',NULL,'Serum unconjugated bilirubin level'),('bilirubin',1,'XaES7',NULL,'Plasma unconjugated bilirubin level'),('bilirubin',1,'44E..',NULL,'Serum bilirubin level'),('bilirubin',1,'44E4.',NULL,'Conjugated bilirubin level'),('bilirubin',1,'XaERu',NULL,'Serum total bilirubin level');
INSERT INTO #codesctv3
VALUES ('cholesterol',2,'XSK14',NULL,'Total cholesterol measurement'),('cholesterol',2,'44PH.',NULL,'Total cholesterol measurement'),('cholesterol',2,'44PJ.',NULL,'Serum total cholesterol level'),('cholesterol',2,'44P..',NULL,'Serum cholesterol'),('cholesterol',2,'44PZ.',NULL,'Serum cholesterol NOS'),('cholesterol',2,'XE2eD',NULL,'Serum cholesterol'),('cholesterol',2,'XaJe9',NULL,'Serum total cholesterol level'),('cholesterol',2,'X772L',NULL,'Cholesterol level'),('cholesterol',2,'XaFs9',NULL,'Fasting cholesterol level'),('cholesterol',2,'XaIRd',NULL,'Plasma total cholesterol level'),('cholesterol',2,'XaLux',NULL,'Serum fasting total cholesterol');
INSERT INTO #codesctv3
VALUES ('diastolic-blood-pressure',1,'X779S',NULL,'DAP-Diastolic arterial pressur'),('diastolic-blood-pressure',1,'X779T',NULL,'DAP-Diastolic arterial pressur'),('diastolic-blood-pressure',1,'Xac5K',NULL,'Baseline diastolic BP'),('diastolic-blood-pressure',1,'Xaedp',NULL,'Non-invasive centrl diastlc BP'),('diastolic-blood-pressure',1,'XaF4a',NULL,'Ave day diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4b',NULL,'Ave 24h diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4e',NULL,'24h diastolic blood pressure'),('diastolic-blood-pressure',1,'XaF4Q',NULL,'Min diastolic blood pressure'),('diastolic-blood-pressure',1,'XaF4R',NULL,'Max diastolic blood pressure'),('diastolic-blood-pressure',1,'XaF4S',NULL,'Ave diastolic blood pressure'),('diastolic-blood-pressure',1,'XaF4T',NULL,'Min day diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4U',NULL,'Min night diast blood pressure'),('diastolic-blood-pressure',1,'XaF4V',NULL,'Min 24h diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4W',NULL,'Max night diast blood pressure'),('diastolic-blood-pressure',1,'XaF4X',NULL,'Max day diast blood pressure'),('diastolic-blood-pressure',1,'XaF4Y',NULL,'Max 24h diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4Z',NULL,'Ave night diast blood pressure'),('diastolic-blood-pressure',1,'XaIwk',NULL,'Standing diastolic BP'),('diastolic-blood-pressure',1,'XaJ2F',NULL,'Sitting diastolic BP'),('diastolic-blood-pressure',1,'XaJ2H',NULL,'Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'XaKFw',NULL,'Average home diastolic BP'),('diastolic-blood-pressure',1,'XaKjG',NULL,'Ambulatory diastolic BP'),('diastolic-blood-pressure',1,'XM02Y',NULL,'DAP-Diastolic arterial pressur'),('diastolic-blood-pressure',1,'246o1',NULL,'Non-invasive central diastolic blood pressure'),('diastolic-blood-pressure',1,'246n0',NULL,'Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'246m.',NULL,'Average diastolic blood pressure'),('diastolic-blood-pressure',1,'246f.',NULL,'Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'246c.',NULL,'Average home diastolic blood pressure'),('diastolic-blood-pressure',1,'246a.',NULL,'Average night interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246X.',NULL,'Average day interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246V.',NULL,'Average 24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'246T.',NULL,'Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'246R.',NULL,'Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'246P.',NULL,'Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'246A.',NULL,'O/E - Diastolic BP reading');
INSERT INTO #codesctv3
VALUES ('egfr',1,'X70kK',NULL,'Tc99m-DTPA clearance - GFR'),('egfr',1,'X70kL',NULL,'Cr51- EDTA clearance - GFR'),('egfr',1,'X90kf',NULL,'With GFR'),('egfr',1,'XaK8y',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'XaMDA',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'XaZpN',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'XacUJ',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'XacUK',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'XSFyN',NULL,'Glomerular filtration rate');
INSERT INTO #codesctv3
VALUES ('gamma-glutamyl-transferase',1,'44G4.',NULL,'Gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'XaES3',NULL,'Serum gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'XaES4',NULL,'Plasma gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'X80E1',NULL,'Gamma-glutamyl transferase'),('gamma-glutamyl-transferase',1,'XE28U',NULL,'Gammaglutamyl transferase (& level)');
INSERT INTO #codesctv3
VALUES ('hba1c',2,'XaERp',NULL,'HbA1c level (DCCT aligned)'),('hba1c',2,'XaPbt',NULL,'HbA1c levl - IFCC standardised'),('hba1c',2,'42W5.',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W4.',NULL,'HbA1c level (DCCT aligned)');
INSERT INTO #codesctv3
VALUES ('hdl-cholesterol',1,'44P5.',NULL,'Serum HDL cholesterol level'),('hdl-cholesterol',1,'44PC.',NULL,'Ser random HDL cholesterol lev'),('hdl-cholesterol',1,'XaEVr',NULL,'Plasma HDL cholesterol level'),('hdl-cholesterol',1,'44d2.',NULL,'Plasma random HDL cholesterol level'),('hdl-cholesterol',1,'44d3.',NULL,'Plasma fasting HDL cholesterol level'),('hdl-cholesterol',1,'44PB.',NULL,'Serum fasting HDL cholesterol level');
INSERT INTO #codesctv3
VALUES ('ldl-cholesterol',1,'44P6.',NULL,'Serum LDL cholesterol level'),('ldl-cholesterol',1,'XaIp4',NULL,'Calculated LDL cholesterol lev'),('ldl-cholesterol',1,'XaEVs',NULL,'Plasma LDL cholesterol level'),('ldl-cholesterol',1,'44d4.',NULL,'Plasma random LDL cholesterol levell'),('ldl-cholesterol',1,'44d5.',NULL,'Plasma fasting LDL cholesterol level'),('ldl-cholesterol',1,'44PD.',NULL,'Serum fasting LDL cholesterol level'),('ldl-cholesterol',1,'44PE.',NULL,'Serum random LDL cholesterol level');
INSERT INTO #codesctv3
VALUES ('sex-hormone-binding-globulin',1,'44CD.',NULL,'Serum sex hormone binding globulin level');
INSERT INTO #codesctv3
VALUES ('systolic-blood-pressure',1,'X779Q',NULL,'Non-invasive systol art press'),('systolic-blood-pressure',1,'X779R',NULL,'Invasive systol arterial press'),('systolic-blood-pressure',1,'Xac5L',NULL,'Baseline systolic BP'),('systolic-blood-pressure',1,'Xaedo',NULL,'Non-invasive central systlc BP'),('systolic-blood-pressure',1,'XaF4d',NULL,'24h systolic blood pressure'),('systolic-blood-pressure',1,'XaF4D',NULL,'Min systolic blood pressure'),('systolic-blood-pressure',1,'XaF4E',NULL,'Max systolic blood pressure'),('systolic-blood-pressure',1,'XaF4F',NULL,'Ave systolic blood pressure'),('systolic-blood-pressure',1,'XaF4G',NULL,'Min day systol blood pressure'),('systolic-blood-pressure',1,'XaF4H',NULL,'Min night syst blood pressure'),('systolic-blood-pressure',1,'XaF4I',NULL,'Max night syst blood pressure'),('systolic-blood-pressure',1,'XaF4J',NULL,'Max day syst blood pressure'),('systolic-blood-pressure',1,'XaF4K',NULL,'Ave night syst blood pressure'),('systolic-blood-pressure',1,'XaF4L',NULL,'Ave day systol blood pressure'),('systolic-blood-pressure',1,'XaF4M',NULL,'Min 24h systol blood pressure'),('systolic-blood-pressure',1,'XaF4N',NULL,'Max 24h systol blood pressure'),('systolic-blood-pressure',1,'XaF4O',NULL,'Ave 24h systol blood pressure'),('systolic-blood-pressure',1,'XaIwj',NULL,'Standing systolic BP'),('systolic-blood-pressure',1,'XaJ2E',NULL,'Sitting systolic BP'),('systolic-blood-pressure',1,'XaJ2G',NULL,'Lying systolic blood pressure'),('systolic-blood-pressure',1,'XaKFx',NULL,'Average home systolic BP'),('systolic-blood-pressure',1,'XaKjF',NULL,'Ambulatory systolic BP'),('systolic-blood-pressure',1,'XM02X',NULL,'SAP - Systol arterial pressure'),('systolic-blood-pressure',1,'246o0',NULL,'Non-invasive central systolic blood pressure'),('systolic-blood-pressure',1,'246n1',NULL,'Baseline systolic blood pressure'),('systolic-blood-pressure',1,'246l.',NULL,'Average systolic blood pressure'),('systolic-blood-pressure',1,'246e.',NULL,'Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'246d.',NULL,'Average home systolic blood pressure'),('systolic-blood-pressure',1,'246b.',NULL,'Average night interval systolic blood pressure'),('systolic-blood-pressure',1,'246Y.',NULL,'Average day interval systolic blood pressure'),('systolic-blood-pressure',1,'246W.',NULL,'Average 24 hour systolic blood pressure'),('systolic-blood-pressure',1,'246S.',NULL,'Lying systolic blood pressure'),('systolic-blood-pressure',1,'246Q.',NULL,'Sitting systolic blood pressure'),('systolic-blood-pressure',1,'246N.',NULL,'Standing systolic blood pressure'),('systolic-blood-pressure',1,'2469.',NULL,'O/E - Systolic BP reading');
INSERT INTO #codesctv3
VALUES ('testosterone',1,'XE2dr',NULL,'Serum testosterone level'),('testosterone',1,'4473.',NULL,'Serum testosterone'),('testosterone',1,'XaItQ',NULL,'Plasma testosterone level');
INSERT INTO #codesctv3
VALUES ('triglycerides',1,'XE2q9',NULL,'Serum triglycerides'),('triglycerides',1,'XE2q9',NULL,'Serum triglyceride levels'),('triglycerides',1,'44Q4.',NULL,'Serum fasting triglyceride level'),('triglycerides',1,'44QZ.',NULL,'Serum triglycerides NOS'),('triglycerides',1,'44e..',NULL,'Plasma triglyceride level'),('triglycerides',1,'44e0.',NULL,'Plasma random triglyceride level'),('triglycerides',1,'44e1.',NULL,'Plasma fasting triglyceride level'),('triglycerides',1,'44Q..',NULL,'Serum triglycerides'),('triglycerides',1,'44Q5.',NULL,'Serum random triglyceride level'),('triglycerides',1,'X772O',NULL,'Triglyceride level');
INSERT INTO #codesctv3
VALUES ('urinary-albumin-creatinine-ratio',1,'46TC.',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'XE2n3',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TD.',NULL,'Urine microalbumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'X773Y',NULL,'Albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'XE2n4',NULL,'Urine microalbumin/creatinine ratio');
INSERT INTO #codesctv3
VALUES ('vitamin-d',1,'44LA.',NULL,'Serum vitamin D'),('vitamin-d',1,'Xabo0',NULL,'Serum total 25-OH vit D level'),('vitamin-d',1,'XaY6m',NULL,'Total 25-hydroxyvitamin D levl'),('vitamin-d',1,'XE2e7',NULL,'Serum vitamin D level'),('vitamin-d',1,'XaXhN',NULL,'Vitamin D level'),('vitamin-d',1,'XaXhT',NULL,'Combined total vit D2 + D3 lvl'),('vitamin-d',1,'XaXm0',NULL,'25-Hydroxyvitamin D level')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesctv3;

IF OBJECT_ID('tempdb..#codessnomed') IS NOT NULL DROP TABLE #codessnomed;
CREATE TABLE #codessnomed (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codessnomed
VALUES ('bmi',2,'301331008',NULL,'Finding of body mass index (finding)'),('bmi',2,'60621009',NULL,'Body mass index (observable entity)'),('bmi',2,'846931000000101',NULL,'Baseline body mass index (observable entity)');
INSERT INTO #codessnomed
VALUES ('alanine-aminotransferase',1,'364571000119101',NULL,'Alanine transaminase in serum'),('alanine-aminotransferase',1,'1018251000000107',NULL,'Serum alanine aminotransferase level'),('alanine-aminotransferase',1,'166641008',NULL,'Liver enzymes (& blood level [ALT] or [SGPT])'),('alanine-aminotransferase',1,'250637003',NULL,'ALT - blood measurement (procedure)'),('alanine-aminotransferase',1,'34608000',NULL,'Alanine aminotransferase measurement (procedure)'),('alanine-aminotransferase',1,'365769003',NULL,'Finding of liver enzyme levels (finding)');
INSERT INTO #codessnomed
VALUES ('albumin',1,'1000821000000103',NULL,'Serum albumin level (observable entity)');
INSERT INTO #codessnomed
VALUES ('alkaline-phosphatase',1,'1000621000000104',NULL,'Serum alkaline phosphatase level (observable entity)'),('alkaline-phosphatase',1,'997611000000101',NULL,'Total alkaline phosphatase level (observable entity)'),('alkaline-phosphatase',1,'271234008',NULL,'Serum alkaline phosphatase measurement (procedure)');
INSERT INTO #codessnomed
VALUES ('aspartate-aminotransferase',1,'1031101000000102',NULL,'Aspartate aminotransferase level (observable entity)'),('aspartate-aminotransferase',1,'1000881000000102',NULL,'Serum aspartate aminotransferase level (observable entity)'),('aspartate-aminotransferase',1,'1106071000000102',NULL,'Enzyme activity of aspartate aminotransferase in serum (observable entity)'),('aspartate-aminotransferase',1,'1000891000000100',NULL,'Plasma aspartate transaminase level (observable entity)'),('aspartate-aminotransferase',1,'1106681000000105',NULL,'Enzyme activity of aspartate aminotransferase in plasma (observable entity)');
INSERT INTO #codessnomed
VALUES ('bilirubin',1,'999691000000104',NULL,'Serum bilirubin level (observable entity)'),('bilirubin',1,'997591000000109',NULL,'Serum total bilirubin level (observable entity)'),('bilirubin',1,'1107221000000109',NULL,'Substance concentration of total bilirubin in serum (observable entity)'),('bilirubin',1,'997581000000107',NULL,'Serum conjugated bilirubin level (observable entity)'),('bilirubin',1,'1106561000000100',NULL,'Substance concentration of conjugated bilirubin in serum (observable entity)'),('bilirubin',1,'1107221000000109',NULL,'Substance concentration of total bilirubin in serum (observable entity)'),('bilirubin',1,'997601000000103',NULL,'Serum unconjugated bilirubin level (observable entity)'),('bilirubin',1,'121000237103',NULL,'Substance concentration of unconjugated bilirubin in serum (observable entity)'),('bilirubin',1,'68711000237101',NULL,'Substance concentration of unconjugated bilirubin (calculated) in serum (observable entity)'),('bilirubin',1,'1003351000000105',NULL,'Conjugated bilirubin level (observable entity)'),('bilirubin',1,'1027461000000102',NULL,'Unconjugated bilirubin level (observable entity)'),('bilirubin',1,'1028081000000104',NULL,'Direct (conjugated) bilirubin (observable entity)'),('bilirubin',1,'365786009',NULL,'Finding of bilirubin level (finding)'),('bilirubin',1,'997551000000101',NULL,'Plasma conjugated bilirubin level (observable entity)'),('bilirubin',1,'997571000000105',NULL,'Plasma unconjugated bilirubin level (observable entity)'),('bilirubin',1,'39748002',NULL,'Bilirubin, direct measurement (procedure)');
INSERT INTO #codessnomed
VALUES ('cholesterol',2,'1005671000000105',NULL,'Serum cholesterol level'),('cholesterol',2,'412808005',NULL,'Serum total cholesterol level'),('cholesterol',2,'121868005',NULL,'Total cholesterol measurement (procedure)'),('cholesterol',2,'994351000000103',NULL,'Serum total cholesterol level'),('cholesterol',2,'1106531000000105',NULL,'Substance concentration of cholesterol in plasma (observable entity)'),('cholesterol',2,'853681000000104',NULL,'Total cholesterol level (observable entity)'),('cholesterol',2,'850981000000101',NULL,'Cholesterol level (observable entity)'),('cholesterol',2,'1017161000000104',NULL,'Plasma total cholesterol level (observable entity)'),('cholesterol',2,'1106541000000101',NULL,'Substance concentration of cholesterol in serum (observable entity)'),('cholesterol',2,'1083761000000106',NULL,'Serum fasting total cholesterol level (observable entity)'),('cholesterol',2,'315017003',NULL,'Fasting cholesterol level (procedure)'),('cholesterol',2,'247801000000106',NULL,'Serum fasting total cholesterol (procedure)');
INSERT INTO #codessnomed
VALUES ('diastolic-blood-pressure',1,'174255007',NULL,'Non-invasive diastolic blood pressure'),('diastolic-blood-pressure',1,'251073000',NULL,'Invasive diastolic blood pressure'),('diastolic-blood-pressure',1,'271650006',NULL,'Diastolic arterial pressure'),('diastolic-blood-pressure',1,'314451001',NULL,'Minimum diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314452008',NULL,'Maximum diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314453003',NULL,'Average diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314454009',NULL,'Minimum day interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314455005',NULL,'Minimum night interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314456006',NULL,'Minimum 24 hour diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314457002',NULL,'Maximum night interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314458007',NULL,'Maximum day interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314459004',NULL,'Maximum 24 hour diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314460009',NULL,'Average night interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314461008',NULL,'Average day interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314462001',NULL,'Average 24 hour diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314465004',NULL,'24 hour diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'400975005',NULL,'Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'407555005',NULL,'Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'407557002',NULL,'Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'413605002',NULL,'Average home diastolic blood pressure'),('diastolic-blood-pressure',1,'446226005',NULL,'Diastolic blood pressure on admission'),('diastolic-blood-pressure',1,'716632005',NULL,'Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'198091000000104',NULL,'Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'1091811000000102',NULL,'Diastolic arterial pressure (observable entity)'),('diastolic-blood-pressure',1,'1036571000000105',NULL,'Non-invasive central diastolic blood pressure'),('diastolic-blood-pressure',1,'163031004',NULL,'On examination - Diastolic BP reading'),('diastolic-blood-pressure',1,'100181000000103',NULL,'Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'1162735000',NULL,'Self reported diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'213051000000103',NULL,'Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'213061000000100',NULL,'Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'75141000000102',NULL,'Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'945851000000103',NULL,'Baseline diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'945861000000100',NULL,'Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'95291000000106',NULL,'Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'95311000000107',NULL,'Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'100161000000107',NULL,'Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'67726005',NULL,'Diastolic arterial pressure (observable entity)'),('diastolic-blood-pressure',1,'79411000000108',NULL,'Standing diastolic blood pressure');
INSERT INTO #codessnomed
VALUES ('egfr',1,'1011481000000105',NULL,'eGFR (estimated glomerular filtration rate) using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'1011491000000107',NULL,'eGFR (estimated glomerular filtration rate) using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'1020291000000106',NULL,'GFR (glomerular filtration rate) calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'1107411000000104',NULL,'eGFR (estimated glomerular filtration rate) by laboratory calculation'),('egfr',1,'241373003',NULL,'Technetium-99m-diethylenetriamine pentaacetic acid clearance - glomerular filtration rate (procedure)'),('egfr',1,'262300005',NULL,'With glomerular filtration rate'),('egfr',1,'737105002',NULL,'GFR (glomerular filtration rate) calculation technique'),('egfr',1,'80274001',NULL,'Glomerular filtration rate (observable entity)'),('egfr',1,'996231000000108',NULL,'GFR (glomerular filtration rate) calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'857971000000104',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula (observable entity)'),('egfr',1,'963601000000106',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation (observable entity)'),('egfr',1,'963611000000108',NULL,'Estimated glomerular filtration rate using cystatin C per 1.73 square metres'),('egfr',1,'963621000000102',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation (observable entity)'),('egfr',1,'963631000000100',NULL,'Estimated glomerular filtration rate using serum creatinine per 1.73 square metres'),('egfr',1,'857981000000102',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres');
INSERT INTO #codessnomed
VALUES ('gamma-glutamyl-transferase',1,'69480007',NULL,'Gammaglutamyl transferase'),('gamma-glutamyl-transferase',1,'1028091000000102',NULL,'Gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'60153001',NULL,'Gamma-glutamyl transferase'),('gamma-glutamyl-transferase',1,'1000851000000108',NULL,'Plasma gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'1000861000000106',NULL,'Serum gamma-glutamyl transferase level');
INSERT INTO #codessnomed
VALUES ('hba1c',2,'1019431000000105',NULL,'HbA1c level (Diabetes Control and Complications Trial aligned)'),('hba1c',2,'999791000000106',NULL,'Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised');
INSERT INTO #codessnomed
VALUES ('hdl-cholesterol',1,'1005681000000107',NULL,'Serum high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1010581000000101',NULL,'Plasma high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1026461000000104',NULL,'Serum random high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1107661000000104',NULL,'Substance concentration of high density lipoprotein cholesterol in plasma (observable entity)'),('hdl-cholesterol',1,'1028831000000106',NULL,'Plasma random high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1107681000000108',NULL,'Substance concentration of high density lipoprotein cholesterol in serum (observable entity)'),('hdl-cholesterol',1,'1026451000000102',NULL,'Serum fasting high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1028841000000102',NULL,'Plasma fasting high density lipoprotein cholesterol level (observable entity)');
INSERT INTO #codessnomed
VALUES ('ldl-cholesterol',1,'1010591000000104',NULL,'Plasma low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1014501000000104',NULL,'Calculated low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1022191000000100',NULL,'Serum low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1026471000000106',NULL,'Serum fasting low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1026481000000108',NULL,'Serum random low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'53981000237105',NULL,'Substance concentration of low density lipoprotein cholesterol in plasma (observable entity)'),('ldl-cholesterol',1,'1108541000000100',NULL,'Substance concentration of low density lipoprotein cholesterol in plasma (observable entity)'),('ldl-cholesterol',1,'1108551000000102',NULL,'Substance concentration of low density lipoprotein cholesterol in serum (observable entity)'),('ldl-cholesterol',1,'1028861000000101',NULL,'Plasma fasting low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1028851000000104',NULL,'Plasma random low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'55621000237101',NULL,'Substance concentration of low density lipoprotein cholesterol in serum (observable entity)');
INSERT INTO #codessnomed
VALUES ('sex-hormone-binding-globulin',1,'999661000000105',NULL,'Serum sex hormone binding globulin level (observable entity)');
INSERT INTO #codessnomed
VALUES ('systolic-blood-pressure',1,'72313002',NULL,'Systolic arterial pressure (observable entity)'),('systolic-blood-pressure',1,'251070002',NULL,'Non-invasive systolic blood pressure'),('systolic-blood-pressure',1,'251071003',NULL,'Invasive systolic blood pressure'),('systolic-blood-pressure',1,'271649006',NULL,'SAP - Systolic arterial pressure'),('systolic-blood-pressure',1,'314438006',NULL,'Minimum systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314439003',NULL,'Maximum systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314440001',NULL,'Average systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314441002',NULL,'Minimum day interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314442009',NULL,'Minimum night interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314443004',NULL,'Maximum night interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314444005',NULL,'Maximum day interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314445006',NULL,'Average night interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314446007',NULL,'Average day interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314447003',NULL,'Minimum 24 hour systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314448008',NULL,'Maximum 24 hour systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314449000',NULL,'Average 24 hour systolic blood pressure (observable entity'),('systolic-blood-pressure',1,'314464000',NULL,'24 hour systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'399304008',NULL,'Systolic blood pressure on admission'),('systolic-blood-pressure',1,'400974009',NULL,'Standing systolic blood pressure'),('systolic-blood-pressure',1,'407554009',NULL,'Sitting systolic blood pressure'),('systolic-blood-pressure',1,'407556006',NULL,'Lying systolic blood pressure'),('systolic-blood-pressure',1,'413606001',NULL,'Average home systolic blood pressure'),('systolic-blood-pressure',1,'716579001',NULL,'Baseline systolic blood pressure'),('systolic-blood-pressure',1,'198081000000101',NULL,'Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'1036551000000101',NULL,'Non-invasive central systolic blood pressure'),('systolic-blood-pressure',1,'163030003',NULL,'On examination - Systolic blood pressure reading'),('systolic-blood-pressure',1,'213041000000101',NULL,'Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'79401000000106',NULL,'Standing systolic blood pressure'),('systolic-blood-pressure',1,'945881000000109',NULL,'Baseline systolic blood pressure'),('systolic-blood-pressure',1,'95301000000105',NULL,'Lying systolic blood pressure'),('systolic-blood-pressure',1,'100151000000109',NULL,'Sitting systolic blood pressure'),('systolic-blood-pressure',1,'100171000000100',NULL,'Lying systolic blood pressure'),('systolic-blood-pressure',1,'1162737008',NULL,'Self reported systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'213031000000105',NULL,'Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'75131000000106',NULL,'Standing systolic blood pressure'),('systolic-blood-pressure',1,'945871000000107',NULL,'Baseline systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'95281000000109',NULL,'Sitting systolic blood pressure');
INSERT INTO #codessnomed
VALUES ('testosterone',1,'270973006',NULL,'Serum testosterone measurement (procedure)'),('testosterone',1,'995571000000101',NULL,'Plasma testosterone level (observable entity)'),('testosterone',1,'997161000000108',NULL,'Serum testosterone level (observable entity)');
INSERT INTO #codessnomed
VALUES ('triglycerides',1,'1028871000000108',NULL,'Plasma random triglyceride level (observable entity)'),('triglycerides',1,'1031321000000109',NULL,'Plasma fasting triglyceride level (observable entity)'),('triglycerides',1,'850991000000104',NULL,'Triglyceride level (observable entity)'),('triglycerides',1,'1005691000000109',NULL,'Serum triglycerides level (observable entity)'),('triglycerides',1,'1109831000000104',NULL,'Substance concentration of triglyceride in serum (observable entity)'),('triglycerides',1,'1026491000000105',NULL,'Serum fasting triglyceride level (observable entity)'),('triglycerides',1,'1010601000000105',NULL,'Plasma triglyceride level (observable entity)'),('triglycerides',1,'1461000237101',NULL,'Substance concentration of triglyceride in serum (observable entity)'),('triglycerides',1,'1026501000000104',NULL,'Serum random triglyceride level (observable entity)'),('triglycerides',1,'1109821000000101',NULL,'Substance concentration of triglyceride in plasma (observable entity)'),('triglycerides',1,'365796000',NULL,'Finding of serum triglyceride levels (finding)'),('triglycerides',1,'271245006',NULL,'Measurement of serum triglyceride level (procedure)');
INSERT INTO #codessnomed
VALUES ('urinary-albumin-creatinine-ratio',1,'144011000',NULL,'Albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'144765005',NULL,'Urine albumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'144766006',NULL,'Urine microalbumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'166721005',NULL,'Albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'167540008',NULL,'Urine albumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'167541007',NULL,'Urine microalbumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'250745003',NULL,'Albumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'271075006',NULL,'Urine albumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'271076007',NULL,'Urine microalbumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'149861000000104',NULL,'Semi-quantitative result of albumin to creatinine ratio in urine by test strip'),('urinary-albumin-creatinine-ratio',1,'1023491000000104',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'1027791000000103',NULL,'Urine microalbumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'1028271000000109',NULL,'Albumin/creatinine ratio');
INSERT INTO #codessnomed
VALUES ('vitamin-d',1,'1007991000000105',NULL,'Serum total 25-hydroxy vitamin D level (observable entity)'),('vitamin-d',1,'1029801000000105',NULL,'Total 25-hydroxyvitamin D level (observable entity)'),('vitamin-d',1,'1031181000000107',NULL,'Serum vitamin D level (observable entity)'),('vitamin-d',1,'12199005',NULL,'Vitamin D, 25-hydroxy measurement (procedure)'),('vitamin-d',1,'270990000',NULL,'Serum vitamin D measurement (procedure)'),('vitamin-d',1,'83729008',NULL,'Vitamin D measurement (procedure)'),('vitamin-d',1,'996641000000102',NULL,'Combined total vitamin D2 and D3 level (observable entity)')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codessnomed;

IF OBJECT_ID('tempdb..#codesemis') IS NOT NULL DROP TABLE #codesemis;
CREATE TABLE #codesemis (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesemis
VALUES ('bmi',2,'^ESCT1192336',NULL,'Finding of body mass index'),('bmi',2,'^ESCTBA828699',NULL,'Baseline BMI (body mass index)'),('bmi',2,'^ESCTBM348480',NULL,'BMI - Body mass index'),('bmi',2,'^ESCTBO348478',NULL,'Body mass index'),('bmi',2,'^ESCTFI589221',NULL,'Finding of BMI (body mass index)'),('bmi',2,'^ESCTOB589220',NULL,'Observation of body mass index'),('bmi',2,'^ESCTQU348481',NULL,'Quetelet index');
INSERT INTO #codesemis
VALUES ('alanine-aminotransferase',1,'^ESCT1270251',NULL,'ALT - blood measurement'),('alanine-aminotransferase',1,'^ESCTAL305713',NULL,'Alanine aminotransferase measurement'),('alanine-aminotransferase',1,'^ESCTAL305714',NULL,'ALT measurement'),('alanine-aminotransferase',1,'^ESCTAL305718',NULL,'ALT/SGPT serum level'),('alanine-aminotransferase',1,'^ESCTAL528831',NULL,'Alanine aminotransferase (ALT) - blood measurement'),('alanine-aminotransferase',1,'^ESCTAL528832',NULL,'Alanine aminotransferase - blood measurement'),('alanine-aminotransferase',1,'^ESCTFI627834',NULL,'Finding of liver enzyme levels'),('alanine-aminotransferase',1,'^ESCTGL305716',NULL,'Glutamic pyruvate transaminase measurement'),('alanine-aminotransferase',1,'^ESCTGP305717',NULL,'GPT measurement'),('alanine-aminotransferase',1,'^ESCTSG305715',NULL,'SGPT measurement');
INSERT INTO #codesemis
VALUES ('alkaline-phosphatase',1,'^ESCTSE552220',NULL,'Serum alkaline phosphatase measurement'),('alkaline-phosphatase',1,'^ESCTSE552222',NULL,'Serum alkal phosphatase level');
INSERT INTO #codesemis
VALUES ('aspartate-aminotransferase',1,'^ESCT1262031',NULL,'Aspartate aminotransferase enzyme activity in serum'),('aspartate-aminotransferase',1,'^ESCT1262102',NULL,'Aspartate aminotransferase enzyme activity in plasma'),('aspartate-aminotransferase',1,'^ESCTAS841213',NULL,'Aspartate transaminase level'),('aspartate-aminotransferase',1,'^ESCTAS841214',NULL,'AST - aspartate transaminase (SGOT)');
INSERT INTO #codesemis
VALUES ('bilirubin',1,'^ESCT1262081',NULL,'Conjugated bilirubin substance concentration in serum'),('bilirubin',1,'^ESCT1262082',NULL,'Conjugated bilirubin molar concentration in serum'),('bilirubin',1,'^ESCT1262166',NULL,'Total bilirubin substance concentration in serum'),('bilirubin',1,'^ESCT1262167',NULL,'Total bilirubin molar concentration in serum'),('bilirubin',1,'^ESCTBI627882',NULL,'Bilirubin level - finding'),('bilirubin',1,'^ESCTFI627884',NULL,'Finding of bilirubin level'),('bilirubin',1,'^ESCTBI313931',NULL,'Bilirubin, direct measurement'),('bilirubin',1,'^ESCTBI313932',NULL,'Bilirubin, conjugated measurement'),('bilirubin',1,'^ESCTCO313933',NULL,'Conjugated bilirubin level'),('bilirubin',1,'^ESCTDI313934',NULL,'Direct bilirubin level');
INSERT INTO #codesemis
VALUES ('cholesterol',2,'^ESCT1192820',NULL,'Serum fasting total cholesterol'),('cholesterol',2,'^ESCT1262075',NULL,'Cholesterol substance concentration in plasma'),('cholesterol',2,'^ESCT1262076',NULL,'Cholesterol molar concentration in plasma'),('cholesterol',2,'^ESCT1262077',NULL,'Cholesterol substance concentration in serum'),('cholesterol',2,'^ESCT1262078',NULL,'Cholesterol molar concentration in serum'),('cholesterol',2,'^ESCTCH829038',NULL,'Cholesterol level'),('cholesterol',2,'^ESCTFA605293',NULL,'Fasting cholesterol level'),('cholesterol',2,'^ESCTSE683159',NULL,'Serum total cholesterol measurement'),('cholesterol',2,'^ESCTSE683160',NULL,'Serum total cholesterol level'),('cholesterol',2,'^ESCTSE846047',NULL,'Serum fasting total cholesterol level'),('cholesterol',2,'^ESCTTO829294',NULL,'Total cholesterol level'),('cholesterol',2,'EGTON456',NULL,'Fasting serum cholesterol');
INSERT INTO #codesemis
VALUES ('diastolic-blood-pressure',1,'EMISNQDI86',NULL,'Diastolic blood pressure - left arm'),('diastolic-blood-pressure',1,'EMISNQDI87',NULL,'Diastolic blood pressure - right arm'),('diastolic-blood-pressure',1,'^ESCT1192438',NULL,'O/E - Diastolic BP reading'),('diastolic-blood-pressure',1,'^ESCT24604632',NULL,'24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTAM805799',NULL,'Ambulatory diastolic BP (blood pressure)'),('diastolic-blood-pressure',1,'^ESCTDA552722',NULL,'DAP - Diastolic arterial pressure'),('diastolic-blood-pressure',1,'^ESCTDB552723',NULL,'DBP - Diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTDI552721',NULL,'Diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTDI552724',NULL,'Diastolic arterial pressure'),('diastolic-blood-pressure',1,'^ESCTDI732123',NULL,'Diastolic blood pressure on admission'),('diastolic-blood-pressure',1,'^ESCTIN529508',NULL,'Invasive diastolic arterial pressure'),('diastolic-blood-pressure',1,'^ESCTIN529509',NULL,'Invasive diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTMA604619',NULL,'Maximum diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTMA604624',NULL,'Maximum night interval diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTMA604625',NULL,'Maximum day interval diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTMA604626',NULL,'Maximum 24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTMI604618',NULL,'Minimum diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTMI604621',NULL,'Minimum day interval diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTMI604622',NULL,'Minimum night interval diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTMI604623',NULL,'Minimum 24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTNO466071',NULL,'Non-invasive diastolic arterial pressure'),('diastolic-blood-pressure',1,'^ESCTNO466072',NULL,'Non-invasive diastolic blood pressure'),('diastolic-blood-pressure',1,'^ESCTON455662',NULL,'On examination - Diastolic blood pressure reading'),('diastolic-blood-pressure',1,'^ESCTON455663',NULL,'On examination - Diastolic BP reading');
INSERT INTO #codesemis
VALUES ('egfr',1,'^ESCT1167392',NULL,'Glomerular filtration rate calculation technique'),('egfr',1,'^ESCT1167393',NULL,'GFR - Glomerular filtration rate calculation technique'),('egfr',1,'^ESCT1237005',NULL,'GFR (glomerular filtration rate) calculation technique'),('egfr',1,'^ESCT1249126',NULL,'eGFR (estimated glomerular filtration rate) using CKD-Epi (Chronic Kidney Disease Epidemiology Collaboration) formula per 1.73 square metres'),('egfr',1,'^ESCT1262192',NULL,'Estimated glomerular filtration rate by laboratory calculation'),('egfr',1,'^ESCT1262193',NULL,'eGFR (estimated glomerular filtration rate) by laboratory calculation'),('egfr',1,'^ESCT1268044',NULL,'GFR - glomerular filtration rate'),('egfr',1,'^ESCT1437095',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'^ESCT1437099',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'^ESCT1437100',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'^ESCTEG829482',NULL,'eGFR (estimated glomerular filtration rate) using CKD-Epi (Chronic Kidney Disease Epidemiology Collaboration) formula'),('egfr',1,'^ESCTEG835295',NULL,'eGFR (estimated glomerular filtration rate) using cystatin C CKD-EPI (Chronic Kidney Disease Epidemiology Collaboration) equation'),('egfr',1,'^ESCTEG835298',NULL,'eGFR (estimated glomerular filtration rate) using creatinine CKD-EPI (Chronic Kidney Disease Epidemiology Collaboration) equation'),('egfr',1,'^ESCTES829480',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula'),('egfr',1,'^ESCTES835294',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation'),('egfr',1,'^ESCTES835297',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation'),('egfr',1,'^ESCTTC515939',NULL,'Tc99m-DTPA clearance - GFR'),('egfr',1,'^ESCTTE515940',NULL,'Technetium-99m-diethylenetriamine pentaacetic acid clearance - glomerular filtration rate'),('egfr',1,'^ESCTWI545152',NULL,'With GFR'),('egfr',1,'^ESCTWI545153',NULL,'With glomerular filtration rate');
INSERT INTO #codesemis
VALUES ('gamma-glutamyl-transferase',1,'^ESCT1377480',NULL,'Gamma-glutamyltransferase'),('gamma-glutamyl-transferase',1,'^ESCT1377481',NULL,'Gamma gTP'),('gamma-glutamyl-transferase',1,'^ESCT1377482',NULL,'GGT - gamma-glutamyl transferase'),('gamma-glutamyl-transferase',1,'^ESCTGA347689',NULL,'gamma-Glutamyltransferase'),('gamma-glutamyl-transferase',1,'^ESCTGA347691',NULL,'gamma GTP'),('gamma-glutamyl-transferase',1,'^ESCTGA347692',NULL,'Gamma-glutamyl transpeptidase'),('gamma-glutamyl-transferase',1,'^ESCTGA347693',NULL,'Gamma-glutamyl transferase'),('gamma-glutamyl-transferase',1,'^ESCTGA363001',NULL,'Gamma glutamyl transferase measurement'),('gamma-glutamyl-transferase',1,'^ESCTGA363002',NULL,'Gamma glutamyl transpeptidase measurement'),('gamma-glutamyl-transferase',1,'^ESCTGA363006',NULL,'Gamma-glutamyl transferase level'),('gamma-glutamyl-transferase',1,'^ESCTGG347694',NULL,'GGT - Gamma-glutamyl transferase'),('gamma-glutamyl-transferase',1,'^ESCTGG363004',NULL,'GGT measurement'),('gamma-glutamyl-transferase',1,'^ESCTGG363005',NULL,'GGTP measurement'),('gamma-glutamyl-transferase',1,'^ESCTGL347690',NULL,'Glutamyl transpeptidase'),('gamma-glutamyl-transferase',1,'^ESCTGT363003',NULL,'GTP measurement');
INSERT INTO #codesemis
VALUES ('hdl-cholesterol',1,'^ESCT1262229',NULL,'HDL (high density lipoprotein) cholesterol substance concentration in plasma'),('hdl-cholesterol',1,'^ESCT1262230',NULL,'HDL (high density lipoprotein) cholesterol molar concentration in plasma'),('hdl-cholesterol',1,'^ESCT1262232',NULL,'HDL (high density lipoprotein) cholesterol substance concentration in serum'),('hdl-cholesterol',1,'^ESCT1262233',NULL,'HDL (high density lipoprotein) cholesterol molar concentration in serum'),('hdl-cholesterol',1,'^ESCTSE838573',NULL,'Serum HDL (high density lipoprotein) cholesterol level');
INSERT INTO #codesemis
VALUES ('ldl-cholesterol',1,'^ESCT1262339',NULL,'LDL-C (low density lipoprotein cholesterol) substance concentration in plasma'),('ldl-cholesterol',1,'^ESCT1262340',NULL,'LDL-C (low density lipoprotein cholesterol) molar concentration in plasma'),('ldl-cholesterol',1,'^ESCT1262341',NULL,'LDL-C (low density lipoprotein cholesterol) substance concentration in serum'),('ldl-cholesterol',1,'^ESCT1262342',NULL,'LDL-C (low density lipoprotein cholesterol) molar concentration in serum'),('ldl-cholesterol',1,'^ESCTSE840392',NULL,'Serum LDL (low density lipoprotein) cholesterol level');
INSERT INTO #codesemis
VALUES ('systolic-blood-pressure',1,'EMISNQSY8',NULL,'Systolic blood pressure - left arm'),('systolic-blood-pressure',1,'EMISNQSY9',NULL,'Systolic blood pressure - right arm'),('systolic-blood-pressure',1,'^ESCT1190337',NULL,'O/E - Systolic BP reading'),('systolic-blood-pressure',1,'^ESCT1407388',NULL,'Non-invasive SAP (systolic arterial pressure)'),('systolic-blood-pressure',1,'^ESCT1407389',NULL,'Invasive SAP (systolic arterial pressure)'),('systolic-blood-pressure',1,'^ESCT24604631',NULL,'24 hour systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTAM805797',NULL,'Ambulatory systolic BP (blood pressure)'),('systolic-blood-pressure',1,'^ESCTIN529505',NULL,'Invasive systolic arterial pressure'),('systolic-blood-pressure',1,'^ESCTIN529507',NULL,'Invasive systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTMA604606',NULL,'Maximum systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTMA604610',NULL,'Maximum night interval systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTMA604611',NULL,'Maximum day interval systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTMA604615',NULL,'Maximum 24 hour systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTMI604605',NULL,'Minimum systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTMI604608',NULL,'Minimum day interval systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTMI604609',NULL,'Minimum night interval systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTMI604614',NULL,'Minimum 24 hour systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTNO529502',NULL,'Non-invasive systolic arterial pressure'),('systolic-blood-pressure',1,'^ESCTNO529504',NULL,'Non-invasive systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTON455659',NULL,'On examination - Systolic BP reading'),('systolic-blood-pressure',1,'^ESCTON455660',NULL,'On examination - Systolic blood pressure reading'),('systolic-blood-pressure',1,'^ESCTSA529503',NULL,'SAP - Systolic arterial pressure'),('systolic-blood-pressure',1,'^ESCTSA529506',NULL,'SAP - Systolic arterial pressure'),('systolic-blood-pressure',1,'^ESCTSA552720',NULL,'SAP - Systolic arterial pressure'),('systolic-blood-pressure',1,'^ESCTSY367626',NULL,'Systolic arterial pressure'),('systolic-blood-pressure',1,'^ESCTSY367627',NULL,'Systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTSY552719',NULL,'Systolic blood pressure'),('systolic-blood-pressure',1,'^ESCTSY662059',NULL,'Systolic blood pressure on admission');
INSERT INTO #codesemis
VALUES ('testosterone',1,'^ESCTSE551843',NULL,'Serum testosterone measurement'),('testosterone',1,'^ESCTSE551844',NULL,'Serum testosterone level');
INSERT INTO #codesemis
VALUES ('triglycerides',1,'^ESCT1262496',NULL,'Triglyceride substance concentration in plasma'),('triglycerides',1,'^ESCT1262497',NULL,'Triglyceride molar concentration in plasma'),('triglycerides',1,'^ESCT1262498',NULL,'Triglyceride substance concentration in serum'),('triglycerides',1,'^ESCT1262499',NULL,'Triglyceride molar concentration in serum'),('triglycerides',1,'^ESCTFI627911',NULL,'Finding of serum triglyceride levels'),('triglycerides',1,'^ESCTSE627910',NULL,'Serum triglyceride levels'),('triglycerides',1,'^ESCTME552241',NULL,'Measurement of serum triglyceride level'),('triglycerides',1,'^ESCTSE552242',NULL,'Serum triglyceride levels');
INSERT INTO #codesemis
VALUES ('urinary-albumin-creatinine-ratio',1,'^ESCT1268129',NULL,'Albumin/creatinine ratio in urine'),('urinary-albumin-creatinine-ratio',1,'^ESCT1435793',NULL,'ACR (albumin to creatinine ratio) in urine by test strip semi-quantitative result'),('urinary-albumin-creatinine-ratio',1,'^ESCT1435794',NULL,'Semi-quantitative result of albumin to creatinine ratio in urine by test strip'),('urinary-albumin-creatinine-ratio',1,'^ESCTAL528959',NULL,'Albumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'^ESCTAL528960',NULL,'Albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'^ESCTAL840923',NULL,'Albumin / creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552017',NULL,'Urine albumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552018',NULL,'Urine albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552019',NULL,'Urine microalbumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552020',NULL,'Urine microalbumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552021',NULL,'Urine microalb/creatnine ratio');
INSERT INTO #codesemis
VALUES ('vitamin-d',1,'^ESCTSE551875',NULL,'Serum vitamin D measurement'),('vitamin-d',1,'^ESCTSE551876',NULL,'Serum vitamin D level'),('vitamin-d',1,'^ESCTVI269420',NULL,'Vitamin D, 25-hydroxy measurement'),('vitamin-d',1,'^ESCTVI386243',NULL,'Vitamin D measurement')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesemis;


IF OBJECT_ID('tempdb..#TempRefCodes') IS NOT NULL DROP TABLE #TempRefCodes;
CREATE TABLE #TempRefCodes (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, version INT NOT NULL, [description] VARCHAR(255));

-- Read v2 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcr.concept, dcr.[version], dcr.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesreadv2 dcr on dcr.code = rc.MainCode
WHERE CodingType='ReadCodeV2'
AND (dcr.term IS NULL OR dcr.term = rc.Term)
and PK_Reference_Coding_ID != -1;

-- CTV3 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcc.concept, dcc.[version], dcc.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesctv3 dcc on dcc.code = rc.MainCode
WHERE CodingType='CTV3'
and PK_Reference_Coding_ID != -1;

-- EMIS codes with a FK Reference Coding ID
INSERT INTO #TempRefCodes
SELECT FK_Reference_Coding_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID != -1;

IF OBJECT_ID('tempdb..#TempSNOMEDRefCodes') IS NOT NULL DROP TABLE #TempSNOMEDRefCodes;
CREATE TABLE #TempSNOMEDRefCodes (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [version] INT NOT NULL, [description] VARCHAR(255));

-- SNOMED codes
INSERT INTO #TempSNOMEDRefCodes
SELECT PK_Reference_SnomedCT_ID, dcs.concept, dcs.[version], dcs.[description]
FROM SharedCare.Reference_SnomedCT rs
INNER JOIN #codessnomed dcs on dcs.code = rs.ConceptID;

-- EMIS codes with a FK SNOMED ID but without a FK Reference Coding ID
INSERT INTO #TempSNOMEDRefCodes
SELECT FK_Reference_SnomedCT_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID = -1
AND FK_Reference_SnomedCT_ID != -1;

-- De-duped tables
IF OBJECT_ID('tempdb..#CodeSets') IS NOT NULL DROP TABLE #CodeSets;
CREATE TABLE #CodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#SnomedSets') IS NOT NULL DROP TABLE #SnomedSets;
CREATE TABLE #SnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedCodeSets') IS NOT NULL DROP TABLE #VersionedCodeSets;
CREATE TABLE #VersionedCodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedSnomedSets') IS NOT NULL DROP TABLE #VersionedSnomedSets;
CREATE TABLE #VersionedSnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

INSERT INTO #VersionedCodeSets
SELECT DISTINCT * FROM #TempRefCodes;

INSERT INTO #VersionedSnomedSets
SELECT DISTINCT * FROM #TempSNOMEDRefCodes;

INSERT INTO #CodeSets
SELECT FK_Reference_Coding_ID, c.concept, [description]
FROM #VersionedCodeSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedCodeSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

INSERT INTO #SnomedSets
SELECT FK_Reference_SnomedCT_ID, c.concept, [description]
FROM #VersionedSnomedSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedSnomedSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

--#endregion

-- >>> Following code sets injected: bmi v2/hba1c v2/cholesterol v2/ldl-cholesterol v1/hdl-cholesterol v1/vitamin-d v1/testosterone v1/sex-hormone-binding-globulin v1/egfr v1
-- >>> Following code sets injected: diastolic-blood-pressure v1/systolic-blood-pressure v1/triglycerides v1/urinary-albumin-creatinine-ratio v1
-- >>> Following code sets injected: alanine-aminotransferase v1/alkaline-phosphatase v1/bilirubin v1/albumin v1/gamma-glutamyl-transferase v1/aspartate-aminotransferase v1

-- First lets get all the measurements in one place to improve query speed later on
IF OBJECT_ID('tempdb..#biomarkerValues') IS NOT NULL DROP TABLE #biomarkerValues;
SELECT 
	FK_Patient_Link_ID,
	CAST(EventDate AS DATE) AS EventDate,
	FK_Reference_Coding_ID,
	FK_Reference_SnomedCT_ID,
	[Value],
	Units
INTO #biomarkerValues
FROM SharedCare.GP_Events
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets)
)
AND FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
--AND EventDate >= @StartDate
AND UPPER([Value]) NOT LIKE '%[A-Z]%' -- Remove any value that contains text. The only valid character is "e" in scientific notation e.g. 2e17 - but none of these values will be in that range
AND [Value] IS NOT NULL
AND [Value] != '0'; -- In theory none of these markers should have a 0 value so this is a sensible default to exclude

-- Get all biomarker values for the cohort
IF OBJECT_ID('tempdb..#biomarkers') IS NOT NULL DROP TABLE #biomarkers;
CREATE TABLE #biomarkers (
	FK_Patient_Link_ID BIGINT,
	Label VARCHAR(32),
	EventDate DATE,
	[Value] NVARCHAR(128),
	Units NVARCHAR(64)
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'diastolic-blood-pressure' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'diastolic-blood-pressure' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'diastolic-blood-pressure' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'systolic-blood-pressure' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'systolic-blood-pressure' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'systolic-blood-pressure' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'triglycerides' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'triglycerides' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'triglycerides' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'bmi' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'bmi' AND [Version] = 2)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'bmi' AND [Version] = 2))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'hba1c' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'hba1c' AND [Version] = 2)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'hba1c' AND [Version] = 2))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'cholesterol' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'cholesterol' AND [Version] = 2)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'cholesterol' AND [Version] = 2))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'ldl-cholesterol' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'ldl-cholesterol' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'ldl-cholesterol' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'hdl-cholesterol' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'hdl-cholesterol' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'hdl-cholesterol' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'vitamin-d' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'vitamin-d' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'vitamin-d' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'testosterone' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'testosterone' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'testosterone' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'sex-hormone-binding-globulin' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'sex-hormone-binding-globulin' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'sex-hormone-binding-globulin' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'egfr' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'egfr' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'egfr' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'urinary-albumin-creatinine-ratio' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'urinary-albumin-creatinine-ratio' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'urinary-albumin-creatinine-ratio' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'alanine-aminotransferase' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'alanine-aminotransferase' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'alanine-aminotransferase' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'alkaline-phosphatase' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'alkaline-phosphatase' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'alkaline-phosphatase' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'bilirubin' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'bilirubin' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'bilirubin' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'albumin' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'albumin' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'albumin' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'gamma-glutamyl-transferase' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'gamma-glutamyl-transferase' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'gamma-glutamyl-transferase' AND [Version] = 1))
);

INSERT INTO #biomarkers
SELECT FK_Patient_Link_ID, 'aspartate-aminotransferase' AS Label, EventDate, [Value], Units
FROM #biomarkerValues
WHERE (
	FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE (Concept = 'aspartate-aminotransferase' AND [Version] = 1)) OR
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE (Concept = 'aspartate-aminotransferase' AND [Version] = 1))
);

-- Final output
SELECT NhsNo, Label, EventDate, [Value], Units FROM #biomarkers b
INNER JOIN #NhsNoToLinkId n on n.FK_Patient_Link_ID = b.FK_Patient_Link_ID
ORDER BY NhsNo, EventDate;