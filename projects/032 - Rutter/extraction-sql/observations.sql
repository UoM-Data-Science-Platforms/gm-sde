--┌──────────────┐
--│ Observations │
--└──────────────┘

-------- RESEARCH DATA ENGINEER CHECK ---------
-- Richard Williams	2021-11-26	Review complete

/* Observations including: 
	Systolic blood pressure
	Diastolic blood pressure
	HbA1c
	Total cholesterol
	LDL cholesterol
	HDL Cholesterol
	Triglyceride
	Creatinine
	eGFR
	Urinary albumin creatinine ratio
	Smoking Status (current/ex/never)
	bodyweight
	height
	BMI
*/

-- OUTPUT: Data with the following fields
-- 	-   PatientId (int)
--	-	ObservationName
--	-	ObservationDateTime (YYYY-MM-DD 00:00:00)
--  -   TestResult 
--  -   TestUnit


-- >>> Codesets required... Inserting the code set code
--
--┌────────────────────┐
--│ Clinical code sets │
--└────────────────────┘

-- OBJECTIVE: To populate temporary tables with the existing clinical code sets.
--            See the [SQL-generation-process.md](SQL-generation-process.md) for more details.

-- INPUT: No pre-requisites

-- OUTPUT: Five temp tables as follows:
--  #AllCodes (Concept, Version, Code)
--  #CodeSets (FK_Reference_Coding_ID, Concept)
--  #SnomedSets (FK_Reference_SnomedCT_ID, FK_SNOMED_ID)
--  #VersionedCodeSets (FK_Reference_Coding_ID, Concept, Version)
--  #VersionedSnomedSets (FK_Reference_SnomedCT_ID, Version, FK_SNOMED_ID)

--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
--!!! DO NOT EDIT THIS FILE MANUALLY !!!
--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

IF OBJECT_ID('tempdb..#AllCodes') IS NOT NULL DROP TABLE #AllCodes;
CREATE TABLE #AllCodes (
  [Concept] [varchar](255) NOT NULL,
  [Version] INT NOT NULL,
  [Code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
  [description] [varchar] (255) NULL 
);

IF OBJECT_ID('tempdb..#codesreadv2') IS NOT NULL DROP TABLE #codesreadv2;
CREATE TABLE #codesreadv2 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesreadv2
VALUES ('diabetes-type-ii',1,'C100100','Diabetes mellitus, adult onset, with no mention of complication'),('diabetes-type-ii',1,'C1001','Diabetes mellitus, adult onset, with no mention of complication'),('diabetes-type-ii',1,'C100112','Non-insulin dependent diabetes mellitus'),('diabetes-type-ii',1,'C1001','Non-insulin dependent diabetes mellitus'),('diabetes-type-ii',1,'C101100','Diabetes mellitus, adult onset, with ketoacidosis'),('diabetes-type-ii',1,'C1011','Diabetes mellitus, adult onset, with ketoacidosis'),('diabetes-type-ii',1,'C102100','Diabetes mellitus, adult onset, with hyperosmolar coma'),('diabetes-type-ii',1,'C1021','Diabetes mellitus, adult onset, with hyperosmolar coma'),('diabetes-type-ii',1,'C103100','Diabetes mellitus, adult onset, with ketoacidotic coma'),('diabetes-type-ii',1,'C1031','Diabetes mellitus, adult onset, with ketoacidotic coma'),('diabetes-type-ii',1,'C104100','Diabetes mellitus, adult onset, with renal manifestation'),('diabetes-type-ii',1,'C1041','Diabetes mellitus, adult onset, with renal manifestation'),('diabetes-type-ii',1,'C105100','Diabetes mellitus, adult onset, with ophthalmic manifestation'),('diabetes-type-ii',1,'C1051','Diabetes mellitus, adult onset, with ophthalmic manifestation'),('diabetes-type-ii',1,'C106100','Diabetes mellitus, adult onset, with neurological manifestation'),('diabetes-type-ii',1,'C1061','Diabetes mellitus, adult onset, with neurological manifestation'),('diabetes-type-ii',1,'C107100','Diabetes mellitus, adult onset, with peripheral circulatory disorder'),('diabetes-type-ii',1,'C1071','Diabetes mellitus, adult onset, with peripheral circulatory disorder'),('diabetes-type-ii',1,'C109.00','Non-insulin dependent diabetes mellitus'),('diabetes-type-ii',1,'C109.','Non-insulin dependent diabetes mellitus'),('diabetes-type-ii',1,'C109.11','NIDDM - Non-insulin dependent diabetes mellitus'),('diabetes-type-ii',1,'C109.','NIDDM - Non-insulin dependent diabetes mellitus'),('diabetes-type-ii',1,'C109.12','Type 2 diabetes mellitus'),('diabetes-type-ii',1,'C109.','Type 2 diabetes mellitus'),('diabetes-type-ii',1,'C109.13','Type II diabetes mellitus'),('diabetes-type-ii',1,'C109.','Type II diabetes mellitus'),('diabetes-type-ii',1,'C109000','Non-insulin-dependent diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C1090','Non-insulin-dependent diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C109011','Type II diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C1090','Type II diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C109012','Type 2 diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C1090','Type 2 diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C109100','Non-insulin-dependent diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C1091','Non-insulin-dependent diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C109111','Type II diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C1091','Type II diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C109112','Type 2 diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C1091','Type 2 diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C109200','Non-insulin-dependent diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C1092','Non-insulin-dependent diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C109211','Type II diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C1092','Type II diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C109212','Type 2 diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C1092','Type 2 diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C109300','Non-insulin-dependent diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C1093','Non-insulin-dependent diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C109311','Type II diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C1093','Type II diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C109312','Type 2 diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C1093','Type 2 diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C109400','Non-insulin dependent diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C1094','Non-insulin dependent diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C109411','Type II diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C1094','Type II diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C109412','Type 2 diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C1094','Type 2 diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C109500','Non-insulin dependent diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C1095','Non-insulin dependent diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C109511','Type II diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C1095','Type II diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C109512','Type 2 diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C1095','Type 2 diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C109600','Non-insulin-dependent diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C1096','Non-insulin-dependent diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C109611','Type II diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C1096','Type II diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C109612','Type 2 diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C1096','Type 2 diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C109700','Non-insulin dependent diabetes mellitus - poor control'),('diabetes-type-ii',1,'C1097','Non-insulin dependent diabetes mellitus - poor control'),('diabetes-type-ii',1,'C109711','Type II diabetes mellitus - poor control'),('diabetes-type-ii',1,'C1097','Type II diabetes mellitus - poor control'),('diabetes-type-ii',1,'C109712','Type 2 diabetes mellitus - poor control'),('diabetes-type-ii',1,'C1097','Type 2 diabetes mellitus - poor control'),('diabetes-type-ii',1,'C109900','Non-insulin-dependent diabetes mellitus without complication'),('diabetes-type-ii',1,'C1099','Non-insulin-dependent diabetes mellitus without complication'),('diabetes-type-ii',1,'C109911','Type II diabetes mellitus without complication'),('diabetes-type-ii',1,'C1099','Type II diabetes mellitus without complication'),('diabetes-type-ii',1,'C109912','Type 2 diabetes mellitus without complication'),('diabetes-type-ii',1,'C1099','Type 2 diabetes mellitus without complication'),('diabetes-type-ii',1,'C109A00','Non-insulin dependent diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C109A','Non-insulin dependent diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C109A11','Type II diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C109A','Type II diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C109A12','Type 2 diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C109A','Type 2 diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C109B00','Non-insulin dependent diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C109B','Non-insulin dependent diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C109B11','Type II diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C109B','Type II diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C109B12','Type 2 diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C109B','Type 2 diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C109C00','Non-insulin dependent diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C109C','Non-insulin dependent diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C109C11','Type II diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C109C','Type II diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C109C12','Type 2 diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C109C','Type 2 diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C109D00','Non-insulin dependent diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C109D','Non-insulin dependent diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C109D11','Type II diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C109D','Type II diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C109D12','Type 2 diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C109D','Type 2 diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C109E00','Non-insulin dependent diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C109E','Non-insulin dependent diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C109E11','Type II diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C109E','Type II diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C109E12','Type 2 diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C109E','Type 2 diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C109F00','Non-insulin-dependent diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C109F','Non-insulin-dependent diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C109F11','Type II diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C109F','Type II diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C109F12','Type 2 diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C109F','Type 2 diabetes mellitus with peripheral angiopathy'),
('diabetes-type-ii',1,'C109G00','Non-insulin dependent diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C109G','Non-insulin dependent diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C109G11','Type II diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C109G','Type II diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C109G12','Type 2 diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C109G','Type 2 diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C109H00','Non-insulin dependent diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C109H','Non-insulin dependent diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C109H11','Type II diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C109H','Type II diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C109H12','Type 2 diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C109H','Type 2 diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C109J00','Insulin treated Type 2 diabetes mellitus'),('diabetes-type-ii',1,'C109J','Insulin treated Type 2 diabetes mellitus'),('diabetes-type-ii',1,'C109J11','Insulin treated non-insulin dependent diabetes mellitus'),('diabetes-type-ii',1,'C109J','Insulin treated non-insulin dependent diabetes mellitus'),('diabetes-type-ii',1,'C109J12','Insulin treated Type II diabetes mellitus'),('diabetes-type-ii',1,'C109J','Insulin treated Type II diabetes mellitus'),('diabetes-type-ii',1,'C109K00','Hyperosmolar non-ketotic state in type 2 diabetes mellitus'),('diabetes-type-ii',1,'C109K','Hyperosmolar non-ketotic state in type 2 diabetes mellitus'),('diabetes-type-ii',1,'C10D.00','Diabetes mellitus autosomal dominant type 2'),('diabetes-type-ii',1,'C10D.','Diabetes mellitus autosomal dominant type 2'),('diabetes-type-ii',1,'C10F.00','Type 2 diabetes mellitus'),('diabetes-type-ii',1,'C10F.','Type 2 diabetes mellitus'),('diabetes-type-ii',1,'C10F.11','Type II diabetes mellitus'),('diabetes-type-ii',1,'C10F.','Type II diabetes mellitus'),('diabetes-type-ii',1,'C10F000','Type 2 diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C10F0','Type 2 diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C10F011','Type II diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C10F0','Type II diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C10F100','Type 2 diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C10F1','Type 2 diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C10F111','Type II diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C10F1','Type II diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C10F200','Type 2 diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C10F2','Type 2 diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C10F211','Type II diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C10F2','Type II diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C10F300','Type 2 diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C10F3','Type 2 diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C10F311','Type II diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C10F3','Type II diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C10F400','Type 2 diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C10F4','Type 2 diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C10F411','Type II diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C10F4','Type II diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C10F500','Type 2 diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C10F5','Type 2 diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C10F511','Type II diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C10F5','Type II diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C10F600','Type 2 diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C10F6','Type 2 diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C10F611','Type II diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C10F6','Type II diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C10F700','Type 2 diabetes mellitus - poor control'),('diabetes-type-ii',1,'C10F7','Type 2 diabetes mellitus - poor control'),('diabetes-type-ii',1,'C10F711','Type II diabetes mellitus - poor control'),('diabetes-type-ii',1,'C10F7','Type II diabetes mellitus - poor control'),('diabetes-type-ii',1,'C10F900','Type 2 diabetes mellitus without complication'),('diabetes-type-ii',1,'C10F9','Type 2 diabetes mellitus without complication'),('diabetes-type-ii',1,'C10F911','Type II diabetes mellitus without complication'),('diabetes-type-ii',1,'C10F9','Type II diabetes mellitus without complication'),('diabetes-type-ii',1,'C10FA00','Type 2 diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C10FA','Type 2 diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C10FA11','Type II diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C10FA','Type II diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'C10FB00','Type 2 diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C10FB','Type 2 diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C10FB11','Type II diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C10FB','Type II diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'C10FC00','Type 2 diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C10FC','Type 2 diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C10FC11','Type II diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C10FC','Type II diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'C10FD00','Type 2 diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C10FD','Type 2 diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C10FD11','Type II diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C10FD','Type II diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'C10FE00','Type 2 diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C10FE','Type 2 diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C10FE11','Type II diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C10FE','Type II diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'C10FF00','Type 2 diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C10FF','Type 2 diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C10FF11','Type II diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C10FF','Type II diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'C10FG00','Type 2 diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C10FG','Type 2 diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C10FG11','Type II diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C10FG','Type II diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'C10FH00','Type 2 diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C10FH','Type 2 diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C10FH11','Type II diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C10FH','Type II diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'C10FJ00','Insulin treated Type 2 diabetes mellitus'),('diabetes-type-ii',1,'C10FJ','Insulin treated Type 2 diabetes mellitus'),('diabetes-type-ii',1,'C10FJ11','Insulin treated Type II diabetes mellitus'),('diabetes-type-ii',1,'C10FJ','Insulin treated Type II diabetes mellitus'),('diabetes-type-ii',1,'C10FK00','Hyperosmolar non-ketotic state in type 2 diabetes mellitus'),('diabetes-type-ii',1,'C10FK','Hyperosmolar non-ketotic state in type 2 diabetes mellitus'),('diabetes-type-ii',1,'C10FK11','Hyperosmolar non-ketotic state in type II diabetes mellitus'),('diabetes-type-ii',1,'C10FK','Hyperosmolar non-ketotic state in type II diabetes mellitus'),('diabetes-type-ii',1,'C10FL00','Type 2 diabetes mellitus with persistent proteinuria'),('diabetes-type-ii',1,'C10FL','Type 2 diabetes mellitus with persistent proteinuria'),('diabetes-type-ii',1,'C10FL11','Type II diabetes mellitus with persistent proteinuria'),('diabetes-type-ii',1,'C10FL','Type II diabetes mellitus with persistent proteinuria'),('diabetes-type-ii',1,'C10FM00','Type 2 diabetes mellitus with persistent microalbuminuria'),('diabetes-type-ii',1,'C10FM','Type 2 diabetes mellitus with persistent microalbuminuria'),('diabetes-type-ii',1,'C10FM11','Type II diabetes mellitus with persistent microalbuminuria'),('diabetes-type-ii',1,'C10FM','Type II diabetes mellitus with persistent microalbuminuria'),('diabetes-type-ii',1,'C10FN00','Type 2 diabetes mellitus with ketoacidosis'),('diabetes-type-ii',1,'C10FN','Type 2 diabetes mellitus with ketoacidosis'),('diabetes-type-ii',1,'C10FN11','Type II diabetes mellitus with ketoacidosis'),('diabetes-type-ii',1,'C10FN','Type II diabetes mellitus with ketoacidosis'),('diabetes-type-ii',1,'C10FP00','Type 2 diabetes mellitus with ketoacidotic coma'),('diabetes-type-ii',1,'C10FP','Type 2 diabetes mellitus with ketoacidotic coma'),('diabetes-type-ii',1,'C10FP11','Type II diabetes mellitus with ketoacidotic coma'),('diabetes-type-ii',1,'C10FP','Type II diabetes mellitus with ketoacidotic coma'),('diabetes-type-ii',1,'C10FQ00','Type 2 diabetes mellitus with exudative maculopathy'),('diabetes-type-ii',1,'C10FQ','Type 2 diabetes mellitus with exudative maculopathy'),('diabetes-type-ii',1,'C10FQ11','Type II diabetes mellitus with exudative maculopathy'),
('diabetes-type-ii',1,'C10FQ','Type II diabetes mellitus with exudative maculopathy'),('diabetes-type-ii',1,'C10FR00','Type 2 diabetes mellitus with gastroparesis'),('diabetes-type-ii',1,'C10FR','Type 2 diabetes mellitus with gastroparesis'),('diabetes-type-ii',1,'C10FR11','Type II diabetes mellitus with gastroparesis'),('diabetes-type-ii',1,'C10FR','Type II diabetes mellitus with gastroparesis'),('diabetes-type-ii',1,'C10y100','Diabetes mellitus, adult onset, with other specified manifestation'),('diabetes-type-ii',1,'C10y1','Diabetes mellitus, adult onset, with other specified manifestation'),('diabetes-type-ii',1,'C10z100','Diabetes mellitus, adult onset, with unspecified complication'),('diabetes-type-ii',1,'C10z1','Diabetes mellitus, adult onset, with unspecified complication');
INSERT INTO #codesreadv2
VALUES ('gestational-diabetes',1,'L1808','Gestational diabetes mellitus'),('gestational-diabetes',1,'L180800','Gestational diabetes mellitus'),('gestational-diabetes',1,'L1809','Gestational diabetes mellitus'),('gestational-diabetes',1,'L180900','Gestational diabetes mellitus');
INSERT INTO #codesreadv2
VALUES ('polycystic-ovarian-syndrome',1,'12FA.','FH: Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'12FA.00','FH: Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'C164.','Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'C164.00','Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'C165.','Polycystic ovarian syndrome'),('polycystic-ovarian-syndrome',1,'C165.00','Polycystic ovarian syndrome');
INSERT INTO #codesreadv2
VALUES ('bmi',1,'22K..00','Body Mass Index'),('bmi',1,'22K..','Body Mass Index'),('bmi',1,'22KE.00','Obese class III (body mass index equal to or greater than 40.0)'),('bmi',1,'22KE.','Obese class III (body mass index equal to or greater than 40.0)'),('bmi',1,'22KD.00','Obese class II (body mass index 35.0 - 39.9)'),('bmi',1,'22KD.','Obese class II (body mass index 35.0 - 39.9)'),('bmi',1,'22KC.00','Obese class I (body mass index 30.0 - 34.9)'),('bmi',1,'22KC.','Obese class I (body mass index 30.0 - 34.9)'),('bmi',1,'22KB.00','Baseline body mass index'),('bmi',1,'22KB.','Baseline body mass index'),('bmi',1,'22KA.00','Target body mass index'),('bmi',1,'22KA.','Target body mass index'),('bmi',1,'22K9.00','Body mass index centile'),('bmi',1,'22K9.','Body mass index centile'),('bmi',1,'22K9K00','Downs syndrome body mass index centile'),('bmi',1,'22K9K','Downs syndrome body mass index centile'),('bmi',1,'22K9J00','Child body mass index greater than 99.6th centile'),('bmi',1,'22K9J','Child body mass index greater than 99.6th centile'),('bmi',1,'22K9H00','Child body mass index 98.1st-99.6th centile'),('bmi',1,'22K9H','Child body mass index 98.1st-99.6th centile'),('bmi',1,'22K9G00','Child body mass index on 98th centile'),('bmi',1,'22K9G','Child body mass index on 98th centile'),('bmi',1,'22K9F00','Child body mass index 92nd-97th centile'),('bmi',1,'22K9F','Child body mass index 92nd-97th centile'),('bmi',1,'22K9E00','Child body mass index on 91st centile'),('bmi',1,'22K9E','Child body mass index on 91st centile'),('bmi',1,'22K9D00','Child body mass index 76th-90th centile'),('bmi',1,'22K9D','Child body mass index 76th-90th centile'),('bmi',1,'22K9C00','Child body mass index on 75th centile'),('bmi',1,'22K9C','Child body mass index on 75th centile'),('bmi',1,'22K9B00','Child body mass index 51st-74th centile'),('bmi',1,'22K9B','Child body mass index 51st-74th centile'),('bmi',1,'22K9A00','Child body mass index on 50th centile'),('bmi',1,'22K9A','Child body mass index on 50th centile'),('bmi',1,'22K9900','Child body mass index 26th-49th centile'),('bmi',1,'22K99','Child body mass index 26th-49th centile'),('bmi',1,'22K9800','Child body mass index on 25th centile'),('bmi',1,'22K98','Child body mass index on 25th centile'),('bmi',1,'22K9700','Child body mass index 10th-24th centile'),('bmi',1,'22K97','Child body mass index 10th-24th centile'),('bmi',1,'22K9600','Child body mass index on 9th centile'),('bmi',1,'22K96','Child body mass index on 9th centile'),('bmi',1,'22K9500','Child body mass index 3rd-8th centile'),('bmi',1,'22K95','Child body mass index 3rd-8th centile'),('bmi',1,'22K9400','Child body mass index on 2nd centile'),('bmi',1,'22K94','Child body mass index on 2nd centile'),('bmi',1,'22K9300','Child body mass index 0.4th-1.9th centile'),('bmi',1,'22K93','Child body mass index 0.4th-1.9th centile'),('bmi',1,'22K9200','Child body mass index less than 0.4th centile'),('bmi',1,'22K92','Child body mass index less than 0.4th centile'),('bmi',1,'22K9100','Child body mass index centile'),('bmi',1,'22K91','Child body mass index centile'),('bmi',1,'22K9000','Baseline body mass index centile'),('bmi',1,'22K90','Baseline body mass index centile'),('bmi',1,'22K8.00','Body mass index 20-24 - normal'),('bmi',1,'22K8.','Body mass index 20-24 - normal'),('bmi',1,'22K7.00','Body mass index 40+ - severely obese'),('bmi',1,'22K7.','Body mass index 40+ - severely obese'),('bmi',1,'22K6.00','Body mass index less than 20'),('bmi',1,'22K6.','Body mass index less than 20'),('bmi',1,'22K5.00','Body mass index 30+ - obesity'),('bmi',1,'22K5.','Body mass index 30+ - obesity'),('bmi',1,'22K4.00','Body mass index index 25-29 - overweight'),('bmi',1,'22K4.','Body mass index index 25-29 - overweight'),('bmi',1,'22K3.00','Body Mass Index low K/M2'),('bmi',1,'22K3.','Body Mass Index low K/M2'),('bmi',1,'22K2.00','Body Mass Index high K/M2'),('bmi',1,'22K2.','Body Mass Index high K/M2'),('bmi',1,'22K1.00','Body Mass Index normal K/M2'),('bmi',1,'22K1.','Body Mass Index normal K/M2'),('bmi',1,'C3808','Childhood obesity'),('bmi',1,'C380800','Childhood obesity'),('bmi',2,'22K..00','Body Mass Index'),('bmi',2,'22K..','Body Mass Index');
INSERT INTO #codesreadv2
VALUES ('height',1,'229..00','O/E - height'),('height',1,'229..','O/E - height'),('height',1,'229Z.00','O/E - height NOS'),('height',1,'229Z.','O/E - height NOS');
INSERT INTO #codesreadv2
VALUES ('smoking-status-current',1,'137P.00','Cigarette smoker'),('smoking-status-current',1,'137P.','Cigarette smoker'),('smoking-status-current',1,'137P.11','Smoker'),('smoking-status-current',1,'137P.','Smoker'),('smoking-status-current',1,'13p3.00','Smoking status at 52 weeks'),('smoking-status-current',1,'13p3.','Smoking status at 52 weeks'),('smoking-status-current',1,'1374.00','Moderate smoker - 10-19 cigs/d'),('smoking-status-current',1,'1374.','Moderate smoker - 10-19 cigs/d'),('smoking-status-current',1,'137G.00','Trying to give up smoking'),('smoking-status-current',1,'137G.','Trying to give up smoking'),('smoking-status-current',1,'137R.00','Current smoker'),('smoking-status-current',1,'137R.','Current smoker'),('smoking-status-current',1,'1376.00','Very heavy smoker - 40+cigs/d'),('smoking-status-current',1,'1376.','Very heavy smoker - 40+cigs/d'),('smoking-status-current',1,'1375.00','Heavy smoker - 20-39 cigs/day'),('smoking-status-current',1,'1375.','Heavy smoker - 20-39 cigs/day'),('smoking-status-current',1,'1373.00','Light smoker - 1-9 cigs/day'),('smoking-status-current',1,'1373.','Light smoker - 1-9 cigs/day'),('smoking-status-current',1,'137M.00','Rolls own cigarettes'),('smoking-status-current',1,'137M.','Rolls own cigarettes'),('smoking-status-current',1,'137o.00','Waterpipe tobacco consumption'),('smoking-status-current',1,'137o.','Waterpipe tobacco consumption'),('smoking-status-current',1,'137m.00','Failed attempt to stop smoking'),('smoking-status-current',1,'137m.','Failed attempt to stop smoking'),('smoking-status-current',1,'137h.00','Minutes from waking to first tobacco consumption'),('smoking-status-current',1,'137h.','Minutes from waking to first tobacco consumption'),('smoking-status-current',1,'137g.00','Cigarette pack-years'),('smoking-status-current',1,'137g.','Cigarette pack-years'),('smoking-status-current',1,'137f.00','Reason for restarting smoking'),('smoking-status-current',1,'137f.','Reason for restarting smoking'),('smoking-status-current',1,'137e.00','Smoking restarted'),('smoking-status-current',1,'137e.','Smoking restarted'),('smoking-status-current',1,'137d.00','Not interested in stopping smoking'),('smoking-status-current',1,'137d.','Not interested in stopping smoking'),('smoking-status-current',1,'137c.00','Thinking about stopping smoking'),('smoking-status-current',1,'137c.','Thinking about stopping smoking'),('smoking-status-current',1,'137b.00','Ready to stop smoking'),('smoking-status-current',1,'137b.','Ready to stop smoking'),('smoking-status-current',1,'137C.00','Keeps trying to stop smoking'),('smoking-status-current',1,'137C.','Keeps trying to stop smoking'),('smoking-status-current',1,'137J.00','Cigar smoker'),('smoking-status-current',1,'137J.','Cigar smoker'),('smoking-status-current',1,'137H.00','Pipe smoker'),('smoking-status-current',1,'137H.','Pipe smoker'),('smoking-status-current',1,'137a.00','Pipe tobacco consumption'),('smoking-status-current',1,'137a.','Pipe tobacco consumption'),('smoking-status-current',1,'137Z.00','Tobacco consumption NOS'),('smoking-status-current',1,'137Z.','Tobacco consumption NOS'),('smoking-status-current',1,'137Y.00','Cigar consumption'),('smoking-status-current',1,'137Y.','Cigar consumption'),('smoking-status-current',1,'137X.00','Cigarette consumption'),('smoking-status-current',1,'137X.','Cigarette consumption'),('smoking-status-current',1,'137V.00','Smoking reduced'),('smoking-status-current',1,'137V.','Smoking reduced'),('smoking-status-current',1,'137Q.00','Smoking started'),('smoking-status-current',1,'137Q.','Smoking started'),('smoking-status-current',1,'137Q.11','Smoking restarted'),('smoking-status-current',1,'137Q.','Smoking restarted');
INSERT INTO #codesreadv2
VALUES ('smoking-status-currently-not',1,'137L.00','Current non-smoker'),('smoking-status-currently-not',1,'137L.','Current non-smoker');
INSERT INTO #codesreadv2
VALUES ('smoking-status-ex',1,'137l.00','Ex roll-up cigarette smoker'),('smoking-status-ex',1,'137l.','Ex roll-up cigarette smoker'),('smoking-status-ex',1,'137j.00','Ex-cigarette smoker'),('smoking-status-ex',1,'137j.','Ex-cigarette smoker'),('smoking-status-ex',1,'137S.00','Ex smoker'),('smoking-status-ex',1,'137S.','Ex smoker'),('smoking-status-ex',1,'137O.00','Ex cigar smoker'),('smoking-status-ex',1,'137O.','Ex cigar smoker'),('smoking-status-ex',1,'137N.00','Ex pipe smoker'),('smoking-status-ex',1,'137N.','Ex pipe smoker'),('smoking-status-ex',1,'137F.00','Ex-smoker - amount unknown'),('smoking-status-ex',1,'137F.','Ex-smoker - amount unknown'),('smoking-status-ex',1,'137B.00','Ex-very heavy smoker (40+/day)'),('smoking-status-ex',1,'137B.','Ex-very heavy smoker (40+/day)'),('smoking-status-ex',1,'137A.00','Ex-heavy smoker (20-39/day)'),('smoking-status-ex',1,'137A.','Ex-heavy smoker (20-39/day)'),('smoking-status-ex',1,'1379.00','Ex-moderate smoker (10-19/day)'),('smoking-status-ex',1,'1379.','Ex-moderate smoker (10-19/day)'),('smoking-status-ex',1,'1378.00','Ex-light smoker (1-9/day)'),('smoking-status-ex',1,'1378.','Ex-light smoker (1-9/day)'),('smoking-status-ex',1,'137K.00','Stopped smoking'),('smoking-status-ex',1,'137K.','Stopped smoking'),('smoking-status-ex',1,'137K000','Recently stopped smoking'),('smoking-status-ex',1,'137K0','Recently stopped smoking'),('smoking-status-ex',1,'137T.00','Date ceased smoking'),('smoking-status-ex',1,'137T.','Date ceased smoking'),('smoking-status-ex',1,'13p4.00','Smoking free weeks'),('smoking-status-ex',1,'13p4.','Smoking free weeks');
INSERT INTO #codesreadv2
VALUES ('smoking-status-ex-trivial',1,'1377.00','Ex-trivial smoker (<1/day)'),('smoking-status-ex-trivial',1,'1377.','Ex-trivial smoker (<1/day)');
INSERT INTO #codesreadv2
VALUES ('smoking-status-never',1,'1371.00','Never smoked tobacco'),('smoking-status-never',1,'1371.','Never smoked tobacco');
INSERT INTO #codesreadv2
VALUES ('smoking-status-passive',1,'137I.00','Passive smoker'),('smoking-status-passive',1,'137I.','Passive smoker'),('smoking-status-passive',1,'137I000','Exposed to tobacco smoke at home'),('smoking-status-passive',1,'137I0','Exposed to tobacco smoke at home'),('smoking-status-passive',1,'13WF400','Passive smoking risk'),('smoking-status-passive',1,'13WF4','Passive smoking risk');
INSERT INTO #codesreadv2
VALUES ('smoking-status-trivial',1,'1372.00','Trivial smoker - < 1 cig/day'),('smoking-status-trivial',1,'1372.','Trivial smoker - < 1 cig/day'),('smoking-status-trivial',1,'1372.11','Occasional smoker'),('smoking-status-trivial',1,'1372.','Occasional smoker');
INSERT INTO #codesreadv2
VALUES ('weight',1,'22A..00','O/E - weight'),('weight',1,'22A..','O/E - weight'),('weight',1,'22AZ.00','O/E - weight NOS'),('weight',1,'22AZ.','O/E - weight NOS');
INSERT INTO #codesreadv2
VALUES ('cholesterol',1,'44P..00','Serum cholesterol'),('cholesterol',1,'44P..','Serum cholesterol'),('cholesterol',1,'44PZ.00','Serum cholesterol NOS'),('cholesterol',1,'44PZ.','Serum cholesterol NOS'),('cholesterol',1,'44PL.00','Non HDL cholesterol level'),('cholesterol',1,'44PL.','Non HDL cholesterol level'),('cholesterol',1,'44PL100','Estimated serum non-high density lipoprotein cholesterol level'),('cholesterol',1,'44PL1','Estimated serum non-high density lipoprotein cholesterol level'),('cholesterol',1,'44PL000','Serum non high density lipoprotein cholesterol level'),('cholesterol',1,'44PL0','Serum non high density lipoprotein cholesterol level'),('cholesterol',1,'44PK.00','Serum fasting total cholesterol'),('cholesterol',1,'44PK.','Serum fasting total cholesterol'),('cholesterol',1,'44PJ.00','Serum total cholesterol level'),('cholesterol',1,'44PJ.','Serum total cholesterol level'),('cholesterol',1,'44PI.00','Calculated LDL cholesterol level'),('cholesterol',1,'44PI.','Calculated LDL cholesterol level'),('cholesterol',1,'44PH.00','Total cholesterol measurement'),('cholesterol',1,'44PH.','Total cholesterol measurement'),('cholesterol',1,'44PG.00','HDL : total cholesterol ratio'),('cholesterol',1,'44PG.','HDL : total cholesterol ratio'),('cholesterol',1,'44PF.00','Total cholesterol:HDL ratio'),('cholesterol',1,'44PF.','Total cholesterol:HDL ratio'),('cholesterol',1,'44PE.00','Serum random LDL cholesterol level'),('cholesterol',1,'44PE.','Serum random LDL cholesterol level'),('cholesterol',1,'44PD.00','Serum fasting LDL cholesterol level'),('cholesterol',1,'44PD.','Serum fasting LDL cholesterol level'),('cholesterol',1,'44PC.00','Serum random HDL cholesterol level'),('cholesterol',1,'44PC.','Serum random HDL cholesterol level'),('cholesterol',1,'44PB.00','Serum fasting HDL cholesterol level'),('cholesterol',1,'44PB.','Serum fasting HDL cholesterol level'),('cholesterol',1,'44P9.00','Serum cholesterol studies'),('cholesterol',1,'44P9.','Serum cholesterol studies'),('cholesterol',1,'44P8.00','Serum HDL:non-HDL cholesterol ratio'),('cholesterol',1,'44P8.','Serum HDL:non-HDL cholesterol ratio'),('cholesterol',1,'44P7.00','Serum VLDL cholesterol level'),('cholesterol',1,'44P7.','Serum VLDL cholesterol level'),('cholesterol',1,'44P6.00','Serum LDL cholesterol level'),('cholesterol',1,'44P6.','Serum LDL cholesterol level'),('cholesterol',1,'44P5.00','Serum HDL cholesterol level'),('cholesterol',1,'44P5.','Serum HDL cholesterol level'),('cholesterol',1,'44P4.00','Serum cholesterol very high'),('cholesterol',1,'44P4.','Serum cholesterol very high'),('cholesterol',1,'44P3.00','Serum cholesterol raised'),('cholesterol',1,'44P3.','Serum cholesterol raised'),('cholesterol',1,'44P2.00','Serum cholesterol borderline'),('cholesterol',1,'44P2.','Serum cholesterol borderline'),('cholesterol',1,'44P1.00','Serum cholesterol normal'),('cholesterol',1,'44P1.','Serum cholesterol normal'),('cholesterol',1,'44PA.00','HDL : LDL ratio'),('cholesterol',1,'44PA.','HDL : LDL ratio'),('cholesterol',1,'44lM.00','Plasma LDL/HDL ratio'),('cholesterol',1,'44lM.','Plasma LDL/HDL ratio'),('cholesterol',1,'44lL.00','Serum LDL/HDL ratio'),('cholesterol',1,'44lL.','Serum LDL/HDL ratio'),('cholesterol',1,'44lK.00','Plasma cholesterol/VLDL ratio'),('cholesterol',1,'44lK.','Plasma cholesterol/VLDL ratio'),('cholesterol',1,'44lJ.00','Serum cholesterol/VLDL ratio'),('cholesterol',1,'44lJ.','Serum cholesterol/VLDL ratio'),('cholesterol',1,'44lI.00','Plasma cholesterol/LDL ratio'),('cholesterol',1,'44lI.','Plasma cholesterol/LDL ratio'),('cholesterol',1,'44lH.00','Serum cholesterol/LDL ratio'),('cholesterol',1,'44lH.','Serum cholesterol/LDL ratio'),('cholesterol',1,'44lG.00','Plasma cholesterol/HDL ratio'),('cholesterol',1,'44lG.','Plasma cholesterol/HDL ratio'),('cholesterol',1,'44lF.00','Serum cholesterol/HDL ratio'),('cholesterol',1,'44lF.','Serum cholesterol/HDL ratio'),('cholesterol',1,'44l2.00','Cholesterol/HDL ratio'),('cholesterol',1,'44l2.','Cholesterol/HDL ratio'),('cholesterol',1,'44dB.00','Plasma LDL cholesterol level'),('cholesterol',1,'44dB.','Plasma LDL cholesterol level'),('cholesterol',1,'44dA.00','Plasma HDL cholesterol level'),('cholesterol',1,'44dA.','Plasma HDL cholesterol level'),('cholesterol',1,'44d5.00','Plasma fasting LDL cholesterol level'),('cholesterol',1,'44d5.','Plasma fasting LDL cholesterol level'),('cholesterol',1,'44d4.00','Plasma random LDL cholesterol level'),('cholesterol',1,'44d4.','Plasma random LDL cholesterol level'),('cholesterol',1,'44d3.00','Plasma fasting HDL cholesterol level'),('cholesterol',1,'44d3.','Plasma fasting HDL cholesterol level'),('cholesterol',1,'44d2.00','Plasma random HDL cholesterol level'),('cholesterol',1,'44d2.','Plasma random HDL cholesterol level'),('cholesterol',1,'44R4.11','LDL - electrophoresis'),('cholesterol',1,'44R4.','LDL - electrophoresis'),('cholesterol',1,'44R4.00','Lipoprotein electroph. - LDL'),('cholesterol',1,'44R4.','Lipoprotein electroph. - LDL'),('cholesterol',1,'44R3.11','HDL - electrophoresis'),('cholesterol',1,'44R3.','HDL - electrophoresis'),('cholesterol',1,'44R3.00','Lipoprotein electroph. - HDL'),('cholesterol',1,'44R3.','Lipoprotein electroph. - HDL'),('cholesterol',1,'662a.00','Pre-treatment serum cholesterol level'),('cholesterol',1,'662a.','Pre-treatment serum cholesterol level'),('cholesterol',1,'44OE.00','Plasma total cholesterol level'),('cholesterol',1,'44OE.','Plasma total cholesterol level'),('cholesterol',1,'44lzY00','Serum high density lipoprotein cholesterol:triglyceride ratio'),('cholesterol',1,'44lzY','Serum high density lipoprotein cholesterol:triglyceride ratio'),('cholesterol',1,'4I3O.00','Fluid sample cholesterol level'),('cholesterol',1,'4I3O.','Fluid sample cholesterol level'),('cholesterol',2,'44P..00','Serum cholesterol'),('cholesterol',2,'44P..','Serum cholesterol'),('cholesterol',2,'44PZ.00','Serum cholesterol NOS'),('cholesterol',2,'44PZ.','Serum cholesterol NOS'),('cholesterol',2,'44PJ.00','Serum total cholesterol level'),('cholesterol',2,'44PJ.','Serum total cholesterol level'),('cholesterol',2,'44PH.00','Total cholesterol measurement'),('cholesterol',2,'44PH.','Total cholesterol measurement');
INSERT INTO #codesreadv2
VALUES ('creatinine',1,'44J3.00','Serum creatinine'),('creatinine',1,'44J3.','Serum creatinine'),('creatinine',1,'44JC.00','Corrected plasma creatinine level'),('creatinine',1,'44JC.','Corrected plasma creatinine level'),('creatinine',1,'44JD.00','Corrected serum creatinine level'),('creatinine',1,'44JD.','Corrected serum creatinine level'),('creatinine',1,'44JF.00','Plasma creatinine level'),('creatinine',1,'44JF.','Plasma creatinine level'),('creatinine',1,'44J3z00','Serum creatinine NOS'),('creatinine',1,'44J3z','Serum creatinine NOS');
INSERT INTO #codesreadv2
VALUES ('diastolic-blood-pressure',1,'246o100','Non-invasive central diastolic blood pressure'),('diastolic-blood-pressure',1,'246o1','Non-invasive central diastolic blood pressure'),('diastolic-blood-pressure',1,'246n000','Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'246n0','Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'246m.00','Average diastolic blood pressure'),('diastolic-blood-pressure',1,'246m.','Average diastolic blood pressure'),('diastolic-blood-pressure',1,'246i.00','Diastolic blood pressure centile'),('diastolic-blood-pressure',1,'246i.','Diastolic blood pressure centile'),('diastolic-blood-pressure',1,'246f.00','Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'246f.','Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'246c.00','Average home diastolic blood pressure'),('diastolic-blood-pressure',1,'246c.','Average home diastolic blood pressure'),('diastolic-blood-pressure',1,'246a.00','Average night interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246a.','Average night interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246X.00','Average day interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246X.','Average day interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246V.00','Average 24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'246V.','Average 24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'246T.00','Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'246T.','Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'246R.00','Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'246R.','Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'246P.00','Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'246P.','Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'246L.00','Target diastolic blood pressure'),('diastolic-blood-pressure',1,'246L.','Target diastolic blood pressure'),('diastolic-blood-pressure',1,'246A.00','O/E - Diastolic BP reading'),('diastolic-blood-pressure',1,'246A.','O/E - Diastolic BP reading');
INSERT INTO #codesreadv2
VALUES ('egfr',1,'451E.00','Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'451E.','Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'451G.00','Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'451G.','Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'451K.00','Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'451K.','Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'451M.00','Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451M.','Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451N.00','Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451N.','Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres');
INSERT INTO #codesreadv2
VALUES ('hba1c',1,'42c..00','HbA1 - diabetic control'),('hba1c',1,'42c..','HbA1 - diabetic control'),('hba1c',1,'42c3.00','HbA1 level (DCCT aligned)'),('hba1c',1,'42c3.','HbA1 level (DCCT aligned)'),('hba1c',1,'42c2.00','HbA1 > 10% - bad control'),('hba1c',1,'42c2.','HbA1 > 10% - bad control'),('hba1c',1,'42c1.00','HbA1 7 - 10% - borderline control'),('hba1c',1,'42c1.','HbA1 7 - 10% - borderline control'),('hba1c',1,'42c0.00','HbA1 < 7% - good control'),('hba1c',1,'42c0.','HbA1 < 7% - good control'),('hba1c',1,'42W..11','Glycosylated Hb'),('hba1c',1,'42W..','Glycosylated Hb'),('hba1c',1,'42W..12','Glycated haemoglobin'),('hba1c',1,'42W..','Glycated haemoglobin'),('hba1c',1,'42W..00','Hb. A1C - diabetic control'),('hba1c',1,'42W..','Hb. A1C - diabetic control'),('hba1c',1,'42WZ.00','Hb. A1C - diabetic control NOS'),('hba1c',1,'42WZ.','Hb. A1C - diabetic control NOS'),('hba1c',1,'42W3.00','Hb. A1C > 10% - bad control'),('hba1c',1,'42W3.','Hb. A1C > 10% - bad control'),('hba1c',1,'42W2.00','Hb. A1C 7-10% - borderline'),('hba1c',1,'42W2.','Hb. A1C 7-10% - borderline'),('hba1c',1,'42W1.00','Hb. A1C < 7% - good control'),('hba1c',1,'42W1.','Hb. A1C < 7% - good control'),('hba1c',1,'42W5.00','Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',1,'42W5.','Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',1,'42W5100','HbA1c (haemoglobin A1c) level (monitoring ranges) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W51','HbA1c (haemoglobin A1c) level (monitoring ranges) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W5000','HbA1c (haemoglobin A1c) level (diagnostic reference range) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W50','HbA1c (haemoglobin A1c) level (diagnostic reference range) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W4.00','HbA1c level (DCCT aligned)'),('hba1c',1,'42W4.','HbA1c level (DCCT aligned)'),('hba1c',1,'44TL.00','Total glycosylated haemoglobin level'),('hba1c',1,'44TL.','Total glycosylated haemoglobin level'),('hba1c',1,'44TB.00','Haemoglobin A1c level'),('hba1c',1,'44TB.','Haemoglobin A1c level'),('hba1c',1,'44TB100','Haemoglobin A1c (monitoring ranges)'),('hba1c',1,'44TB1','Haemoglobin A1c (monitoring ranges)'),('hba1c',1,'44TB000','Haemoglobin A1c (diagnostic reference range)'),('hba1c',1,'44TB0','Haemoglobin A1c (diagnostic reference range)'),('hba1c',2,'42W5.00','Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W5.','Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W4.00','HbA1c level (DCCT aligned)'),('hba1c',2,'42W4.','HbA1c level (DCCT aligned)');
INSERT INTO #codesreadv2
VALUES ('hdl-cholesterol',1,'44PC.00','Serum random HDL cholesterol level'),('hdl-cholesterol',1,'44PC.','Serum random HDL cholesterol level'),('hdl-cholesterol',1,'44P5.00','Serum HDL cholesterol level'),('hdl-cholesterol',1,'44P5.','Serum HDL cholesterol level'),('hdl-cholesterol',1,'44dA.00','Plasma HDL cholesterol level'),('hdl-cholesterol',1,'44dA.','Plasma HDL cholesterol level');
INSERT INTO #codesreadv2
VALUES ('ldl-cholesterol',1,'44PI.00','Calculated LDL cholesterol level'),('ldl-cholesterol',1,'44PI.','Calculated LDL cholesterol level'),('ldl-cholesterol',1,'44P6.00','Serum LDL cholesterol level'),('ldl-cholesterol',1,'44P6.','Serum LDL cholesterol level'),('ldl-cholesterol',1,'44dB.00','Plasma LDL cholesterol level'),('ldl-cholesterol',1,'44dB.','Plasma LDL cholesterol level');
INSERT INTO #codesreadv2
VALUES ('systolic-blood-pressure',1,'246o000','Non-invasive central systolic blood pressure'),('systolic-blood-pressure',1,'246o0','Non-invasive central systolic blood pressure'),('systolic-blood-pressure',1,'246n100','Baseline systolic blood pressure'),('systolic-blood-pressure',1,'246n1','Baseline systolic blood pressure'),('systolic-blood-pressure',1,'246l.00','Average systolic blood pressure'),('systolic-blood-pressure',1,'246l.','Average systolic blood pressure'),('systolic-blood-pressure',1,'246j.00','Systolic blood pressure centile'),('systolic-blood-pressure',1,'246j.','Systolic blood pressure centile'),('systolic-blood-pressure',1,'246e.00','Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'246e.','Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'246d.00','Average home systolic blood pressure'),('systolic-blood-pressure',1,'246d.','Average home systolic blood pressure'),('systolic-blood-pressure',1,'246b.00','Average night interval systolic blood pressure'),('systolic-blood-pressure',1,'246b.','Average night interval systolic blood pressure'),('systolic-blood-pressure',1,'246Y.00','Average day interval systolic blood pressure'),('systolic-blood-pressure',1,'246Y.','Average day interval systolic blood pressure'),('systolic-blood-pressure',1,'246W.00','Average 24 hour systolic blood pressure'),('systolic-blood-pressure',1,'246W.','Average 24 hour systolic blood pressure'),('systolic-blood-pressure',1,'246S.00','Lying systolic blood pressure'),('systolic-blood-pressure',1,'246S.','Lying systolic blood pressure'),('systolic-blood-pressure',1,'246Q.00','Sitting systolic blood pressure'),('systolic-blood-pressure',1,'246Q.','Sitting systolic blood pressure'),('systolic-blood-pressure',1,'246N.00','Standing systolic blood pressure'),('systolic-blood-pressure',1,'246N.','Standing systolic blood pressure'),('systolic-blood-pressure',1,'246K.00','Target systolic blood pressure'),('systolic-blood-pressure',1,'246K.','Target systolic blood pressure'),('systolic-blood-pressure',1,'2469.00','O/E - Systolic BP reading'),('systolic-blood-pressure',1,'2469.','O/E - Systolic BP reading');
INSERT INTO #codesreadv2
VALUES ('triglycerides',1,'44Q..00','Serum triglycerides'),('triglycerides',1,'44Q..','Serum triglycerides'),('triglycerides',1,'44Q4.00','Serum fasting triglyceride level'),('triglycerides',1,'44Q4.','Serum fasting triglyceride level'),('triglycerides',1,'44Q5.00','Serum random triglyceride level'),('triglycerides',1,'44Q5.','Serum random triglyceride level'),('triglycerides',1,'44QZ.00','Serum triglycerides NOS'),('triglycerides',1,'44QZ.','Serum triglycerides NOS');
INSERT INTO #codesreadv2
VALUES ('urinary-albumin-creatinine-ratio',1,'46TC.','Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TC.00','Urine albumin:creatinine ratio')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesreadv2;

IF OBJECT_ID('tempdb..#codesctv3') IS NOT NULL DROP TABLE #codesctv3;
CREATE TABLE #codesctv3 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesctv3
VALUES ('diabetes-type-ii',1,'C1011','Diabetes mellitus, adult onset, with ketoacidosis'),('diabetes-type-ii',1,'C1021','Diabetes mellitus, adult onset, with hyperosmolar coma'),('diabetes-type-ii',1,'C1031','Diabetes mellitus, adult onset, with ketoacidotic coma'),('diabetes-type-ii',1,'C1041','Diabetes mellitus, adult onset, with renal manifestation'),('diabetes-type-ii',1,'C1051','Diabetes mellitus, adult onset, with ophthalmic manifestation'),('diabetes-type-ii',1,'C1061','Diabetes mellitus, adult onset, with neurological manifestation'),('diabetes-type-ii',1,'C1071','Diabetes mellitus, adult onset, with peripheral circulatory disorder'),('diabetes-type-ii',1,'C1090','Non-insulin-dependent diabetes mellitus with renal complications'),('diabetes-type-ii',1,'C1091','Non-insulin-dependent diabetes mellitus with ophthalmic complications'),('diabetes-type-ii',1,'C1092','Non-insulin-dependent diabetes mellitus with neurological complications'),('diabetes-type-ii',1,'C1093','Non-insulin-dependent diabetes mellitus with multiple complications'),('diabetes-type-ii',1,'C1094','Non-insulin-dependent diabetes mellitus with ulcer'),('diabetes-type-ii',1,'C1095','Non-insulin-dependent diabetes mellitus with gangrene'),('diabetes-type-ii',1,'C1096','NIDDM - Non-insulin-dependent diabetes mellitus with retinopathy'),('diabetes-type-ii',1,'C1097','Non-insulin-dependent diabetes mellitus - poor control'),('diabetes-type-ii',1,'C10y1','Diabetes mellitus, adult onset, with other specified manifestation'),('diabetes-type-ii',1,'C10z1','Diabetes mellitus, adult onset, with unspecified complication'),('diabetes-type-ii',1,'X40J5','Non-insulin-dependent diabetes mellitus'),('diabetes-type-ii',1,'X40J6','Insulin treated Type 2 diabetes mellitus'),('diabetes-type-ii',1,'X40JJ','Diabetes mellitus autosomal dominant type 2'),('diabetes-type-ii',1,'XE10F','Diabetes mellitus, adult onset, with no mention of complication'),('diabetes-type-ii',1,'XM19j','[EDTA] Diabetes Type II (non-insulin-dependent) associated with renal failure'),('diabetes-type-ii',1,'XaELQ','Non-insulin-dependent diabetes mellitus without complication'),('diabetes-type-ii',1,'XaEnp','Type II diabetes mellitus with mononeuropathy'),('diabetes-type-ii',1,'XaEnq','Type 2 diabetes mellitus with polyneuropathy'),('diabetes-type-ii',1,'XaF05','Type 2 diabetes mellitus with nephropathy'),('diabetes-type-ii',1,'XaFWI','Type II diabetes mellitus with hypoglycaemic coma'),('diabetes-type-ii',1,'XaFmA','Type II diabetes mellitus with diabetic cataract'),('diabetes-type-ii',1,'XaFn7','Non-insulin-dependent diabetes mellitus with peripheral angiopathy'),('diabetes-type-ii',1,'XaFn8','Non-insulin dependent diabetes mellitus with arthropathy'),('diabetes-type-ii',1,'XaFn9','Non-insulin dependent diabetes mellitus with neuropathic arthropathy'),('diabetes-type-ii',1,'XaIfG','Type II diabetes on insulin'),('diabetes-type-ii',1,'XaIfI','Type II diabetes on diet only'),('diabetes-type-ii',1,'XaIrf','Hyperosmolar non-ketotic state in type II diabetes mellitus'),('diabetes-type-ii',1,'XaIzQ','Type 2 diabetes mellitus with persistent proteinuria'),('diabetes-type-ii',1,'XaIzR','Type 2 diabetes mellitus with persistent microalbuminuria'),('diabetes-type-ii',1,'XaJQp','Type II diabetes mellitus with exudative maculopathy'),('diabetes-type-ii',1,'XaKyX','Type II diabetes mellitus with gastroparesis');
INSERT INTO #codesctv3
VALUES ('gestational-diabetes',1,'L1808','Gestational diabetes');
INSERT INTO #codesctv3
VALUES ('polycystic-ovarian-syndrome',1,'X406n','Polycystic ovarian syndrome'),('polycystic-ovarian-syndrome',1,'X406n','Polycystic ovary syndrome'),('polycystic-ovarian-syndrome',1,'XE10l','PCO - Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'XE2p5','(Polycystic ovaries) or (Stein-Leventhal syndrome)'),('polycystic-ovarian-syndrome',1,'XaJZG','FH: Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'C164.','Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'X406n','PCOD - Polycystic ovarian disease'),('polycystic-ovarian-syndrome',1,'XE10l','Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'X406n','PCOS - Polycystic ovarian syndrome'),('polycystic-ovarian-syndrome',1,'XE2p5','Polycystic ovaries'),('polycystic-ovarian-syndrome',1,'C164.','(Polycystic ovaries) or (isosexual virilisation) or (Stein-Leventhal syndrome) or (multicystic ovaries)'),('polycystic-ovarian-syndrome',1,'X406n','Polycystic ovarian disease');
INSERT INTO #codesctv3
VALUES ('bmi',1,'22K..','Body Mass Index'),('bmi',1,'22K1.','Body Mass Index normal K/M2'),('bmi',1,'22K2.','Body Mass Index high K/M2'),('bmi',1,'22K3.','Body Mass Index low K/M2'),('bmi',1,'22K4.','Body mass index index 25-29 - overweight'),('bmi',1,'22K5.','Body mass index 30+ - obesity'),('bmi',1,'X76CO','Quetelet index'),('bmi',1,'Xa7wG','Observation of body mass index'),('bmi',1,'Xaa0k','Childhood obesity'),('bmi',1,'Xaatm','Child BMI centile'),('bmi',1,'Xabdn','Downs syndrome BMI centile'),('bmi',1,'XabHx','Obese class I (BMI 30.0-34.9)'),('bmi',1,'XabHy','Obese class II (BMI 35.0-39.9)'),('bmi',1,'XabHz','Obese cls III (BMI eq/gr 40.0)'),('bmi',1,'XabSe','Child BMI < 0.4th centile'),('bmi',1,'XabSf','Child BMI 0.4th-1.9th centile'),('bmi',1,'XabSg','Child BMI on 2nd centile'),('bmi',1,'XabSh','Child BMI 3rd-8th centile'),('bmi',1,'XabSj','Child BMI on 9th centile'),('bmi',1,'XabSk','Child BMI 10th-24th centile'),('bmi',1,'XabSl','Child BMI on 25th centile'),('bmi',1,'XabSm','Child BMI 26th-49th centile'),('bmi',1,'XabSn','Child BMI on 50th centile'),('bmi',1,'XabTe','Child BMI on 75th centile'),('bmi',1,'XabTf','Child BMI 76th-90th centile'),('bmi',1,'XabTg','Child BMI on 91st centile'),('bmi',1,'XabTh','Child BMI 92nd-97th centile'),('bmi',1,'XabTi','Child BMI on 98th centile'),('bmi',1,'XabTj','Child BMI 98.1-99.6 centile'),('bmi',1,'XabTk','Child BMI > 99.6th centile'),('bmi',1,'XabTZ','Child BMI 51st-74th centile'),('bmi',1,'XaCDR','Body mass index less than 20'),('bmi',1,'XaJJH','BMI 40+ - severely obese'),('bmi',1,'XaJqk','Body mass index 20-24 - normal'),('bmi',1,'XaVwA','Body mass index centile'),('bmi',1,'XaZck','Baseline BMI centile'),('bmi',1,'XaZcl','Baseline body mass index'),('bmi',2,'22K..','Body Mass Index');
INSERT INTO #codesctv3
VALUES ('height',1,'229..','O/E - height'),('height',1,'229Z.','O/E - height NOS');
INSERT INTO #codesctv3
VALUES ('smoking-status-current',1,'1373.','Lt cigaret smok, 1-9 cigs/day'),('smoking-status-current',1,'1374.','Mod cigaret smok, 10-19 cigs/d'),('smoking-status-current',1,'1375.','Hvy cigaret smok, 20-39 cigs/d'),('smoking-status-current',1,'1376.','Very hvy cigs smoker,40+cigs/d'),('smoking-status-current',1,'137C.','Keeps trying to stop smoking'),('smoking-status-current',1,'137D.','Admitted tobacco cons untrue ?'),('smoking-status-current',1,'137G.','Trying to give up smoking'),('smoking-status-current',1,'137H.','Pipe smoker'),('smoking-status-current',1,'137J.','Cigar smoker'),('smoking-status-current',1,'137M.','Rolls own cigarettes'),('smoking-status-current',1,'137P.','Cigarette smoker'),('smoking-status-current',1,'137Q.','Smoking started'),('smoking-status-current',1,'137R.','Current smoker'),('smoking-status-current',1,'137Z.','Tobacco consumption NOS'),('smoking-status-current',1,'Ub1tI','Cigarette consumption'),('smoking-status-current',1,'Ub1tJ','Cigar consumption'),('smoking-status-current',1,'Ub1tK','Pipe tobacco consumption'),('smoking-status-current',1,'XaBSp','Smoking restarted'),('smoking-status-current',1,'XaIIu','Smoking reduced'),('smoking-status-current',1,'XaIkW','Thinking about stop smoking'),('smoking-status-current',1,'XaIkX','Ready to stop smoking'),('smoking-status-current',1,'XaIkY','Not interested stop smoking'),('smoking-status-current',1,'XaItg','Reason for restarting smoking'),('smoking-status-current',1,'XaIuQ','Cigarette pack-years'),('smoking-status-current',1,'XaJX2','Min from wake to 1st tobac con'),('smoking-status-current',1,'XaWNE','Failed attempt to stop smoking'),('smoking-status-current',1,'XaZIE','Waterpipe tobacco consumption'),('smoking-status-current',1,'XE0og','Tobacco smoking consumption'),('smoking-status-current',1,'XE0oq','Cigarette smoker'),('smoking-status-current',1,'XE0or','Smoking started');
INSERT INTO #codesctv3
VALUES ('smoking-status-currently-not',1,'Ub0oq','Non-smoker'),('smoking-status-currently-not',1,'137L.','Current non-smoker');
INSERT INTO #codesctv3
VALUES ('smoking-status-ex',1,'1378.','Ex-light smoker (1-9/day)'),('smoking-status-ex',1,'1379.','Ex-moderate smoker (10-19/day)'),('smoking-status-ex',1,'137A.','Ex-heavy smoker (20-39/day)'),('smoking-status-ex',1,'137B.','Ex-very heavy smoker (40+/day)'),('smoking-status-ex',1,'137F.','Ex-smoker - amount unknown'),('smoking-status-ex',1,'137K.','Stopped smoking'),('smoking-status-ex',1,'137N.','Ex-pipe smoker'),('smoking-status-ex',1,'137O.','Ex-cigar smoker'),('smoking-status-ex',1,'137T.','Date ceased smoking'),('smoking-status-ex',1,'Ub1na','Ex-smoker'),('smoking-status-ex',1,'Xa1bv','Ex-cigarette smoker'),('smoking-status-ex',1,'XaIr7','Smoking free weeks'),('smoking-status-ex',1,'XaKlS','[V]PH of tobacco abuse'),('smoking-status-ex',1,'XaQ8V','Ex roll-up cigarette smoker'),('smoking-status-ex',1,'XaQzw','Recently stopped smoking'),('smoking-status-ex',1,'XE0ok','Ex-light cigaret smok, 1-9/day'),('smoking-status-ex',1,'XE0ol','Ex-mod cigaret smok, 10-19/day'),('smoking-status-ex',1,'XE0om','Ex-heav cigaret smok,20-39/day'),('smoking-status-ex',1,'XE0on','Ex-very hv cigaret smk,40+/day');
INSERT INTO #codesctv3
VALUES ('smoking-status-ex-trivial',1,'XE0oj','Ex-triv cigaret smoker, <1/day'),('smoking-status-ex-trivial',1,'1377.','Ex-trivial smoker (<1/day)');
INSERT INTO #codesctv3
VALUES ('smoking-status-never',1,'XE0oh','Never smoked tobacco'),('smoking-status-never',1,'1371.','Never smoked tobacco');
INSERT INTO #codesctv3
VALUES ('smoking-status-passive',1,'137I.','Passive smoker'),('smoking-status-passive',1,'Ub0pe','Exposed to tobacco smoke at work'),('smoking-status-passive',1,'Ub0pf','Exposed to tobacco smoke at home'),('smoking-status-passive',1,'Ub0pg','Exposed to tobacco smoke in public places'),('smoking-status-passive',1,'13WF4','Passive smoking risk');
INSERT INTO #codesctv3
VALUES ('smoking-status-trivial',1,'XagO3','Occasional tobacco smoker'),('smoking-status-trivial',1,'XE0oi','Triv cigaret smok, < 1 cig/day'),('smoking-status-trivial',1,'1372.','Trivial smoker - < 1 cig/day');
INSERT INTO #codesctv3
VALUES ('weight',1,'22A..','O/E - weight'),('weight',1,'22AZ.','O/E - weight NOS');
INSERT INTO #codesctv3
VALUES ('cholesterol',1,'X772L','Cholesterol level'),('cholesterol',1,'X772M','High density lipoprot chol lev'),('cholesterol',1,'X772N','LDL-Low dens lipoprot chol lev'),('cholesterol',1,'X773m','Percentage chol as ester'),('cholesterol',1,'X773W','HDL/LDL ratio'),('cholesterol',1,'X80J1','HDL - High density lipoprotein'),('cholesterol',1,'X80Nb','Hi density lipoprot subfrac 2'),('cholesterol',1,'X80Nc','Hi density lipoprot subfrac 3'),('cholesterol',1,'X80Ne','LDL - Low density lipoprotein'),('cholesterol',1,'X80NT','Free cholesterol'),('cholesterol',1,'X80NU','Cholesterol ester'),('cholesterol',1,'XabE1','Se non HDL cholesterol level'),('cholesterol',1,'XabT0','Estim serum non-HDL cholest lv'),('cholesterol',1,'Xabub','Se HDL chol:triglyceride ratio'),('cholesterol',1,'XaEil','Hi dens lipoprt/tot chol ratio'),('cholesterol',1,'XaERR','Cholesterol/HDL ratio'),('cholesterol',1,'XaEUp','Lipoprotein cholesterol ratio'),('cholesterol',1,'XaEUq','Serum cholesterol/HDL ratio'),('cholesterol',1,'XaEUr','Plasma cholesterol/HDL ratio'),('cholesterol',1,'XaEUs','Serum cholesterol/LDL ratio'),('cholesterol',1,'XaEUt','Plasma cholesterol/LDL ratio'),('cholesterol',1,'XaEUu','Serum cholesterol/VLDL ratio'),('cholesterol',1,'XaEUv','Plasma cholesterol/VLDL ratio'),('cholesterol',1,'XaEVQ','Serum LDL/HDL ratio'),('cholesterol',1,'XaEVr','Plasma HDL cholesterol level'),('cholesterol',1,'XaEVR','Plasma LDL/HDL ratio'),('cholesterol',1,'XaEVs','Plasma LDL cholesterol level'),('cholesterol',1,'XaFs9','Fasting cholesterol level'),('cholesterol',1,'XaIp4','Calculated LDL cholesterol lev'),('cholesterol',1,'XaIqd','Pre-treatmnt serum cholest lev'),('cholesterol',1,'XaIRd','Plasma total cholesterol level'),('cholesterol',1,'XaIYp','Fluid sample cholesterol level'),('cholesterol',1,'XaJe9','Serum total cholesterol level'),('cholesterol',1,'XaLux','Serum fastng total cholesterol'),('cholesterol',1,'XaN3z','Non HDL cholesterol level'),('cholesterol',1,'XE28o','HDL : LDL ratio'),('cholesterol',1,'XE2eD','Serum cholesterol'),('cholesterol',1,'XE2mn','Ser HDL/non-HDL cholest ratio'),('cholesterol',1,'XSK14','Total cholesterol measurement'),('cholesterol',1,'44P..','Serum cholesterol'),('cholesterol',1,'44PZ.','Serum cholesterol NOS'),('cholesterol',1,'44PL.','Non HDL cholesterol level'),('cholesterol',1,'44PL1','Estimated serum non-high density lipoprotein cholesterol level'),('cholesterol',1,'44PL0','Serum non high density lipoprotein cholesterol level'),('cholesterol',1,'44PK.','Serum fasting total cholesterol'),('cholesterol',1,'44PJ.','Serum total cholesterol level'),('cholesterol',1,'44PI.','Calculated LDL cholesterol level'),('cholesterol',1,'44PH.','Total cholesterol measurement'),('cholesterol',1,'44PG.','HDL : total cholesterol ratio'),('cholesterol',1,'44PF.','Total cholesterol:HDL ratio'),('cholesterol',1,'44PE.','Serum random LDL cholesterol level'),('cholesterol',1,'44PD.','Serum fasting LDL cholesterol level'),('cholesterol',1,'44PC.','Serum random HDL cholesterol level'),('cholesterol',1,'44PB.','Serum fasting HDL cholesterol level'),('cholesterol',1,'44P9.','Serum cholesterol studies'),('cholesterol',1,'44P8.','Serum HDL:non-HDL cholesterol ratio'),('cholesterol',1,'44P7.','Serum VLDL cholesterol level'),('cholesterol',1,'44P6.','Serum LDL cholesterol level'),('cholesterol',1,'44P5.','Serum HDL cholesterol level'),('cholesterol',1,'44P4.','Serum cholesterol very high'),('cholesterol',1,'44P3.','Serum cholesterol raised'),('cholesterol',1,'44P2.','Serum cholesterol borderline'),('cholesterol',1,'44P1.','Serum cholesterol normal'),('cholesterol',1,'44PA.','HDL : LDL ratio'),('cholesterol',1,'44lM.','Plasma LDL/HDL ratio'),('cholesterol',1,'44lL.','Serum LDL/HDL ratio'),('cholesterol',1,'44lK.','Plasma cholesterol/VLDL ratio'),('cholesterol',1,'44lJ.','Serum cholesterol/VLDL ratio'),('cholesterol',1,'44lI.','Plasma cholesterol/LDL ratio'),('cholesterol',1,'44lH.','Serum cholesterol/LDL ratio'),('cholesterol',1,'44lG.','Plasma cholesterol/HDL ratio'),('cholesterol',1,'44lF.','Serum cholesterol/HDL ratio'),('cholesterol',1,'44l2.','Cholesterol/HDL ratio'),('cholesterol',1,'44dB.','Plasma LDL cholesterol level'),('cholesterol',1,'44dA.','Plasma HDL cholesterol level'),('cholesterol',1,'44d5.','Plasma fasting LDL cholesterol level'),('cholesterol',1,'44d4.','Plasma random LDL cholesterol level'),('cholesterol',1,'44d3.','Plasma fasting HDL cholesterol level'),('cholesterol',1,'44d2.','Plasma random HDL cholesterol level'),('cholesterol',1,'44R4.','LDL - electrophoresis'),('cholesterol',1,'44R4.','Lipoprotein electroph. - LDL'),('cholesterol',1,'44R3.','HDL - electrophoresis'),('cholesterol',1,'44R3.','Lipoprotein electroph. - HDL'),('cholesterol',1,'662a.','Pre-treatment serum cholesterol level'),('cholesterol',1,'44OE.','Plasma total cholesterol level'),('cholesterol',1,'44lzY','Serum high density lipoprotein cholesterol:triglyceride ratio'),('cholesterol',1,'4I3O.','Fluid sample cholesterol level'),('cholesterol',2,'XSK14','Total cholesterol measurement'),('cholesterol',2,'44PH.','Total cholesterol measurement'),('cholesterol',2,'44PJ.','Serum total cholesterol level'),('cholesterol',2,'44P..','Serum cholesterol'),('cholesterol',2,'44PZ.','Serum cholesterol NOS'),('cholesterol',2,'XE2eD','Serum cholesterol'),('cholesterol',2,'XaJe9','Serum total cholesterol level');
INSERT INTO #codesctv3
VALUES ('creatinine',1,'XE2q5','Serum creatinine'),('creatinine',1,'XE2q5','Serum creatinine level'),('creatinine',1,'XaERc','Corrected serum creatinine level'),('creatinine',1,'XaERX','Corrected plasma creatinine level'),('creatinine',1,'44J3z','Serum creatinine NOS');
INSERT INTO #codesctv3
VALUES ('diastolic-blood-pressure',1,'X779S','DAP-Diastolic arterial pressur'),('diastolic-blood-pressure',1,'X779T','DAP-Diastolic arterial pressur'),('diastolic-blood-pressure',1,'Xac5K','Baseline diastolic BP'),('diastolic-blood-pressure',1,'Xaedp','Non-invasive centrl diastlc BP'),('diastolic-blood-pressure',1,'XaF4a','Ave day diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4b','Ave 24h diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4e','24h diastolic blood pressure'),('diastolic-blood-pressure',1,'XaF4Q','Min diastolic blood pressure'),('diastolic-blood-pressure',1,'XaF4R','Max diastolic blood pressure'),('diastolic-blood-pressure',1,'XaF4S','Ave diastolic blood pressure'),('diastolic-blood-pressure',1,'XaF4T','Min day diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4U','Min night diast blood pressure'),('diastolic-blood-pressure',1,'XaF4V','Min 24h diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4W','Max night diast blood pressure'),('diastolic-blood-pressure',1,'XaF4X','Max day diast blood pressure'),('diastolic-blood-pressure',1,'XaF4Y','Max 24h diastol blood pressure'),('diastolic-blood-pressure',1,'XaF4Z','Ave night diast blood pressure'),('diastolic-blood-pressure',1,'XaIwk','Standing diastolic BP'),('diastolic-blood-pressure',1,'XaJ2F','Sitting diastolic BP'),('diastolic-blood-pressure',1,'XaJ2H','Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'XaKFw','Average home diastolic BP'),('diastolic-blood-pressure',1,'XaKjG','Ambulatory diastolic BP'),('diastolic-blood-pressure',1,'XaYg8','Diastolic BP centile'),('diastolic-blood-pressure',1,'XM02Y','DAP-Diastolic arterial pressur'),('diastolic-blood-pressure',1,'246o1','Non-invasive central diastolic blood pressure'),('diastolic-blood-pressure',1,'246n0','Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'246m.','Average diastolic blood pressure'),('diastolic-blood-pressure',1,'246i.','Diastolic blood pressure centile'),('diastolic-blood-pressure',1,'246f.','Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'246c.','Average home diastolic blood pressure'),('diastolic-blood-pressure',1,'246a.','Average night interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246X.','Average day interval diastolic blood pressure'),('diastolic-blood-pressure',1,'246V.','Average 24 hour diastolic blood pressure'),('diastolic-blood-pressure',1,'246T.','Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'246R.','Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'246P.','Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'246L.','Target diastolic blood pressure'),('diastolic-blood-pressure',1,'246A.','O/E - Diastolic BP reading');
INSERT INTO #codesctv3
VALUES ('egfr',1,'X70kK','Tc99m-DTPA clearance - GFR'),('egfr',1,'X70kL','Cr51- EDTA clearance - GFR'),('egfr',1,'X90kf','With GFR'),('egfr',1,'XaK8y','Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'XaMDA','Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'XaZpN','Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'XacUJ','Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'XacUK','Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres');
INSERT INTO #codesctv3
VALUES ('hba1c',1,'X772q','Haemoglobin A1c level'),('hba1c',1,'XE24t','Hb. A1C - diabetic control'),('hba1c',1,'42W1.','Hb. A1C < 7% - good control'),('hba1c',1,'42W2.','Hb. A1C 7-10% - borderline'),('hba1c',1,'42W3.','Hb. A1C > 10% - bad control'),('hba1c',1,'42WZ.','Hb. A1C - diabetic control NOS'),('hba1c',1,'X80U4','Glycosylat haemoglobin-c frac'),('hba1c',1,'XaCES','HbA1 - diabetic control'),('hba1c',1,'XaCET','HbA1 <7% - good control'),('hba1c',1,'XaCEV','HbA1 >10% - bad control'),('hba1c',1,'XaCEU','HbA1 7-10% - borderline contrl'),('hba1c',1,'XaERp','HbA1c level (DCCT aligned)'),('hba1c',1,'XaPbt','HbA1c levl - IFCC standardised'),('hba1c',1,'XabrE','HbA1c (diagnostic refrn range)'),('hba1c',1,'XabrF','HbA1c (monitoring ranges)'),('hba1c',1,'Xaezd','HbA1c(diagnos ref rnge)IFCC st'),('hba1c',1,'Xaeze','HbA1c(monitoring rnges)IFCC st'),('hba1c',1,'42W..','Hb. A1C - diabetic control'),('hba1c',1,'42W5.','Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',1,'42W51','HbA1c (haemoglobin A1c) level (monitoring ranges) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W50','HbA1c (haemoglobin A1c) level (diagnostic reference range) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'42W4.','HbA1c level (DCCT aligned)'),('hba1c',1,'44TB.','Haemoglobin A1c level'),('hba1c',1,'44TB1','Haemoglobin A1c (monitoring ranges)'),('hba1c',1,'44TB0','Haemoglobin A1c (diagnostic reference range)'),('hba1c',2,'XaERp','HbA1c level (DCCT aligned)'),('hba1c',2,'XaPbt','HbA1c levl - IFCC standardised'),('hba1c',2,'42W5.','Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',2,'42W4.','HbA1c level (DCCT aligned)');
INSERT INTO #codesctv3
VALUES ('hdl-cholesterol',1,'44P5.','Serum HDL cholesterol level'),('hdl-cholesterol',1,'44PC.','Ser random HDL cholesterol lev'),('hdl-cholesterol',1,'XaEVr','Plasma HDL cholesterol level');
INSERT INTO #codesctv3
VALUES ('ldl-cholesterol',1,'44P6.','Serum LDL cholesterol level'),('ldl-cholesterol',1,'XaIp4','Calculated LDL cholesterol lev'),('ldl-cholesterol',1,'XaEVs','Plasma LDL cholesterol level');
INSERT INTO #codesctv3
VALUES ('systolic-blood-pressure',1,'X779Q','Non-invasive systol art press'),('systolic-blood-pressure',1,'X779R','Invasive systol arterial press'),('systolic-blood-pressure',1,'Xac5L','Baseline systolic BP'),('systolic-blood-pressure',1,'Xaedo','Non-invasive central systlc BP'),('systolic-blood-pressure',1,'XaF4d','24h systolic blood pressure'),('systolic-blood-pressure',1,'XaF4D','Min systolic blood pressure'),('systolic-blood-pressure',1,'XaF4E','Max systolic blood pressure'),('systolic-blood-pressure',1,'XaF4F','Ave systolic blood pressure'),('systolic-blood-pressure',1,'XaF4G','Min day systol blood pressure'),('systolic-blood-pressure',1,'XaF4H','Min night syst blood pressure'),('systolic-blood-pressure',1,'XaF4I','Max night syst blood pressure'),('systolic-blood-pressure',1,'XaF4J','Max day syst blood pressure'),('systolic-blood-pressure',1,'XaF4K','Ave night syst blood pressure'),('systolic-blood-pressure',1,'XaF4L','Ave day systol blood pressure'),('systolic-blood-pressure',1,'XaF4M','Min 24h systol blood pressure'),('systolic-blood-pressure',1,'XaF4N','Max 24h systol blood pressure'),('systolic-blood-pressure',1,'XaF4O','Ave 24h systol blood pressure'),('systolic-blood-pressure',1,'XaIwj','Standing systolic BP'),('systolic-blood-pressure',1,'XaJ2E','Sitting systolic BP'),('systolic-blood-pressure',1,'XaJ2G','Lying systolic blood pressure'),('systolic-blood-pressure',1,'XaKFx','Average home systolic BP'),('systolic-blood-pressure',1,'XaKjF','Ambulatory systolic BP'),('systolic-blood-pressure',1,'XaXfX','Post exerc sys BP respons norm'),('systolic-blood-pressure',1,'XaXfY','Post exer sys BP respon abnorm'),('systolic-blood-pressure',1,'XaYg9','Systolic BP centile'),('systolic-blood-pressure',1,'XM02X','SAP - Systol arterial pressure'),('systolic-blood-pressure',1,'246o0','Non-invasive central systolic blood pressure'),('systolic-blood-pressure',1,'246n1','Baseline systolic blood pressure'),('systolic-blood-pressure',1,'246l.','Average systolic blood pressure'),('systolic-blood-pressure',1,'246j.','Systolic blood pressure centile'),('systolic-blood-pressure',1,'246e.','Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'246d.','Average home systolic blood pressure'),('systolic-blood-pressure',1,'246b.','Average night interval systolic blood pressure'),('systolic-blood-pressure',1,'246Y.','Average day interval systolic blood pressure'),('systolic-blood-pressure',1,'246W.','Average 24 hour systolic blood pressure'),('systolic-blood-pressure',1,'246S.','Lying systolic blood pressure'),('systolic-blood-pressure',1,'246Q.','Sitting systolic blood pressure'),('systolic-blood-pressure',1,'246N.','Standing systolic blood pressure'),('systolic-blood-pressure',1,'246K.','Target systolic blood pressure'),('systolic-blood-pressure',1,'2469.','O/E - Systolic BP reading');
INSERT INTO #codesctv3
VALUES ('triglycerides',1,'XE2q9','Serum triglycerides'),('triglycerides',1,'XE2q9','Serum triglyceride levels'),('triglycerides',1,'44Q4.','Serum fasting triglyceride level'),('triglycerides',1,'44QZ.','Serum triglycerides NOS');
INSERT INTO #codesctv3
VALUES ('urinary-albumin-creatinine-ratio',1,'46TC.','Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'XE2n3','Urine albumin:creatinine ratio')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesctv3;

IF OBJECT_ID('tempdb..#codessnomed') IS NOT NULL DROP TABLE #codessnomed;
CREATE TABLE #codessnomed (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codessnomed
VALUES ('bmi',1,'6497000','Decreased body mass index (finding)'),('bmi',1,'35425004','Normal body mass index (finding)'),('bmi',1,'48499001','Increased body mass index (finding)'),('bmi',1,'162863004','Body mass index 25-29 - overweight'),('bmi',1,'162864005','BMI 30+ - obesity'),('bmi',1,'301331008','Observation of body mass index'),('bmi',1,'310252000','BMI less than 20'),('bmi',1,'408512008','Body mass index 40+ - morbidly obese'),('bmi',1,'412768003','Body mass index 20-24 - normal'),('bmi',1,'427090001','Body mass index less than 16.5'),('bmi',1,'450451007','Childhood overweight BMI greater than 85 percentile'),('bmi',1,'722595002','Overweight in adulthood with BMI of 25 or more but less than 30'),('bmi',1,'920141000000102','Child BMI (body mass index) less than 0.4th centile'),('bmi',1,'920161000000101','Child BMI (body mass index) 0.4th-1.9th centile'),('bmi',1,'920181000000105','Child BMI (body mass index) on 2nd centile'),('bmi',1,'920201000000109','Child BMI (body mass index) 3rd-8th centile'),('bmi',1,'920231000000103','Child BMI (body mass index) on 9th centile'),('bmi',1,'920251000000105','Child BMI (body mass index) 10th-24th centile'),('bmi',1,'920271000000101','Child BMI (body mass index) on 25th centile'),('bmi',1,'920291000000102','Child BMI (body mass index) 26th-49th centile'),('bmi',1,'920311000000101','Child BMI (body mass index) on 50th centile'),('bmi',1,'920841000000108','Child BMI (body mass index) 51st-74th centile'),('bmi',1,'920931000000108','Child BMI (body mass index) on 75th centile'),('bmi',1,'920951000000101','Child BMI (body mass index) 76th-90th centile'),('bmi',1,'920971000000105','Child BMI (body mass index) on 91st centile'),('bmi',1,'920991000000109','Child BMI (body mass index) 92nd-97th centile'),('bmi',1,'921011000000105','Child BMI (body mass index) on 98th centile'),('bmi',1,'921031000000102','Child BMI (body mass index) 98.1st-99.6th centile'),('bmi',1,'921051000000109','Child BMI (body mass index) greater than 99.6th centile'),('bmi',1,'914721000000105','Obese class I (body mass index 30.0 - 34.9)'),('bmi',1,'914731000000107','Obese class II (body mass index 35.0 - 39.9)'),('bmi',1,'914741000000103','Obese class III (body mass index equal to or greater than 40.0)'),('bmi',1,'443371000124107','Body mass index 30.00 to 34.99'),('bmi',1,'443381000124105','Body mass index 35.00 to 39.99'),('bmi',1,'60621009','Quetelet index'),('bmi',1,'846931000000101','Baseline BMI (body mass index)'),('bmi',1,'852451000000103','Maximum body mass index (observable entity)'),('bmi',1,'852461000000100','Minimum body mass index (observable entity)'),('bmi',1,'446974000','Body mass index centile'),('bmi',1,'846911000000109','Baseline BMI (body mass index) centile'),('bmi',1,'896691000000102','Child BMI (body mass index) centile'),('bmi',1,'926011000000101','Downs syndrome BMI (body mass index) centile'),('bmi',1,'722562008','Foetal or neonatal effect or suspected effect of maternal obesity with adult body mass index 30 or greater but less than 40'),('bmi',1,'722563003','Foetal or neonatal effect of maternal obesity with adult body mass index equal to or greater than 40'),('bmi',1,'705131003','Child at risk for overweight body mass index greater than 85 percentile'),('bmi',1,'43991000119102','History of childhood obesity BMI 95-100 percentile'),('bmi',1,'698094009','Calculation of body mass index'),('bmi',1,'444862003','Childhood obesity BMI 95-100 percentile'),('bmi',2,'301331008','Finding of body mass index (finding)');
INSERT INTO #codessnomed
VALUES ('smoking-status-current',1,'266929003','Smoking started (life style)'),('smoking-status-current',1,'836001000000109','Waterpipe tobacco consumption (observable entity)'),('smoking-status-current',1,'77176002','Smoker (life style)'),('smoking-status-current',1,'65568007','Cigarette smoker (life style)'),('smoking-status-current',1,'394873005','Not interested in stopping smoking (finding)'),('smoking-status-current',1,'394872000','Ready to stop smoking (finding)'),('smoking-status-current',1,'394871007','Thinking about stopping smoking (observable entity)'),('smoking-status-current',1,'266918002','Tobacco smoking consumption (observable entity)'),('smoking-status-current',1,'230057008','Cigar consumption (observable entity)'),('smoking-status-current',1,'230056004','Cigarette consumption (observable entity)'),('smoking-status-current',1,'160623006','Smoking: [started] or [restarted]'),('smoking-status-current',1,'160622001','Smoker (& cigarette)'),('smoking-status-current',1,'160619003','Rolls own cigarettes (finding)'),('smoking-status-current',1,'160616005','Trying to give up smoking (finding)'),('smoking-status-current',1,'160612007','Keeps trying to stop smoking (finding)'),('smoking-status-current',1,'160606002','Very heavy cigarette smoker (40+ cigs/day) (life style)'),('smoking-status-current',1,'160605003','Heavy cigarette smoker (20-39 cigs/day) (life style)'),('smoking-status-current',1,'160604004','Moderate cigarette smoker (10-19 cigs/day) (life style)'),('smoking-status-current',1,'160603005','Light cigarette smoker (1-9 cigs/day) (life style)'),('smoking-status-current',1,'59978006','Cigar smoker (life style)'),('smoking-status-current',1,'446172000','Failed attempt to stop smoking (finding)'),('smoking-status-current',1,'413173009','Minutes from waking to first tobacco consumption (observable entity)'),('smoking-status-current',1,'401201003','Cigarette pack-years (observable entity)'),('smoking-status-current',1,'401159003','Reason for restarting smoking (observable entity)'),('smoking-status-current',1,'308438006','Smoking restarted (life style)'),('smoking-status-current',1,'230058003','Pipe tobacco consumption (observable entity)'),('smoking-status-current',1,'134406006','Smoking reduced (observable entity)'),('smoking-status-current',1,'82302008','Pipe smoker (life style)');
INSERT INTO #codessnomed
VALUES ('smoking-status-currently-not',1,'160618006','Current non-smoker (life style)'),('smoking-status-currently-not',1,'8392000','Non-smoker (life style)');
INSERT INTO #codessnomed
VALUES ('smoking-status-ex',1,'160617001','Stopped smoking (life style)'),('smoking-status-ex',1,'160620009','Ex-pipe smoker (life style)'),('smoking-status-ex',1,'160621008','Ex-cigar smoker (life style)'),('smoking-status-ex',1,'160625004','Date ceased smoking (observable entity)'),('smoking-status-ex',1,'266922007','Ex-light cigarette smoker (1-9/day) (life style)'),('smoking-status-ex',1,'266923002','Ex-moderate cigarette smoker (10-19/day) (life style)'),('smoking-status-ex',1,'266924008','Ex-heavy cigarette smoker (20-39/day) (life style)'),('smoking-status-ex',1,'266925009','Ex-very heavy cigarette smoker (40+/day) (life style)'),('smoking-status-ex',1,'281018007','Ex-cigarette smoker (life style)'),('smoking-status-ex',1,'395177003','Smoking free weeks (observable entity)'),('smoking-status-ex',1,'492191000000103','Ex roll-up cigarette smoker (finding)'),('smoking-status-ex',1,'517211000000106','Recently stopped smoking (finding)'),('smoking-status-ex',1,'8517006','Ex-smoker (life style)');
INSERT INTO #codessnomed
VALUES ('smoking-status-ex-trivial',1,'266921000','Ex-trivial cigarette smoker (<1/day) (life style)');
INSERT INTO #codessnomed
VALUES ('smoking-status-never',1,'160601007','Non-smoker (& [never smoked tobacco])'),('smoking-status-never',1,'266919005','Never smoked tobacco (life style)');
INSERT INTO #codessnomed
VALUES ('smoking-status-passive',1,'43381005','Passive smoker (finding)'),('smoking-status-passive',1,'161080002','Passive smoking risk (environment)'),('smoking-status-passive',1,'228523000','Exposed to tobacco smoke at work (finding)'),('smoking-status-passive',1,'228524006','Exposed to tobacco smoke at home (finding)'),('smoking-status-passive',1,'228525007','Exposed to tobacco smoke in public places (finding)'),('smoking-status-passive',1,'713142003','At risk from passive smoking (finding)'),('smoking-status-passive',1,'722451000000101','Passive smoking (qualifier value)');
INSERT INTO #codessnomed
VALUES ('smoking-status-trivial',1,'266920004','Trivial cigarette smoker (less than one cigarette/day) (life style)'),('smoking-status-trivial',1,'428041000124106','Occasional tobacco smoker (finding)');
INSERT INTO #codessnomed
VALUES ('cholesterol',1,'13067005','Cholesteryl esters measurement (procedure)'),('cholesterol',1,'17888004','High density lipoprotein measurement (procedure)'),('cholesterol',1,'28036006','High density lipoprotein cholesterol level'),('cholesterol',1,'77068002','Cholesterol measurement (procedure)'),('cholesterol',1,'104583003','High density lipoprotein/total cholesterol ratio measurement'),('cholesterol',1,'104584009','Intermediate density lipoprotein cholesterol measurement'),('cholesterol',1,'104585005','Very low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'104586006','Cholesterol/triglyceride ratio measurement (procedure)'),('cholesterol',1,'104594004','Cholesterol esterase measurement (procedure)'),('cholesterol',1,'104777003','Lecithin cholesterol acyltransferase measurement (procedure)'),('cholesterol',1,'104781003','Lipids, cholesterol measurement (procedure)'),('cholesterol',1,'104990004','Triglyceride and ester in high density lipoprotein measurement (procedure)'),('cholesterol',1,'104992007','Triglyceride and ester in low density lipoprotein measurement'),('cholesterol',1,'113079009','Low density lipoprotein cholesterol level'),('cholesterol',1,'121751004','Cholesterol sulfate measurement (procedure)'),('cholesterol',1,'121868005','Total cholesterol measurement (procedure)'),('cholesterol',1,'166832000','Serum high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166833005','Serum low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166834004','Serum very low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166838001','Serum fasting high density lipoprotein cholesterol measurement'),('cholesterol',1,'166839009','Serum random high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166840006','Serum fasting low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'166841005','Serum random low density lipoprotein cholesterol measurement'),('cholesterol',1,'166842003','Total cholesterol:high density lipoprotein ratio measurement'),('cholesterol',1,'167072001','Plasma random high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'167073006','Plasma fasting high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'167074000','Plasma random low density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'167075004','Plasma fasting low density lipoprotein cholesterol measurement'),('cholesterol',1,'250743005','HDL/LDL ratio'),('cholesterol',1,'250759005','Measurement of percentage cholesterol as ester (procedure)'),('cholesterol',1,'271059008','Serum high density lipoprotein/non-high density lipoprotein cholesterol ratio measurement (procedure)'),('cholesterol',1,'313811003','Cholesterol/High density lipoprotein ratio measurement'),('cholesterol',1,'313988001','Lipoprotein cholesterol ratio measurement (procedure)'),('cholesterol',1,'313989009','Serum cholesterol/high density lipoprotein ratio measurement'),('cholesterol',1,'313990000','Plasma cholesterol/high density lipoprotein ratio measurement'),('cholesterol',1,'313991001','Serum cholesterol/low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'313992008','Plasma cholesterol/low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'313993003','Serum cholesterol/very low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'313994009','Plasma cholesterol/very low density lipoprotein ratio measurement'),('cholesterol',1,'314012003','Serum low density lipoprotein/high density lipoprotein ratio measurement'),('cholesterol',1,'314013008','Plasma low density lipoprotein/high density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'314035000','Plasma high density lipoprotein cholesterol measurement (procedure)'),('cholesterol',1,'314036004','Plasma low density lipoprotein cholesterol measurement'),('cholesterol',1,'315017003','Fasting cholesterol level (procedure)'),('cholesterol',1,'390956002','Plasma total cholesterol level'),('cholesterol',1,'391291008','Fluid sample cholesterol level'),('cholesterol',1,'395065005','Calculated low density lipoprotein cholesterol level (procedure)'),('cholesterol',1,'395153009','Pre-treatment serum cholesterol level'),('cholesterol',1,'412808005','Serum total cholesterol level'),('cholesterol',1,'443915001','Measurement of total cholesterol and triglycerides'),('cholesterol',1,'789381000000104','Cholesterol/phospholipid ratio measurement (procedure)'),('cholesterol',1,'195861000000108','Cholesterol content measurement (procedure)'),('cholesterol',1,'293821000000103','Non high density lipoprotein cholesterol level'),('cholesterol',1,'194351000000100','Cholesterol/low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'194361000000102','Cholesterol/very low density lipoprotein ratio measurement (procedure)'),('cholesterol',1,'247801000000106','Serum fasting total cholesterol'),('cholesterol',1,'194801000000108','High density lipoprotein/non-high density lipoprotein cholesterol ratio measurement (procedure)'),('cholesterol',1,'912151000000109','Serum non high density lipoprotein cholesterol level'),('cholesterol',1,'920471000000100','Estimated serum non-high density lipoprotein cholesterol level'),('cholesterol',1,'1006191000000106','Serum non HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1102851000000101','Estimated serum non high density lipoprotein cholesterol level (observable entity)'),('cholesterol',1,'1030411000000101','Non HDL cholesterol level'),('cholesterol',1,'1005681000000107','Serum HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1015271000000109','Serum HDL (high density lipoprotein):non-HDL (high density lipoprotein) cholesterol ratio'),('cholesterol',1,'1015681000000109','Serum cholesterol/HDL (high density lipoprotein) ratio'),('cholesterol',1,'1015741000000109','Serum LDL (low density lipoprotein)/HDL (high density lipoprotein) ratio'),('cholesterol',1,'1015751000000107','Plasma LDL/HDL (low density lipoprotein/high density lipoprotein) ratio'),('cholesterol',1,'1010581000000101','Plasma HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1015701000000106','Serum cholesterol/LDL (low density lipoprotein) ratio'),('cholesterol',1,'1015711000000108','Plasma cholesterol/LDL (low density lipoprotein) ratio'),('cholesterol',1,'1010591000000104','Plasma LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1014501000000104','Calculated LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1022191000000100','Serum LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1003441000000101','Serum VLDL (very low density lipoprotein) cholesterol level'),('cholesterol',1,'1015721000000102','Serum cholesterol/VLDL (very low density lipoprotein) ratio'),('cholesterol',1,'1015731000000100','Plasma cholesterol/VLDL (very low density lipoprotein) ratio'),('cholesterol',1,'1024231000000104','Fluid sample cholesterol level'),('cholesterol',1,'1031421000000101','High density lipoprotein/total cholesterol ratio'),('cholesterol',1,'1026451000000102','Serum fasting HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1026461000000104','Serum random HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1107681000000108','HDL (high density lipoprotein) cholesterol molar concentration in serum'),('cholesterol',1,'1028831000000106','Plasma random HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1028841000000102','Plasma fasting HDL (high density lipoprotein) cholesterol level'),('cholesterol',1,'1107661000000104','HDL (high density lipoprotein) cholesterol molar concentration in plasma'),('cholesterol',1,'1028861000000101','Plasma fasting LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1028851000000104','Plasma random LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1026471000000106','Serum fasting LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1026481000000108','Serum random LDL (low density lipoprotein) cholesterol level'),('cholesterol',1,'1015691000000106','Plasma cholesterol/HDL (high density lipoprotein) ratio'),('cholesterol',1,'994351000000103','Serum total cholesterol level'),('cholesterol',1,'1005671000000105','Serum cholesterol level'),('cholesterol',1,'1017161000000104','Plasma total cholesterol level'),('cholesterol',1,'1107731000000104','Ratio of high density lipoprotein cholesterol to total cholesterol in plasma (observable entity)'),('cholesterol',1,'1107741000000108','Ratio of high density lipoprotein cholesterol to total cholesterol in serum (observable entity)'),('cholesterol',1,'1028551000000102','Total cholesterol:HDL (high density lipoprotein) ratio'),('cholesterol',1,'1029071000000109','HDL/LDL ratio'),('cholesterol',1,'1083861000000102','Serum HDL (high density lipoprotein) cholesterol/triglyceride ratio'),('cholesterol',1,'1083761000000106','Serum fasting total cholesterol level (observable entity)'),('cholesterol',1,'1106541000000101','Cholesterol molar concentration in serum'),('cholesterol',1,'1106531000000105','Cholesterol molar concentration in plasma'),('cholesterol',1,'9422000','Alpha-lipoprotein'),('cholesterol',1,'9556009','Acyl CoA cholesterol acyltransferase'),('cholesterol',1,'22244007','LDL - Low density lipoprotein'),('cholesterol',1,'73427004','Cholesterol ester'),('cholesterol',1,'88557001','LCAT - Lecithin cholesterol acyltransferase'),('cholesterol',1,'102741009','Free cholesterol'),('cholesterol',1,'115332003','High density lipoprotein subfraction 2'),('cholesterol',1,'115333008','High density lipoprotein subfraction 3'),('cholesterol',1,'416724002','Cholesterol derivative'),('cholesterol',1,'707084003','HDL cholesterol 2'),
('cholesterol',1,'707086001','HDL cholesterol 2a'),('cholesterol',1,'707091000','IDL cholesterol 1'),('cholesterol',1,'707092007','IDL cholesterol 2'),('cholesterol',1,'707093002','LDL cholesterol pattern A'),('cholesterol',1,'707094008','LDL cholesterol pattern BI'),('cholesterol',1,'707095009','LDL cholesterol pattern BII'),('cholesterol',1,'707096005','LDL cholesterol, acetylated'),('cholesterol',1,'707097001','LDL cholesterol, narrow density'),('cholesterol',1,'707098006','Cholesterol in lipoprotein a'),('cholesterol',1,'707099003','VLDL cholesterol 3'),('cholesterol',1,'707100006','VLDL cholesterol, acetylated'),('cholesterol',1,'707101005','VLDL cholesterol, beta'),('cholesterol',1,'707124003','HDL cholesterol 2b'),('cholesterol',1,'707125002','HDL cholesterol 3'),('cholesterol',1,'707126001','HDL cholesterol 3a'),('cholesterol',1,'707127005','HDL cholesterol 3c'),('cholesterol',1,'707128000','HDL cholesterol 3b'),('cholesterol',1,'712626002','Cholesterol in chylomicrons'),('cholesterol',1,'13644009','High cholesterol'),('cholesterol',1,'124055002','Decreased cholesterol esters (finding)'),('cholesterol',1,'166828006','Serum cholesterol normal (finding)'),('cholesterol',1,'166830008','Serum cholesterol raised (finding)'),('cholesterol',1,'166831007','Serum cholesterol very high (finding)'),('cholesterol',1,'365793008','Finding of cholesterol level'),('cholesterol',1,'365794002','Finding of serum cholesterol level'),('cholesterol',1,'370992007','High blood cholesterol/triglycerides'),('cholesterol',1,'398036000','Low density lipoprotein catabolic defect'),('cholesterol',1,'442234001','Serum cholesterol borderline high (finding)'),('cholesterol',1,'442350007','Serum cholesterol borderline low (finding)'),('cholesterol',1,'445445006','Raised low density lipoprotein cholesterol'),('cholesterol',1,'67991000119104','Serum cholesterol abnormal (finding)'),('cholesterol',1,'850981000000101','Cholesterol level (observable entity)'),('cholesterol',1,'852401000000104','Maximum cholesterol level (observable entity)'),('cholesterol',1,'852411000000102','Minimum cholesterol level (observable entity)'),('cholesterol',1,'853681000000104','Total cholesterol level (observable entity)'),('cholesterol',1,'404670008','Hollenhorst plaque'),('cholesterol',1,'166854003','Lipoprotein electrophoresis - High density lipoprotein (procedure)'),('cholesterol',1,'166855002','Lipoprotein electrophoresis - Low density lipoprotein'),('cholesterol',1,'124054003','Increased cholesterol esters (finding)'),('cholesterol',1,'439953004','Elevated cholesterol/high density lipoprotein ratio'),('cholesterol',1,'102857004','Urinary crystal, cholesterol (finding)'),('cholesterol',1,'939391000000100','Serum high density lipoprotein cholesterol:triglyceride ratio'),('cholesterol',2,'1005671000000105','Serum cholesterol level'),('cholesterol',2,'412808005','Serum total cholesterol level'),('cholesterol',2,'121868005','Total cholesterol measurement (procedure)'),('cholesterol',2,'994351000000103','Serum total cholesterol level');
INSERT INTO #codessnomed
VALUES ('diastolic-blood-pressure',1,'174255007','Non-invasive diastolic blood pressure'),('diastolic-blood-pressure',1,'251073000','Invasive diastolic blood pressure'),('diastolic-blood-pressure',1,'271650006','Diastolic arterial pressure'),('diastolic-blood-pressure',1,'314451001','Minimum diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314452008','Maximum diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314453003','Average diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314454009','Minimum day interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314455005','Minimum night interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314456006','Minimum 24 hour diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314457002','Maximum night interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314458007','Maximum day interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314459004','Maximum 24 hour diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314460009','Average night interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314461008','Average day interval diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314462001','Average 24 hour diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'314465004','24 hour diastolic blood pressure (observable entity)'),('diastolic-blood-pressure',1,'400975005','Standing diastolic blood pressure'),('diastolic-blood-pressure',1,'407555005','Sitting diastolic blood pressure'),('diastolic-blood-pressure',1,'407557002','Lying diastolic blood pressure'),('diastolic-blood-pressure',1,'413605002','Average home diastolic blood pressure'),('diastolic-blood-pressure',1,'446226005','Diastolic blood pressure on admission'),('diastolic-blood-pressure',1,'716632005','Baseline diastolic blood pressure'),('diastolic-blood-pressure',1,'198091000000104','Ambulatory diastolic blood pressure'),('diastolic-blood-pressure',1,'814081000000101','Diastolic blood pressure centile'),('diastolic-blood-pressure',1,'1091811000000102','Diastolic arterial pressure (observable entity)'),('diastolic-blood-pressure',1,'1036571000000105','Non-invasive central diastolic blood pressure'),('diastolic-blood-pressure',1,'23154005','Increased diastolic arterial pressure (finding)'),('diastolic-blood-pressure',1,'42689008','Decreased diastolic arterial pressure (finding)'),('diastolic-blood-pressure',1,'49844009','Abnormal diastolic arterial pressure (finding)'),('diastolic-blood-pressure',1,'53813002','Normal diastolic arterial pressure (finding)'),('diastolic-blood-pressure',1,'163031004','On examination - Diastolic BP reading');
INSERT INTO #codessnomed
VALUES ('egfr',1,'1011481000000105','eGFR (estimated glomerular filtration rate) using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'1011491000000107','eGFR (estimated glomerular filtration rate) using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'1020291000000106','GFR (glomerular filtration rate) calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'1107411000000104','eGFR (estimated glomerular filtration rate) by laboratory calculation'),('egfr',1,'241373003','Technetium-99m-diethylenetriamine pentaacetic acid clearance - glomerular filtration rate (procedure)'),('egfr',1,'262300005','With glomerular filtration rate'),('egfr',1,'737105002','GFR (glomerular filtration rate) calculation technique'),('egfr',1,'80274001','Glomerular filtration rate (observable entity)'),('egfr',1,'996231000000108','GFR (glomerular filtration rate) calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin');
INSERT INTO #codessnomed
VALUES ('hba1c',1,'1019431000000105','HbA1c level (Diabetes Control and Complications Trial aligned)'),('hba1c',1,'1003671000000109','Haemoglobin A1c level'),('hba1c',1,'1049301000000100','HbA1c (haemoglobin A1c) level (diagnostic reference range) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'1049321000000109','HbA1c (haemoglobin A1c) level (monitoring ranges) - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'1107481000000106','HbA1c (haemoglobin A1c) molar concentration in blood'),('hba1c',1,'999791000000106','Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised'),('hba1c',1,'1010941000000103','Haemoglobin A1c (monitoring ranges)'),('hba1c',1,'1010951000000100','Haemoglobin A1c (diagnostic reference range)'),('hba1c',1,'165679005','Haemoglobin A1c (HbA1c) less than 7% indicating good diabetic control'),('hba1c',1,'165680008','Haemoglobin A1c (HbA1c) between 7%-10% indicating borderline diabetic control'),('hba1c',1,'165681007','Hemoglobin A1c (HbA1c) greater than 10% indicating poor diabetic control'),('hba1c',1,'365845005','Haemoglobin A1C - diabetic control finding'),('hba1c',1,'444751005','High hemoglobin A1c level'),('hba1c',1,'43396009','Hemoglobin A1c measurement (procedure)'),('hba1c',1,'313835008','Hemoglobin A1c measurement aligned to the Diabetes Control and Complications Trial'),('hba1c',1,'371981000000106','Hb A1c (Haemoglobin A1c) level - IFCC (International Federation of Clinical Chemistry and Laboratory Medicine) standardised'),('hba1c',1,'444257008','Calculation of estimated average glucose based on haemoglobin A1c'),('hba1c',1,'269823000','Haemoglobin A1C - diabetic control interpretation'),('hba1c',1,'443911005','Ordinal level of hemoglobin A1c'),('hba1c',1,'733830002','HbA1c - Glycated haemoglobin-A1c'),('hba1c',2,'1019431000000105','HbA1c level (Diabetes Control and Complications Trial aligned)'),('hba1c',2,'999791000000106','Haemoglobin A1c level - International Federation of Clinical Chemistry and Laboratory Medicine standardised');
INSERT INTO #codessnomed
VALUES ('hdl-cholesterol',1,'1005681000000107','Serum high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1010581000000101','Plasma high density lipoprotein cholesterol level (observable entity)'),('hdl-cholesterol',1,'1026461000000104','Serum random high density lipoprotein cholesterol level (observable entity)');
INSERT INTO #codessnomed
VALUES ('ldl-cholesterol',1,'1010591000000104','Plasma low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1014501000000104','Calculated low density lipoprotein cholesterol level (observable entity)'),('ldl-cholesterol',1,'1022191000000100','Serum low density lipoprotein cholesterol level (observable entity)');
INSERT INTO #codessnomed
VALUES ('systolic-blood-pressure',1,'72313002','Systolic arterial pressure (observable entity)'),('systolic-blood-pressure',1,'251070002','Non-invasive systolic blood pressure'),('systolic-blood-pressure',1,'251071003','Invasive systolic blood pressure'),('systolic-blood-pressure',1,'271649006','SAP - Systolic arterial pressure'),('systolic-blood-pressure',1,'314438006','Minimum systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314439003','Maximum systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314440001','Average systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314441002','Minimum day interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314442009','Minimum night interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314443004','Maximum night interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314444005','Maximum day interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314445006','Average night interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314446007','Average day interval systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314447003','Minimum 24 hour systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314448008','Maximum 24 hour systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'314449000','Average 24 hour systolic blood pressure (observable entity'),('systolic-blood-pressure',1,'314464000','24 hour systolic blood pressure (observable entity)'),('systolic-blood-pressure',1,'399304008','Systolic blood pressure on admission'),('systolic-blood-pressure',1,'400974009','Standing systolic blood pressure'),('systolic-blood-pressure',1,'407554009','Sitting systolic blood pressure'),('systolic-blood-pressure',1,'407556006','Lying systolic blood pressure'),('systolic-blood-pressure',1,'413606001','Average home systolic blood pressure'),('systolic-blood-pressure',1,'716579001','Baseline systolic blood pressure'),('systolic-blood-pressure',1,'198081000000101','Ambulatory systolic blood pressure'),('systolic-blood-pressure',1,'814101000000107','Systolic blood pressure centile'),('systolic-blood-pressure',1,'1036551000000101','Non-invasive central systolic blood pressure'),('systolic-blood-pressure',1,'1087991000000109','Level of reduction in systolic blood pressure on standing (observable entity)'),('systolic-blood-pressure',1,'12929001','Normal systolic arterial pressure (finding)'),('systolic-blood-pressure',1,'18050000','Increased systolic arterial pressure (finding)'),('systolic-blood-pressure',1,'18352002','Abnormal systolic arterial pressure (finding)'),('systolic-blood-pressure',1,'81010002','Decreased systolic arterial pressure (finding)'),('systolic-blood-pressure',1,'163030003','On examination - Systolic blood pressure reading'),('systolic-blood-pressure',1,'707303003','Post exercise systolic blood pressure response abnormal'),('systolic-blood-pressure',1,'707304009','Post exercise systolic blood pressure response normal (finding)')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codessnomed;

IF OBJECT_ID('tempdb..#codesemis') IS NOT NULL DROP TABLE #codesemis;
CREATE TABLE #codesemis (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesemis
VALUES ('gestational-diabetes',1,'^ESCTGE801661','Gestational diabetes, delivered'),('gestational-diabetes',1,'^ESCTGE801662','Gestational diabetes mellitus complicating pregnancy');
INSERT INTO #codesemis
VALUES ('bmi',1,'EMISNQBM1','BMI centile');
INSERT INTO #codesemis
VALUES ('diastolic-blood-pressure',1,'EMISNQDI86','Diastolic blood pressure - left arm'),('diastolic-blood-pressure',1,'EMISNQDI87','Diastolic blood pressure - right arm');
INSERT INTO #codesemis
VALUES ('systolic-blood-pressure',1,'EMISNQSY8','Systolic blood pressure - left arm'),('systolic-blood-pressure',1,'EMISNQSY9','Systolic blood pressure - right arm')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesemis;


IF OBJECT_ID('tempdb..#TempRefCodes') IS NOT NULL DROP TABLE #TempRefCodes;
CREATE TABLE #TempRefCodes (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, version INT NOT NULL, [description] VARCHAR(255));

-- Read v2 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcr.concept, dcr.[version], dcr.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesreadv2 dcr on dcr.code = rc.MainCode
WHERE CodingType='ReadCodeV2'
and PK_Reference_Coding_ID != -1;

-- CTV3 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcc.concept, dcc.[version], dcc.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesctv3 dcc on dcc.code = rc.MainCode
WHERE CodingType='CTV3'
and PK_Reference_Coding_ID != -1;

-- EMIS codes with a FK Reference Coding ID
INSERT INTO #TempRefCodes
SELECT FK_Reference_Coding_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID != -1;

IF OBJECT_ID('tempdb..#TempSNOMEDRefCodes') IS NOT NULL DROP TABLE #TempSNOMEDRefCodes;
CREATE TABLE #TempSNOMEDRefCodes (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [version] INT NOT NULL, [description] VARCHAR(255));

-- SNOMED codes
INSERT INTO #TempSNOMEDRefCodes
SELECT PK_Reference_SnomedCT_ID, dcs.concept, dcs.[version], dcs.[description]
FROM SharedCare.Reference_SnomedCT rs
INNER JOIN #codessnomed dcs on dcs.code = rs.ConceptID;

-- EMIS codes with a FK SNOMED ID but without a FK Reference Coding ID
INSERT INTO #TempSNOMEDRefCodes
SELECT FK_Reference_SnomedCT_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID = -1
AND FK_Reference_SnomedCT_ID != -1;

-- De-duped tables
IF OBJECT_ID('tempdb..#CodeSets') IS NOT NULL DROP TABLE #CodeSets;
CREATE TABLE #CodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#SnomedSets') IS NOT NULL DROP TABLE #SnomedSets;
CREATE TABLE #SnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedCodeSets') IS NOT NULL DROP TABLE #VersionedCodeSets;
CREATE TABLE #VersionedCodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedSnomedSets') IS NOT NULL DROP TABLE #VersionedSnomedSets;
CREATE TABLE #VersionedSnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

INSERT INTO #VersionedCodeSets
SELECT DISTINCT * FROM #TempRefCodes;

INSERT INTO #VersionedSnomedSets
SELECT DISTINCT * FROM #TempSNOMEDRefCodes;

INSERT INTO #CodeSets
SELECT FK_Reference_Coding_ID, c.concept, [description]
FROM #VersionedCodeSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedCodeSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

INSERT INTO #SnomedSets
SELECT FK_Reference_SnomedCT_ID, c.concept, [description]
FROM #VersionedSnomedSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedSnomedSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

-- >>> Following code sets injected: hba1c v2/cholesterol v2/hdl-cholesterol v1/ldl-cholesterol v1/egfr v1/creatinine v1/triglycerides v1
-- >>> Following code sets injected: systolic-blood-pressure v1/diastolic-blood-pressure v1/urinary-albumin-creatinine-ratio v1
-- >>> Following code sets injected: smoking-status-current v1/smoking-status-currently-not v1/smoking-status-ex v1/smoking-status-ex-trivial v1/smoking-status-never v1/smoking-status-passive v1/smoking-status-trivial v1
-- >>> Following code sets injected: bmi v2/height v1/weight v1


------ Find the main cohort and the matched controls ---------

-- Set the start date
DECLARE @StartDate datetime;
SET @StartDate = '2019-07-09';

--Just want the output, not the messages
SET NOCOUNT ON;

-- Find all patients alive at start date
IF OBJECT_ID('tempdb..#PossiblePatients') IS NOT NULL DROP TABLE #PossiblePatients;
SELECT PK_Patient_Link_ID as FK_Patient_Link_ID, EthnicMainGroup, DeathDate INTO #PossiblePatients FROM [RLS].vw_Patient_Link
WHERE (DeathDate IS NULL OR DeathDate >= @StartDate);

-- Find all patients registered with a GP
IF OBJECT_ID('tempdb..#PatientsWithGP') IS NOT NULL DROP TABLE #PatientsWithGP;
SELECT DISTINCT FK_Patient_Link_ID INTO #PatientsWithGP FROM [RLS].vw_Patient
where FK_Reference_Tenancy_ID = 2;

-- Make cohort from patients alive at start date and registered with a GP
IF OBJECT_ID('tempdb..#Patients') IS NOT NULL DROP TABLE #Patients;
SELECT pp.* INTO #Patients FROM #PossiblePatients pp
INNER JOIN #PatientsWithGP gp on gp.FK_Patient_Link_ID = pp.FK_Patient_Link_ID;

-- >>> Following code sets injected: diabetes-type-ii v1/polycystic-ovarian-syndrome v1/gestational-diabetes v1

--┌─────┐
--│ Sex │
--└─────┘

-- OBJECTIVE: To get the Sex for each patient.

-- INPUT: Assumes there exists a temp table as follows:
-- #Patients (FK_Patient_Link_ID)
--  A distinct list of FK_Patient_Link_IDs for each patient in the cohort

-- OUTPUT: A temp table as follows:
-- #PatientSex (FK_Patient_Link_ID, Sex)
-- 	- FK_Patient_Link_ID - unique patient id
--	- Sex - M/F

-- ASSUMPTIONS:
--	- Patient data is obtained from multiple sources. Where patients have multiple sexes we determine the sex as follows:
--	-	If the patients has a sex in their primary care data feed we use that as most likely to be up to date
--	-	If every sex for a patient is the same, then we use that
--	-	If there is a single most recently updated sex in the database then we use that
--	-	Otherwise the patient's sex is considered unknown

-- Get all patients sex for the cohort
IF OBJECT_ID('tempdb..#AllPatientSexs') IS NOT NULL DROP TABLE #AllPatientSexs;
SELECT 
	FK_Patient_Link_ID,
	FK_Reference_Tenancy_ID,
	HDMModifDate,
	Sex
INTO #AllPatientSexs
FROM RLS.vw_Patient p
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
AND Sex IS NOT NULL;


-- If patients have a tenancy id of 2 we take this as their most likely Sex
-- as this is the GP data feed and so most likely to be up to date
IF OBJECT_ID('tempdb..#PatientSex') IS NOT NULL DROP TABLE #PatientSex;
SELECT FK_Patient_Link_ID, MIN(Sex) as Sex INTO #PatientSex FROM #AllPatientSexs
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
AND FK_Reference_Tenancy_ID = 2
GROUP BY FK_Patient_Link_ID;

-- Find the patients who remain unmatched
IF OBJECT_ID('tempdb..#UnmatchedSexPatients') IS NOT NULL DROP TABLE #UnmatchedSexPatients;
SELECT FK_Patient_Link_ID INTO #UnmatchedSexPatients FROM #Patients
EXCEPT
SELECT FK_Patient_Link_ID FROM #PatientSex;

-- If every Sex is the same for all their linked patient ids then we use that
INSERT INTO #PatientSex
SELECT FK_Patient_Link_ID, MIN(Sex) FROM #AllPatientSexs
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #UnmatchedSexPatients)
GROUP BY FK_Patient_Link_ID
HAVING MIN(Sex) = MAX(Sex);

-- Find any still unmatched patients
TRUNCATE TABLE #UnmatchedSexPatients;
INSERT INTO #UnmatchedSexPatients
SELECT FK_Patient_Link_ID FROM #Patients
EXCEPT
SELECT FK_Patient_Link_ID FROM #PatientSex;

-- If there is a unique most recent Sex then use that
INSERT INTO #PatientSex
SELECT p.FK_Patient_Link_ID, MIN(p.Sex) FROM #AllPatientSexs p
INNER JOIN (
	SELECT FK_Patient_Link_ID, MAX(HDMModifDate) MostRecentDate FROM #AllPatientSexs
	WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #UnmatchedSexPatients)
	GROUP BY FK_Patient_Link_ID
) sub ON sub.FK_Patient_Link_ID = p.FK_Patient_Link_ID AND sub.MostRecentDate = p.HDMModifDate
GROUP BY p.FK_Patient_Link_ID
HAVING MIN(Sex) = MAX(Sex);

-- Tidy up - helpful in ensuring the tempdb doesn't run out of space mid-query
DROP TABLE #AllPatientSexs;
DROP TABLE #UnmatchedSexPatients;
--┌───────────────┐
--│ Year of birth │
--└───────────────┘

-- OBJECTIVE: To get the year of birth for each patient.

-- INPUT: Assumes there exists a temp table as follows:
-- #Patients (FK_Patient_Link_ID)
--  A distinct list of FK_Patient_Link_IDs for each patient in the cohort

-- OUTPUT: A temp table as follows:
-- #PatientYearOfBirth (FK_Patient_Link_ID, YearOfBirth)
-- 	- FK_Patient_Link_ID - unique patient id
--	- YearOfBirth - INT

-- ASSUMPTIONS:
--	- Patient data is obtained from multiple sources. Where patients have multiple YOBs we determine the YOB as follows:
--	-	If the patients has a YOB in their primary care data feed we use that as most likely to be up to date
--	-	If every YOB for a patient is the same, then we use that
--	-	If there is a single most recently updated YOB in the database then we use that
--	-	Otherwise we take the highest YOB for the patient that is not in the future

-- Get all patients year of birth for the cohort
IF OBJECT_ID('tempdb..#AllPatientYearOfBirths') IS NOT NULL DROP TABLE #AllPatientYearOfBirths;
SELECT 
	FK_Patient_Link_ID,
	FK_Reference_Tenancy_ID,
	HDMModifDate,
	YEAR(Dob) AS YearOfBirth
INTO #AllPatientYearOfBirths
FROM RLS.vw_Patient p
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
AND Dob IS NOT NULL;


-- If patients have a tenancy id of 2 we take this as their most likely YOB
-- as this is the GP data feed and so most likely to be up to date
IF OBJECT_ID('tempdb..#PatientYearOfBirth') IS NOT NULL DROP TABLE #PatientYearOfBirth;
SELECT FK_Patient_Link_ID, MIN(YearOfBirth) as YearOfBirth INTO #PatientYearOfBirth FROM #AllPatientYearOfBirths
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
AND FK_Reference_Tenancy_ID = 2
GROUP BY FK_Patient_Link_ID;

-- Find the patients who remain unmatched
IF OBJECT_ID('tempdb..#UnmatchedYobPatients') IS NOT NULL DROP TABLE #UnmatchedYobPatients;
SELECT FK_Patient_Link_ID INTO #UnmatchedYobPatients FROM #Patients
EXCEPT
SELECT FK_Patient_Link_ID FROM #PatientYearOfBirth;

-- If every YOB is the same for all their linked patient ids then we use that
INSERT INTO #PatientYearOfBirth
SELECT FK_Patient_Link_ID, MIN(YearOfBirth) FROM #AllPatientYearOfBirths
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #UnmatchedYobPatients)
GROUP BY FK_Patient_Link_ID
HAVING MIN(YearOfBirth) = MAX(YearOfBirth);

-- Find any still unmatched patients
TRUNCATE TABLE #UnmatchedYobPatients;
INSERT INTO #UnmatchedYobPatients
SELECT FK_Patient_Link_ID FROM #Patients
EXCEPT
SELECT FK_Patient_Link_ID FROM #PatientYearOfBirth;

-- If there is a unique most recent YOB then use that
INSERT INTO #PatientYearOfBirth
SELECT p.FK_Patient_Link_ID, MIN(p.YearOfBirth) FROM #AllPatientYearOfBirths p
INNER JOIN (
	SELECT FK_Patient_Link_ID, MAX(HDMModifDate) MostRecentDate FROM #AllPatientYearOfBirths
	WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #UnmatchedYobPatients)
	GROUP BY FK_Patient_Link_ID
) sub ON sub.FK_Patient_Link_ID = p.FK_Patient_Link_ID AND sub.MostRecentDate = p.HDMModifDate
GROUP BY p.FK_Patient_Link_ID
HAVING MIN(YearOfBirth) = MAX(YearOfBirth);

-- Find any still unmatched patients
TRUNCATE TABLE #UnmatchedYobPatients;
INSERT INTO #UnmatchedYobPatients
SELECT FK_Patient_Link_ID FROM #Patients
EXCEPT
SELECT FK_Patient_Link_ID FROM #PatientYearOfBirth;

-- Otherwise just use the highest value (with the exception that can't be in the future)
INSERT INTO #PatientYearOfBirth
SELECT FK_Patient_Link_ID, MAX(YearOfBirth) FROM #AllPatientYearOfBirths
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #UnmatchedYobPatients)
GROUP BY FK_Patient_Link_ID
HAVING MAX(YearOfBirth) <= YEAR(GETDATE());

-- Tidy up - helpful in ensuring the tempdb doesn't run out of space mid-query
DROP TABLE #AllPatientYearOfBirths;
DROP TABLE #UnmatchedYobPatients;

-- FIND PATIENTS WITH A DIAGNOSIS OF POLYCYSTIC OVARY SYNDROME OR GESTATIONAL DIABETES, TO EXCLUDE

IF OBJECT_ID('tempdb..#exclusions') IS NOT NULL DROP TABLE #exclusions;
SELECT DISTINCT gp.FK_Patient_Link_ID
INTO #exclusions
FROM [RLS].[vw_GP_Events] gp
LEFT OUTER JOIN #Patients p ON p.FK_Patient_Link_ID = gp.FK_Patient_Link_ID
WHERE SuppliedCode IN 
	(SELECT [Code] FROM #AllCodes WHERE [Concept] IN 
		('polycystic-ovarian-syndrome', 'gestational-diabetes') AND [Version] = 1)
			AND EventDate BETWEEN '2018-07-09' AND '2022-03-31'

---- CREATE TABLE OF ALL PATIENTS THAT HAVE ANY LIFETIME DIAGNOSES OF T2D OF 2019-07-19

IF OBJECT_ID('tempdb..#diabetes2_diagnoses') IS NOT NULL DROP TABLE #diabetes2_diagnoses;
SELECT gp.FK_Patient_Link_ID, 
		YearOfBirth, 
		Sex,
		EthnicMainGroup,
		EventDate,
		SuppliedCode
INTO #diabetes2_diagnoses
FROM [RLS].[vw_GP_Events] gp
LEFT OUTER JOIN #Patients p ON p.FK_Patient_Link_ID = gp.FK_Patient_Link_ID
LEFT OUTER JOIN #PatientYearOfBirth yob ON yob.FK_Patient_Link_ID = p.FK_Patient_Link_ID
LEFT OUTER JOIN #PatientSex sex ON sex.FK_Patient_Link_ID = p.FK_Patient_Link_ID
WHERE (SuppliedCode IN 
	(SELECT [Code] FROM #AllCodes WHERE [Concept] IN ('diabetes-type-ii') AND [Version] = 1)) 
    AND gp.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
	AND gp.FK_Patient_Link_ID NOT IN (SELECT FK_Patient_Link_ID FROM #exclusions)
	AND (gp.EventDate) <= '2019-07-09'
	AND YEAR('2019-07-09') - yob.YearOfBirth >= 18


-- Define the main cohort to be matched
IF OBJECT_ID('tempdb..#MainCohort') IS NOT NULL DROP TABLE #MainCohort;
SELECT DISTINCT FK_Patient_Link_ID, 
		YearOfBirth, 
		Sex,
		EthnicMainGroup
INTO #MainCohort
FROM #diabetes2_diagnoses
--WHERE FK_Patient_Link_ID IN (#####INTERVENTION_TABLE)

/*

-- Define the population of potential matches for the cohort
IF OBJECT_ID('tempdb..#PotentialMatches') IS NOT NULL DROP TABLE #PotentialMatches;
SELECT DISTINCT p.FK_Patient_Link_ID, Sex, YearOfBirth
INTO #PotentialMatches
FROM #diabetes2_diagnoses
WHERE p.FK_Patient_Link_ID NOT IN (SELECT FK_Patient_Link_ID FROM #MainCohort)



--┌────────────────────────────────────────────────────┐
--│ Cohort matching on year of birth / sex 					   │
--└────────────────────────────────────────────────────┘

-- OBJECTIVE: To take a primary cohort and find a 1:n matched cohort based on year of birth and sex.

-- INPUT: Takes two parameters
--  - yob-flex: integer - number of years each way that still allow a year of birth match
--  - num-matches: integer - number of matches for each patient in the cohort
-- Requires two temp tables to exist as follows:
-- #MainCohort (FK_Patient_Link_ID, Sex, YearOfBirth)
-- 	- FK_Patient_Link_ID - unique patient id
--	- Sex - M/F
--	- YearOfBirth - Integer
-- #PotentialMatches (FK_Patient_Link_ID, Sex, YearOfBirth)
-- 	- FK_Patient_Link_ID - unique patient id
--	- Sex - M/F
--	- YearOfBirth - Integer

-- OUTPUT: A temp table as follows:
-- #CohortStore (FK_Patient_Link_ID, YearOfBirth, Sex, MatchingPatientId, MatchingYearOfBirth)
--  - FK_Patient_Link_ID - unique patient id for primary cohort patient
--  - YearOfBirth - of the primary cohort patient
--  - Sex - of the primary cohort patient
--  - MatchingPatientId - id of the matched patient
--  - MatchingYearOfBirth - year of birth of the matched patient

-- First we extend the #PrimaryCohort table to give each age-sex combo a unique number
-- and to avoid polluting the #MainCohort table
IF OBJECT_ID('tempdb..#Cases') IS NOT NULL DROP TABLE #Cases;
SELECT FK_Patient_Link_ID AS PatientId, YearOfBirth, Sex, Row_Number() OVER(PARTITION BY YearOfBirth, Sex ORDER BY FK_Patient_Link_ID) AS CaseRowNumber
INTO #Cases FROM #MainCohort;

-- Then we do the same with the #PotentialMatches
IF OBJECT_ID('tempdb..#Matches') IS NOT NULL DROP TABLE #Matches;
SELECT FK_Patient_Link_ID AS PatientId, YearOfBirth, Sex, Row_Number() OVER(PARTITION BY YearOfBirth, Sex ORDER BY FK_Patient_Link_ID) AS AssignedPersonNumber
INTO #Matches FROM #PotentialMatches;

-- Find the number of people with each characteristic in the main cohort
IF OBJECT_ID('tempdb..#CharacteristicCount') IS NOT NULL DROP TABLE #CharacteristicCount;
SELECT YearOfBirth, Sex, COUNT(*) AS [Count] INTO #CharacteristicCount FROM #Cases GROUP BY YearOfBirth, Sex;

-- Find the number of potential matches for each Age/Sex combination
-- The output of this is useful for seeing how many matches you can get
-- SELECT A.YearOfBirth, A.Sex, B.Count / A.Count AS NumberOfPotentialMatchesPerCohortPatient FROM (SELECT * FROM #CharacteristicCount) A LEFT OUTER JOIN (SELECT YearOfBirth, Sex, COUNT(*) AS [Count] FROM #Matches GROUP BY YearOfBirth, Sex) B ON B.YearOfBirth = A.YearOfBirth AND B.Sex = A.Sex ORDER BY NumberOfPotentialMatches,A.YearOfBirth,A.Sex;

-- The final table contains a row for each match, so e.g. if patient 1 has 4
-- matches then there will be 4 rows in the table for this.
IF OBJECT_ID('tempdb..#CohortStore') IS NOT NULL DROP TABLE #CohortStore;
CREATE TABLE #CohortStore(
  PatientId BIGINT, 
  YearOfBirth INT, 
  Sex nchar(1), 
  MatchingPatientId BIGINT,
  MatchingYearOfBirth INT
) ON [PRIMARY];

--1. First match try to match people exactly. We do this as follows:
--    - For each YOB/Sex combination we find all potential matches. E.g. all patients
--      in the potential matches with sex='F' and yob=1957
--    - We then try to assign a single match to all cohort members with sex='F' and yob=1957
--    - If there are still matches unused, we then assign a second match to all cohort members
--    - This continues until we either run out of matches, or successfully match everyone with
--      the desired number of matches.
DECLARE @Counter1 INT; 
SET @Counter1=1;
-- In this loop we find one match at a time for each patient in the cohort
WHILE ( @Counter1 <= 20)
BEGIN
  INSERT INTO #CohortStore
  SELECT c.PatientId, c.YearOfBirth, c.Sex, p.PatientId AS MatchedPatientId, c.YearOfBirth
  FROM #Cases c
    INNER JOIN #CharacteristicCount cc on cc.YearOfBirth = c.YearOfBirth and cc.Sex = c.Sex
    INNER JOIN #Matches p 
      ON p.Sex = c.Sex 
      AND p.YearOfBirth = c.YearOfBirth 
      -- This next line is the trick to only matching each person once
      AND p.AssignedPersonNumber = CaseRowNumber + (@counter1 - 1) * cc.[Count];

  -- We might not need this, but to be extra sure let's delete any patients who 
  -- we're already using to match people
  DELETE FROM #Matches WHERE PatientId IN (SELECT MatchingPatientId FROM #CohortStore);

  SET @Counter1  = @Counter1  + 1
END

--2. Now relax the yob restriction to get extra matches for people with no matches
DECLARE @LastRowInsert1 INT;
SET @LastRowInsert1=1;
WHILE ( @LastRowInsert1 > 0)
BEGIN
  INSERT INTO #CohortStore
  SELECT sub.PatientId, sub.YearOfBirth, sub.Sex, MatchedPatientId, MAX(m.YearOfBirth) FROM (
  SELECT c.PatientId, c.YearOfBirth, c.Sex, MAX(p.PatientId) AS MatchedPatientId, Row_Number() OVER(PARTITION BY MAX(p.PatientId) ORDER BY p.PatientId) AS AssignedPersonNumber
  FROM #Cases c
  INNER JOIN #Matches p 
    ON p.Sex = c.Sex 
    AND p.YearOfBirth >= c.YearOfBirth - 1
    AND p.YearOfBirth <= c.YearOfBirth + 1
  WHERE c.PatientId in (
    -- find patients who aren't currently matched
    select PatientId from #Cases except select PatientId from #CohortStore
  )
  GROUP BY c.PatientId, c.YearOfBirth, c.Sex, p.PatientId) sub
  INNER JOIN #Matches m 
    ON m.Sex = sub.Sex 
    AND m.PatientId = sub.MatchedPatientId
    AND m.YearOfBirth >= sub.YearOfBirth - 1
    AND m.YearOfBirth <= sub.YearOfBirth + 1
  WHERE sub.AssignedPersonNumber = 1
  GROUP BY sub.PatientId, sub.YearOfBirth, sub.Sex, MatchedPatientId;
  SELECT @LastRowInsert1=@@ROWCOUNT;

  DELETE FROM #Matches WHERE PatientId IN (SELECT MatchingPatientId FROM #CohortStore);
END

--3. Now relax the yob restriction to get extra matches for people with only 1, 2, 3, ... n-1 matches
DECLARE @Counter2 INT; 
SET @Counter2=1;
WHILE (@Counter2 < 20)
BEGIN
  DECLARE @LastRowInsert INT;
  SET @LastRowInsert=1;
  WHILE ( @LastRowInsert > 0)
  BEGIN

    IF OBJECT_ID('tempdb..#CohortPatientForEachMatchingPatient') IS NOT NULL DROP TABLE #CohortPatientForEachMatchingPatient;
    SELECT p.PatientId AS MatchedPatientId, c.PatientId, Row_Number() OVER(PARTITION BY p.PatientId ORDER BY p.PatientId) AS MatchedPatientNumber
    INTO #CohortPatientForEachMatchingPatient
    FROM #Matches p
    INNER JOIN #Cases c
      ON p.Sex = c.Sex 
      AND p.YearOfBirth >= c.YearOfBirth - 1
      AND p.YearOfBirth <= c.YearOfBirth + 1
    WHERE c.PatientId IN (
      -- find patients who only have @Counter2 matches
      SELECT PatientId FROM #CohortStore GROUP BY PatientId HAVING count(*) = @Counter2
    );

    IF OBJECT_ID('tempdb..#CohortPatientForEachMatchingPatientWithCohortNumbered') IS NOT NULL DROP TABLE #CohortPatientForEachMatchingPatientWithCohortNumbered;
    SELECT PatientId, MatchedPatientId, Row_Number() OVER(PARTITION BY PatientId ORDER BY MatchedPatientId) AS PatientNumber
    INTO #CohortPatientForEachMatchingPatientWithCohortNumbered
    FROM #CohortPatientForEachMatchingPatient
    WHERE MatchedPatientNumber = 1;

    INSERT INTO #CohortStore
    SELECT s.PatientId, c.YearOfBirth, c.Sex, MatchedPatientId, m.YearOfBirth FROM #CohortPatientForEachMatchingPatientWithCohortNumbered s
    LEFT OUTER JOIN #Cases c ON c.PatientId = s.PatientId
    LEFT OUTER JOIN #Matches m ON m.PatientId = MatchedPatientId
    WHERE PatientNumber = 1;

    SELECT @LastRowInsert=@@ROWCOUNT;

    DELETE FROM #Matches WHERE PatientId IN (SELECT MatchingPatientId FROM #CohortStore);
  END
  
  SET @Counter2  = @Counter2  + 1
END

-- Get the matched cohort detail - same as main cohort
IF OBJECT_ID('tempdb..#MatchedCohort') IS NOT NULL DROP TABLE #MatchedCohort;
SELECT 
  c.MatchingPatientId AS FK_Patient_Link_ID,
  Sex,
  MatchingYearOfBirth,
  EthnicMainGroup,
  PatientId AS PatientWhoIsMatched
INTO #MatchedCohort
FROM #CohortStore c
LEFT OUTER JOIN #Patients p ON p.FK_Patient_Link_ID = c.MatchingPatientId
LEFT OUTER JOIN #PatientIMDDecile imd ON imd.FK_Patient_Link_ID = c.MatchingPatientId
WHERE c.PatientId IN (SELECT FK_Patient_Link_ID FROM #Patients);

-- Define a table with all the patient ids for the main cohort and the matched cohort
IF OBJECT_ID('tempdb..#PatientIds') IS NOT NULL DROP TABLE #PatientIds;
SELECT PatientId AS FK_Patient_Link_ID INTO #PatientIds FROM #CohortStore
UNION
SELECT MatchingPatientId FROM #CohortStore;

*/

-- Get observation values for the cohort
IF OBJECT_ID('tempdb..#observations') IS NOT NULL DROP TABLE #observations;
SELECT 
	FK_Patient_Link_ID,
	CAST(EventDate AS DATE) AS EventDate,
	Concept = CASE WHEN sn.Concept IS NOT NULL THEN sn.Concept ELSE co.Concept END,
	[Version] =  CASE WHEN sn.[Version] IS NOT NULL THEN sn.[Version] ELSE co.[Version] END,
	[Value],
	[Units]
INTO #observations
FROM RLS.vw_GP_Events gp
LEFT JOIN #VersionedSnomedSets sn ON sn.FK_Reference_SnomedCT_ID = gp.FK_Reference_SnomedCT_ID
LEFT JOIN #VersionedCodeSets co ON co.FK_Reference_Coding_ID = gp.FK_Reference_Coding_ID
WHERE
	(gp.FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE Concept NOT IN 
	('polycystic-ovarian-syndrome', 'gestational-diabetes', 'diabetes-type-ii' )) OR
    gp.FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE Concept NOT IN 
	('polycystic-ovarian-syndrome', 'gestational-diabetes', 'diabetes-type-ii' )) )
AND gp.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #MainCohort)
AND EventDate BETWEEN '2016-04-01' AND '2022-03-31' 

-- WHERE CODES EXIST IN BOTH VERSIONS OF THE CODE SET (OR IN OTHER SIMILAR CODE SETS), THERE WILL BE DUPLICATES, SO EXCLUDE THEM FROM THE SETS/VERSIONS THAT WE DON'T WANT 

IF OBJECT_ID('tempdb..#all_observations') IS NOT NULL DROP TABLE #all_observations;
select 
	FK_Patient_Link_ID, CAST(EventDate AS DATE) EventDate, Concept, [Value], [Units], [Version]
into #all_observations
from #observations
except
select FK_Patient_Link_ID, EventDate, Concept, [Value], [Units], [Version] from #observations 
where 
	(Concept = 'cholesterol' and [Version] <> 2) OR -- e.g. serum HDL cholesterol appears in cholesterol v1 code set, which we don't want, but we do want the code as part of the hdl-cholesterol code set.
	(Concept = 'hba1c' and [Version] <> 2) OR -- e.g. hba1c level appears twice with same value: from version 1 and version 2. We only want version 2 so exclude any others.
	(Concept = 'bmi' and [Version] <> 2) -- e.g. BMI appears appears twice with same value: from version 1 and version 2. We only want version 2 so exclude any others.

-- REMOVE USELESS OBSERVATIONS WITH NO VALUE

IF OBJECT_ID('tempdb..#observations_final') IS NOT NULL DROP TABLE #observations_final;
SELECT FK_Patient_Link_ID,
	EventDate,
	Concept,
	[Value] = CASE WHEN Concept LIKE '%smoking%' THEN '1' ELSE TRY_CONVERT(NUMERIC (18,5), [Value]) END, -- simplify and standardise smoking values by assigning value to '1'. For any other tests, convert to numeric so no text can appear.
	[Units]
INTO #observations_final
FROM #all_observations
WHERE [Value] != '0' -- REMOVE NVARCHAR VALUES THAT ARE ZERO
	AND [Value] IS NOT NULL -- REMOVE ANY NULL VALUES

-- BRING TOGETHER FOR FINAL OUTPUT

SELECT	 
	PatientId = m.FK_Patient_Link_ID
	,NULL AS MainCohortMatchedPatientId
	,TestName = o.Concept
	,TestDate = o.EventDate
	,TestResult =o.[Value]
	,TestUnit = o.[Units]
FROM #MainCohort m
LEFT JOIN #observations_final o ON o.FK_Patient_Link_ID = m.FK_Patient_Link_ID 
WHERE  [Value] IS NOT NULL AND [Value] != '0' AND [Value] > 0 AND UPPER([Value]) NOT LIKE '%[A-Z]%'  -- EXTRA CHECKS IN CASE ANY ZERO, NULL OR TEXT VALUES REMAINED
/* UNION
-- patients in matched cohort
SELECT	 
	PatientId = m.FK_Patient_Link_ID
	,m.PatientWhoIsMatched AS MainCohortMatchedPatientId
	,TestName = o.Concept
	,TestDate = o.EventDate
	,TestResult = o.[Value]
	,TestUnit = o.[Units]
FROM #MatchedCohort m
LEFT JOIN #observations_final o ON o.FK_Patient_Link_ID = m.FK_Patient_Link_ID
WHERE  [Value] IS NOT NULL AND [Value] != '0' AND  [Value] > 0 AND UPPER([Value]) NOT LIKE '%[A-Z]%'  -- EXTRA CHECKS IN CASE ANY ZERO, NULL OR TEXT VALUES REMAINED

*/