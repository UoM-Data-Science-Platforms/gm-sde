--┌─────────────────────────────────────────┐
--│ Hospital stay information for cohort    │
--└─────────────────────────────────────────┘

------------ RESEARCH DATA ENGINEER CHECK ------------
------------------------------------------------------

-- OUTPUT: Data with the following fields
-- Patient Id
-- AdmissionDate (DD-MM-YYYY)
-- DischargeDate (DD-MM-YYYY)
-- LengthOfStay 
-- Hospital - ANONYMOUS

-- Set the start date
DECLARE @StartDate datetime;
DECLARE @EndDate datetime;
SET @StartDate = '2018-03-01';
SET @EndDate = '2023-08-31';

--Just want the output, not the messages
SET NOCOUNT ON;

--┌──────────────────────────────────────────────────────────────────────┐
--│ Define Cohort for RQ041: patients with biochemical evidence of CKD   │
--└──────────────────────────────────────────────────────────────────────┘

-- OBJECTIVE: To build the cohort of patients needed for RQ041. This reduces duplication of code in the template scripts.

-- COHORT: Any patient with biochemical evidence of CKD. More detail in the comments throughout this script.

-- INPUT: assumes there exists one temp table as follows:
-- #Patients (FK_Patient_Link_ID)
--  A distinct list of FK_Patient_Link_IDs for each patient in the cohort

-- OUTPUT: A temp table as follows:
-- #Cohort (FK_Patient_Link_ID)
-- #PatientEventData


DECLARE @StudyStartDate datetime;
SET @StudyStartDate = '2018-03-01';

--┌───────────────────────────────────────────────────────────┐
--│ Create table of patients who are registered with a GM GP  │
--└───────────────────────────────────────────────────────────┘

-- INPUT REQUIREMENTS: @StudyStartDate

-- Find all patients alive at start date
IF OBJECT_ID('tempdb..#PossiblePatients') IS NOT NULL DROP TABLE #PossiblePatients;
SELECT PK_Patient_Link_ID as FK_Patient_Link_ID, EthnicMainGroup, EthnicGroupDescription, DeathDate INTO #PossiblePatients FROM [SharedCare].Patient_Link
WHERE 
	(DeathDate IS NULL OR (DeathDate >= @StudyStartDate))

-- Find all patients registered with a GP
IF OBJECT_ID('tempdb..#PatientsWithGP') IS NOT NULL DROP TABLE #PatientsWithGP;
SELECT DISTINCT FK_Patient_Link_ID INTO #PatientsWithGP FROM [SharedCare].Patient
where FK_Reference_Tenancy_ID = 2
AND GPPracticeCode NOT LIKE 'ZZZ%';

-- Make cohort from patients alive at start date and registered with a GP
IF OBJECT_ID('tempdb..#Patients') IS NOT NULL DROP TABLE #Patients;
SELECT pp.* INTO #Patients FROM #PossiblePatients pp
INNER JOIN #PatientsWithGP gp on gp.FK_Patient_Link_ID = pp.FK_Patient_Link_ID;

------------------------------------------

-- OUTPUT: #Patients

-- LOAD CODESETS NEEDED FOR DEFINING COHORT

-- >>> Codesets required... Inserting the code set code
--
--┌────────────────────┐
--│ Clinical code sets │
--└────────────────────┘

-- OBJECTIVE: To populate temporary tables with the existing clinical code sets.
--            See the [SQL-generation-process.md](SQL-generation-process.md) for more details.

-- INPUT: No pre-requisites

-- OUTPUT: Five temp tables as follows:
--  #AllCodes (Concept, Version, Code)
--  #CodeSets (FK_Reference_Coding_ID, Concept)
--  #SnomedSets (FK_Reference_SnomedCT_ID, FK_SNOMED_ID)
--  #VersionedCodeSets (FK_Reference_Coding_ID, Concept, Version)
--  #VersionedSnomedSets (FK_Reference_SnomedCT_ID, Version, FK_SNOMED_ID)

--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
--!!! DO NOT EDIT THIS FILE MANUALLY !!!
--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

--#region Clinical code sets

IF OBJECT_ID('tempdb..#AllCodes') IS NOT NULL DROP TABLE #AllCodes;
CREATE TABLE #AllCodes (
  [Concept] [varchar](255) NOT NULL,
  [Version] INT NOT NULL,
  [Code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
  [description] [varchar] (255) NULL 
);

IF OBJECT_ID('tempdb..#codesreadv2') IS NOT NULL DROP TABLE #codesreadv2;
CREATE TABLE #codesreadv2 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesreadv2
VALUES ('glomerulonephritis',1,'K02..',NULL,'Chronic glomerulonephritis'),('glomerulonephritis',1,'K02..00',NULL,'Chronic glomerulonephritis'),('glomerulonephritis',1,'K02z.',NULL,'Chronic glomerulonephritis NOS'),('glomerulonephritis',1,'K02z.00',NULL,'Chronic glomerulonephritis NOS'),('glomerulonephritis',1,'K02y.',NULL,'Other chronic glomerulonephritis'),('glomerulonephritis',1,'K02y.00',NULL,'Other chronic glomerulonephritis'),('glomerulonephritis',1,'K02yz',NULL,'Other chronic glomerulonephritis NOS'),('glomerulonephritis',1,'K02yz00',NULL,'Other chronic glomerulonephritis NOS'),('glomerulonephritis',1,'K02y3',NULL,'Chronic diffuse glomerulonephritis'),('glomerulonephritis',1,'K02y300',NULL,'Chronic diffuse glomerulonephritis'),('glomerulonephritis',1,'K02y2',NULL,'Chronic focal glomerulonephritis'),('glomerulonephritis',1,'K02y200',NULL,'Chronic focal glomerulonephritis'),('glomerulonephritis',1,'K02y1',NULL,'Chronic exudative glomerulonephritis'),('glomerulonephritis',1,'K02y100',NULL,'Chronic exudative glomerulonephritis'),('glomerulonephritis',1,'K02y0',NULL,'Chronic glomerulonephritis + diseases EC'),('glomerulonephritis',1,'K02y000',NULL,'Chronic glomerulonephritis + diseases EC'),('glomerulonephritis',1,'K023.',NULL,'Chronic rapidly progressive glomerulonephritis'),('glomerulonephritis',1,'K023.00',NULL,'Chronic rapidly progressive glomerulonephritis'),('glomerulonephritis',1,'K022.',NULL,'Chronic membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K022.00',NULL,'Chronic membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K021.',NULL,'Chronic membranous glomerulonephritis'),('glomerulonephritis',1,'K021.00',NULL,'Chronic membranous glomerulonephritis'),('glomerulonephritis',1,'K020.',NULL,'Chronic proliferative glomerulonephritis'),('glomerulonephritis',1,'K020.00',NULL,'Chronic proliferative glomerulonephritis'),('glomerulonephritis',1,'K00..',NULL,'Acute glomerulonephritis'),('glomerulonephritis',1,'K00..00',NULL,'Acute glomerulonephritis'),('glomerulonephritis',1,'K00z.',NULL,'Acute glomerulonephritis NOS'),('glomerulonephritis',1,'K00z.00',NULL,'Acute glomerulonephritis NOS'),('glomerulonephritis',1,'K00y.',NULL,'Other acute glomerulonephritis'),('glomerulonephritis',1,'K00y.00',NULL,'Other acute glomerulonephritis'),('glomerulonephritis',1,'K00yz',NULL,'Other acute glomerulonephritis NOS'),('glomerulonephritis',1,'K00yz00',NULL,'Other acute glomerulonephritis NOS'),('glomerulonephritis',1,'K00y0',NULL,'Acute glomerulonephritis in diseases EC'),('glomerulonephritis',1,'K00y000',NULL,'Acute glomerulonephritis in diseases EC'),('glomerulonephritis',1,'K000.',NULL,'Acute proliferative glomerulonephritis'),('glomerulonephritis',1,'K000.00',NULL,'Acute proliferative glomerulonephritis'),('glomerulonephritis',1,'K0001',NULL,'Crescentic glomerulonephritis'),('glomerulonephritis',1,'K000100',NULL,'Crescentic glomerulonephritis'),('glomerulonephritis',1,'K032z',NULL,'Nephritis unspecified with lesion of membranoproliferative glomerulonephritis NOS'),('glomerulonephritis',1,'K032z00',NULL,'Nephritis unspecified with lesion of membranoproliferative glomerulonephritis NOS'),('glomerulonephritis',1,'K032y',NULL,'Nephritis unspecified with other specified lesion of membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K032y00',NULL,'Nephritis unspecified with other specified lesion of membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K0325',NULL,'Other familial glomerulonephritis'),('glomerulonephritis',1,'K032500',NULL,'Other familial glomerulonephritis'),('glomerulonephritis',1,'K0324',NULL,'Familial glomerulonephritis in Alports syndrome'),('glomerulonephritis',1,'K032400',NULL,'Familial glomerulonephritis in Alports syndrome'),('glomerulonephritis',1,'K0323',NULL,'Anaphylactoid glomerulonephritis'),('glomerulonephritis',1,'K032300',NULL,'Anaphylactoid glomerulonephritis'),('glomerulonephritis',1,'K0322',NULL,'Focal glomerulonephritis with focal recurrent macroscopic glomerulonephritis'),('glomerulonephritis',1,'K032200',NULL,'Focal glomerulonephritis with focal recurrent macroscopic glomerulonephritis'),('glomerulonephritis',1,'K0320',NULL,'Focal membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K032000',NULL,'Focal membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K01B.',NULL,'Nephrotic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K01B.00',NULL,'Nephrotic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K019.',NULL,'Nephrotic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K019.00',NULL,'Nephrotic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K018.',NULL,'Nephrotic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K018.00',NULL,'Nephrotic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K017.',NULL,'Nephrotic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K017.00',NULL,'Nephrotic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K016.',NULL,'Nephrotic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K016.00',NULL,'Nephrotic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K012.',NULL,'Nephrotic syndrome with membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K012.00',NULL,'Nephrotic syndrome with membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K011.',NULL,'Nephrotic syndrome with membranous glomerulonephritis'),('glomerulonephritis',1,'K011.00',NULL,'Nephrotic syndrome with membranous glomerulonephritis'),('glomerulonephritis',1,'K010.',NULL,'Nephrotic syndrome with proliferative glomerulonephritis'),('glomerulonephritis',1,'K010.00',NULL,'Nephrotic syndrome with proliferative glomerulonephritis'),('glomerulonephritis',1,'K013.',NULL,'Nephrotic syndrome with minimal change glomerulonephritis'),('glomerulonephritis',1,'K013.00',NULL,'Nephrotic syndrome with minimal change glomerulonephritis'),('glomerulonephritis',1,'K03z.',NULL,'Unspecified glomerulonephritis NOS'),('glomerulonephritis',1,'K03z.00',NULL,'Unspecified glomerulonephritis NOS'),('glomerulonephritis',1,'K03X.',NULL,'Unspecified nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K03X.00',NULL,'Unspecified nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K03W.',NULL,'Unspecified nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K03W.00',NULL,'Unspecified nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K03U.',NULL,'Unspecified nephritic syndrome, diffuse concentric glomerulonephritis'),('glomerulonephritis',1,'K03U.00',NULL,'Unspecified nephritic syndrome, diffuse concentric glomerulonephritis'),('glomerulonephritis',1,'K036.',NULL,'Cryoglobulinaemic glomerulonephritis'),('glomerulonephritis',1,'K036.00',NULL,'Cryoglobulinaemic glomerulonephritis'),('glomerulonephritis',1,'K0A07',NULL,'Acute nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A0700',NULL,'Acute nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A05',NULL,'Acute nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A0500',NULL,'Acute nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A04',NULL,'Acute nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A0400',NULL,'Acute nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A03',NULL,'Acute nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A0300',NULL,'Acute nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A02',NULL,'Acute nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A0200',NULL,'Acute nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A17',NULL,'Rapidly progressive nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A1700',NULL,'Rapidly progressive nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A15',NULL,'Rapidly progressive nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A1500',NULL,'Rapidly progressive nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A14',NULL,'Rapidly progressive nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A1400',NULL,'Rapidly progressive nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A13',NULL,'Rapidly progressive nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A1300',NULL,'Rapidly progressive nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A12',NULL,'Rapidly progressive nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A1200',NULL,'Rapidly progressive nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A27',NULL,'Recurrent and persistent haematuria, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A2700',NULL,'Recurrent and persistent haematuria, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A25',NULL,'Recurrent and persistent haematuria, diffuse mesangiocapillary glomerulonephritis'),
('glomerulonephritis',1,'K0A2500',NULL,'Recurrent and persistent haematuria, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A24',NULL,'Recurrent and persistent haematuria, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A2400',NULL,'Recurrent and persistent haematuria, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A23',NULL,'Recurrent and persistent haematuria, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A2300',NULL,'Recurrent and persistent haematuria, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A22',NULL,'Recurrent and persistent haematuria, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A2200',NULL,'Recurrent and persistent haematuria, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A37',NULL,'Chronic nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A3700',NULL,'Chronic nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A35',NULL,'Chronic nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A3500',NULL,'Chronic nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A34',NULL,'Chronic nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A3400',NULL,'Chronic nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A33',NULL,'Chronic nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A3300',NULL,'Chronic nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A32',NULL,'Chronic nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A3200',NULL,'Chronic nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A47',NULL,'Isolated proteinuria with specified morphological lesion, diffuse concentric glomerulonephritis'),('glomerulonephritis',1,'K0A4700',NULL,'Isolated proteinuria with specified morphological lesion, diffuse concentric glomerulonephritis'),('glomerulonephritis',1,'K0A45',NULL,'Isolated proteinuria with specified morphological lesion, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A4500',NULL,'Isolated proteinuria with specified morphological lesion, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A44',NULL,'Isolated proteinuria with specified morphological lesion, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A4400',NULL,'Isolated proteinuria with specified morphological lesion, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A43',NULL,'Isolated proteinuria with specified morphological lesion, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A4300',NULL,'Isolated proteinuria with specified morphological lesion, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A42',NULL,'Isolated proteinuria with specified morphological lesion, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A4200',NULL,'Isolated proteinuria with specified morphological lesion, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A57',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A5700',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A55',NULL,'[X]Hereditary nephropathy, not elsewhere classified, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A5500',NULL,'[X]Hereditary nephropathy, not elsewhere classified, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A54',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A5400',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A53',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A5300',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A52',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A5200',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'Kyu0C',NULL,'[X]Unspecified nephritic syndrome, diffuse concentric glomerulonephritis'),('glomerulonephritis',1,'Kyu0C00',NULL,'[X]Unspecified nephritic syndrome, diffuse concentric glomerulonephritis'),('glomerulonephritis',1,'Kyu0A',NULL,'[X]Unspecified nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'Kyu0A00',NULL,'[X]Unspecified nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'Kyu09',NULL,'[X]Unspecified nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'Kyu0900',NULL,'[X]Unspecified nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A9.',NULL,'Cytomegalovirus-induced glomerulonephritis'),('glomerulonephritis',1,'K0A9.00',NULL,'Cytomegalovirus-induced glomerulonephritis'),('glomerulonephritis',1,'K0A8.',NULL,'Rapidly progressive glomerulonephritis'),('glomerulonephritis',1,'K0A8.00',NULL,'Rapidly progressive glomerulonephritis'),('glomerulonephritis',1,'SP08b',NULL,'De novo glomerulonephritis'),('glomerulonephritis',1,'SP08b00',NULL,'De novo glomerulonephritis'),('glomerulonephritis',1,'K0A28',NULL,'IgA nephropathy'),('glomerulonephritis',1,'K0A2800',NULL,'IgA nephropathy'),('glomerulonephritis',1,'G7520',NULL,'Goodpastures syndrome'),('glomerulonephritis',1,'G752000',NULL,'Goodpastures syndrome'),('glomerulonephritis',1,'K01x4',NULL,'Nephrotic syndrome in systemic lupus erythematosus'),('glomerulonephritis',1,'K01x400',NULL,'Nephrotic syndrome in systemic lupus erythematosus'),('glomerulonephritis',1,'K00y2',NULL,'Acute focal nephritis'),('glomerulonephritis',1,'K00y200',NULL,'Acute focal nephritis'),('glomerulonephritis',1,'K00y3',NULL,'Acute diffuse nephritis'),('glomerulonephritis',1,'K00y300',NULL,'Acute diffuse nephritis'),('glomerulonephritis',1,'K033.',NULL,'Rapidly progressive nephritis unspecified'),('glomerulonephritis',1,'K033.00',NULL,'Rapidly progressive nephritis unspecified'),('glomerulonephritis',1,'PKy90',NULL,'Alports syndrome'),('glomerulonephritis',1,'PKy9000',NULL,'Alports syndrome'),('glomerulonephritis',1,'K001.',NULL,'Acute nephritis with lesions of necrotising glomerulitis'),('glomerulonephritis',1,'K001.00',NULL,'Acute nephritis with lesions of necrotising glomerulitis'),('glomerulonephritis',1,'K00y1',NULL,'Acute exudative nephritis'),('glomerulonephritis',1,'K00y100',NULL,'Acute exudative nephritis'),('glomerulonephritis',1,'K031.',NULL,'Membranous nephritis unspecified'),('glomerulonephritis',1,'K031.00',NULL,'Membranous nephritis unspecified');
INSERT INTO #codesreadv2
VALUES ('kidney-stones',1,'4G4..',NULL,'O/E: kidney stone'),('kidney-stones',1,'4G4..00',NULL,'O/E: kidney stone'),('kidney-stones',1,'4G42.',NULL,'O/E: phosphate -staghorn-stone'),('kidney-stones',1,'4G42.00',NULL,'O/E: phosphate -staghorn-stone'),('kidney-stones',1,'4G4Z.',NULL,'O/E: renal stone NOS'),('kidney-stones',1,'4G4Z.00',NULL,'O/E: renal stone NOS'),('kidney-stones',1,'C3411',NULL,'Renal stone - uric acid'),('kidney-stones',1,'C341100',NULL,'Renal stone - uric acid'),('kidney-stones',1,'K1006',NULL,'Calculous pyelonephritis'),('kidney-stones',1,'K100600',NULL,'Calculous pyelonephritis'),('kidney-stones',1,'K12..',NULL,'Calculus of kidney and ureter'),('kidney-stones',1,'K12..00',NULL,'Calculus of kidney and ureter'),('kidney-stones',1,'K120.',NULL,'Calculus of kidney'),('kidney-stones',1,'K120.00',NULL,'Calculus of kidney'),('kidney-stones',1,'K122.',NULL,'Calculus of kidney with calculus of ureter'),('kidney-stones',1,'K122.00',NULL,'Calculus of kidney with calculus of ureter'),('kidney-stones',1,'PD31.',NULL,'Congenital calculus of kidney'),('kidney-stones',1,'PD31.00',NULL,'Congenital calculus of kidney');
INSERT INTO #codesreadv2
VALUES ('vasculitis',1,'M2y0X',NULL,'Vasculitis limited to skin, unspecified'),('vasculitis',1,'M2y0X00',NULL,'Vasculitis limited to skin, unspecified'),('vasculitis',1,'M2y02',NULL,'Livedoid vasculitis'),('vasculitis',1,'M2y0200',NULL,'Livedoid vasculitis'),('vasculitis',1,'Myu7G',NULL,'[X]Vasculitis limited to skin, unspecified'),('vasculitis',1,'Myu7G00',NULL,'[X]Vasculitis limited to skin, unspecified'),('vasculitis',1,'Myu7A',NULL,'[X]Other vasculitis limited to the skin'),('vasculitis',1,'Myu7A00',NULL,'[X]Other vasculitis limited to the skin'),('vasculitis',1,'M152.',NULL,'Erythema nodosum'),('vasculitis',1,'M152.00',NULL,'Erythema nodosum'),('vasculitis',1,'C3321',NULL,'Cryoglobulinaemic vasculitis'),('vasculitis',1,'C332100',NULL,'Cryoglobulinaemic vasculitis'),('vasculitis',1,'F421E',NULL,'Retinal vasculitis NOS'),('vasculitis',1,'F421E00',NULL,'Retinal vasculitis NOS'),('vasculitis',1,'G758.',NULL,'Churg-Strauss vasculitis'),('vasculitis',1,'G758.00',NULL,'Churg-Strauss vasculitis'),('vasculitis',1,'G76B.',NULL,'Vasculitis'),('vasculitis',1,'G76B.00',NULL,'Vasculitis'),('vasculitis',1,'N040N',NULL,'Rheumatoid vasculitis'),('vasculitis',1,'N040N00',NULL,'Rheumatoid vasculitis'),('vasculitis',1,'D310.',NULL,'Allergic purpura'),('vasculitis',1,'D310.00',NULL,'Allergic purpura'),('vasculitis',1,'D3100',NULL,'Acute vascular purpura'),('vasculitis',1,'D310000',NULL,'Acute vascular purpura'),('vasculitis',1,'F371.',NULL,'Polyneuropathy in collagen vascular disease'),('vasculitis',1,'F371.00',NULL,'Polyneuropathy in collagen vascular disease'),('vasculitis',1,'G750.',NULL,'Polyarteritis nodosa'),('vasculitis',1,'G750.00',NULL,'Polyarteritis nodosa'),('vasculitis',1,'G752.',NULL,'Hypersensitivity angiitis'),('vasculitis',1,'G752.00',NULL,'Hypersensitivity angiitis'),('vasculitis',1,'G752z',NULL,'Hypersensitivity angiitis NOS'),('vasculitis',1,'G752z00',NULL,'Hypersensitivity angiitis NOS');
INSERT INTO #codesreadv2
VALUES ('kidney-transplant',1,'14S2.',NULL,'H/O: kidney recipient'),('kidney-transplant',1,'14S2.00',NULL,'H/O: kidney recipient'),('kidney-transplant',1,'7B00.',NULL,'Transplantation of kidney'),('kidney-transplant',1,'7B00.00',NULL,'Transplantation of kidney'),('kidney-transplant',1,'7B001',NULL,'Transplantation of kidney from live donor'),('kidney-transplant',1,'7B00100',NULL,'Transplantation of kidney from live donor'),('kidney-transplant',1,'7B002',NULL,'Transplantation of kidney from cadaver'),('kidney-transplant',1,'7B00200',NULL,'Transplantation of kidney from cadaver'),('kidney-transplant',1,'7B00y',NULL,'Other specified transplantation of kidney'),('kidney-transplant',1,'7B00y00',NULL,'Other specified transplantation of kidney'),('kidney-transplant',1,'7B00z',NULL,'Transplantation of kidney NOS'),('kidney-transplant',1,'7B00z00',NULL,'Transplantation of kidney NOS'),('kidney-transplant',1,'K0B5.',NULL,'Renal tubulo-interstitial disorders in transplant rejection'),('kidney-transplant',1,'K0B5.00',NULL,'Renal tubulo-interstitial disorders in transplant rejection'),('kidney-transplant',1,'SP080',NULL,'Transplanted organ failure'),('kidney-transplant',1,'SP08000',NULL,'Transplanted organ failure'),('kidney-transplant',1,'SP083',NULL,'Kidney transplant failure and rejection'),('kidney-transplant',1,'SP08300',NULL,'Kidney transplant failure and rejection'),('kidney-transplant',1,'TB001',NULL,'Transplantation of kidney as the cause of abnormal reaction of patient, or of later complication, without mention of misadventure at the time of operation'),('kidney-transplant',1,'TB00100',NULL,'Transplantation of kidney as the cause of abnormal reaction of patient, or of later complication, without mention of misadventure at the time of operation'),('kidney-transplant',1,'ZV420',NULL,'[V]Kidney transplanted'),('kidney-transplant',1,'ZV42000',NULL,'[V]Kidney transplanted');
INSERT INTO #codesreadv2
VALUES ('covid-positive-antigen-test',1,'43kB1',NULL,'SARS-CoV-2 antigen positive'),('covid-positive-antigen-test',1,'43kB100',NULL,'SARS-CoV-2 antigen positive');
INSERT INTO #codesreadv2
VALUES ('covid-positive-pcr-test',1,'4J3R6',NULL,'SARS-CoV-2 RNA pos lim detect'),('covid-positive-pcr-test',1,'4J3R600',NULL,'SARS-CoV-2 RNA pos lim detect'),('covid-positive-pcr-test',1,'A7952',NULL,'COVID-19 confirmed by laboratory test'),('covid-positive-pcr-test',1,'A795200',NULL,'COVID-19 confirmed by laboratory test'),('covid-positive-pcr-test',1,'43hF.',NULL,'Detection of SARS-CoV-2 by PCR'),('covid-positive-pcr-test',1,'43hF.00',NULL,'Detection of SARS-CoV-2 by PCR'),('covid-positive-pcr-test',1,'43jS.',NULL,'Coronavirus nucleic acid detection'),('covid-positive-pcr-test',1,'43jS.00',NULL,'Coronavirus nucleic acid detection'),('covid-positive-pcr-test',1,'43jS0',NULL,'Coronavirus nucleic acid detection assay'),('covid-positive-pcr-test',1,'43jS000',NULL,'Coronavirus nucleic acid detection assay'),('covid-positive-pcr-test',1,'43jS1',NULL,'Coronavirus ribonucleic acid detection assay'),('covid-positive-pcr-test',1,'43jS100',NULL,'Coronavirus ribonucleic acid detection assay');
INSERT INTO #codesreadv2
VALUES ('covid-positive-test-other',1,'4J3R1',NULL,'2019-nCoV (novel coronavirus) detected'),('covid-positive-test-other',1,'4J3R100',NULL,'2019-nCoV (novel coronavirus) detected');
INSERT INTO #codesreadv2
VALUES ('egfr',1,'451E.',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'451E.00',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'451G.',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'451G.00',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'451K.',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'451K.00',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'451M.',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451M.00',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451N.',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451N.00',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'451F.',NULL,'Glomerular filtration rate'),('egfr',1,'451F.00',NULL,'Glomerular filtration rate');
INSERT INTO #codesreadv2
VALUES ('urinary-albumin-creatinine-ratio',1,'46TC.',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TC.00',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'44J7.',NULL,'Albumin / creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'44J7.00',NULL,'Albumin / creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TD.',NULL,'Urine microalbumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TD.00',NULL,'Urine microalbumin:creatinine ratio')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesreadv2;

IF OBJECT_ID('tempdb..#codesctv3') IS NOT NULL DROP TABLE #codesctv3;
CREATE TABLE #codesctv3 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesctv3
VALUES ('glomerulonephritis',1,'Xa1uD',NULL,'Glomerulonephritis'),('glomerulonephritis',1,'XE0dY',NULL,'Acute glomerulonephritis'),('glomerulonephritis',1,'K00z.',NULL,'Acute glomerulonephritis NOS'),('glomerulonephritis',1,'K001.',NULL,'Acute nephritis with lesions of necrotising glomerulitis'),('glomerulonephritis',1,'K000.',NULL,'Acute proliferative glomerulonephritis'),('glomerulonephritis',1,'X30IG',NULL,'Crescentic glomerulonephritis'),('glomerulonephritis',1,'Xa33d',NULL,'[EDTA] Crescentric glomerulonephritis (type I,II,III) associated with renal failure'),('glomerulonephritis',1,'X30I9',NULL,'Endocapillary glomerulonephritis'),('glomerulonephritis',1,'X30IA',NULL,'Idiopathic endocapillary glomerulonephritis'),('glomerulonephritis',1,'X30IB',NULL,'Post-infectious glomerulonephritis'),('glomerulonephritis',1,'X30ID',NULL,'Post-infectious glomerulonephritis - Garland variety'),('glomerulonephritis',1,'X30IC',NULL,'Post-streptococcal glomerulonephritis'),('glomerulonephritis',1,'X30IE',NULL,'Shunt nephritis'),('glomerulonephritis',1,'X30IF',NULL,'Necrotising glomerulonephritis'),('glomerulonephritis',1,'K00y.',NULL,'Other acute glomerulonephritis'),('glomerulonephritis',1,'K00y3',NULL,'Acute diffuse nephritis'),('glomerulonephritis',1,'K00y1',NULL,'Acute exudative nephritis'),('glomerulonephritis',1,'K00y2',NULL,'Acute focal nephritis'),('glomerulonephritis',1,'K00y0',NULL,'Acute glomerulonephritis in diseases EC'),('glomerulonephritis',1,'K00yz',NULL,'Other acute glomerulonephritis NOS'),('glomerulonephritis',1,'XE0db',NULL,'Chronic glomerulonephritis'),('glomerulonephritis',1,'XM1AL',NULL,'[EDTA] Glomerulonephritis, histologically examined (otherwise specified) associated with renal failure'),('glomerulonephritis',1,'XM1AM',NULL,'[EDTA] Glomerulonephritis, histologically not examined associated with renal failure'),('glomerulonephritis',1,'K000.',NULL,'PGN - Acute proliferative glomerulonephritis'),('glomerulonephritis',1,'X30I9',NULL,'Endocapillary glomerulonephritis'),('glomerulonephritis',1,'X30IF',NULL,'Necrotising glomerulonephritis'),('glomerulonephritis',1,'X30IG',NULL,'CGN - Crescentic glomerulonephritis'),('glomerulonephritis',1,'XE0dY',NULL,'AGN - Acute glomerulonephritis'),('glomerulonephritis',1,'X30IA',NULL,'Idiopathic endocapillary glomerulonephritis'),('glomerulonephritis',1,'X30IB',NULL,'Post-infectious glomerulonephritis'),('glomerulonephritis',1,'Xa33d',NULL,'[EDTA] Crescentric glomerulonephritis (type I,II,III) associated with renal failure'),('glomerulonephritis',1,'K00y.',NULL,'Other acute glomerulonephritis'),('glomerulonephritis',1,'K00z.',NULL,'Acute glomerulonephritis NOS'),('glomerulonephritis',1,'Xa1uD',NULL,'Glomerulonephritis'),('glomerulonephritis',1,'X30IC',NULL,'Post-streptococcal glomerulonephritis'),('glomerulonephritis',1,'X30ID',NULL,'Post-infectious glomerulonephritis - Garland variety'),('glomerulonephritis',1,'K00y0',NULL,'Acute glomerulonephritis in diseases EC'),('glomerulonephritis',1,'K00yz',NULL,'Other acute glomerulonephritis NOS'),('glomerulonephritis',1,'XE0db',NULL,'CGN - Chronic glomerulonephritis'),('glomerulonephritis',1,'XM1AL',NULL,'[EDTA] Glomerulonephritis, histologically examined (otherwise specified) associated with renal failure'),('glomerulonephritis',1,'XM1AM',NULL,'[EDTA] Glomerulonephritis, histologically not examined associated with renal failure'),('glomerulonephritis',1,'K020.',NULL,'Chronic nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K021.',NULL,'Chronic nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K023.',NULL,'Chronic rapidly progressive glomerulonephritis'),('glomerulonephritis',1,'K02y.',NULL,'Other chronic glomerulonephritis'),('glomerulonephritis',1,'K02y2',NULL,'Chronic focal glomerulonephritis'),('glomerulonephritis',1,'K02y3',NULL,'Chronic diffuse glomerulonephritis'),('glomerulonephritis',1,'K02yz',NULL,'Other chronic glomerulonephritis NOS'),('glomerulonephritis',1,'K02z.',NULL,'Chronic glomerulonephritis NOS'),('glomerulonephritis',1,'K0A34',NULL,'Chronic nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A35',NULL,'Chronic nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A37',NULL,'Chronic nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'X30Ie',NULL,'GN - Hereditary glomerulonephritis'),('glomerulonephritis',1,'Xa9CC',NULL,'Minimal change glomerulonephritis'),('glomerulonephritis',1,'K02..',NULL,'Chronic glomerulonephritis'),('glomerulonephritis',1,'K022.',NULL,'Membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'X30IW',NULL,'Mesangial IgM proliferative glomerulonephritis'),('glomerulonephritis',1,'X30IY',NULL,'Membranous glomerulonephritis - stage I'),('glomerulonephritis',1,'X30IZ',NULL,'MGN stage II - Membranous glomerulonephritis - stage II'),('glomerulonephritis',1,'X30Ia',NULL,'MGN stage III - Membranous glomerulonephritis stage III'),('glomerulonephritis',1,'X30Ib',NULL,'MGN stage IV - Membranous glomerulonephritis stage IV'),('glomerulonephritis',1,'X30Ic',NULL,'MGN stage V - Membranous glomerulonephritis stage V'),('glomerulonephritis',1,'K02y0',NULL,'Chronic glomerulonephritis with diseases EC'),('glomerulonephritis',1,'K02y1',NULL,'Chronic exudative glomerulonephritis'),('glomerulonephritis',1,'K0325',NULL,'Other familial glomerulonephritis'),('glomerulonephritis',1,'X30Ih',NULL,'Non-progressive hereditary glomerulonephritis'),('glomerulonephritis',1,'X30IH',NULL,'Steroid-sensitive minimal change glomerulonephritis'),('glomerulonephritis',1,'X30II',NULL,'Steroid-resistant minimal change glomerulonephritis'),('glomerulonephritis',1,'X30IJ',NULL,'Steroid-dependent minimal change glomerulonephritis'),('glomerulonephritis',1,'K0320',NULL,'Focal membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'X30IR',NULL,'Mesangiocapillary glomerulonephritis NEC'),('glomerulonephritis',1,'X30IS',NULL,'Mesangiocapillary glomerulonephritis type I'),('glomerulonephritis',1,'X30IT',NULL,'Mesangiocapillary glomerulonephritis type II'),('glomerulonephritis',1,'X30IU',NULL,'MCGN type III - Mesangiocapillary glomerulonephritis type III'),('glomerulonephritis',1,'X30IV',NULL,'Mesangiocapillary glomerulonephritis type IV'),('glomerulonephritis',1,'XM19Y',NULL,'[EDTA] Membrano-proliferative glomerulonephritis,type I (proven immunofluorescence / electron microscopy-excluding lupus erythematosus+other specified multi-system disease) associated renal failure'),('glomerulonephritis',1,'XM19Z',NULL,'[EDTA] Dense deposit disease, membrano-proliferative glomerulonephritis, type II, (proven by immunofluorescence and/or electronic microscopy) associated with renal failure'),('glomerulonephritis',1,'K032y',NULL,'Mesangiocapillary glomerulonephritis NEC'),('glomerulonephritis',1,'K032z',NULL,'Nephritis unspecified with lesion of membranoproliferative glomerulonephritis NOS'),('glomerulonephritis',1,'K0A02',NULL,'Acute nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A03',NULL,'Acute nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A04',NULL,'Acute nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A05',NULL,'Acute nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'X30I8',NULL,'Rapidly progressive glomerulonephritis'),('glomerulonephritis',1,'XE0de',NULL,'Nephritis unspecified with other specified lesion of membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'X30I3',NULL,'Mixed membranous and proliferative glomerulonephritis NEC'),('glomerulonephritis',1,'X30I4',NULL,'Mesangioproliferative glomerulonephritis NEC'),('glomerulonephritis',1,'X30I5',NULL,'Lobular glomerulonephritis NEC'),('glomerulonephritis',1,'X30I6',NULL,'Hypocomplementaemic persistent glomerulonephritis NEC'),('glomerulonephritis',1,'K0A12',NULL,'Rapidly progressive nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A13',NULL,'Rapidly progressive nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A14',NULL,'Rapidly progressive nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A15',NULL,'Rapidly progressive nephritic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A17',NULL,'Rapidly progressive nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K010.',NULL,'Nephrotic syndrome with proliferative glomerulonephritis'),('glomerulonephritis',1,'K011.',NULL,'Nephrotic syndrome with membranous glomerulonephritis'),('glomerulonephritis',1,'K012.',NULL,'Nephrotic syndrome with membranoproliferative glomerulonephritis'),('glomerulonephritis',1,'K013.',NULL,'Nephrotic syndrome with minimal change glomerulonephritis'),('glomerulonephritis',1,'K016.',NULL,'Nephrotic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K017.',NULL,'Nephrotic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K018.',NULL,'Nephrotic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K019.',NULL,'Nephrotic syndrome, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K01B.',NULL,'Nephrotic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A07',NULL,'Acute nephritic syndrome, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'XE0dZ',NULL,'Nephrotic syndrome with minimal change glomerulonephritis'),('glomerulonephritis',1,'K0A22',NULL,'Recurrent and persistent haematuria, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A23',NULL,'Recurrent and persistent haematuria, diffuse mesangial proliferative glomerulonephritis'),
('glomerulonephritis',1,'K0A24',NULL,'Recurrent and persistent haematuria, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A25',NULL,'Recurrent and persistent haematuria, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A27',NULL,'Recurrent and persistent haematuria, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'K0A42',NULL,'Isolated proteinuria with specified morphological lesion, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A43',NULL,'Isolated proteinuria with specified morphological lesion, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A44',NULL,'Isolated proteinuria with specified morphological lesion, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A45',NULL,'Isolated proteinuria with specified morphological lesion, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A47',NULL,'Isolated proteinuria with specified morphological lesion, diffuse concentric glomerulonephritis'),('glomerulonephritis',1,'K0A52',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'K0A53',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A54',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'K0A55',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'K0A57',NULL,'Hereditary nephropathy, not elsewhere classified, diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'Kyu09',NULL,'[X]Unspecified nephritic syndrome, diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'Kyu0A',NULL,'[X]Unspecified nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'Kyu0C',NULL,'[X]Unspecified nephritic syndrome, diffuse concentric glomerulonephritis'),('glomerulonephritis',1,'K0322',NULL,'Focal glomerulonephritis with focal recurrent macroscopic glomerulonephritis'),('glomerulonephritis',1,'K0323',NULL,'Anaphylactoid glomerulonephritis'),('glomerulonephritis',1,'X30Kw',NULL,'Cryoglobulinaemic glomerulonephritis'),('glomerulonephritis',1,'Xa33h',NULL,'[EDTA] Cryoglobulineme glomerulonephritis associated with renal failure'),('glomerulonephritis',1,'X30Mf',NULL,'De novo glomerulonephritis'),('glomerulonephritis',1,'X30Mj',NULL,'CMV - Cytomegalovirus-induced glomerulonephritis'),('glomerulonephritis',1,'K03z.',NULL,'Unspecified glomerulonephritis NOS'),('glomerulonephritis',1,'X30L1',NULL,'Malignancy-associated glomerulonephritis'),('glomerulonephritis',1,'X705a',NULL,'Primary pauci-immune necrotising and crescentic glomerulonephritis'),('glomerulonephritis',1,'K01x4',NULL,'Lupus nephritis'),('glomerulonephritis',1,'X30IQ',NULL,'IgAN - IgA nephropathy'),('glomerulonephritis',1,'K031.',NULL,'Membranous nephritis unspecified'),('glomerulonephritis',1,'K01x4',NULL,'(Nephrotic syndrome in systemic lupus erythematosus) or (lupus nephritis)'),('glomerulonephritis',1,'G7520',NULL,'Goodpastures syndrome'),('glomerulonephritis',1,'K01x4',NULL,'Nephrotic syndrome in systemic lupus erythematosus'),('glomerulonephritis',1,'K033.',NULL,'Rapidly progressive nephritis unspecified'),('glomerulonephritis',1,'X30Kr',NULL,'Lupus nephritis - WHO Class V'),('glomerulonephritis',1,'PKy90',NULL,'Alports syndrome'),('glomerulonephritis',1,'XE0dd',NULL,'Primary IgA nephropathy'),('glomerulonephritis',1,'X30Kp',NULL,'Lupus nephritis - WHO Class III'),('glomerulonephritis',1,'X30Kq',NULL,'Lupus nephritis - WHO Class IV'),('glomerulonephritis',1,'X30IQ',NULL,'IgA nephropathy'),('glomerulonephritis',1,'XE0da',NULL,'Lupus nephritis'),('glomerulonephritis',1,'XE0dd',NULL,'Bergers disease');
INSERT INTO #codesctv3
VALUES ('kidney-stones',1,'XE0dk',NULL,'Calculus of kidney'),('kidney-stones',1,'X30Pp',NULL,'Calculus in calyceal diverticulum'),('kidney-stones',1,'X30Pr',NULL,'Calculus in pelviureteric junction'),('kidney-stones',1,'X30Pq',NULL,'Calculus in renal pelvis'),('kidney-stones',1,'X30Po',NULL,'Calyceal renal calculus'),('kidney-stones',1,'XE0fN',NULL,'Kidney calculus (& [staghorn])'),('kidney-stones',1,'K120z',NULL,'Renal calculus NOS'),('kidney-stones',1,'K1200',NULL,'Staghorn calculus'),('kidney-stones',1,'XM14o',NULL,'Uric acid renal calculus'),('kidney-stones',1,'4G4..',NULL,'O/E: renal calculus'),('kidney-stones',1,'4G42.',NULL,'Phosphate kidney stone &/or [O/E: staghorn]'),('kidney-stones',1,'4G4Z.',NULL,'O/E: renal stone NOS'),('kidney-stones',1,'C3411',NULL,'(Uric acid nephrolithiasis) or (renal stone - uric acid)'),('kidney-stones',1,'K12..',NULL,'Urinary calculus (& [kidney &/or ureter)'),('kidney-stones',1,'K120.',NULL,'(Calculus of kidney) or (nephrolithiasis NOS)'),('kidney-stones',1,'PD31.',NULL,'Congenital calculus of kidney'),('kidney-stones',1,'X30Pn',NULL,'Nephrolithiasis NOS'),('kidney-stones',1,'XE0dj',NULL,'Calculus of kidney and ureter'),('kidney-stones',1,'XM1XM',NULL,'Phosphate kidney stone');
INSERT INTO #codesctv3
VALUES ('vasculitis',1,'C3321',NULL,'Cryoglobulinaemic vasculitis'),('vasculitis',1,'X205F',NULL,'Secondary systemic vasculitis'),('vasculitis',1,'X205G',NULL,'Vasculitis secondary to drug'),('vasculitis',1,'X701l',NULL,'Rheumatoid vasculitis'),('vasculitis',1,'X705w',NULL,'Lupus vasculitis'),('vasculitis',1,'X205D',NULL,'Systemic vasculitis'),('vasculitis',1,'X705t',NULL,'Nailfold rheumatoid vasculitis'),('vasculitis',1,'X705u',NULL,'Systemic rheumatoid vasculitis'),('vasculitis',1,'X705v',NULL,'Necrotising rheumatoid vasculitis'),('vasculitis',1,'G76B.',NULL,'Vasculitis'),('vasculitis',1,'X7061',NULL,'Essential cryoglobulinaemic vasculitis'),('vasculitis',1,'X50BC',NULL,'Primary cutaneous vasculitis'),('vasculitis',1,'X50BG',NULL,'Gougerot-Ruiter vasculitis'),('vasculitis',1,'X705x',NULL,'Hypocomplementaemic vasculitis'),('vasculitis',1,'X50BI',NULL,'Secondary cutaneous vasculitis'),('vasculitis',1,'Myu7A',NULL,'[X]Other vasculitis limited to the skin'),('vasculitis',1,'Myu7G',NULL,'[X]Vasculitis limited to skin, unspecified'),('vasculitis',1,'X50BK',NULL,'Nodular vasculitis'),('vasculitis',1,'X00Dw',NULL,'Cerebral arteritis in systemic vasculitis'),('vasculitis',1,'X00Dz',NULL,'Primary central nervous system granulomatous vasculitis'),('vasculitis',1,'X705i',NULL,'Churg-Strauss vasculitis'),('vasculitis',1,'F421E',NULL,'Retinal vasculitis NOS'),('vasculitis',1,'X00dO',NULL,'Retinal vasculitis'),('vasculitis',1,'X309p',NULL,'Peritoneal vasculitis'),('vasculitis',1,'XaXlI',NULL,'H/O vasculitis'),('vasculitis',1,'D310.',NULL,'Allergic purpura'),('vasculitis',1,'D3100',NULL,'Acute vascular purpura'),('vasculitis',1,'F371.',NULL,'Neuropathy in vasculitis and connective tissue disease'),('vasculitis',1,'G750.',NULL,'(Polyarteritis nodosa) or (necrotising angiitis)'),('vasculitis',1,'G750.',NULL,'Polyarteritis nodosa'),('vasculitis',1,'G752.',NULL,'Hypersensitivity: [angiitis] or [arteritis]'),('vasculitis',1,'G752z',NULL,'Hypersensitivity angiitis NOS'),('vasculitis',1,'X203B',NULL,'Post-arteritic pulmonary hypertension'),('vasculitis',1,'XE0VV',NULL,'Hypersensitivity angiitis');
INSERT INTO #codesctv3
VALUES ('kidney-transplant',1,'14S2.',NULL,'H/O: kidney recipient'),('kidney-transplant',1,'7B00.',NULL,'Renal transplant'),('kidney-transplant',1,'7B001',NULL,'Live donor renal transplant'),('kidney-transplant',1,'7B002',NULL,'Cadaveric renal transplant'),('kidney-transplant',1,'7B00y',NULL,'Other specified transplantation of kidney'),('kidney-transplant',1,'7B00z',NULL,'Transplantation of kidney NOS'),('kidney-transplant',1,'K0B5.',NULL,'Renal tubulo-interstitial disorders in transplant rejection'),('kidney-transplant',1,'SP080',NULL,'(Transpl organ fail) or (deterior ren func aft ren transpl)'),('kidney-transplant',1,'SP083',NULL,'Kidney transplant failure and rejection'),('kidney-transplant',1,'TB001',NULL,'Kidney transplant with complication, without blame'),('kidney-transplant',1,'X30D2',NULL,'Xenograft renal transplant'),('kidney-transplant',1,'X30J3',NULL,'End stage renal failure with renal transplant'),('kidney-transplant',1,'X30Ma',NULL,'Chronic rejection of renal transplant - grade III'),('kidney-transplant',1,'X30Mb',NULL,'Acute-on-chronic rejection of renal transplant'),('kidney-transplant',1,'X30Mc',NULL,'Failed renal transplant'),('kidney-transplant',1,'X30Md',NULL,'Perfusion injury of renal transplant'),('kidney-transplant',1,'X30Me',NULL,'De novo transplant disease'),('kidney-transplant',1,'X30Mf',NULL,'De novo glomerulonephritis'),('kidney-transplant',1,'X30Mg',NULL,'Transplant glomerulopathy'),('kidney-transplant',1,'X30Mh',NULL,'Transplant glomerulopathy - early form'),('kidney-transplant',1,'X30Mi',NULL,'Transplant glomerulopathy - late form'),('kidney-transplant',1,'X30MN',NULL,'Renal transplant disorder'),('kidney-transplant',1,'X30MO',NULL,'Primary non-function of renal transplant'),('kidney-transplant',1,'X30MP',NULL,'Renal transplant rejection'),('kidney-transplant',1,'X30MQ',NULL,'Hyperacute rejection of renal transplant'),('kidney-transplant',1,'X30MR',NULL,'Accelerated rejection of renal transplant'),('kidney-transplant',1,'X30MS',NULL,'Very mild acute rejection of renal transplant'),('kidney-transplant',1,'X30MT',NULL,'Acute rejection of renal transplant'),('kidney-transplant',1,'X30MU',NULL,'Acute rejection of renal transplant - grade I'),('kidney-transplant',1,'X30MV',NULL,'Acute rejection of renal transplant - grade II'),('kidney-transplant',1,'X30MW',NULL,'Acute rejection of renal transplant - grade III'),('kidney-transplant',1,'X30MX',NULL,'Chronic rejection of renal transplant'),('kidney-transplant',1,'X30MY',NULL,'Chronic rejection of renal transplant - grade 1'),('kidney-transplant',1,'X30MZ',NULL,'Chronic rejection of renal transplant - grade II'),('kidney-transplant',1,'X30NN',NULL,'Perirenal and periureteric post-transplant lymphocele'),('kidney-transplant',1,'Xa0HK',NULL,'Unexplained episode of renal transplant dysfunction'),('kidney-transplant',1,'Xa0HL',NULL,'Pre-existing disease in renal transplant'),('kidney-transplant',1,'Xa1dw',NULL,'Transplant kidney'),('kidney-transplant',1,'Xa3x6',NULL,'Kidney replacement'),('kidney-transplant',1,'Xaa2O',NULL,'Thrombosis of artery of transplanted kidney'),('kidney-transplant',1,'Xaa2Q',NULL,'Thrombosis of vein of transplanted kidney'),('kidney-transplant',1,'XaE9T',NULL,'Donor renal transplantation'),('kidney-transplant',1,'XaM1o',NULL,'Allotransplantation of kidney from cadaver, heart-beating'),('kidney-transplant',1,'XaM1p',NULL,'Allotransplantation kidney from cadaver, heart non-beating'),('kidney-transplant',1,'XaM4e',NULL,'Interventions associated with transplantation of kidney'),('kidney-transplant',1,'XaM4f',NULL,'OS interventions associated with transplantation of kidney'),('kidney-transplant',1,'XaM4g',NULL,'Interventions associated with transplantation of kidney NOS'),('kidney-transplant',1,'XaM4l',NULL,'Post-transplantation of kidney examination, recipient'),('kidney-transplant',1,'XaMKM',NULL,'Allotransplantation of kidney from cadaver NEC'),('kidney-transplant',1,'XaZe2',NULL,'Rupture of artery of transplanted kidney'),('kidney-transplant',1,'XaZe3',NULL,'Rupture of vein of transplanted kidney'),('kidney-transplant',1,'XaZe7',NULL,'Stenosis of vein of transplanted kidney'),('kidney-transplant',1,'XaZkw',NULL,'Aneurysm of vein of transplanted kidney'),('kidney-transplant',1,'XaZl0',NULL,'Aneurysm of artery of transplanted kidney'),('kidney-transplant',1,'XaZWa',NULL,'Urological complication of renal transplant'),('kidney-transplant',1,'XaZYx',NULL,'Vascular complication of renal transplant'),('kidney-transplant',1,'Y1602',NULL,'Kidney-pancreas transplant'),('kidney-transplant',1,'ZV420',NULL,'[V]Kidney transplanted');
INSERT INTO #codesctv3
VALUES ('covid-positive-antigen-test',1,'Y269d',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) antigen detection result positive'),('covid-positive-antigen-test',1,'43kB1',NULL,'SARS-CoV-2 antigen positive');
INSERT INTO #codesctv3
VALUES ('covid-positive-pcr-test',1,'4J3R6',NULL,'SARS-CoV-2 RNA pos lim detect'),('covid-positive-pcr-test',1,'Y240b',NULL,'Severe acute respiratory syndrome coronavirus 2 qualitative existence in specimen (observable entity)'),('covid-positive-pcr-test',1,'Y2a3b',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive'),('covid-positive-pcr-test',1,'A7952',NULL,'COVID-19 confirmed by laboratory test'),('covid-positive-pcr-test',1,'Y228d',NULL,'Coronavirus disease 19 caused by severe acute respiratory syndrome coronavirus 2 confirmed by laboratory test (situation)'),('covid-positive-pcr-test',1,'Y210e',NULL,'Detection of 2019-nCoV (novel coronavirus) using polymerase chain reaction technique'),('covid-positive-pcr-test',1,'43hF.',NULL,'Detection of SARS-CoV-2 by PCR'),('covid-positive-pcr-test',1,'Y2a3d',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive at the limit of detection'),('covid-positive-pcr-test',1,'Xab7a',NULL,'Coronavirus nucleic acid detection assay'),('covid-positive-pcr-test',1,'Xaboe',NULL,'Coronavirus ribonucleic acid detection assay'),('covid-positive-pcr-test',1,'XaLTE',NULL,'Coronavirus nucleic acid detection');
INSERT INTO #codesctv3
VALUES ('covid-positive-test-other',1,'4J3R1',NULL,'2019-nCoV (novel coronavirus) detected'),('covid-positive-test-other',1,'Y20d1',NULL,'Confirmed 2019-nCov (Wuhan) infection'),('covid-positive-test-other',1,'Y23f7',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) detection result positive');
INSERT INTO #codesctv3
VALUES ('egfr',1,'X70kK',NULL,'Tc99m-DTPA clearance - GFR'),('egfr',1,'X70kL',NULL,'Cr51- EDTA clearance - GFR'),('egfr',1,'X90kf',NULL,'With GFR'),('egfr',1,'XaK8y',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'XaMDA',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'XaZpN',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres'),('egfr',1,'XacUJ',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'XacUK',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'XSFyN',NULL,'Glomerular filtration rate');
INSERT INTO #codesctv3
VALUES ('urinary-albumin-creatinine-ratio',1,'46TC.',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'XE2n3',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'46TD.',NULL,'Urine microalbumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'X773Y',NULL,'Albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'XE2n4',NULL,'Urine microalbumin/creatinine ratio')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesctv3;

IF OBJECT_ID('tempdb..#codessnomed') IS NOT NULL DROP TABLE #codessnomed;
CREATE TABLE #codessnomed (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codessnomed
VALUES ('glomerulonephritis',1,'1426004',NULL,'Necrotizing glomerulonephritis (disorder)'),('glomerulonephritis',1,'3704008',NULL,'Diffuse endocapillary proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'4676006',NULL,'Systemic lupus erythematosus glomerulonephritis syndrome, World Health Organization class II (disorder)'),('glomerulonephritis',1,'11013005',NULL,'Systemic lupus erythematosus glomerulonephritis syndrome, World Health Organization class VI'),('glomerulonephritis',1,'13335004',NULL,'Sclerosing glomerulonephritis (disorder)'),('glomerulonephritis',1,'19351000',NULL,'Acute glomerulonephritis (disorder)'),('glomerulonephritis',1,'20917003',NULL,'CGN - Chronic glomerulonephritis'),('glomerulonephritis',1,'35546006',NULL,'Mesangial proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'36171008',NULL,'GN - Glomerulonephritis'),('glomerulonephritis',1,'36402006',NULL,'Systemic lupus erythematosus glomerulonephritis syndrome, World Health Organization class IV'),('glomerulonephritis',1,'44785005',NULL,'MCN - Minimal change nephropathy'),('glomerulonephritis',1,'50581000',NULL,'Goodpasture syndrome'),('glomerulonephritis',1,'52042003',NULL,'Systemic lupus erythematosus glomerulonephritis syndrome, World Health Organization class V'),('glomerulonephritis',1,'55652009',NULL,'Idiopathic crescentic glomerulonephritis type 3'),('glomerulonephritis',1,'57965003',NULL,'Acute benign haemorrhagic glomerulonephritis'),('glomerulonephritis',1,'59479006',NULL,'Mesangiocapillary glomerulonephritis, type II (disorder)'),('glomerulonephritis',1,'64168005',NULL,'Idiopathic crescentic glomerulonephritis, type I (disorder)'),('glomerulonephritis',1,'64212008',NULL,'Diffuse crescentic glomerulonephritis (disorder)'),('glomerulonephritis',1,'68544003',NULL,'PSGN - Post-streptococcal glomerulonephritis'),('glomerulonephritis',1,'68779003',NULL,'Primary immunoglobulin A nephropathy (disorder)'),('glomerulonephritis',1,'68815009',NULL,'Systemic lupus erythematosus glomerulonephritis syndrome'),('glomerulonephritis',1,'73286009',NULL,'Systemic lupus erythematosus glomerulonephritis syndrome, World Health Organization class I (disorder)'),('glomerulonephritis',1,'73305009',NULL,'Amyloid-like glomerulopathy'),('glomerulonephritis',1,'75888001',NULL,'Mesangiocapillary glomerulonephritis type I'),('glomerulonephritis',1,'76521009',NULL,'Systemic lupus erythematosus glomerulonephritis syndrome, World Health Organization class III'),('glomerulonephritis',1,'77182004',NULL,'Chronic nephritic syndrome, diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'80321008',NULL,'Mesangiocapillary glomerulonephritis (disorder)'),('glomerulonephritis',1,'83866005',NULL,'Focal AND segmental proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'123609007',NULL,'Subacute glomerulonephritis (disorder)'),('glomerulonephritis',1,'123752003',NULL,'Immune complex glomerulonephritis'),('glomerulonephritis',1,'197579006',NULL,'Acute proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197582001',NULL,'Acute glomerulonephritis associated with another disorder'),('glomerulonephritis',1,'197589005',NULL,'Nephrotic syndrome with proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197590001',NULL,'Nephrotic syndrome with membranous glomerulonephritis (disorder)'),('glomerulonephritis',1,'197591002',NULL,'Nephrotic syndrome with membranoproliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197595006',NULL,'Nephrotic syndrome, diffuse membranous glomerulonephritis (disorder)'),('glomerulonephritis',1,'197596007',NULL,'Nephrotic syndrome, diffuse mesangial proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197597003',NULL,'Nephrotic syndrome, diffuse endocapillary proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197598008',NULL,'Nephrotic syndrome, diffuse mesangiocapillary glomerulonephritis (disorder)'),('glomerulonephritis',1,'197600002',NULL,'Nephrotic syndrome, diffuse crescentic glomerulonephritis (disorder)'),('glomerulonephritis',1,'197613008',NULL,'Chronic mesangial proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197616000',NULL,'Chronic glomerulonephritis associated with another disorder'),('glomerulonephritis',1,'197617009',NULL,'Chronic exudative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197618004',NULL,'Chronic focal glomerulonephritis (disorder)'),('glomerulonephritis',1,'197619007',NULL,'Chronic diffuse glomerulonephritis (disorder)'),('glomerulonephritis',1,'197626007',NULL,'Focal membranoproliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197629000',NULL,'Anaphylactoid glomerulonephritis (disorder)'),('glomerulonephritis',1,'197683002',NULL,'Acute nephritic syndrome, diffuse membranous glomerulonephritis (disorder)'),('glomerulonephritis',1,'197684008',NULL,'Acute nephritic syndrome, diffuse mesangial proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197685009',NULL,'Acute nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197686005',NULL,'Acute nephritic syndrome, diffuse mesangiocapillary glomerulonephritis (disorder)'),('glomerulonephritis',1,'197688006',NULL,'Acute nephritic syndrome, diffuse crescentic glomerulonephritis (disorder)'),('glomerulonephritis',1,'197692004',NULL,'Rapidly progressive nephritic syndrome, diffuse membranous glomerulonephritis (disorder)'),('glomerulonephritis',1,'197693009',NULL,'Rapidly progressive nephritic syndrome, diffuse mesangial proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197694003',NULL,'Rapidly progressive nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197695002',NULL,'Rapidly progressive nephritic syndrome, diffuse mesangiocapillary glomerulonephritis (disorder)'),('glomerulonephritis',1,'197697005',NULL,'Rapidly progressive nephritic syndrome, diffuse crescentic glomerulonephritis (disorder)'),('glomerulonephritis',1,'197712008',NULL,'Chronic nephritic syndrome, diffuse endocapillary proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'197713003',NULL,'Chronic nephritic syndrome, diffuse mesangiocapillary glomerulonephritis (disorder)'),('glomerulonephritis',1,'197715005',NULL,'Chronic nephritic syndrome, diffuse crescentic glomerulonephritis (disorder)'),('glomerulonephritis',1,'197720005',NULL,'Isolated proteinuria with specified morphological lesion, diffuse membranous glomerulonephritis (finding)'),('glomerulonephritis',1,'197721009',NULL,'Isolated proteinuria with specified morphological lesion, diffuse mesangial proliferative glomerulonephritis (finding)'),('glomerulonephritis',1,'197722002',NULL,'Isolated proteinuria with specified morphological lesion, diffuse endocapillary proliferative glomerulonephritis (finding)'),('glomerulonephritis',1,'197723007',NULL,'Isolated proteinuria with specified morphological lesion, diffuse mesangiocapillary glomerulonephritis (finding)'),('glomerulonephritis',1,'197725000',NULL,'Isolated proteinuria with specified morphological lesion, diffuse concentric glomerulonephritis (finding)'),('glomerulonephritis',1,'236392004',NULL,'Rapidly progressive glomerulonephritis (disorder)'),('glomerulonephritis',1,'236393009',NULL,'Endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'236394003',NULL,'Idiopathic endocapillary glomerulonephritis (disorder)'),('glomerulonephritis',1,'236395002',NULL,'Post-infectious glomerulonephritis (disorder)'),('glomerulonephritis',1,'236397005',NULL,'Post-infectious glomerulonephritis - Garland variety (disorder)'),('glomerulonephritis',1,'236398000',NULL,'Proliferative crescentic glomerulonephritis'),('glomerulonephritis',1,'236399008',NULL,'Steroid-sensitive minimal change glomerulonephritis (disorder)'),('glomerulonephritis',1,'236400001',NULL,'Steroid-resistant minimal change glomerulonephritis (disorder)'),('glomerulonephritis',1,'236401002',NULL,'Steroid-dependent minimal change glomerulonephritis (disorder)'),('glomerulonephritis',1,'236407003',NULL,'Immunoglobulin A nephropathy (disorder)'),('glomerulonephritis',1,'236409000',NULL,'Mesangiocapillary glomerulonephritis type III (disorder)'),('glomerulonephritis',1,'236410005',NULL,'Mesangiocapillary glomerulonephritis type IV (disorder)'),('glomerulonephritis',1,'236411009',NULL,'Immunoglobulin M nephropathy (disorder)'),('glomerulonephritis',1,'236413007',NULL,'Membranous glomerulonephritis - stage I (disorder)'),('glomerulonephritis',1,'236414001',NULL,'Membranous glomerulonephritis - stage II (disorder)'),('glomerulonephritis',1,'236415000',NULL,'Membranous glomerulonephritis - stage III (disorder)'),('glomerulonephritis',1,'236416004',NULL,'Membranous glomerulonephritis - stage IV (disorder)'),('glomerulonephritis',1,'236417008',NULL,'Membranous glomerulonephritis stage V (disorder)'),('glomerulonephritis',1,'236419006',NULL,'Progressive hereditary glomerulonephritis without deafness (disorder)'),('glomerulonephritis',1,'236505008',NULL,'Cryoglobulinemic glomerulonephritis (disorder)'),('glomerulonephritis',1,'236508005',NULL,'Malignancy-associated glomerulonephritis (disorder)'),('glomerulonephritis',1,'236586006',NULL,'De novo glomerulonephritis (disorder)'),('glomerulonephritis',1,'236590008',NULL,'Cytomegalovirus-induced glomerulonephritis (disorder)'),('glomerulonephritis',1,'239932005',NULL,'Primary pauci-immune necrotizing and crescentic glomerulonephritis (disorder)'),('glomerulonephritis',1,'266549004',NULL,'Nephrotic syndrome with minimal change glomerulonephritis (disorder)'),('glomerulonephritis',1,'359694003',NULL,'Idiopathic crescentic glomerulonephritis, type II (disorder)'),('glomerulonephritis',1,'363233007',NULL,'Nephrotic syndrome secondary to glomerulonephritis (disorder)'),
('glomerulonephritis',1,'399190000',NULL,'Non-progressive hereditary glomerulonephritis'),('glomerulonephritis',1,'399340005',NULL,'Alports syndrome'),('glomerulonephritis',1,'425384007',NULL,'Sarcoidosis with glomerulonephritis'),('glomerulonephritis',1,'425455002',NULL,'Diabetic glomerulonephritis'),('glomerulonephritis',1,'427555000',NULL,'Glomerulonephritis co-occurrent and due to Wegeners granulomatosis'),('glomerulonephritis',1,'441815006',NULL,'Proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'445258009',NULL,'Idiopathic rapidly progressive glomerulonephritis'),('glomerulonephritis',1,'707332000',NULL,'Recurrent proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'711531007',NULL,'Focal mesangial proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'714815007',NULL,'Recurrent haematuria co-occurrent and due to diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'714816008',NULL,'Persistent haematuria co-occurrent and due to diffuse crescentic glomerulonephritis'),('glomerulonephritis',1,'714817004',NULL,'Recurrent haematuria co-occurrent and due to diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'714818009',NULL,'Persistent haematuria co-occurrent and due to diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'714819001',NULL,'Recurrent haematuria co-occurrent and due to diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'714820007',NULL,'Persistent haematuria co-occurrent and due to diffuse mesangiocapillary glomerulonephritis'),('glomerulonephritis',1,'714821006',NULL,'Recurrent haematuria co-occurrent and due to diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'714822004',NULL,'Persistent haematuria co-occurrent and due to diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'714825002',NULL,'Recurrent haematuria co-occurrent and due to diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'714826001',NULL,'Persistent haematuria co-occurrent and due to diffuse mesangial proliferative glomerulonephritis'),('glomerulonephritis',1,'718192000',NULL,'Congo red negative amyloidosis like glomerulopathy'),('glomerulonephritis',1,'722086002',NULL,'Malignancy-associated membranous nephropathy'),('glomerulonephritis',1,'722119002',NULL,'Idiopathic membranous nephropathy'),('glomerulonephritis',1,'722120008',NULL,'Membranous glomerulonephritis caused by drug'),('glomerulonephritis',1,'722168002',NULL,'Membranous glomerulonephritis co-occurrent with infectious disease'),('glomerulonephritis',1,'722761003',NULL,'Complement component 3 glomerulonephritis'),('glomerulonephritis',1,'726082003',NULL,'Immunotactoid glomerulonephritis'),('glomerulonephritis',1,'733472005',NULL,'Microcephalus, glomerulonephritis, marfanoid habitus syndrome'),('glomerulonephritis',1,'106911000119102',NULL,'Idiopathic glomerulonephritis'),('glomerulonephritis',1,'120241000119100',NULL,'Glomerulonephritis due to hepatitis C'),('glomerulonephritis',1,'85381000119105',NULL,'Glomerulonephritis due to Henoch-Schönlein purpura (disorder)'),('glomerulonephritis',1,'89681000119101',NULL,'Glomerulonephritis co-occurrent and due to scleroderma'),('glomerulonephritis',1,'101711000119105',NULL,'Glomerulonephritis co-occurrent and due to antineutrophil cytoplasmic antibody positive vasculitis'),('glomerulonephritis',1,'90971000119103',NULL,'Glomerulonephritis co-occurrent and due to vasculitis'),('glomerulonephritis',1,'195791000119101',NULL,'Chronic proliferative glomerulonephritis'),('glomerulonephritis',1,'367561000119103',NULL,'Hereditary diffuse mesangiocapillary glomerulonephritis (disorder)'),('glomerulonephritis',1,'367551000119100',NULL,'Hereditary diffuse mesangial proliferative glomerulonephritis (disorder)'),('glomerulonephritis',1,'367531000119106',NULL,'Hereditary diffuse endocapillary proliferative glomerulonephritis'),('glomerulonephritis',1,'367541000119102',NULL,'Hereditary diffuse membranous glomerulonephritis'),('glomerulonephritis',1,'368941000119108',NULL,'Hereditary nephropathy co-occurrent with membranoproliferative glomerulonephritis type III'),('glomerulonephritis',1,'368881000119109',NULL,'Rapidly progressive nephritic syndrome co-occurrent and due to membranoproliferative glomerulonephritis type III (disorder)'),('glomerulonephritis',1,'28191000119109',NULL,'Chronic nephritic syndrome with membranous glomerulonephritis (disorder)'),('glomerulonephritis',1,'368931000119104',NULL,'Isolated proteinuria co-occurrent and due to membranoproliferative glomerulonephritis type III (disorder)'),('glomerulonephritis',1,'368921000119102',NULL,'Nephritic syndrome co-occurrent and due to membranoproliferative glomerulonephritis type III (disorder)'),('glomerulonephritis',1,'368911000119109',NULL,'Nephrotic syndrome co-occurrent and due to membranoproliferative glomerulonephritis type III'),('glomerulonephritis',1,'367511000119101',NULL,'Hereditary dense deposit disease'),('glomerulonephritis',1,'367521000119108',NULL,'Hereditary diffuse crescentic glomerulonephritis (disorder)'),('glomerulonephritis',1,'368871000119106',NULL,'Acute nephritic syndrome co-occurrent and due to membranoproliferative glomerulonephritis type III (disorder)'),('glomerulonephritis',1,'368901000119106',NULL,'Chronic nephritic syndrome co-occurrent and due to membranoproliferative glomerulonephritis type III (disorder)'),('glomerulonephritis',1,'123610002',NULL,'Healed glomerulonephritis (disorder)');
INSERT INTO #codessnomed
VALUES ('kidney-stones',1,'95570007',NULL,'Kidney stone (disorder)'),('kidney-stones',1,'833291009',NULL,'Calcium oxalate calculus of kidney (disorder)'),('kidney-stones',1,'427649000',NULL,'Calcium renal calculus (disorder)'),('kidney-stones',1,'23754003',NULL,'Calculous pyelonephritis (disorder)'),('kidney-stones',1,'236710009',NULL,'Calculus in renal pelvis (disorder)'),('kidney-stones',1,'266556005',NULL,'Calculus of kidney and ureter (disorder)'),('kidney-stones',1,'236708007',NULL,'Calyceal renal calculus (disorder)'),('kidney-stones',1,'48061001',NULL,'Congenital calculus of kidney (disorder)'),('kidney-stones',1,'833293007',NULL,'Cystine calculus of kidney (disorder)'),('kidney-stones',1,'699322002',NULL,'Matrix stone of kidney (disorder)'),('kidney-stones',1,'168041003',NULL,'On examination - renal calculus (disorder)'),('kidney-stones',1,'275893001',NULL,'Phosphate calculus of kidney (disorder)'),('kidney-stones',1,'1056501000112102',NULL,'Recurrent kidney stone (disorder)'),('kidney-stones',1,'197794008',NULL,'Staghorn calculus (disorder)'),('kidney-stones',1,'274401005',NULL,'Uric acid renal calculus (disorder)'),('kidney-stones',1,'236713006',NULL,'X-linked recessive nephrolithiasis with renal failure (disorder)');
INSERT INTO #codessnomed
VALUES ('vasculitis',1,'228007',NULL,'Lucio phenomenon (disorder)'),('vasculitis',1,'9177003',NULL,'Histiocytic vasculitis of skin (disorder)'),('vasculitis',1,'11791001',NULL,'Necrotizing vasculitis (disorder)'),('vasculitis',1,'31996006',NULL,'Vasculitis (disorder)'),('vasculitis',1,'46286007',NULL,'Lymphocytic vasculitis of skin (disorder)'),('vasculitis',1,'46956008',NULL,'Polyangiitis'),('vasculitis',1,'53312001',NULL,'Vasculitis of the skin (disorder)'),('vasculitis',1,'55275006',NULL,'Non-tubercular erythema induratum'),('vasculitis',1,'56780006',NULL,'Segmental hyalinizing vasculitis (disorder)'),('vasculitis',1,'60555002',NULL,'Hypersensitivity angiitis (disorder)'),('vasculitis',1,'64832003',NULL,'Neutrophilic vasculitis of skin (disorder)'),('vasculitis',1,'77628002',NULL,'Retinal vasculitis (disorder)'),('vasculitis',1,'95578000',NULL,'Renal vasculitis (disorder)'),('vasculitis',1,'190815001',NULL,'Cryoglobulinemic vasculitis (disorder)'),('vasculitis',1,'191306005',NULL,'Henoch-Schönlein purpura (disorder)'),('vasculitis',1,'230731002',NULL,'Cerebral arteritis in systemic vasculitis (disorder)'),('vasculitis',1,'230733004',NULL,'Isolated angiitis of central nervous system (disorder)'),('vasculitis',1,'234019004',NULL,'Secondary systemic vasculitis (disorder)'),('vasculitis',1,'234020005',NULL,'Vasculitis caused by drug'),('vasculitis',1,'238762002',NULL,'Livedoid vasculitis (disorder)'),('vasculitis',1,'238785001',NULL,'Primary cutaneous vasculitis (disorder)'),('vasculitis',1,'238786000',NULL,'Gougerot-Ruiter purpura (disorder)'),('vasculitis',1,'238787009',NULL,'Secondary cutaneous vasculitis (disorder)'),('vasculitis',1,'239924002',NULL,'Primary necrotizing systemic vasculitis (disorder)'),('vasculitis',1,'239933000',NULL,'Primary necrotizing vasculitis with granulomata (disorder)'),('vasculitis',1,'239941000',NULL,'Nailfold rheumatoid vasculitis (disorder)'),('vasculitis',1,'239942007',NULL,'Systemic rheumatoid vasculitis (disorder)'),('vasculitis',1,'239943002',NULL,'Necrotizing rheumatoid vasculitis (disorder)'),('vasculitis',1,'239944008',NULL,'Lupus erythematosus-associated vasculitis'),('vasculitis',1,'239945009',NULL,'Hypocomplementemic urticarial vasculitis (disorder)'),('vasculitis',1,'239947001',NULL,'Essential mixed cryoglobulinemia (disorder)'),('vasculitis',1,'400054000',NULL,'Rheumatoid vasculitis'),('vasculitis',1,'402416000',NULL,'Urticarial vasculitis with monoclonal immunoglobulin M component, Schnitzler'),('vasculitis',1,'402655006',NULL,'Necrotizing cutaneous vasculitis'),('vasculitis',1,'402656007',NULL,'Urticarial vasculitis'),('vasculitis',1,'402657003',NULL,'Necrotizing vasculitis secondary to connective tissue disease'),('vasculitis',1,'402658008',NULL,'Serum sickness type vasculitis'),('vasculitis',1,'402659000',NULL,'Drug-induced necrotizing vasculitis'),('vasculitis',1,'402660005',NULL,'Necrotizing vasculitis secondary to infection'),('vasculitis',1,'402661009',NULL,'Paraneoplastic vasculitis'),('vasculitis',1,'402662002',NULL,'Necrotizing vasculitis due to mixed cryoglobulinemia'),('vasculitis',1,'402663007',NULL,'Pustular vasculitis'),('vasculitis',1,'402664001',NULL,'Localized cutaneous vasculitis'),('vasculitis',1,'402855009',NULL,'Normocomplementemic urticarial vasculitis'),('vasculitis',1,'402859003',NULL,'Necrotizing vasculitis of undetermined etiology'),('vasculitis',1,'402958005',NULL,'Pustular vasculitis due to gonococcal bacteremia'),('vasculitis',1,'403510002',NULL,'Urticarial vasculitis due to lupus erythematosus'),('vasculitis',1,'403511003',NULL,'Necrotizing vasculitis due to lupus erythematosus'),('vasculitis',1,'403518009',NULL,'Necrotizing vasculitis due to scleroderma'),('vasculitis',1,'403616000',NULL,'Drug-induced lymphocytic vasculitis'),('vasculitis',1,'407530004',NULL,'Primary systemic vasculitis'),('vasculitis',1,'416703007',NULL,'Retinal vasculitis due to polyarteritis nodosa'),('vasculitis',1,'417303004',NULL,'Retinal vasculitis due to systemic lupus erythematosus'),('vasculitis',1,'427020007',NULL,'Cerebral vasculitis'),('vasculitis',1,'427213005',NULL,'Autoimmune vasculitis'),('vasculitis',1,'427356003',NULL,'Eosinophilic vasculitis of skin'),('vasculitis',1,'718217000',NULL,'Cutaneous small vessel vasculitis'),('vasculitis',1,'721664001',NULL,'Mesenteric arteritis'),('vasculitis',1,'722191003',NULL,'Antineutrophil cytoplasmic antibody (ANCA) positive vasculitis'),('vasculitis',1,'722858009',NULL,'Vasculitis of large intestine'),('vasculitis',1,'724063005',NULL,'Postinfective vasculitis'),('vasculitis',1,'724597006',NULL,'Large vessel vasculitis'),('vasculitis',1,'724598001',NULL,'Medium sized vessel vasculitis'),('vasculitis',1,'724599009',NULL,'Small vessel vasculitis'),('vasculitis',1,'724600007',NULL,'Immune complex small vessel vasculitis'),('vasculitis',1,'724601006',NULL,'Vasculitis caused by antineutrophil cytoplasmic antibody'),('vasculitis',1,'724602004',NULL,'Single organ vasculitis'),('vasculitis',1,'724996005',NULL,'Vasculitic lumbosacral plexopathy'),('vasculitis',1,'737184001',NULL,'Interstitial lung disease with systemic vasculitis'),('vasculitis',1,'762302008',NULL,'Drug-associated immune complex vasculitis'),('vasculitis',1,'762352004',NULL,'Demyelination due to systemic vasculitis'),('vasculitis',1,'762537007',NULL,'Livedoid vasculitis of lower limb due to varicose veins of lower limb'),('vasculitis',1,'985941000000100',NULL,'Medium vessel vasculitis (disorder)'),('vasculitis',1,'101711000119105',NULL,'Glomerulonephritis co-occurrent and due to antineutrophil cytoplasmic antibody positive vasculitis'),('vasculitis',1,'985971000000106',NULL,'Sarcoid vasculitis (disorder)'),('vasculitis',1,'988101000000109',NULL,'Vasculitis co-occurrent and due to Hepatitis B virus infection (disorder)'),('vasculitis',1,'988081000000103',NULL,'Antineutrophil cytoplasmic antibody associated vasculitis caused by drug (disorder)'),('vasculitis',1,'988111000000106',NULL,'Cryoglobulinaemic vasculitis co-occurrent and due to Hepatitis C virus infection (disorder)'),('vasculitis',1,'233948000',NULL,'Pulmonary hypertension in vasculitis'),('vasculitis',1,'703355003',NULL,'Pulmonary hypertension due to vasculitis (disorder)'),('vasculitis',1,'404658009',NULL,'Optic disc vasculitis'),('vasculitis',1,'193177003',NULL,'Polyneuropathy in collagen vascular disease (disorder)'),('vasculitis',1,'472974007',NULL,'History of vasculitis');
INSERT INTO #codessnomed
VALUES ('covid-positive-antigen-test',1,'1322781000000102',NULL,'Severe acute respiratory syndrome coronavirus 2 antigen detection result positive (finding)'),('covid-positive-antigen-test',1,'871553007',NULL,'Detection of Severe acute respiratory syndrome coronavirus 2 antigen (observable entity)'),('covid-positive-antigen-test',1,'1240391000000107',NULL,'Antigen of severe acute respiratory syndrome coronavirus 2'),('covid-positive-antigen-test',1,'51631000237101',NULL,'Qualitative result of severe acute respiratory syndrome coronavirus 2 antigen in serum (observable entity)');
INSERT INTO #codessnomed
VALUES ('covid-positive-pcr-test',1,'1240511000000106',NULL,'Detection of 2019 novel coronavirus using polymerase chain reaction technique (procedure)'),('covid-positive-pcr-test',1,'1300721000000109',NULL,'Coronavirus disease 19 caused by severe acute respiratory syndrome coronavirus 2 confirmed by laboratory test (situation)'),('covid-positive-pcr-test',1,'871560001',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 using polymerase chain reaction (observable entity)'),('covid-positive-pcr-test',1,'1269559008',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 using microchip real time polymerase chain reaction (observable entity)'),('covid-positive-pcr-test',1,'204351000000100',NULL,'Coronavirus nucleic acid detection (procedure)'),('covid-positive-pcr-test',1,'906711000000107',NULL,'Coronavirus nucleic acid detection assay (procedure)'),('covid-positive-pcr-test',1,'933791000000101',NULL,'Coronavirus ribonucleic acid detection assay (procedure)'),('covid-positive-pcr-test',1,'817111000000102',NULL,'Measurement of coronavirus ribonucleic acid by nucleic acid amplification test (procedure)'),('covid-positive-pcr-test',1,'1029481000000103',NULL,'Coronavirus nucleic acid detection assay (observable entity)'),('covid-positive-pcr-test',1,'1008541000000105',NULL,'Coronavirus ribonucleic acid detection assay (observable entity)'),('covid-positive-pcr-test',1,'1321301000000101',NULL,'Severe acute respiratory syndrome coronavirus 2 ribonucleic acid qualitative existence in specimen (observable entity)'),('covid-positive-pcr-test',1,'1324601000000106',NULL,'Severe acute respiratory syndrome coronavirus 2 ribonucleic acid detected (finding)'),('covid-positive-pcr-test',1,'1324881000000100',NULL,'Severe acute respiratory syndrome coronavirus 2 ribonucleic acid detection result positive at the limit of detection (finding)');
INSERT INTO #codessnomed
VALUES ('covid-positive-test-other',1,'1240581000000104',NULL,'Severe acute respiratory syndrome coronavirus 2 detected (finding)'),('covid-positive-test-other',1,'1321301000000101',NULL,'Severe acute respiratory syndrome coronavirus 2 qualitative existence in specimen (observable entity)'),('covid-positive-test-other',1,'1324601000000106',NULL,'Severe acute respiratory syndrome coronavirus 2 ribonucleic acid detected (finding)'),('covid-positive-test-other',1,'1324881000000100',NULL,'Severe acute respiratory syndrome coronavirus 2 ribonucleic acid detection result positive at the limit of detection (finding)'),('covid-positive-test-other',1,'871562009',NULL,'Detection of Severe acute respiratory syndrome coronavirus 2 (observable entity)'),('covid-positive-test-other',1,'1300731000000106',NULL,'Coronavirus disease 19 caused by severe acute respiratory syndrome coronavirus 2 confirmed using clinical diagnostic criteria (situation)'),('covid-positive-test-other',1,'1240751000000100 ',NULL,'Coronavirus disease 19 caused by severe acute respiratory syndrome coronavirus 2'),('covid-positive-test-other',1,'189486241000119100 ',NULL,'Asymptomatic Severe acute respiratory syndrome coronavirus 2 infection'),('covid-positive-test-other',1,'871555000',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 (observable entity)'),('covid-positive-test-other',1,'50321000237103',NULL,'Qualitative result of severe acute respiratory syndrome coronavirus 2 ribonucleic acid nucleic acid amplification (observable entity)'),('covid-positive-test-other',1,'871560001',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 using polymerase chain reaction (observable entity)'),('covid-positive-test-other',1,'1269559008',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 using microchip real time polymerase chain reaction (observable entity)'),('covid-positive-test-other',1,'871559006',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 in bronchoalveolar lavage fluid (observable entity)'),('covid-positive-test-other',1,'871558003',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 in sputum (observable entity)'),('covid-positive-test-other',1,'871557008',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 in oropharyngeal swab (observable entity)'),('covid-positive-test-other',1,'871556004',NULL,'Detection of ribonucleic acid of severe acute respiratory syndrome coronavirus 2 in nasopharyngeal swab (observable entity)'),('covid-positive-test-other',1,'871553007',NULL,'Detection of severe acute respiratory syndrome coronavirus 2 antigen (observable entity)'),('covid-positive-test-other',1,'51631000237101',NULL,'Qualitative result of severe acute respiratory syndrome coronavirus 2 antigen in serum (observable entity)'),('covid-positive-test-other',1,'840539006',NULL,'Disease caused by Severe acute respiratory syndrome coronavirus 2 (disorder)'),('covid-positive-test-other',1,'840544004',NULL,'Suspected disease caused by 2019 novel coronavirus (situation)'),('covid-positive-test-other',1,'1325171000000109',NULL,'Acute disease caused by severe acute respiratory syndrome coronavirus 2 infection (disorder)'),('covid-positive-test-other',1,'1240761000000102',NULL,'Suspected disease caused by 2019 novel coronavirus (situation)'),('covid-positive-test-other',1,'1300681000000102',NULL,'Assessment using coronavirus disease 19 severity scale (procedure)'),('covid-positive-test-other',1,'1325181000000106',NULL,'Ongoing symptomatic disease caused by severe acute respiratory syndrome coronavirus 2 (disorder)');
INSERT INTO #codessnomed
VALUES ('egfr',1,'1011481000000105',NULL,'eGFR (estimated glomerular filtration rate) using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'1011491000000107',NULL,'eGFR (estimated glomerular filtration rate) using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'1020291000000106',NULL,'GFR (glomerular filtration rate) calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation'),('egfr',1,'1107411000000104',NULL,'eGFR (estimated glomerular filtration rate) by laboratory calculation'),('egfr',1,'241373003',NULL,'Technetium-99m-diethylenetriamine pentaacetic acid clearance - glomerular filtration rate (procedure)'),('egfr',1,'262300005',NULL,'With glomerular filtration rate'),('egfr',1,'737105002',NULL,'GFR (glomerular filtration rate) calculation technique'),('egfr',1,'80274001',NULL,'Glomerular filtration rate (observable entity)'),('egfr',1,'996231000000108',NULL,'GFR (glomerular filtration rate) calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'857971000000104',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula (observable entity)'),('egfr',1,'963601000000106',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation (observable entity)'),('egfr',1,'963611000000108',NULL,'Estimated glomerular filtration rate using cystatin C per 1.73 square metres'),('egfr',1,'963621000000102',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation (observable entity)'),('egfr',1,'963631000000100',NULL,'Estimated glomerular filtration rate using serum creatinine per 1.73 square metres'),('egfr',1,'857981000000102',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula per 1.73 square metres');
INSERT INTO #codessnomed
VALUES ('urinary-albumin-creatinine-ratio',1,'144011000',NULL,'Albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'144765005',NULL,'Urine albumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'144766006',NULL,'Urine microalbumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'166721005',NULL,'Albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'167540008',NULL,'Urine albumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'167541007',NULL,'Urine microalbumin:creatinine ratio (& level)'),('urinary-albumin-creatinine-ratio',1,'250745003',NULL,'Albumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'271075006',NULL,'Urine albumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'271076007',NULL,'Urine microalbumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'149861000000104',NULL,'Semi-quantitative result of albumin to creatinine ratio in urine by test strip'),('urinary-albumin-creatinine-ratio',1,'1023491000000104',NULL,'Urine albumin:creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'1027791000000103',NULL,'Urine microalbumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'1028271000000109',NULL,'Albumin/creatinine ratio')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codessnomed;

IF OBJECT_ID('tempdb..#codesemis') IS NOT NULL DROP TABLE #codesemis;
CREATE TABLE #codesemis (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesemis
VALUES ('covid-positive-antigen-test',1,'^ESCT1305304',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) antigen detection result positive'),('covid-positive-antigen-test',1,'^ESCT1348538',NULL,'Detection of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) antigen'),('covid-positive-antigen-test',1,'^ESCT1305305',NULL,'2019-nCoV (novel coronavirus) antigen detection result positive'),('covid-positive-antigen-test',1,'^ESCT1348539',NULL,'Detection of Severe acute respiratory syndrome coronavirus 2 antigen'),('covid-positive-antigen-test',1,'^ESCT1348540',NULL,'Detection of 2019 novel coronavirus antigen'),('covid-positive-antigen-test',1,'^ESCT1348541',NULL,'Detection of 2019-nCoV (novel coronavirus) antigen'),('covid-positive-antigen-test',1,'^ESCT1299023',NULL,'Antigen of 2019-nCoV (novel coronavirus)'),('covid-positive-antigen-test',1,'^ESCT1299024',NULL,'Antigen of Wuhan 2019-nCoV (novel coronavirus)'),('covid-positive-antigen-test',1,'^ESCT1299025',NULL,'Antigen of 2019 novel coronavirus'),('covid-positive-antigen-test',1,'^ESCT1301213',NULL,'Antigen of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2)');
INSERT INTO #codesemis
VALUES ('covid-positive-pcr-test',1,'^ESCT1305238',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) qualitative existence in specimen'),('covid-positive-pcr-test',1,'^ESCT1348314',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive'),('covid-positive-pcr-test',1,'^ESCT1305235',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive'),('covid-positive-pcr-test',1,'^ESCT1300228',NULL,'COVID-19 confirmed by laboratory test GP COVID-19'),('covid-positive-pcr-test',1,'^ESCT1348316',NULL,'2019-nCoV (novel coronavirus) ribonucleic acid detected'),('covid-positive-pcr-test',1,'^ESCT1301223',NULL,'Detection of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) using polymerase chain reaction technique'),('covid-positive-pcr-test',1,'^ESCT1348359',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive at the limit of detection'),('covid-positive-pcr-test',1,'^ESCT1299053',NULL,'Detection of 2019-nCoV (novel coronavirus) using polymerase chain reaction technique'),('covid-positive-pcr-test',1,'^ESCT1300228',NULL,'COVID-19 confirmed by laboratory test'),('covid-positive-pcr-test',1,'^ESCT1348359',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive at the limit of detection'),('covid-positive-pcr-test',1,'^ESCT1299054',NULL,'Detection of Wuhan 2019-nCoV (novel coronavirus) using polymerase chain reaction technique'),('covid-positive-pcr-test',1,'^ESCT1299055',NULL,'Detection of 2019 novel coronavirus using polymerase chain reaction technique'),('covid-positive-pcr-test',1,'^ESCT1348570',NULL,'Detection of RNA (ribonucleic acid) of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) using polymerase chain reaction'),('covid-positive-pcr-test',1,'^ESCT1348571',NULL,'Detection of ribonucleic acid of COVID-19 using polymerase chain reaction'),('covid-positive-pcr-test',1,'^ESCT1348572',NULL,'Detection of ribonucleic acid of 2019 novel coronavirus using polymerase chain reaction'),('covid-positive-pcr-test',1,'^ESCT1348573',NULL,'Detection of ribonucleic acid of Severe acute respiratory syndrome coronavirus 2 using polymerase chain reaction'),('covid-positive-pcr-test',1,'^ESCT1348574',NULL,'Detection of ribonucleic acid of 2019-nCoV (novel coronavirus) using polymerase chain reaction'),('covid-positive-pcr-test',1,'^ESCTCO806483',NULL,'Coronavirus nucleic acid detection'),('covid-positive-pcr-test',1,'^ESCTCO832162',NULL,'Coronavirus nucleic acid detection assay'),('covid-positive-pcr-test',1,'^ESCTCO833909',NULL,'Coronavirus RNA (ribonucleic acid) detection assay'),('covid-positive-pcr-test',1,'^ESCT1348315',NULL,'Severe acute respiratory syndrome coronavirus 2 ribonucleic acid detected');
INSERT INTO #codesemis
VALUES ('covid-positive-test-other',1,'^ESCT1303928',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) detection result positive'),('covid-positive-test-other',1,'^ESCT1299074',NULL,'2019-nCoV (novel coronavirus) detected'),('covid-positive-test-other',1,'^ESCT1301230',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) detected'),('covid-positive-test-other',1,'EMISNQCO303',NULL,'Confirmed 2019-nCoV (Wuhan) infectio'),('covid-positive-test-other',1,'^ESCT1299075',NULL,'Wuhan 2019-nCoV (novel coronavirus) detected'),('covid-positive-test-other',1,'^ESCT1300229',NULL,'COVID-19 confirmed using clinical diagnostic criteria'),('covid-positive-test-other',1,'^ESCT1348575',NULL,'Detection of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2)'),('covid-positive-test-other',1,'^ESCT1299074',NULL,'2019-nCoV (novel coronavirus) detected'),('covid-positive-test-other',1,'^ESCT1300229',NULL,'COVID-19 confirmed using clinical diagnostic criteria'),('covid-positive-test-other',1,'EMISNQCO303',NULL,'Confirmed 2019-nCoV (novel coronavirus) infection'),('covid-positive-test-other',1,'EMISNQCO303',NULL,'Confirmed 2019-nCoV (novel coronavirus) infection'),('covid-positive-test-other',1,'^ESCT1348575',NULL,'Detection of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2)'),('covid-positive-test-other',1,'^ESCT1299076',NULL,'2019 novel coronavirus detected'),('covid-positive-test-other',1,'^ESCT1303246',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) qualitative existence in specimen'),('covid-positive-test-other',1,'^ESCT1303247',NULL,'2019-nCoV (novel coronavirus) qualitative existence in specimen'),('covid-positive-test-other',1,'^ESCT1348315',NULL,'Severe acute respiratory syndrome coronavirus 2 ribonucleic acid detected'),('covid-positive-test-other',1,'^ESCT1348360',NULL,'2019-nCoV (novel coronavirus) detection result positive at the limit of detection'),('covid-positive-test-other',1,'^ESCT1348394',NULL,'Severe acute respiratory syndrome coronavirus 2 detected'),('covid-positive-test-other',1,'^ESCT1348395',NULL,'COVID-19 detected'),('covid-positive-test-other',1,'^ESCT1300230',NULL,'Probable COVID-19 confirmed using clinical diagnostic criteria'),('covid-positive-test-other',1,'^ESCT1300231',NULL,'COVID-19 confirmed clinically'),('covid-positive-test-other',1,'^ESCT1305235',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive'),('covid-positive-test-other',1,'^ESCT1305238',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) qualitative existence in specimen'),('covid-positive-test-other',1,'^ESCT1348314',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive'),('covid-positive-test-other',1,'^ESCT1348316',NULL,'2019-nCoV (novel coronavirus) ribonucleic acid detected'),('covid-positive-test-other',1,'^ESCT1348359',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) RNA (ribonucleic acid) detection result positive at the limit of detection'),('covid-positive-test-other',1,'^ESCT1348576',NULL,'Detection of Severe acute respiratory syndrome coronavirus 2'),('covid-positive-test-other',1,'^ESCT1348577',NULL,'Detection of COVID-19'),('covid-positive-test-other',1,'^ESCT1348578',NULL,'2019 novel coronavirus assay'),('covid-positive-test-other',1,'^ESCT1348579',NULL,'Detection of 2019-nCoV (novel coronavirus)'),('covid-positive-test-other',1,'^ESCT1299074',NULL,'2019-nCoV (novel coronavirus) detected'),('covid-positive-test-other',1,'^ESCT1299075',NULL,'Wuhan 2019-nCoV (novel coronavirus) detected'),('covid-positive-test-other',1,'^ESCT1299076',NULL,'2019 novel coronavirus detected'),('covid-positive-test-other',1,'^ESCT1301230',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) detected'),('covid-positive-test-other',1,'^ESCT1303246',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) qualitative existence in specimen'),('covid-positive-test-other',1,'^ESCT1303247',NULL,'2019-nCoV (novel coronavirus) qualitative existence in specimen'),('covid-positive-test-other',1,'^ESCT1303928',NULL,'SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) detection result positive'),('covid-positive-test-other',1,'^ESCT1348360',NULL,'2019-nCoV (novel coronavirus) detection result positive at the limit of detection'),('covid-positive-test-other',1,'^ESCT1348394',NULL,'Severe acute respiratory syndrome coronavirus 2 detected'),('covid-positive-test-other',1,'^ESCT1348395',NULL,'COVID-19 detected'),('covid-positive-test-other',1,'^ESCT1299113',NULL,'Disease caused by 2019-nCoV (novel coronavirus)'),('covid-positive-test-other',1,'^ESCT1299114',NULL,'Disease caused by Wuhan 2019-nCoV (novel coronavirus)'),('covid-positive-test-other',1,'^ESCT1299115',NULL,'Disease caused by 2019 novel coronavirus'),('covid-positive-test-other',1,'^ESCT1301243',NULL,'COVID-19'),('covid-positive-test-other',1,'^ESCT1301244',NULL,'COVID-19 caused by SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2)'),('covid-positive-test-other',1,'^ESCT1348538',NULL,'Detection of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) antigen'),('covid-positive-test-other',1,'^ESCT1348539',NULL,'Detection of Severe acute respiratory syndrome coronavirus 2 antigen'),('covid-positive-test-other',1,'^ESCT1348540',NULL,'Detection of 2019 novel coronavirus antigen'),('covid-positive-test-other',1,'^ESCT1348541',NULL,'Detection of 2019-nCoV (novel coronavirus) antigen'),('covid-positive-test-other',1,'^ESCT1348542',NULL,'Detection of ribonucleic acid of Severe acute respiratory syndrome coronavirus 2'),('covid-positive-test-other',1,'^ESCT1348543',NULL,'Detection of ribonucleic acid of COVID-19'),('covid-positive-test-other',1,'^ESCT1348544',NULL,'2019 novel coronavirus ribonucleic acid assay'),('covid-positive-test-other',1,'^ESCT1348545',NULL,'COVID-19 ribonucleic acid assay'),('covid-positive-test-other',1,'^ESCT1348546',NULL,'Detection of RNA (ribonucleic acid) of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) in nasopharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348547',NULL,'Detection of ribonucleic acid of 2019 novel coronavirus in nasopharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348548',NULL,'Nasopharyngeal swab COVID-19 ribonucleic acid assay'),('covid-positive-test-other',1,'^ESCT1348549',NULL,'Detection of ribonucleic acid of Severe acute respiratory syndrome coronavirus 2 in nasopharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348550',NULL,'Detection of ribonucleic acid of COVID-19 in nasopharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348551',NULL,'Detection of ribonucleic acid of 2019-nCoV (novel coronavirus) in nasopharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348552',NULL,'Detection of RNA (ribonucleic acid) of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) in oropharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348553',NULL,'Detection of ribonucleic acid of 2019 novel coronavirus in oropharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348554',NULL,'Oropharyngeal swab COVID-19 ribonucleic acid assay'),('covid-positive-test-other',1,'^ESCT1348555',NULL,'Detection of ribonucleic acid of COVID-19 in oropharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348556',NULL,'Detection of ribonucleic acid of Severe acute respiratory syndrome coronavirus 2 in oropharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348557',NULL,'Detection of ribonucleic acid of 2019-nCoV (novel coronavirus) in oropharyngeal swab'),('covid-positive-test-other',1,'^ESCT1348558',NULL,'Detection of RNA (ribonucleic acid) of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) in sputum'),('covid-positive-test-other',1,'^ESCT1348559',NULL,'Detection of ribonucleic acid of Severe acute respiratory syndrome coronavirus 2 in sputum'),('covid-positive-test-other',1,'^ESCT1348560',NULL,'Sputum COVID-19 ribonucleic acid assay'),('covid-positive-test-other',1,'^ESCT1348561',NULL,'Detection of ribonucleic acid of COVID-19 in sputum'),('covid-positive-test-other',1,'^ESCT1348562',NULL,'Detection of ribonucleic acid of 2019 novel coronavirus in sputum'),('covid-positive-test-other',1,'^ESCT1348563',NULL,'Detection of ribonucleic acid of 2019-nCoV (novel coronavirus) in sputum'),('covid-positive-test-other',1,'^ESCT1348564',NULL,'Detection of RNA (ribonucleic acid) of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) in bronchoalveolar lavage fluid'),('covid-positive-test-other',1,'^ESCT1348565',NULL,'Detection of ribonucleic acid of COVID-19 in bronchoalveolar lavage fluid'),('covid-positive-test-other',1,'^ESCT1348566',NULL,'Bronchoalveolar lavage fluid COVID-19 ribonucleic acid assay'),('covid-positive-test-other',1,'^ESCT1348567',NULL,'Detection of ribonucleic acid of Severe acute respiratory syndrome coronavirus 2 in bronchoalveolar lavage fluid'),('covid-positive-test-other',1,'^ESCT1348568',NULL,'Detection of ribonucleic acid of 2019 novel coronavirus in bronchoalveolar lavage fluid'),('covid-positive-test-other',1,'^ESCT1348569',NULL,'Detection of ribonucleic acid of 2019-nCoV (novel coronavirus) in bronchoalveolar lavage fluid'),('covid-positive-test-other',1,'^ESCT1348570',NULL,'Detection of RNA (ribonucleic acid) of SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) using polymerase chain reaction'),('covid-positive-test-other',1,'^ESCT1348571',NULL,'Detection of ribonucleic acid of COVID-19 using polymerase chain reaction'),('covid-positive-test-other',1,'^ESCT1348572',NULL,'Detection of ribonucleic acid of 2019 novel coronavirus using polymerase chain reaction'),('covid-positive-test-other',1,'^ESCT1348573',NULL,'Detection of ribonucleic acid of Severe acute respiratory syndrome coronavirus 2 using polymerase chain reaction'),
('covid-positive-test-other',1,'^ESCT1348574',NULL,'Detection of ribonucleic acid of 2019-nCoV (novel coronavirus) using polymerase chain reaction'),('covid-positive-test-other',1,'^ESCT1348656',NULL,'Asymptomatic SARS-CoV-2 (severe acute respiratory syndrome coronavirus 2) infection'),('covid-positive-test-other',1,'^ESCT1348657',NULL,'Asymptomatic COVID-19'),('covid-positive-test-other',1,'^ESCT1348658',NULL,'Asymptomatic 2019 novel coronavirus'),('covid-positive-test-other',1,'^ESCT1348659',NULL,'Asymptomatic Severe acute respiratory syndrome coronavirus 2 infection'),('covid-positive-test-other',1,'^ESCT1348660',NULL,'Asymptomatic 2019-nCoV (novel coronavirus) infection'),('covid-positive-test-other',1,'^ESCT1421535',NULL,'Detection of ribonucleic acid of SARS-CoV-2 in bronchoalveolar lavage fluid');
INSERT INTO #codesemis
VALUES ('egfr',1,'^ESCT1167392',NULL,'Glomerular filtration rate calculation technique'),('egfr',1,'^ESCT1167393',NULL,'GFR - Glomerular filtration rate calculation technique'),('egfr',1,'^ESCT1237005',NULL,'GFR (glomerular filtration rate) calculation technique'),('egfr',1,'^ESCT1249126',NULL,'eGFR (estimated glomerular filtration rate) using CKD-Epi (Chronic Kidney Disease Epidemiology Collaboration) formula per 1.73 square metres'),('egfr',1,'^ESCT1262192',NULL,'Estimated glomerular filtration rate by laboratory calculation'),('egfr',1,'^ESCT1262193',NULL,'eGFR (estimated glomerular filtration rate) by laboratory calculation'),('egfr',1,'^ESCT1268044',NULL,'GFR - glomerular filtration rate'),('egfr',1,'^ESCT1437095',NULL,'Glomerular filtration rate calculated by abbreviated Modification of Diet in Renal Disease Study Group calculation adjusted for African American origin'),('egfr',1,'^ESCT1437099',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'^ESCT1437100',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation per 1.73 square metres'),('egfr',1,'^ESCTEG829482',NULL,'eGFR (estimated glomerular filtration rate) using CKD-Epi (Chronic Kidney Disease Epidemiology Collaboration) formula'),('egfr',1,'^ESCTEG835295',NULL,'eGFR (estimated glomerular filtration rate) using cystatin C CKD-EPI (Chronic Kidney Disease Epidemiology Collaboration) equation'),('egfr',1,'^ESCTEG835298',NULL,'eGFR (estimated glomerular filtration rate) using creatinine CKD-EPI (Chronic Kidney Disease Epidemiology Collaboration) equation'),('egfr',1,'^ESCTES829480',NULL,'Estimated glomerular filtration rate using Chronic Kidney Disease Epidemiology Collaboration formula'),('egfr',1,'^ESCTES835294',NULL,'Estimated glomerular filtration rate using cystatin C Chronic Kidney Disease Epidemiology Collaboration equation'),('egfr',1,'^ESCTES835297',NULL,'Estimated glomerular filtration rate using creatinine Chronic Kidney Disease Epidemiology Collaboration equation'),('egfr',1,'^ESCTTC515939',NULL,'Tc99m-DTPA clearance - GFR'),('egfr',1,'^ESCTTE515940',NULL,'Technetium-99m-diethylenetriamine pentaacetic acid clearance - glomerular filtration rate'),('egfr',1,'^ESCTWI545152',NULL,'With GFR'),('egfr',1,'^ESCTWI545153',NULL,'With glomerular filtration rate');
INSERT INTO #codesemis
VALUES ('urinary-albumin-creatinine-ratio',1,'^ESCT1268129',NULL,'Albumin/creatinine ratio in urine'),('urinary-albumin-creatinine-ratio',1,'^ESCT1435793',NULL,'ACR (albumin to creatinine ratio) in urine by test strip semi-quantitative result'),('urinary-albumin-creatinine-ratio',1,'^ESCT1435794',NULL,'Semi-quantitative result of albumin to creatinine ratio in urine by test strip'),('urinary-albumin-creatinine-ratio',1,'^ESCTAL528959',NULL,'Albumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'^ESCTAL528960',NULL,'Albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'^ESCTAL840923',NULL,'Albumin / creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552017',NULL,'Urine albumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552018',NULL,'Urine albumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552019',NULL,'Urine microalbumin/creatinine ratio measurement'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552020',NULL,'Urine microalbumin/creatinine ratio'),('urinary-albumin-creatinine-ratio',1,'^ESCTUR552021',NULL,'Urine microalb/creatnine ratio')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesemis;


IF OBJECT_ID('tempdb..#TempRefCodes') IS NOT NULL DROP TABLE #TempRefCodes;
CREATE TABLE #TempRefCodes (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, version INT NOT NULL, [description] VARCHAR(255));

-- Read v2 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcr.concept, dcr.[version], dcr.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesreadv2 dcr on dcr.code = rc.MainCode
WHERE CodingType='ReadCodeV2'
AND (dcr.term IS NULL OR dcr.term = rc.Term)
and PK_Reference_Coding_ID != -1;

-- CTV3 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcc.concept, dcc.[version], dcc.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesctv3 dcc on dcc.code = rc.MainCode
WHERE CodingType='CTV3'
and PK_Reference_Coding_ID != -1;

-- EMIS codes with a FK Reference Coding ID
INSERT INTO #TempRefCodes
SELECT FK_Reference_Coding_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID != -1;

IF OBJECT_ID('tempdb..#TempSNOMEDRefCodes') IS NOT NULL DROP TABLE #TempSNOMEDRefCodes;
CREATE TABLE #TempSNOMEDRefCodes (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [version] INT NOT NULL, [description] VARCHAR(255));

-- SNOMED codes
INSERT INTO #TempSNOMEDRefCodes
SELECT PK_Reference_SnomedCT_ID, dcs.concept, dcs.[version], dcs.[description]
FROM SharedCare.Reference_SnomedCT rs
INNER JOIN #codessnomed dcs on dcs.code = rs.ConceptID;

-- EMIS codes with a FK SNOMED ID but without a FK Reference Coding ID
INSERT INTO #TempSNOMEDRefCodes
SELECT FK_Reference_SnomedCT_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID = -1
AND FK_Reference_SnomedCT_ID != -1;

-- De-duped tables
IF OBJECT_ID('tempdb..#CodeSets') IS NOT NULL DROP TABLE #CodeSets;
CREATE TABLE #CodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#SnomedSets') IS NOT NULL DROP TABLE #SnomedSets;
CREATE TABLE #SnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedCodeSets') IS NOT NULL DROP TABLE #VersionedCodeSets;
CREATE TABLE #VersionedCodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedSnomedSets') IS NOT NULL DROP TABLE #VersionedSnomedSets;
CREATE TABLE #VersionedSnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

INSERT INTO #VersionedCodeSets
SELECT DISTINCT * FROM #TempRefCodes;

INSERT INTO #VersionedSnomedSets
SELECT DISTINCT * FROM #TempSNOMEDRefCodes;

INSERT INTO #CodeSets
SELECT FK_Reference_Coding_ID, c.concept, [description]
FROM #VersionedCodeSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedCodeSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

INSERT INTO #SnomedSets
SELECT FK_Reference_SnomedCT_ID, c.concept, [description]
FROM #VersionedSnomedSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedSnomedSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

--#endregion

-- >>> Following code sets injected: egfr v1/urinary-albumin-creatinine-ratio v1/glomerulonephritis v1/kidney-transplant v1/kidney-stones v1/vasculitis v1

---- FIND PATIENTS WITH BIOCHEMICAL EVIDENCE OF CKD

---- find all eGFR and ACR tests

IF OBJECT_ID('tempdb..#EGFR_TESTS') IS NOT NULL DROP TABLE #EGFR_TESTS;
SELECT gp.FK_Patient_Link_ID, 
	CAST(GP.EventDate AS DATE) AS EventDate, 
	[value] = TRY_CONVERT(NUMERIC (18,5), [Value])
INTO #EGFR_TESTS
FROM SharedCare.GP_Events gp
WHERE 
	(gp.FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE Concept = 'egfr' AND [Version]=1) OR
	 gp.FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE Concept = 'egfr' AND [Version]=1))
		AND gp.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
		AND (gp.EventDate) --BETWEEN '2005-01-01' and 
		<= @EndDate
		AND [Value] IS NOT NULL AND TRY_CONVERT(NUMERIC (18,5), [Value]) <> 0 AND [Value] <> '0' -- REMOVE NULLS AND ZEROES
		AND UPPER([Value]) NOT LIKE '%[A-Z]%' -- REMOVE RECORDS WITH TEXT 

IF OBJECT_ID('tempdb..#ACR_TESTS') IS NOT NULL DROP TABLE #ACR_TESTS;
SELECT gp.FK_Patient_Link_ID, 
	CAST(GP.EventDate AS DATE) AS EventDate, 
	[value] = TRY_CONVERT(NUMERIC (18,5), [Value])
INTO #ACR_TESTS
FROM SharedCare.GP_Events gp
WHERE 
	(gp.FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE Concept = 'urinary-albumin-creatinine-ratio' AND [Version]=1) OR
	 gp.FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE Concept = 'urinary-albumin-creatinine-ratio'  AND [Version]=1))
		AND gp.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
		AND gp.EventDate --BETWEEN '2005-01-01' and 
		<= @EndDate
		AND [Value] IS NOT NULL AND TRY_CONVERT(NUMERIC (18,5), [Value]) <> 0 AND [Value] <> '0' -- REMOVE NULLS AND ZEROES
		AND UPPER([Value]) NOT LIKE '%[A-Z]%' -- REMOVE RECORDS WITH TEXT 

-- "eGFR < 60 Ml/Min lasting for at least 3 months"

-- For each low egfr we calculate the first date more than 3 months in the future when they also have a low egfr.
IF OBJECT_ID('tempdb..#E1TEMP') IS NOT NULL DROP TABLE #E1TEMP
SELECT E1.FK_Patient_Link_ID, E1.EventDate, MIN(E2.EventDate) AS FirstLowDatePost3Months 
INTO #E1Temp 
FROM #EGFR_TESTS E1
  INNER JOIN #EGFR_TESTS E2 ON
    E1.FK_Patient_Link_ID = E2.FK_Patient_Link_ID AND
    E2.EventDate >= DATEADD(month, 3, E1.EventDate)
WHERE TRY_CONVERT(NUMERIC, E1.Value) < 60 AND TRY_CONVERT(NUMERIC, E2.Value)  < 60
GROUP BY E1.FK_Patient_Link_ID, E1.EventDate;

-- For each low egfr we find the first date after where their egfr wasn't low
IF OBJECT_ID('tempdb..#E2TEMP') IS NOT NULL DROP TABLE #E2TEMP
SELECT E1.FK_Patient_Link_ID, E1.EventDate, MIN(E2.EventDate) AS FirstOkDatePostValue 
INTO #E2Temp 
FROM #EGFR_TESTS E1
  INNER JOIN #EGFR_TESTS E2 ON
    E1.FK_Patient_Link_ID = E2.FK_Patient_Link_ID AND
    E1.EventDate < E2.EventDate 
WHERE TRY_CONVERT(NUMERIC, E1.Value) < 60 AND TRY_CONVERT(NUMERIC, E2.Value) >= 60
GROUP BY E1.FK_Patient_Link_ID, E1.EventDate;

-- We want everyone in the first table REGARDLESS of whether they have a healthy EGFR in between their <60 results
IF OBJECT_ID('tempdb..#EGFR_cohort') IS NOT NULL DROP TABLE #EGFR_cohort
SELECT DISTINCT E1.FK_Patient_Link_ID
INTO #EGFR_cohort
FROM #E1Temp E1
--LEFT OUTER JOIN #E2Temp E2 ON E1.FK_Patient_Link_ID = E2.FK_Patient_Link_ID AND E1.EventDate = E2.EventDate
--WHERE FirstOkDatePostValue IS NULL OR FirstOkDatePostValue > FirstLowDatePost3Months;

-- Create table of patients who have a healthy EGFR in between their <60 results - this will be used to create a flag for these patients
IF OBJECT_ID('tempdb..#EGFR_HealthyResultInbetween') IS NOT NULL DROP TABLE #EGFR_HealthyResultInbetween
SELECT DISTINCT E1.FK_Patient_Link_ID
INTO #EGFR_HealthyResultInbetween
FROM #E1Temp E1
LEFT OUTER JOIN #E2Temp E2 ON E1.FK_Patient_Link_ID = E2.FK_Patient_Link_ID AND E1.EventDate = E2.EventDate
WHERE FirstOkDatePostValue < FirstLowDatePost3Months;

--------------- Same as above but for: "ACR > 3mg/mmol lasting for at least 3 months” ---------------------

-- For each high ACR we calculate the first date more than 3 months in the future when they also have a high ACR.

IF OBJECT_ID('tempdb..#A1TEMP') IS NOT NULL DROP TABLE #A1TEMP
SELECT A1.FK_Patient_Link_ID, A1.EventDate, MIN(A2.EventDate) AS FirstLowDatePost3Months 
INTO #A1Temp 
FROM #ACR_TESTS A1
  INNER JOIN #ACR_TESTS A2 ON
    A1.FK_Patient_Link_ID = A2.FK_Patient_Link_ID AND
    A2.EventDate >= DATEADD(month, 3, A1.EventDate)
WHERE TRY_CONVERT(NUMERIC, A1.Value) >= 3 AND TRY_CONVERT(NUMERIC, A2.Value)  >= 3
GROUP BY A1.FK_Patient_Link_ID, A1.EventDate;

-- For each high ACR we find the first date after where their ACR wasn't high
IF OBJECT_ID('tempdb..#A2TEMP') IS NOT NULL DROP TABLE #A2TEMP
SELECT A1.FK_Patient_Link_ID, A1.EventDate, MIN(A2.EventDate) AS FirstOkDatePostValue 
INTO #A2Temp 
FROM #ACR_TESTS A1
  INNER JOIN #ACR_TESTS A2 ON
    A1.FK_Patient_Link_ID = A2.FK_Patient_Link_ID AND
    A1.EventDate < A2.EventDate 
WHERE TRY_CONVERT(NUMERIC, A1.Value) >= 3 AND TRY_CONVERT(NUMERIC, A2.Value) < 3
GROUP BY A1.FK_Patient_Link_ID, A1.EventDate;

-- We want everyone in the first table REGARDLESS of whether they have a healthy ACR in between their >3 results
IF OBJECT_ID('tempdb..#ACR_cohort') IS NOT NULL DROP TABLE #ACR_cohort
SELECT DISTINCT A1.FK_Patient_Link_ID
INTO #ACR_cohort
FROM #A1Temp A1
--LEFT OUTER JOIN #A2Temp A2 ON A1.FK_Patient_Link_ID = A2.FK_Patient_Link_ID AND A1.EventDate = A2.EventDate
--WHERE FirstOkDatePostValue IS NULL OR FirstOkDatePostValue > FirstLowDatePost3Months;

-- Create table of patients who have a healthy ACR in between their >=3 results - this will be used to create a flag for these patients
IF OBJECT_ID('tempdb..#ACR_HealthyResultInbetween') IS NOT NULL DROP TABLE #ACR_HealthyResultInbetween
SELECT DISTINCT A1.FK_Patient_Link_ID
INTO #ACR_HealthyResultInbetween
FROM #A1Temp A1
LEFT OUTER JOIN #A2Temp A2 ON A1.FK_Patient_Link_ID = A2.FK_Patient_Link_ID AND A1.EventDate = A2.EventDate
WHERE FirstOkDatePostValue < FirstLowDatePost3Months;


-- CREATE TABLE OF PATIENTS THAT HAVE A HISTORY OF KIDNEY DAMAGE (TO BE USED AS EXTRA CRITERIA FOR EGFRs INDICATING CKD STAGE 1 AND 2)

IF OBJECT_ID('tempdb..#kidney_damage') IS NOT NULL DROP TABLE #kidney_damage;
SELECT DISTINCT FK_Patient_Link_ID
INTO #kidney_damage
FROM SharedCare.GP_Events gp
WHERE (
	gp.FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE Concept IN ('glomerulonephritis', 'kidney-transplant', 'kidney-stones', 'vasculitis') AND [Version]=1) OR
    gp.FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE Concept IN ('glomerulonephritis', 'kidney-transplant', 'kidney-stones', 'vasculitis') AND [Version]=1)
	)
	AND EventDate <= @StartDate

--┌───────────────┐
--│ Year of birth │
--└───────────────┘

-- OBJECTIVE: To get the year of birth for each patient.

-- INPUT: Assumes there exists a temp table as follows:
-- #Patients (FK_Patient_Link_ID)
--  A distinct list of FK_Patient_Link_IDs for each patient in the cohort

-- OUTPUT: A temp table as follows:
-- #PatientYearOfBirth (FK_Patient_Link_ID, YearOfBirth)
-- 	- FK_Patient_Link_ID - unique patient id
--	- YearOfBirth - INT

-- ASSUMPTIONS:
--	- Patient data is obtained from multiple sources. Where patients have multiple YOBs we determine the YOB as follows:
--	-	If the patients has a YOB in their primary care data feed we use that as most likely to be up to date
--	-	If every YOB for a patient is the same, then we use that
--	-	If there is a single most recently updated YOB in the database then we use that
--	-	Otherwise we take the highest YOB for the patient that is not in the future

-- Get all patients year of birth for the cohort
IF OBJECT_ID('tempdb..#AllPatientYearOfBirths') IS NOT NULL DROP TABLE #AllPatientYearOfBirths;
SELECT 
	FK_Patient_Link_ID,
	FK_Reference_Tenancy_ID,
	HDMModifDate,
	YEAR(Dob) AS YearOfBirth
INTO #AllPatientYearOfBirths
FROM SharedCare.Patient p
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
AND Dob IS NOT NULL;


-- If patients have a tenancy id of 2 we take this as their most likely YOB
-- as this is the GP data feed and so most likely to be up to date
IF OBJECT_ID('tempdb..#PatientYearOfBirth') IS NOT NULL DROP TABLE #PatientYearOfBirth;
SELECT FK_Patient_Link_ID, MIN(YearOfBirth) as YearOfBirth INTO #PatientYearOfBirth FROM #AllPatientYearOfBirths
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
AND FK_Reference_Tenancy_ID = 2
GROUP BY FK_Patient_Link_ID
HAVING MIN(YearOfBirth) = MAX(YearOfBirth);

-- Find the patients who remain unmatched
IF OBJECT_ID('tempdb..#UnmatchedYobPatients') IS NOT NULL DROP TABLE #UnmatchedYobPatients;
SELECT FK_Patient_Link_ID INTO #UnmatchedYobPatients FROM #Patients
EXCEPT
SELECT FK_Patient_Link_ID FROM #PatientYearOfBirth;

-- If every YOB is the same for all their linked patient ids then we use that
INSERT INTO #PatientYearOfBirth
SELECT FK_Patient_Link_ID, MIN(YearOfBirth) FROM #AllPatientYearOfBirths
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #UnmatchedYobPatients)
GROUP BY FK_Patient_Link_ID
HAVING MIN(YearOfBirth) = MAX(YearOfBirth);

-- Find any still unmatched patients
TRUNCATE TABLE #UnmatchedYobPatients;
INSERT INTO #UnmatchedYobPatients
SELECT FK_Patient_Link_ID FROM #Patients
EXCEPT
SELECT FK_Patient_Link_ID FROM #PatientYearOfBirth;

-- If there is a unique most recent YOB then use that
INSERT INTO #PatientYearOfBirth
SELECT p.FK_Patient_Link_ID, MIN(p.YearOfBirth) FROM #AllPatientYearOfBirths p
INNER JOIN (
	SELECT FK_Patient_Link_ID, MAX(HDMModifDate) MostRecentDate FROM #AllPatientYearOfBirths
	WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #UnmatchedYobPatients)
	GROUP BY FK_Patient_Link_ID
) sub ON sub.FK_Patient_Link_ID = p.FK_Patient_Link_ID AND sub.MostRecentDate = p.HDMModifDate
GROUP BY p.FK_Patient_Link_ID
HAVING MIN(YearOfBirth) = MAX(YearOfBirth);

-- Find any still unmatched patients
TRUNCATE TABLE #UnmatchedYobPatients;
INSERT INTO #UnmatchedYobPatients
SELECT FK_Patient_Link_ID FROM #Patients
EXCEPT
SELECT FK_Patient_Link_ID FROM #PatientYearOfBirth;

-- Otherwise just use the highest value (with the exception that can't be in the future)
INSERT INTO #PatientYearOfBirth
SELECT FK_Patient_Link_ID, MAX(YearOfBirth) FROM #AllPatientYearOfBirths
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #UnmatchedYobPatients)
GROUP BY FK_Patient_Link_ID
HAVING MAX(YearOfBirth) <= YEAR(GETDATE());

-- Tidy up - helpful in ensuring the tempdb doesn't run out of space mid-query
DROP TABLE #AllPatientYearOfBirths;
DROP TABLE #UnmatchedYobPatients;


-- FIND EARLIEST EGFR AND ACR EVIDENCE OF CKD FOR EACH PATIENT

IF OBJECT_ID('tempdb..#EarliestEvidence') IS NOT NULL DROP TABLE #EarliestEvidence;
SELECT FK_Patient_Link_ID, min(EventDate) as EarliestDate, TestName = 'egfr'
INTO #EarliestEvidence
FROM #E1Temp e
GROUP BY FK_Patient_Link_ID
UNION ALL 
SELECT FK_Patient_Link_ID, min(EventDate) as EarliestDate, TestName = 'acr'
FROM #A1Temp a
GROUP BY FK_Patient_Link_ID

---- CREATE COHORT:
	-- 1. PATIENTS WITH EGFR TESTS INDICATIVE OF CKD STAGES 1-2, PLUS RAISED ACR OR HISTORY OF KIDNEY DAMAGE
	-- 2. PATIENTS WITH EGFR TESTS INDICATIVE OF CKD STAGES 3-5 (AT LEAST 3 MONTHS APART)
	-- 3. PATIENTS WITH ACR TESTS INDICATIVE OF CKD (A3 AND A2) (AT LEAST 3 MONTHS APART)

IF OBJECT_ID('tempdb..#Cohort') IS NOT NULL DROP TABLE #Cohort;
SELECT p.FK_Patient_Link_ID,
		p.EthnicMainGroup,
		yob.YearOfBirth,
		p.DeathDate,
		EvidenceOfCKD_egfr = CASE WHEN p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #EGFR_cohort) 			THEN 1 ELSE 0 END,-- egfr indicating stages 3-5 	
		EvidenceOfCKD_combo = CASE WHEN (p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #EGFR_TESTS where [Value] >= 60) -- egfr indicating stage 1 or 2, with ACR evidence or kidney damage
				AND ((p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #ACR_cohort)) 
					OR p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #kidney_damage)))						THEN 1 ELSE 0 END,
		EvidenceOfCKD_acr = CASE WHEN p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #ACR_cohort) 		THEN 1 ELSE 0 END, -- ACR evidence
		HealthyEgfrResult = CASE WHEN p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #EGFR_HealthyResultInbetween) THEN 1 ELSE 0 END,
		HealthyAcrResult = CASE WHEN p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #ACR_HealthyResultInbetween) THEN 1 ELSE 0 END,
		EarliestEgfrEvidence = egfr.EarliestDate,
		EarliestAcrEvidence = acr.EarliestDate
INTO #Cohort
FROM #Patients p
LEFT OUTER JOIN #PatientYearOfBirth yob ON yob.FK_Patient_Link_ID = p.FK_Patient_Link_ID
LEFT OUTER JOIN #EarliestEvidence egfr 
	ON egfr.FK_Patient_Link_ID = p.FK_Patient_Link_ID AND egfr.TestName = 'egfr' 
LEFT OUTER JOIN #EarliestEvidence acr 
	ON acr.FK_Patient_Link_ID = p.FK_Patient_Link_ID AND acr.TestName = 'acr' 
WHERE 
	(DeathDate < @EndDate OR DeathDate IS NULL) AND 
	(YEAR(@StartDate) - YearOfBirth > 18) AND 								-- OVER 18s ONLY
		( 
	p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #EGFR_cohort ) -- egfr indicating stages 3-5
		OR (
	p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #EGFR_TESTS where [Value] >= 60) -- egfr indicating stage 1 or 2, with ACR evidence or kidney damage
			AND ((p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #ACR_cohort)) OR p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #kidney_damage))
			) 
		OR p.FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #ACR_cohort) -- ACR evidence
		)

-- TABLE OF GP EVENTS FOR COHORT TO SPEED UP REUSABLE QUERIES

IF OBJECT_ID('tempdb..#PatientEventData') IS NOT NULL DROP TABLE #PatientEventData;
SELECT 
  FK_Patient_Link_ID,
  CAST(EventDate AS DATE) AS EventDate,
  SuppliedCode,
  FK_Reference_SnomedCT_ID,
  FK_Reference_Coding_ID,
  [Value],
  [Units]
INTO #PatientEventData
FROM SharedCare.GP_Events
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Cohort);


--Outputs from this reusable query:
-- #Cohort
-- #PatientEventData

---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------


-- REDUCE THE #Patients TABLE SO THAT IT ONLY INCLUDES THE COHORT, AND REUSABLE QUERIES CAN USE IT TO BE RUN QUICKER 

DELETE FROM #Patients
WHERE FK_Patient_Link_ID NOT IN (SELECT FK_Patient_Link_ID FROM #Cohort)

--┌─────────────────────────────────────────┐
--│ Secondary admissions and length of stay │
--└─────────────────────────────────────────┘

-- OBJECTIVE: To obtain a table with every secondary care admission, along with the acute provider,
--						the date of admission, the date of discharge, and the length of stay.

-- INPUT: One parameter
--	-	all-patients: boolean - (true/false) if true, then all patients are included, otherwise only those in the pre-existing #Patients table.

-- OUTPUT: Two temp table as follows:
-- #Admissions (FK_Patient_Link_ID, AdmissionDate, AcuteProvider)
-- 	- FK_Patient_Link_ID - unique patient id
--	- AdmissionDate - date of admission (YYYY-MM-DD)
--	- AcuteProvider - Bolton, SRFT, Stockport etc..
--  (Limited to one admission per person per hospital per day, because if a patient has 2 admissions 
--   on the same day to the same hopsital then it's most likely data duplication rather than two short
--   hospital stays)
-- #LengthOfStay (FK_Patient_Link_ID, AdmissionDate)
-- 	- FK_Patient_Link_ID - unique patient id
--	- AdmissionDate - date of admission (YYYY-MM-DD)
--	- AcuteProvider - Bolton, SRFT, Stockport etc..
--	- DischargeDate - date of discharge (YYYY-MM-DD)
--	- LengthOfStay - Number of days between admission and discharge. 1 = [0,1) days, 2 = [1,2) days, etc.

-- Set the temp end date until new legal basis - OLD
--DECLARE @TEMPAdmissionsEndDate datetime;
--SET @TEMPAdmissionsEndDate = '2022-06-01';

-- Populate temporary table with admissions
-- Convert AdmissionDate to a date to avoid issues where a person has two admissions
-- on the same day (but only one discharge)
IF OBJECT_ID('tempdb..#Admissions') IS NOT NULL DROP TABLE #Admissions;
CREATE TABLE #Admissions (
	FK_Patient_Link_ID BIGINT,
	AdmissionDate DATE,
	AcuteProvider NVARCHAR(150)
);
BEGIN
	IF 'false'='true'
		INSERT INTO #Admissions
		SELECT DISTINCT FK_Patient_Link_ID, CONVERT(DATE, AdmissionDate) AS AdmissionDate, t.TenancyName AS AcuteProvider
		FROM [SharedCare].[Acute_Inpatients] i
		LEFT OUTER JOIN SharedCare.Reference_Tenancy t ON t.PK_Reference_Tenancy_ID = i.FK_Reference_Tenancy_ID
		WHERE EventType = 'Admission'
		AND AdmissionDate >= @StartDate
		--AND AdmissionDate <= @TEMPAdmissionsEndDate;
	ELSE
		INSERT INTO #Admissions
		SELECT DISTINCT FK_Patient_Link_ID, CONVERT(DATE, AdmissionDate) AS AdmissionDate, t.TenancyName AS AcuteProvider
		FROM [SharedCare].[Acute_Inpatients] i
		LEFT OUTER JOIN SharedCare.Reference_Tenancy t ON t.PK_Reference_Tenancy_ID = i.FK_Reference_Tenancy_ID
		WHERE EventType = 'Admission'
		AND FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
		AND AdmissionDate >= @StartDate
		--AND AdmissionDate <= @TEMPAdmissionsEndDate;
END

--┌──────────────────────┐
--│ Secondary discharges │
--└──────────────────────┘

-- OBJECTIVE: To obtain a table with every secondary care discharge, along with the acute provider,
--						and the date of discharge.

-- INPUT: One parameter
--	-	all-patients: boolean - (true/false) if true, then all patients are included, otherwise only those in the pre-existing #Patients table.

-- OUTPUT: A temp table as follows:
-- #Discharges (FK_Patient_Link_ID, DischargeDate, AcuteProvider)
-- 	- FK_Patient_Link_ID - unique patient id
--	- DischargeDate - date of discharge (YYYY-MM-DD)
--	- AcuteProvider - Bolton, SRFT, Stockport etc..
--  (Limited to one discharge per person per hospital per day, because if a patient has 2 discharges 
--   on the same day to the same hopsital then it's most likely data duplication rather than two short
--   hospital stays)

-- Set the temp end date until new legal basis
--DECLARE @TEMPDischargesEndDate datetime;
--SET @TEMPDischargesEndDate = '2022-06-01';

-- Populate temporary table with discharges
IF OBJECT_ID('tempdb..#Discharges') IS NOT NULL DROP TABLE #Discharges;
CREATE TABLE #Discharges (
	FK_Patient_Link_ID BIGINT,
	DischargeDate DATE,
	AcuteProvider NVARCHAR(150)
);
BEGIN
	IF 'false'='true'
		INSERT INTO #Discharges
    SELECT DISTINCT FK_Patient_Link_ID, CONVERT(DATE, DischargeDate) AS DischargeDate, t.TenancyName AS AcuteProvider 
    FROM [SharedCare].[Acute_Inpatients] i
    LEFT OUTER JOIN SharedCare.Reference_Tenancy t ON t.PK_Reference_Tenancy_ID = i.FK_Reference_Tenancy_ID
    WHERE EventType = 'Discharge'
    AND DischargeDate >= @StartDate
   -- AND DischargeDate <= @TEMPDischargesEndDate;
  ELSE
		INSERT INTO #Discharges
    SELECT DISTINCT FK_Patient_Link_ID, CONVERT(DATE, DischargeDate) AS DischargeDate, t.TenancyName AS AcuteProvider 
    FROM [SharedCare].[Acute_Inpatients] i
    LEFT OUTER JOIN SharedCare.Reference_Tenancy t ON t.PK_Reference_Tenancy_ID = i.FK_Reference_Tenancy_ID
    WHERE EventType = 'Discharge'
		AND FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients)
    AND DischargeDate >= @StartDate
    --AND DischargeDate <= @TEMPDischargesEndDate;;
END
-- 535285 rows	535285 rows
-- 00:00:28		00:00:14


-- Link admission with discharge to get length of stay
-- Length of stay is zero-indexed e.g. 
-- 1 = [0,1) days
-- 2 = [1,2) days
IF OBJECT_ID('tempdb..#LengthOfStay') IS NOT NULL DROP TABLE #LengthOfStay;
SELECT 
	a.FK_Patient_Link_ID, a.AdmissionDate, a.AcuteProvider, 
	MIN(d.DischargeDate) AS DischargeDate, 
	1 + DATEDIFF(day,a.AdmissionDate, MIN(d.DischargeDate)) AS LengthOfStay
	INTO #LengthOfStay
FROM #Admissions a
INNER JOIN #Discharges d ON d.FK_Patient_Link_ID = a.FK_Patient_Link_ID AND d.DischargeDate >= a.AdmissionDate AND d.AcuteProvider = a.AcuteProvider
GROUP BY a.FK_Patient_Link_ID, a.AdmissionDate, a.AcuteProvider
ORDER BY a.FK_Patient_Link_ID, a.AdmissionDate, a.AcuteProvider;
-- 511740 rows	511740 rows	
-- 00:00:04		00:00:05

--┌────────────────────────────────────┐
--│ COVID-related secondary admissions │
--└────────────────────────────────────┘

-- OBJECTIVE: To classify every admission to secondary care based on whether it is a COVID or non-COVID related.
--						A COVID-related admission is classed as an admission within 4 weeks after, or up to 2 weeks before
--						a positive test.

-- INPUT: Takes one parameter
--  - start-date: string - (YYYY-MM-DD) the date to count diagnoses from. Usually this should be 2020-01-01.
--	-	all-patients: boolean - (true/false) if true, then all patients are included, otherwise only those in the pre-existing #Patients table.
--	- gp-events-table: string - (table name) the name of the table containing the GP events. Usually is "RLS.vw_GP_Events" but can be anything with the columns: FK_Patient_Link_ID, EventDate, and SuppliedCode
-- And assumes there exists two temp tables as follows:
-- #Patients (FK_Patient_Link_ID)
--  A distinct list of FK_Patient_Link_IDs for each patient in the cohort
-- #Admissions (FK_Patient_Link_ID, AdmissionDate, AcuteProvider)
--  A distinct list of the admissions for each patient in the cohort

-- OUTPUT: A temp table as follows:
-- #COVIDUtilisationAdmissions (FK_Patient_Link_ID, AdmissionDate, AcuteProvider, CovidHealthcareUtilisation)
--	- FK_Patient_Link_ID - unique patient id
--	- AdmissionDate - date of admission (YYYY-MM-DD)
--	- AcuteProvider - Bolton, SRFT, Stockport etc..
--	- CovidHealthcareUtilisation - 'TRUE' if admission within 4 weeks after, or up to 14 days before, a positive test

-- Get first positive covid test for each patient
--┌─────────────────────┐
--│ Patients with COVID │
--└─────────────────────┘

-- OBJECTIVE: To get tables of all patients with a COVID diagnosis in their record. This now includes a table
-- that has reinfections. This uses a 90 day cut-off to rule out patients that get multiple tests for
-- a single infection. This 90 day cut-off is also used in the government COVID dashboard. In the first wave,
-- prior to widespread COVID testing, and prior to the correct clinical codes being	available to clinicians,
-- infections were recorded in a variety of ways. We therefore take the first diagnosis from any code indicative
-- of COVID. However, for subsequent infections we insist on the presence of a positive COVID test (PCR or antigen)
-- as opposed to simply a diagnosis code. This is to avoid the situation where a hospital diagnosis code gets 
-- entered into the primary care record several months after the actual infection.

-- INPUT: Takes three parameters
--  - start-date: string - (YYYY-MM-DD) the date to count diagnoses from. Usually this should be 2020-01-01.
--	-	all-patients: boolean - (true/false) if true, then all patients are included, otherwise only those in the pre-existing #Patients table.
--	- gp-events-table: string - (table name) the name of the table containing the GP events. Usually is "SharedCare.GP_Events" but can be anything with the columns: FK_Patient_Link_ID, EventDate, and SuppliedCode

-- OUTPUT: Three temp tables as follows:
-- #CovidPatients (FK_Patient_Link_ID, FirstCovidPositiveDate)
-- 	- FK_Patient_Link_ID - unique patient id
--	- FirstCovidPositiveDate - earliest COVID diagnosis
-- #CovidPatientsAllDiagnoses (FK_Patient_Link_ID, CovidPositiveDate)
-- 	- FK_Patient_Link_ID - unique patient id
--	- CovidPositiveDate - any COVID diagnosis
-- #CovidPatientsMultipleDiagnoses
--	-	FK_Patient_Link_ID - unique patient id
--	-	FirstCovidPositiveDate - date of first COVID diagnosis
--	-	SecondCovidPositiveDate - date of second COVID diagnosis
--	-	ThirdCovidPositiveDate - date of third COVID diagnosis
--	-	FourthCovidPositiveDate - date of fourth COVID diagnosis
--	-	FifthCovidPositiveDate - date of fifth COVID diagnosis

-- >>> Following code sets injected: covid-positive-antigen-test v1/covid-positive-pcr-test v1/covid-positive-test-other v1


-- Set the temp end date until new legal basis - OLD
--DECLARE @TEMPWithCovidEndDate datetime;
--SET @TEMPWithCovidEndDate = '2022-06-01';

IF OBJECT_ID('tempdb..#CovidPatientsAllDiagnoses') IS NOT NULL DROP TABLE #CovidPatientsAllDiagnoses;
CREATE TABLE #CovidPatientsAllDiagnoses (
	FK_Patient_Link_ID BIGINT,
	CovidPositiveDate DATE
);

INSERT INTO #CovidPatientsAllDiagnoses
SELECT DISTINCT FK_Patient_Link_ID, CONVERT(DATE, [EventDate]) AS CovidPositiveDate
FROM [SharedCare].[COVID19]
WHERE (
	(GroupDescription = 'Confirmed' AND SubGroupDescription != 'Negative') OR
	(GroupDescription = 'Tested' AND SubGroupDescription = 'Positive')
)
AND EventDate > '2020-01-01'
--AND EventDate <= @TEMPWithCovidEndDate
--AND EventDate <= GETDATE()
AND FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients);

-- We can rely on the GraphNet table for first diagnosis.
IF OBJECT_ID('tempdb..#CovidPatients') IS NOT NULL DROP TABLE #CovidPatients;
SELECT FK_Patient_Link_ID, MIN(CovidPositiveDate) AS FirstCovidPositiveDate INTO #CovidPatients
FROM #CovidPatientsAllDiagnoses
GROUP BY FK_Patient_Link_ID;

-- Now let's get the dates of any positive test (i.e. not things like suspected, or historic)
IF OBJECT_ID('tempdb..#AllPositiveTestsTemp') IS NOT NULL DROP TABLE #AllPositiveTestsTemp;
CREATE TABLE #AllPositiveTestsTemp (
	FK_Patient_Link_ID BIGINT,
	TestDate DATE
);

INSERT INTO #AllPositiveTestsTemp
SELECT DISTINCT FK_Patient_Link_ID, CAST(EventDate AS DATE) AS TestDate
FROM #PatientEventData
WHERE SuppliedCode IN (
	select Code from #AllCodes 
	where Concept in ('covid-positive-antigen-test','covid-positive-pcr-test','covid-positive-test-other') 
	AND Version = 1
)
--AND EventDate <= @TEMPWithCovidEndDate
AND FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients);

IF OBJECT_ID('tempdb..#CovidPatientsMultipleDiagnoses') IS NOT NULL DROP TABLE #CovidPatientsMultipleDiagnoses;
CREATE TABLE #CovidPatientsMultipleDiagnoses (
	FK_Patient_Link_ID BIGINT,
	FirstCovidPositiveDate DATE,
	SecondCovidPositiveDate DATE,
	ThirdCovidPositiveDate DATE,
	FourthCovidPositiveDate DATE,
	FifthCovidPositiveDate DATE
);

-- Populate first diagnosis
INSERT INTO #CovidPatientsMultipleDiagnoses (FK_Patient_Link_ID, FirstCovidPositiveDate)
SELECT FK_Patient_Link_ID, MIN(FirstCovidPositiveDate) FROM
(
	SELECT * FROM #CovidPatients
	UNION
	SELECT * FROM #AllPositiveTestsTemp
) sub
GROUP BY FK_Patient_Link_ID;

-- Now let's get second tests.
UPDATE t1
SET t1.SecondCovidPositiveDate = NextTestDate
FROM #CovidPatientsMultipleDiagnoses AS t1
INNER JOIN (
SELECT cp.FK_Patient_Link_ID, MIN(apt.TestDate) AS NextTestDate FROM #CovidPatients cp
INNER JOIN #AllPositiveTestsTemp apt ON cp.FK_Patient_Link_ID = apt.FK_Patient_Link_ID AND apt.TestDate >= DATEADD(day, 90, FirstCovidPositiveDate)
GROUP BY cp.FK_Patient_Link_ID) AS sub ON sub.FK_Patient_Link_ID = t1.FK_Patient_Link_ID;

-- Now let's get third tests.
UPDATE t1
SET t1.ThirdCovidPositiveDate = NextTestDate
FROM #CovidPatientsMultipleDiagnoses AS t1
INNER JOIN (
SELECT cp.FK_Patient_Link_ID, MIN(apt.TestDate) AS NextTestDate FROM #CovidPatientsMultipleDiagnoses cp
INNER JOIN #AllPositiveTestsTemp apt ON cp.FK_Patient_Link_ID = apt.FK_Patient_Link_ID AND apt.TestDate >= DATEADD(day, 90, SecondCovidPositiveDate)
GROUP BY cp.FK_Patient_Link_ID) AS sub ON sub.FK_Patient_Link_ID = t1.FK_Patient_Link_ID;

-- Now let's get fourth tests.
UPDATE t1
SET t1.FourthCovidPositiveDate = NextTestDate
FROM #CovidPatientsMultipleDiagnoses AS t1
INNER JOIN (
SELECT cp.FK_Patient_Link_ID, MIN(apt.TestDate) AS NextTestDate FROM #CovidPatientsMultipleDiagnoses cp
INNER JOIN #AllPositiveTestsTemp apt ON cp.FK_Patient_Link_ID = apt.FK_Patient_Link_ID AND apt.TestDate >= DATEADD(day, 90, ThirdCovidPositiveDate)
GROUP BY cp.FK_Patient_Link_ID) AS sub ON sub.FK_Patient_Link_ID = t1.FK_Patient_Link_ID;

-- Now let's get fifth tests.
UPDATE t1
SET t1.FifthCovidPositiveDate = NextTestDate
FROM #CovidPatientsMultipleDiagnoses AS t1
INNER JOIN (
SELECT cp.FK_Patient_Link_ID, MIN(apt.TestDate) AS NextTestDate FROM #CovidPatientsMultipleDiagnoses cp
INNER JOIN #AllPositiveTestsTemp apt ON cp.FK_Patient_Link_ID = apt.FK_Patient_Link_ID AND apt.TestDate >= DATEADD(day, 90, FourthCovidPositiveDate)
GROUP BY cp.FK_Patient_Link_ID) AS sub ON sub.FK_Patient_Link_ID = t1.FK_Patient_Link_ID;

IF OBJECT_ID('tempdb..#COVIDUtilisationAdmissions') IS NOT NULL DROP TABLE #COVIDUtilisationAdmissions;
SELECT 
	a.*, 
	CASE
		WHEN c.FK_Patient_Link_ID IS NOT NULL THEN 'TRUE'
		ELSE 'FALSE'
	END AS CovidHealthcareUtilisation
INTO #COVIDUtilisationAdmissions 
FROM #Admissions a
LEFT OUTER join #CovidPatients c ON 
	a.FK_Patient_Link_ID = c.FK_Patient_Link_ID 
	AND a.AdmissionDate <= DATEADD(WEEK, 4, c.FirstCovidPositiveDate)
	AND a.AdmissionDate >= DATEADD(DAY, -14, c.FirstCovidPositiveDate);


----- create anonymised identifier for each hospital
-- this is included in case PI needs to consider hopsitals that don't have as much historic data

IF OBJECT_ID('tempdb..#hospitals') IS NOT NULL DROP TABLE #hospitals;
SELECT DISTINCT AcuteProvider
INTO #hospitals
FROM #LengthOfStay

IF OBJECT_ID('tempdb..#RandomiseHospital') IS NOT NULL DROP TABLE #RandomiseHospital;
SELECT AcuteProvider
	, HospitalID = ROW_NUMBER() OVER (order by newid())
INTO #RandomiseHospital
FROM #hospitals


--bring together for final output
SELECT 
	PatientId = m.FK_Patient_Link_ID,
	l.AdmissionDate,
	l.DischargeDate,
	rh.HospitalID
FROM #Cohort m 
LEFT JOIN #LengthOfStay l ON m.FK_Patient_Link_ID = l.FK_Patient_Link_ID
LEFT OUTER JOIN #COVIDUtilisationAdmissions c ON c.FK_Patient_Link_ID = l.FK_Patient_Link_ID AND c.AdmissionDate = l.AdmissionDate AND c.AcuteProvider = l.AcuteProvider
LEFT OUTER JOIN #RandomiseHospital rh ON rh.AcuteProvider = l.AcuteProvider
WHERE c.CovidHealthcareUtilisation = 'TRUE'
	AND l.AdmissionDate <= @EndDate
