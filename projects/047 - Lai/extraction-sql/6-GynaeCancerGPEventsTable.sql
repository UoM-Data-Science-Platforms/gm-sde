--+--------------------------------------------------------------------------------+
--¦ Gynae cancer information from the GPEvents table (cohort 2)                    ¦
--+--------------------------------------------------------------------------------+

-------- RESEARCH DATA ENGINEER CHECK ---------

-- OUTPUT: Data with the following fields
-- PatientId
-- EventDate (YYYY-MM-DD)
-- GynaeCancerRelatedCode (code values)


-- >>> Codesets required... Inserting the code set code
--
--┌────────────────────┐
--│ Clinical code sets │
--└────────────────────┘

-- OBJECTIVE: To populate temporary tables with the existing clinical code sets.
--            See the [SQL-generation-process.md](SQL-generation-process.md) for more details.

-- INPUT: No pre-requisites

-- OUTPUT: Five temp tables as follows:
--  #AllCodes (Concept, Version, Code)
--  #CodeSets (FK_Reference_Coding_ID, Concept)
--  #SnomedSets (FK_Reference_SnomedCT_ID, FK_SNOMED_ID)
--  #VersionedCodeSets (FK_Reference_Coding_ID, Concept, Version)
--  #VersionedSnomedSets (FK_Reference_SnomedCT_ID, Version, FK_SNOMED_ID)

--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
--!!! DO NOT EDIT THIS FILE MANUALLY !!!
--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

--#region Clinical code sets

IF OBJECT_ID('tempdb..#AllCodes') IS NOT NULL DROP TABLE #AllCodes;
CREATE TABLE #AllCodes (
  [Concept] [varchar](255) NOT NULL,
  [Version] INT NOT NULL,
  [Code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
  [description] [varchar] (255) NULL 
);

IF OBJECT_ID('tempdb..#codesreadv2') IS NOT NULL DROP TABLE #codesreadv2;
CREATE TABLE #codesreadv2 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesreadv2
VALUES ('gynaecological-cancer',1,'B44..',NULL,'Malignant neoplasm of ovary and other uterine adnexa'),('gynaecological-cancer',1,'B44..00',NULL,'Malignant neoplasm of ovary and other uterine adnexa'),('gynaecological-cancer',1,'B44z.',NULL,'Malignant neoplasm of uterine adnexa NOS'),('gynaecological-cancer',1,'B44z.00',NULL,'Malignant neoplasm of uterine adnexa NOS'),('gynaecological-cancer',1,'B44y.',NULL,'Malignant neoplasm of other site of uterine adnexa'),('gynaecological-cancer',1,'B44y.00',NULL,'Malignant neoplasm of other site of uterine adnexa'),('gynaecological-cancer',1,'B440.',NULL,'Malignant neoplasm of ovary'),('gynaecological-cancer',1,'B440.00',NULL,'Malignant neoplasm of ovary'),('gynaecological-cancer',1,'1J06.',NULL,'Suspected cervical cancer'),('gynaecological-cancer',1,'1J06.00',NULL,'Suspected cervical cancer'),('gynaecological-cancer',1,'1J07.',NULL,'Suspected endometrial cancer'),('gynaecological-cancer',1,'1J07.00',NULL,'Suspected endometrial cancer'),('gynaecological-cancer',1,'1J0J.',NULL,'Suspected gynaecological cancer'),('gynaecological-cancer',1,'1J0J.00',NULL,'Suspected gynaecological cancer'),('gynaecological-cancer',1,'38GT9',NULL,'QCancer cervical cancer risk'),('gynaecological-cancer',1,'38GT900',NULL,'QCancer cervical cancer risk'),('gynaecological-cancer',1,'38GT8',NULL,'QCancer endometrial cancer risk'),('gynaecological-cancer',1,'38GT800',NULL,'QCancer endometrial cancer risk'),('gynaecological-cancer',1,'K5E..',NULL,'Other abnormal uterine and vaginal bleeding'),('gynaecological-cancer',1,'K5E..00',NULL,'Other abnormal uterine and vaginal bleeding'),('gynaecological-cancer',1,'K5Ez.',NULL,'Abnormal uterine and vaginal bleeding, unspecified'),('gynaecological-cancer',1,'K5Ez.00',NULL,'Abnormal uterine and vaginal bleeding, unspecified'),('gynaecological-cancer',1,'K5E2.',NULL,'Abnormal vaginal bleeding, unspecified'),('gynaecological-cancer',1,'K5E2.00',NULL,'Abnormal vaginal bleeding, unspecified'),('gynaecological-cancer',1,'8Hn1.',NULL,'Fast track referral for suspected gynaecological cancer'),('gynaecological-cancer',1,'8Hn1.00',NULL,'Fast track referral for suspected gynaecological cancer'),('gynaecological-cancer',1,'9Np4.',NULL,'Seen in fast track suspected gynaecological cancer clinic'),('gynaecological-cancer',1,'9Np4.00',NULL,'Seen in fast track suspected gynaecological cancer clinic'),('gynaecological-cancer',1,'Byu70',NULL,'[X]Malignant neoplasm of uterine adnexa, unspecified'),('gynaecological-cancer',1,'Byu7000',NULL,'[X]Malignant neoplasm of uterine adnexa, unspecified'),('gynaecological-cancer',1,'B4302',NULL,'Malignant neoplasm of endometrium of corpus uteri'),('gynaecological-cancer',1,'B430200',NULL,'Malignant neoplasm of endometrium of corpus uteri'),('gynaecological-cancer',1,'B7A..',NULL,'Benign neoplasm of ovary'),('gynaecological-cancer',1,'B7A..00',NULL,'Benign neoplasm of ovary'),('gynaecological-cancer',1,'B586.',NULL,'Secondary malignant neoplasm of ovary'),('gynaecological-cancer',1,'B586.00',NULL,'Secondary malignant neoplasm of ovary'),('gynaecological-cancer',1,'B912.',NULL,'Neoplasm of uncertain behaviour of ovary'),('gynaecological-cancer',1,'B912.00',NULL,'Neoplasm of uncertain behaviour of ovary'),('gynaecological-cancer',1,'Kyu9D',NULL,'[X]Other specified abnormal uterine and vaginal bleeding'),('gynaecological-cancer',1,'Kyu9D00',NULL,'[X]Other specified abnormal uterine and vaginal bleeding'),('gynaecological-cancer',1,'K59B.',NULL,'Postmenopausal postcoital bleeding'),('gynaecological-cancer',1,'K59B.00',NULL,'Postmenopausal postcoital bleeding'),('gynaecological-cancer',1,'K5A1.',NULL,'Postmenopausal bleeding'),('gynaecological-cancer',1,'K5A1.00',NULL,'Postmenopausal bleeding'),('gynaecological-cancer',1,'8H4V.',NULL,'Referral to gynaecology special interest general practitioner'),('gynaecological-cancer',1,'8H4V.00',NULL,'Referral to gynaecology special interest general practitioner'),('gynaecological-cancer',1,'8Hku.',NULL,'Referral to community gynaecology service'),('gynaecological-cancer',1,'8Hku.00',NULL,'Referral to community gynaecology service'),('gynaecological-cancer',1,'8T0B.',NULL,'Referral to paediatric gynaecology service'),('gynaecological-cancer',1,'8T0B.00',NULL,'Referral to paediatric gynaecology service'),('gynaecological-cancer',1,'8H58.',NULL,'Gynaecological referral'),('gynaecological-cancer',1,'8H58.00',NULL,'Gynaecological referral'),('gynaecological-cancer',1,'8HJ6.',NULL,'Gynaecological self-referral'),('gynaecological-cancer',1,'8HJ6.00',NULL,'Gynaecological self-referral'),('gynaecological-cancer',1,'8HV7.',NULL,'Private referral to gynaecologist'),('gynaecological-cancer',1,'8HV7.00',NULL,'Private referral to gynaecologist'),('gynaecological-cancer',1,'38GT4',NULL,'QCancer ovarian cancer risk calculator'),('gynaecological-cancer',1,'38GT400',NULL,'QCancer ovarian cancer risk calculator'),('gynaecological-cancer',1,'B41..',NULL,'Malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'B41..00',NULL,'Malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'B41y.',NULL,'Malignant neoplasm of other site of cervix'),('gynaecological-cancer',1,'B41y.00',NULL,'Malignant neoplasm of other site of cervix'),('gynaecological-cancer',1,'B41yz',NULL,'Malignant neoplasm of other site of cervix NOS'),('gynaecological-cancer',1,'B41yz00',NULL,'Malignant neoplasm of other site of cervix NOS'),('gynaecological-cancer',1,'B41z.',NULL,'Malignant neoplasm of cervix uteri NOS'),('gynaecological-cancer',1,'B41z.00',NULL,'Malignant neoplasm of cervix uteri NOS'),('gynaecological-cancer',1,'B45..',NULL,'Malignant neoplasm of other and unspecified female genital organs'),('gynaecological-cancer',1,'B45..00',NULL,'Malignant neoplasm of other and unspecified female genital organs'),('gynaecological-cancer',1,'B45y.',NULL,'Malignant neoplasm of other specified female genital organ'),('gynaecological-cancer',1,'B45y.00',NULL,'Malignant neoplasm of other specified female genital organ'),('gynaecological-cancer',1,'B45z.',NULL,'Malignant neoplasm of female genital organ NOS'),('gynaecological-cancer',1,'B45z.00',NULL,'Malignant neoplasm of female genital organ NOS'),('gynaecological-cancer',1,'B58y2',NULL,'Secondary malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'B58y200',NULL,'Secondary malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'B790.',NULL,'Benign neoplasm of cervix uteri NEC'),('gynaecological-cancer',1,'B790.00',NULL,'Benign neoplasm of cervix uteri NEC'),('gynaecological-cancer',1,'B7A2.',NULL,'Benign teratoma of ovary'),('gynaecological-cancer',1,'B7A2.00',NULL,'Benign teratoma of ovary'),('gynaecological-cancer',1,'Byu7.',NULL,'[X]Malignant neoplasm of female genital organs'),('gynaecological-cancer',1,'Byu7.00',NULL,'[X]Malignant neoplasm of female genital organs'),('gynaecological-cancer',1,'Byu71',NULL,'[X]Malignant neoplasm of other specified female genital organs'),('gynaecological-cancer',1,'Byu7100',NULL,'[X]Malignant neoplasm of other specified female genital organs'),('gynaecological-cancer',1,'Byu73',NULL,'[X]Malignant neoplasm of female genital organ, unspecified'),('gynaecological-cancer',1,'Byu7300',NULL,'[X]Malignant neoplasm of female genital organ, unspecified'),('gynaecological-cancer',1,'K5E0.',NULL,'Abnormal uterine bleeding unrelated to menstrual cycle'),('gynaecological-cancer',1,'K5E0.00',NULL,'Abnormal uterine bleeding unrelated to menstrual cycle'),('gynaecological-cancer',1,'R0934',NULL,'[D]Pelvic mass'),('gynaecological-cancer',1,'R093400',NULL,'[D]Pelvic mass'),('gynaecological-cancer',1,'R0935',NULL,'[D]Pelvic lump'),('gynaecological-cancer',1,'R093500',NULL,'[D]Pelvic lump')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesreadv2;

IF OBJECT_ID('tempdb..#codesctv3') IS NOT NULL DROP TABLE #codesctv3;
CREATE TABLE #codesctv3 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesctv3
VALUES ('gynaecological-cancer',1,'X78iC',NULL,'Malignant tumour of female genital organ'),('gynaecological-cancer',1,'B44..',NULL,'Malignant neoplasm of ovary and other uterine adnexa'),('gynaecological-cancer',1,'B440.',NULL,'Malignant neoplasm of ovary'),('gynaecological-cancer',1,'B44y.',NULL,'Malignant neoplasm of other site of uterine adnexa'),('gynaecological-cancer',1,'B44z.',NULL,'Malignant neoplasm of uterine adnexa NOS'),('gynaecological-cancer',1,'Byu70',NULL,'[X]Malignant neoplasm of uterine adnexa, unspecified'),('gynaecological-cancer',1,'XaFrN',NULL,'Local recurrence of malignant tumour of cervix'),('gynaecological-cancer',1,'XE1w9',NULL,'Benign neoplasm of ovary'),('gynaecological-cancer',1,'B7A..',NULL,'Benign neoplasm of ovary'),('gynaecological-cancer',1,'XaKzK',NULL,'Suspected gynaecological cancer'),('gynaecological-cancer',1,'XaFwn',NULL,'Suspected endometrial cancer'),('gynaecological-cancer',1,'XaFwm',NULL,'Suspected cervical cancer'),('gynaecological-cancer',1,'XaaIN',NULL,'QCancer endometrial cancer risk'),('gynaecological-cancer',1,'XaZev',NULL,'QCancer ovarian cancer risk'),('gynaecological-cancer',1,'XaaIO',NULL,'QCancer cervical cancer risk'),('gynaecological-cancer',1,'XaE6w',NULL,'Other abnormal uterine and vaginal bleeding'),('gynaecological-cancer',1,'XaE6z',NULL,'Abnormal vaginal bleeding, unspecified'),('gynaecological-cancer',1,'XaE70',NULL,'Abnormal uterine and vaginal bleeding, unspecified'),('gynaecological-cancer',1,'XaXsb',NULL,'Referral to community gynaecology service'),('gynaecological-cancer',1,'8H58.',NULL,'Gynaecological referral'),('gynaecological-cancer',1,'8HJ6.',NULL,'Gynaecological self-referral'),('gynaecological-cancer',1,'8HV7.',NULL,'Private referral to gynaecologist'),('gynaecological-cancer',1,'XaBTf',NULL,'Referral to gynaecologist'),('gynaecological-cancer',1,'XaAgH',NULL,'Referral to obstetrician and gynaecologist'),('gynaecological-cancer',1,'XaMeB',NULL,'Fast track referral for suspected gynaecological cancer'),('gynaecological-cancer',1,'XaPyV',NULL,'Seen in fast track suspected gynaecological cancer clinic'),('gynaecological-cancer',1,'XaFri',NULL,'Metastasis from malignant tumour of cervix'),('gynaecological-cancer',1,'B912.',NULL,'Neoplasm of uncertain behaviour of ovary'),('gynaecological-cancer',1,'Kyu9D',NULL,'[X]Other specified abnormal uterine and vaginal bleeding'),('gynaecological-cancer',1,'Xa86A',NULL,'Abnormal vaginal bleeding'),('gynaecological-cancer',1,'XaKJm',NULL,'Postmenopausal postcoital bleeding'),('gynaecological-cancer',1,'XaAct',NULL,'Referral to obstetrics and gynaecology service'),('gynaecological-cancer',1,'XaMA6',NULL,'Referral to gynaecology special interest general practitioner'),('gynaecological-cancer',1,'Xaack',NULL,'Referral to paediatric gynaecology service'),('gynaecological-cancer',1,'B41..',NULL,'Cervical carcinoma (uterus)'),('gynaecological-cancer',1,'B41..',NULL,'Malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'B41y.',NULL,'Malignant neoplasm of other site of cervix'),('gynaecological-cancer',1,'B41y.',NULL,'Malignant neoplasm of other site of cervix'),('gynaecological-cancer',1,'B41yz',NULL,'Malignant neoplasm of other site of cervix NOS'),('gynaecological-cancer',1,'B41yz',NULL,'Malignant neoplasm of other site of cervix NOS'),('gynaecological-cancer',1,'B41z.',NULL,'Malignant neoplasm of cervix uteri NOS'),('gynaecological-cancer',1,'B41z.',NULL,'Malignant neoplasm of cervix uteri NOS'),('gynaecological-cancer',1,'B4302',NULL,'Malignant neoplasm of endometrium'),('gynaecological-cancer',1,'B4302',NULL,'Malignant neoplasm of endometrium of corpus uteri'),('gynaecological-cancer',1,'B4302',NULL,'Malignant neoplasm of endometrium of corpus uteri'),('gynaecological-cancer',1,'B45..',NULL,'Malignant neoplasm of other and unspecified female genital organs'),('gynaecological-cancer',1,'B45..',NULL,'Malignant neoplasm of other and unspecified female genital organs'),('gynaecological-cancer',1,'B45y.',NULL,'Malignant neoplasm of other specified female genital organ'),('gynaecological-cancer',1,'B45y.',NULL,'Malignant neoplasm of other specified female genital organ'),('gynaecological-cancer',1,'B45z.',NULL,'Malignant neoplasm of female genital organ NOS'),('gynaecological-cancer',1,'B45z.',NULL,'Malignant neoplasm of female genital organ NOS'),('gynaecological-cancer',1,'B586.',NULL,'Krukenburg tumour'),('gynaecological-cancer',1,'B586.',NULL,'Metastasis to ovary'),('gynaecological-cancer',1,'B586.',NULL,'Metastasis to ovary'),('gynaecological-cancer',1,'B586.',NULL,'Ovarian metastasis'),('gynaecological-cancer',1,'B586.',NULL,'Secondary cancer of ovary'),('gynaecological-cancer',1,'B586.',NULL,'Secondary malignant neoplasm of ovary'),('gynaecological-cancer',1,'B586.',NULL,'Secondary tumour to ovary'),('gynaecological-cancer',1,'B58y2',NULL,'Secondary cancer of the cervix'),('gynaecological-cancer',1,'B58y2',NULL,'Secondary malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'B58y2',NULL,'Secondary malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'B790.',NULL,'Benign neoplasm of cervix uteri NEC'),('gynaecological-cancer',1,'Byu7.',NULL,'[X]Malignant neoplasm of female genital organs'),('gynaecological-cancer',1,'Byu7.',NULL,'[X]Malignant neoplasm of female genital organs'),('gynaecological-cancer',1,'Byu71',NULL,'[X]Malignant neoplasm of other specified female genital organs'),('gynaecological-cancer',1,'Byu71',NULL,'[X]Malignant neoplasm of other specified female genital organs'),('gynaecological-cancer',1,'Byu73',NULL,'[X]Malignant neoplasm of female genital organ, unspecified'),('gynaecological-cancer',1,'Byu73',NULL,'[X]Malignant neoplasm of female genital organ, unspecified'),('gynaecological-cancer',1,'K5A1.',NULL,'Bleeding after menopause'),('gynaecological-cancer',1,'K5A1.',NULL,'PMB - Postmenopausal bleeding'),('gynaecological-cancer',1,'K5A1.',NULL,'Postmenopausal bleeding'),('gynaecological-cancer',1,'K5A1.',NULL,'Postmenopausal bleeding'),('gynaecological-cancer',1,'R0934',NULL,'[D]Pelvic mass'),('gynaecological-cancer',1,'R0934',NULL,'[D]Pelvic mass'),('gynaecological-cancer',1,'R0935',NULL,'[D]Pelvic lump'),('gynaecological-cancer',1,'R0935',NULL,'[D]Pelvic lump'),('gynaecological-cancer',1,'X407e',NULL,'Tumour of cervix'),('gynaecological-cancer',1,'X407e',NULL,'Tumour of cervix'),('gynaecological-cancer',1,'X78Wf',NULL,'Ovarian tumour'),('gynaecological-cancer',1,'X78Wf',NULL,'Tumour of ovary'),('gynaecological-cancer',1,'X78Wf',NULL,'Tumour of ovary'),('gynaecological-cancer',1,'X78Wl',NULL,'Clear cell tumour of ovary'),('gynaecological-cancer',1,'X78Wl',NULL,'Clear cell tumour of ovary'),('gynaecological-cancer',1,'X78Wl',NULL,'Mesonephroid tumour of ovary'),('gynaecological-cancer',1,'X78Wm',NULL,'Borderline epithelial tumour'),('gynaecological-cancer',1,'X78Wm',NULL,'Borderline epithelial tumour'),('gynaecological-cancer',1,'X78Wo',NULL,'Undifferentiated carcinoma of ovary'),('gynaecological-cancer',1,'X78Wo',NULL,'Undifferentiated carcinoma of ovary'),('gynaecological-cancer',1,'X78XE',NULL,'Benign teratoma of ovary'),('gynaecological-cancer',1,'X78XE',NULL,'Benign teratoma of ovary'),('gynaecological-cancer',1,'X78XF',NULL,'Dermoid cyst of ovary'),('gynaecological-cancer',1,'X78XF',NULL,'Dermoid cyst of ovary'),('gynaecological-cancer',1,'X78XF',NULL,'Mature cystic teratoma of ovary'),('gynaecological-cancer',1,'X78Xl',NULL,'Benign tumour of cervix'),('gynaecological-cancer',1,'X78Xl',NULL,'Benign tumour of cervix'),('gynaecological-cancer',1,'XaE6x',NULL,'Abnormal uterine bleeding unrelated to menstrual cycle'),('gynaecological-cancer',1,'XaE6x',NULL,'Abnormal uterine bleeding unrelated to menstrual cycle'),('gynaecological-cancer',1,'XE1vi',NULL,'Ca cervix'),('gynaecological-cancer',1,'XE1vi',NULL,'Cancer of cervix'),('gynaecological-cancer',1,'XE1vi',NULL,'Malignant neoplasm of cervix'),('gynaecological-cancer',1,'XE1vi',NULL,'Malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'XE1vi',NULL,'Malignant tumour of cervix'),('gynaecological-cancer',1,'XE1vi',NULL,'Malignant tumour of cervix'),('gynaecological-cancer',1,'XE1w8',NULL,'Benign neoplasm of cervix uteri NEC'),('gynaecological-cancer',1,'XE1w8',NULL,'Benign neoplasm of cervix uteri NEC'),('gynaecological-cancer',1,'XE1zN',NULL,'Adenocarcinoma cervix uteri'),('gynaecological-cancer',1,'XE1zN',NULL,'Carcinoma cervix uteri'),('gynaecological-cancer',1,'XE1zN',NULL,'Carcinoma cervix uteri: [adenocarcinoma] or [invasive]'),('gynaecological-cancer',1,'XE1zN',NULL,'Cervical carcinoma, invasive'),('gynaecological-cancer',1,'XE1zT',NULL,'Ca cervix uteri NOS'),('gynaecological-cancer',1,'XE1zT',NULL,'Ca cervix uteri NOS'),('gynaecological-cancer',1,'XE1zX',NULL,'Ca ovary/other uterine adnexa'),('gynaecological-cancer',1,'XE1zX',NULL,'Ca ovary/other uterine adnexa'),('gynaecological-cancer',1,'XE1zZ',NULL,'Ca ovary/uterine adnexa NOS'),('gynaecological-cancer',1,'XM1Ca',NULL,'Pelvic mass'),('gynaecological-cancer',1,'XM1Ca',NULL,'Pelvic mass'),('gynaecological-cancer',1,'XM1CZ',NULL,'Pelvic lump'),('gynaecological-cancer',1,'XM1CZ',NULL,'Pelvic lump')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesctv3;

IF OBJECT_ID('tempdb..#codessnomed') IS NOT NULL DROP TABLE #codessnomed;
CREATE TABLE #codessnomed (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codessnomed
VALUES ('gynaecological-cancer',1,'74285003',NULL,'Mass of pelvic structure'),('gynaecological-cancer',1,'92056006',NULL,'Benign tumor of cervix'),('gynaecological-cancer',1,'92260003',NULL,'Benign ovarian tumor'),('gynaecological-cancer',1,'93934004',NULL,'Primary malignant neoplasm of ovary (disorder)'),('gynaecological-cancer',1,'94126000',NULL,'Primary malignant neoplasm of uterine adnexa (disorder)'),('gynaecological-cancer',1,'94455000',NULL,'Cancer metastatic to ovary'),('gynaecological-cancer',1,'94664002',NULL,'Secondary malignant neoplasm of uterine adnexa (disorder)'),('gynaecological-cancer',1,'94792004',NULL,'Neoplasm of uncertain behavior of uterine cervix (disorder)'),('gynaecological-cancer',1,'94974001',NULL,'Neoplasm of uncertain behavior of ovary (disorder)'),('gynaecological-cancer',1,'109880006',NULL,'Overlapping malignant neoplasm of uterine cervix (disorder)'),('gynaecological-cancer',1,'123841004',NULL,'Tumor of cervix'),('gynaecological-cancer',1,'123843001',NULL,'Tumor of ovary'),('gynaecological-cancer',1,'188192002',NULL,'Malignant neoplasm of endometrium of corpus uteri (disorder)'),('gynaecological-cancer',1,'188469005',NULL,'Cancer metastatic to cervix'),('gynaecological-cancer',1,'254856004',NULL,'Undifferentiated ovarian cancer'),('gynaecological-cancer',1,'314970000',NULL,'Local recurrence of malignant tumor of cervix (disorder)'),('gynaecological-cancer',1,'314992001',NULL,'Metastasis from malignant tumor of cervix (disorder)'),('gynaecological-cancer',1,'363354003',NULL,'Cervical cancer'),('gynaecological-cancer',1,'363443007',NULL,'Ovarian cancer'),('gynaecological-cancer',1,'363514001',NULL,'Malignant tumor of female genital organ (disorder)'),('gynaecological-cancer',1,'369522002',NULL,'Primary malignant neoplasm of left ovary (disorder)'),('gynaecological-cancer',1,'369523007',NULL,'Cancer metastatic to left ovary'),('gynaecological-cancer',1,'369529006',NULL,'Primary malignant neoplasm of right ovary (disorder)'),('gynaecological-cancer',1,'369530001',NULL,'Cancer metastatic to right ovary'),('gynaecological-cancer',1,'372024009',NULL,'Primary malignant neoplasm of uterine cervix'),('gynaecological-cancer',1,'416712009',NULL,'Clear cell (mesonephric) neoplasm of ovary'),('gynaecological-cancer',1,'422782004',NULL,'Primary malignant neoplasm of ovary, with widespread metastatic disease'),('gynaecological-cancer',1,'423274005',NULL,'Ovarian cancer stage 4'),('gynaecological-cancer',1,'423480004',NULL,'Cancer of ovary, stage 3'),('gynaecological-cancer',1,'423973006',NULL,'Invasive cervical cancer'),('gynaecological-cancer',1,'424486004',NULL,'Cancer of ovary, stage 2'),('gynaecological-cancer',1,'424600001',NULL,'Ovarian cancer stage 1'),('gynaecological-cancer',1,'428322007',NULL,'Malignant neoplasm of uterine adnexa'),('gynaecological-cancer',1,'716855006',NULL,'Theca steroid producing cell malignant tumour of ovary'),('gynaecological-cancer',1,'718220008',NULL,'Hereditary breast and ovarian cancer syndrome'),('gynaecological-cancer',1,'764791008',NULL,'Borderline epithelial neoplasm of ovary (disorder)'),('gynaecological-cancer',1,'33521000119105',NULL,'Neoplasm of low malignant potential behavior of ovary (disorder)'),('gynaecological-cancer',1,'15540006',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage I'),('gynaecological-cancer',1,'25654007',NULL,'FIGO CC stage Ib'),('gynaecological-cancer',1,'49219005',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage Ia'),('gynaecological-cancer',1,'52708004',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage III (finding)'),('gynaecological-cancer',1,'68240008',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage II (finding)'),('gynaecological-cancer',1,'81822003',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage IV (finding)'),('gynaecological-cancer',1,'87977001',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage Ib occ'),('gynaecological-cancer',1,'708327004',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IA1 (finding)'),('gynaecological-cancer',1,'708331005',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IA2 (finding)'),('gynaecological-cancer',1,'708340009',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IB1 (finding)'),('gynaecological-cancer',1,'708368008',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IB2 (finding)'),('gynaecological-cancer',1,'708381001',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIA1 (finding)'),('gynaecological-cancer',1,'708383003',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIA2 (finding)'),('gynaecological-cancer',1,'708387002',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIB (finding)'),('gynaecological-cancer',1,'708393005',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIIA (finding)'),('gynaecological-cancer',1,'708395003',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIIB (finding)'),('gynaecological-cancer',1,'708400002',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IVA (finding)'),('gynaecological-cancer',1,'708404006',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IVB (finding)'),('gynaecological-cancer',1,'315266007',NULL,'Suspected cervical cancer (situation)'),('gynaecological-cancer',1,'315267003',NULL,'Suspected endometrial cancer (situation)'),('gynaecological-cancer',1,'397682005',NULL,'Suspected gynecological cancer (situation)'),('gynaecological-cancer',1,'725275004',NULL,'Subject refused referral to gynaecologist'),('gynaecological-cancer',1,'762997004',NULL,'Suspected ovarian cancer'),('gynaecological-cancer',1,'4461000175108',NULL,'Screening for malignant neoplasm of cervix not done'),('gynaecological-cancer',1,'112241000119107',NULL,'Cervical cancer Papanicolaou smear screening declined'),('gynaecological-cancer',1,'30382004',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage II'),('gynaecological-cancer',1,'34537009',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage IV'),('gynaecological-cancer',1,'46756001',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage I A'),('gynaecological-cancer',1,'50237009',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage I'),('gynaecological-cancer',1,'60275007',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage I B (finding)'),('gynaecological-cancer',1,'80975007',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage III (finding)'),('gynaecological-cancer',1,'708415001',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer stage IIIB'),('gynaecological-cancer',1,'708432002',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer stage IIIC1'),('gynaecological-cancer',1,'708435000',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage IIIC2'),('gynaecological-cancer',1,'708443005',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IVA (finding)'),('gynaecological-cancer',1,'708446002',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IVB (finding)'),('gynaecological-cancer',1,'708533009',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IIIA'),('gynaecological-cancer',1,'785781000000101',NULL,'Referral to community gynaecology service'),('gynaecological-cancer',1,'76742009',NULL,'Postmenopausal bleeding (finding)'),('gynaecological-cancer',1,'301822002',NULL,'Abnormal vaginal bleeding (finding)'),('gynaecological-cancer',1,'415149004',NULL,'Postmenopausal postcoital bleeding'),('gynaecological-cancer',1,'874231000000101',NULL,'QCancer endometrial cancer risk'),('gynaecological-cancer',1,'848891000000105',NULL,'QCancer ovarian cancer risk (observable entity)'),('gynaecological-cancer',1,'874251000000108',NULL,'QCancer cervical cancer risk'),('gynaecological-cancer',1,'369814002',NULL,'T3 (III): Endometrial tumor with local and/or regional spread as specified in T3a, b, N1 and FIGO IIIA, B, and C below or adnexa (direct extension or metastasis) and/or cancer cells in ascites or peritoneal washings (finding)'),('gynaecological-cancer',1,'446526009',NULL,'Debulking of neoplasm of ovary'),('gynaecological-cancer',1,'473239006',NULL,'Bilateral oophorectomy for malignant tumour of ovary'),('gynaecological-cancer',1,'94397007',NULL,'Cancer metastatic to neck lymph nodes'),('gynaecological-cancer',1,'700125004',NULL,'Referral to paediatric gynaecology service'),('gynaecological-cancer',1,'432519008',NULL,'Elevated cancer antigen 125'),('gynaecological-cancer',1,'276311000000101',NULL,'Fast track referral for suspected gynaecological cancer'),('gynaecological-cancer',1,'382511000000105',NULL,'Seen in fast track suspected gynaecological cancer clinic'),('gynaecological-cancer',1,'249011000000106',NULL,'Referral to gynaecology special interest general practitioner'),('gynaecological-cancer',1,'119423009',NULL,'Benign teratoma of ovary (disorder)'),('gynaecological-cancer',1,'189116006',NULL,'Benign neoplasm of ovary (& dermoid cyst)'),('gynaecological-cancer',1,'312984006',NULL,'Abnormal uterine bleeding unrelated to menstrual cycle (disorder)')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codessnomed;

IF OBJECT_ID('tempdb..#codesemis') IS NOT NULL DROP TABLE #codesemis;
CREATE TABLE #codesemis (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[term] [varchar](20) COLLATE Latin1_General_CS_AS NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesemis
VALUES ('gynaecological-cancer',1,'^ESCT1199845',NULL,'Suspected ovarian cancer'),('gynaecological-cancer',1,'^ESCT1202154',NULL,'Borderline epithelial tumour of ovary'),('gynaecological-cancer',1,'^ESCT1202155',NULL,'Borderline ovarian epithelial tumor'),('gynaecological-cancer',1,'^ESCT1202156',NULL,'Borderline ovarian epithelial tumour'),('gynaecological-cancer',1,'^ESCT1202157',NULL,'Borderline epithelial tumor of ovary'),('gynaecological-cancer',1,'^ESCT1202158',NULL,'Borderline epithelial neoplasm of ovary'),('gynaecological-cancer',1,'^ESCT1247309',NULL,'Malignant tumor of female genital organ'),('gynaecological-cancer',1,'^ESCTBE399649',NULL,'Benign neoplasm of uterine cervix'),('gynaecological-cancer',1,'^ESCTBE399650',NULL,'Benign neoplasm of cervix uteri'),('gynaecological-cancer',1,'^ESCTBE399651',NULL,'Benign tumour of cervix'),('gynaecological-cancer',1,'^ESCTBE399652',NULL,'Benign tumor of cervix'),('gynaecological-cancer',1,'^ESCTBE400041',NULL,'Benign ovarian tumor'),('gynaecological-cancer',1,'^ESCTBI748490',NULL,'Bilateral oophorectomy for malignant neoplasm of ovary'),('gynaecological-cancer',1,'^ESCTBI748491',NULL,'Bilateral oophorectomy for ovarian malignancy'),('gynaecological-cancer',1,'^ESCTBI748492',NULL,'Bilateral oophorectomy for malignant tumor of ovary'),('gynaecological-cancer',1,'^ESCTBI748493',NULL,'Bilateral oophorectomy for malignant tumour of ovary'),('gynaecological-cancer',1,'^ESCTBL374815',NULL,'Bleeding after menopause'),('gynaecological-cancer',1,'^ESCTCA403543',NULL,'Cancer metastatic to neck lymph nodes'),('gynaecological-cancer',1,'^ESCTCA403692',NULL,'Cancer metastatic to ovary'),('gynaecological-cancer',1,'^ESCTCA475133',NULL,'Cancer metastatic to cervix'),('gynaecological-cancer',1,'^ESCTCA624310',NULL,'Cancer of cervix'),('gynaecological-cancer',1,'^ESCTCA624313',NULL,'Cancer of the uterine cervix'),('gynaecological-cancer',1,'^ESCTCA624613',NULL,'CA - Cancer of ovary'),('gynaecological-cancer',1,'^ESCTCA632597',NULL,'Cancer metastatic to left ovary'),('gynaecological-cancer',1,'^ESCTCA632610',NULL,'Cancer metastatic to right ovary'),('gynaecological-cancer',1,'^ESCTCA700461',NULL,'Carcinoma of ovary, stage 4'),('gynaecological-cancer',1,'^ESCTCA700462',NULL,'Cancer of ovary, stage 4'),('gynaecological-cancer',1,'^ESCTCA700824',NULL,'Carcinoma of ovary, stage 3'),('gynaecological-cancer',1,'^ESCTCA700826',NULL,'Cancer of ovary, stage 3'),('gynaecological-cancer',1,'^ESCTCA701746',NULL,'Carcinoma of uterine cervix, invasive'),('gynaecological-cancer',1,'^ESCTCA701747',NULL,'Cancer of uterine cervix, invasive'),('gynaecological-cancer',1,'^ESCTCA702727',NULL,'Carcinoma of ovary, stage 2'),('gynaecological-cancer',1,'^ESCTCA702729',NULL,'Cancer of ovary, stage 2'),('gynaecological-cancer',1,'^ESCTCA702949',NULL,'Carcinoma of ovary, stage 1'),('gynaecological-cancer',1,'^ESCTCA702950',NULL,'Cancer of ovary, stage 1'),('gynaecological-cancer',1,'^ESCTCE624314',NULL,'Cervical cancer'),('gynaecological-cancer',1,'^ESCTCE797918',NULL,'Cervical cancer screening not done'),('gynaecological-cancer',1,'^ESCTCE803550',NULL,'Cervical cancer Papanicolaou smear screening declined'),('gynaecological-cancer',1,'^ESCTCL689609',NULL,'Clear cell (mesonephric) neoplasm of ovary'),('gynaecological-cancer',1,'^ESCTDE732582',NULL,'Debulking of neoplasm of ovary'),('gynaecological-cancer',1,'^ESCTEL716188',NULL,'Elevated cancer antigen 125'),('gynaecological-cancer',1,'^ESCTFI274652',NULL,'FIGO CC stage I'),('gynaecological-cancer',1,'^ESCTFI291047',NULL,'FIGO CC stage Ib'),('gynaecological-cancer',1,'^ESCTFI298928',NULL,'FIGO EC stage II'),('gynaecological-cancer',1,'^ESCTFI305606',NULL,'FIGO EC stage IV'),('gynaecological-cancer',1,'^ESCTFI325560',NULL,'FIGO EC stage I A'),('gynaecological-cancer',1,'^ESCTFI329633',NULL,'FIGO CC stage Ia'),('gynaecological-cancer',1,'^ESCTFI331374',NULL,'FIGO EC stage I'),('gynaecological-cancer',1,'^ESCTFI335459',NULL,'FIGO CC stage III'),('gynaecological-cancer',1,'^ESCTFI347892',NULL,'FIGO EC stage I B'),('gynaecological-cancer',1,'^ESCTFI361021',NULL,'FIGO CC stage II'),('gynaecological-cancer',1,'^ESCTFI381706',NULL,'FIGO EC stage III'),('gynaecological-cancer',1,'^ESCTFI383047',NULL,'FIGO CC stage IV'),('gynaecological-cancer',1,'^ESCTFI392953',NULL,'FIGO CC stage Ib occ'),('gynaecological-cancer',1,'^ESCTFI763214',NULL,'FIGO CC stage IA1'),('gynaecological-cancer',1,'^ESCTFI763222',NULL,'FIGO CC stage IA2'),('gynaecological-cancer',1,'^ESCTFI763240',NULL,'FIGO CC stage IB1'),('gynaecological-cancer',1,'^ESCTFI763270',NULL,'FIGO CC stage IB2'),('gynaecological-cancer',1,'^ESCTFI763288',NULL,'FIGO CC stage IIA1'),('gynaecological-cancer',1,'^ESCTFI763293',NULL,'FIGO CC stage IIA2'),('gynaecological-cancer',1,'^ESCTFI763301',NULL,'FIGO CC stage IIB'),('gynaecological-cancer',1,'^ESCTFI763311',NULL,'FIGO CC stage IIIA'),('gynaecological-cancer',1,'^ESCTFI763317',NULL,'FIGO CC stage IIIB'),('gynaecological-cancer',1,'^ESCTFI763327',NULL,'FIGO CC stage IVA'),('gynaecological-cancer',1,'^ESCTFI763336',NULL,'FIGO CC stage IVB'),('gynaecological-cancer',1,'^ESCTFI763356',NULL,'FIGO EC stage IIIB'),('gynaecological-cancer',1,'^ESCTFI763390',NULL,'FIGO EC stage IIIC1'),('gynaecological-cancer',1,'^ESCTFI763398',NULL,'FIGO EC stage IIIC2'),('gynaecological-cancer',1,'^ESCTFI763414',NULL,'FIGO EC stage IVA'),('gynaecological-cancer',1,'^ESCTFI763420',NULL,'FIGO EC stage IVB'),('gynaecological-cancer',1,'^ESCTFI763570',NULL,'FIGO EC stage IIIA'),('gynaecological-cancer',1,'^ESCTGY472470',NULL,'Gynecological referral'),('gynaecological-cancer',1,'^ESCTGY472575',NULL,'Gynecological self-referral'),('gynaecological-cancer',1,'^ESCTHE776943',NULL,'Hereditary breast and ovarian cancer syndrome'),('gynaecological-cancer',1,'^ESCTIN274653',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage I'),('gynaecological-cancer',1,'^ESCTIN274654',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage I'),('gynaecological-cancer',1,'^ESCTIN274655',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage I'),('gynaecological-cancer',1,'^ESCTIN291043',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer stage Ib'),('gynaecological-cancer',1,'^ESCTIN291044',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage Ib'),('gynaecological-cancer',1,'^ESCTIN291045',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage Ib'),('gynaecological-cancer',1,'^ESCTIN291046',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage Ib'),('gynaecological-cancer',1,'^ESCTIN298929',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage II'),('gynaecological-cancer',1,'^ESCTIN298930',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage II'),('gynaecological-cancer',1,'^ESCTIN298931',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer stage II'),('gynaecological-cancer',1,'^ESCTIN298932',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage II'),('gynaecological-cancer',1,'^ESCTIN305607',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage IV'),('gynaecological-cancer',1,'^ESCTIN305608',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IV'),('gynaecological-cancer',1,'^ESCTIN305609',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage IV'),('gynaecological-cancer',1,'^ESCTIN325561',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage I A'),('gynaecological-cancer',1,'^ESCTIN325562',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage I A'),('gynaecological-cancer',1,'^ESCTIN325563',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage I A'),('gynaecological-cancer',1,'^ESCTIN329631',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage Ia'),('gynaecological-cancer',1,'^ESCTIN329632',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage Ia'),('gynaecological-cancer',1,'^ESCTIN329634',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage Ia'),('gynaecological-cancer',1,'^ESCTIN331375',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage I'),('gynaecological-cancer',1,'^ESCTIN331376',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage I'),('gynaecological-cancer',1,'^ESCTIN331377',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage I'),('gynaecological-cancer',1,'^ESCTIN335460',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage III'),('gynaecological-cancer',1,'^ESCTIN335461',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage III'),('gynaecological-cancer',1,'^ESCTIN335462',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage III'),('gynaecological-cancer',1,'^ESCTIN347893',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage I B'),('gynaecological-cancer',1,'^ESCTIN347894',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage I B'),('gynaecological-cancer',1,'^ESCTIN347895',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage I B'),('gynaecological-cancer',1,'^ESCTIN361022',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage II'),
('gynaecological-cancer',1,'^ESCTIN361023',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage II'),('gynaecological-cancer',1,'^ESCTIN361024',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage II'),('gynaecological-cancer',1,'^ESCTIN381707',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage III'),('gynaecological-cancer',1,'^ESCTIN381708',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage III'),('gynaecological-cancer',1,'^ESCTIN381709',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage III'),('gynaecological-cancer',1,'^ESCTIN383048',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IV'),('gynaecological-cancer',1,'^ESCTIN383049',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IV'),('gynaecological-cancer',1,'^ESCTIN383050',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage IV'),('gynaecological-cancer',1,'^ESCTIN392954',NULL,'International Federation of Gynecology and Obstetrics cervical cancer stage Ib occ'),('gynaecological-cancer',1,'^ESCTIN392955',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage Ib occ'),('gynaecological-cancer',1,'^ESCTIN392956',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer stage Ib occ'),('gynaecological-cancer',1,'^ESCTIN392957',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage Ib occ'),('gynaecological-cancer',1,'^ESCTIN701748',NULL,'Invasive cervical cancer'),('gynaecological-cancer',1,'^ESCTIN716186',NULL,'Increased cancer antigen 125'),('gynaecological-cancer',1,'^ESCTIN763215',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IA1'),('gynaecological-cancer',1,'^ESCTIN763216',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IA1'),('gynaecological-cancer',1,'^ESCTIN763223',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IA2'),('gynaecological-cancer',1,'^ESCTIN763224',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IA2'),('gynaecological-cancer',1,'^ESCTIN763241',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IB1'),('gynaecological-cancer',1,'^ESCTIN763242',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IB1'),('gynaecological-cancer',1,'^ESCTIN763271',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IB2'),('gynaecological-cancer',1,'^ESCTIN763272',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IB2'),('gynaecological-cancer',1,'^ESCTIN763289',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IIA1'),('gynaecological-cancer',1,'^ESCTIN763290',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIA1'),('gynaecological-cancer',1,'^ESCTIN763294',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIA2'),('gynaecological-cancer',1,'^ESCTIN763295',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IIA2'),('gynaecological-cancer',1,'^ESCTIN763302',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IIB'),('gynaecological-cancer',1,'^ESCTIN763303',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIB'),('gynaecological-cancer',1,'^ESCTIN763312',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIIA'),('gynaecological-cancer',1,'^ESCTIN763313',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IIIA'),('gynaecological-cancer',1,'^ESCTIN763318',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IIIB'),('gynaecological-cancer',1,'^ESCTIN763319',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IIIB'),('gynaecological-cancer',1,'^ESCTIN763328',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IVA'),('gynaecological-cancer',1,'^ESCTIN763329',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IVA'),('gynaecological-cancer',1,'^ESCTIN763337',NULL,'International Federation of Gynecology and Obstetrics cervical cancer (FIGO CC) stage IVB'),('gynaecological-cancer',1,'^ESCTIN763338',NULL,'International Federation of Gynaecology and Obstetrics cervical cancer (FIGO CC) stage IVB'),('gynaecological-cancer',1,'^ESCTIN763357',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage IIIB'),('gynaecological-cancer',1,'^ESCTIN763358',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IIIB'),('gynaecological-cancer',1,'^ESCTIN763359',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage IIIB'),('gynaecological-cancer',1,'^ESCTIN763360',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer stage IIIB'),('gynaecological-cancer',1,'^ESCTIN763391',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IIIC1'),('gynaecological-cancer',1,'^ESCTIN763392',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage IIIC1'),('gynaecological-cancer',1,'^ESCTIN763393',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage IIIC1'),('gynaecological-cancer',1,'^ESCTIN763394',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer stage IIIC1'),('gynaecological-cancer',1,'^ESCTIN763399',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IIIC2'),('gynaecological-cancer',1,'^ESCTIN763400',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage IIIC2'),('gynaecological-cancer',1,'^ESCTIN763401',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer stage IIIC2'),('gynaecological-cancer',1,'^ESCTIN763402',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer stage IIIC2'),('gynaecological-cancer',1,'^ESCTIN763415',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage IVA'),('gynaecological-cancer',1,'^ESCTIN763416',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IVA'),('gynaecological-cancer',1,'^ESCTIN763421',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IVB'),('gynaecological-cancer',1,'^ESCTIN763422',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage IVB'),('gynaecological-cancer',1,'^ESCTIN763569',NULL,'International Federation of Gynaecology and Obstetrics endometrial cancer (FIGO EC) stage IIIA'),('gynaecological-cancer',1,'^ESCTIN763571',NULL,'International Federation of Gynecology and Obstetrics endometrial cancer (FIGO EC) stage IIIA'),('gynaecological-cancer',1,'^ESCTKR403685',NULL,'Krukenburg tumor'),('gynaecological-cancer',1,'^ESCTKR403691',NULL,'Krukenburg tumour'),('gynaecological-cancer',1,'^ESCTLO605219',NULL,'Local recurrence of malignant tumour of cervix'),('gynaecological-cancer',1,'^ESCTLO605220',NULL,'Local recurrence of malignant tumor of cervix'),('gynaecological-cancer',1,'^ESCTMA370769',NULL,'Mass of pelvic structure'),('gynaecological-cancer',1,'^ESCTMA624309',NULL,'Malignant tumor of cervix'),('gynaecological-cancer',1,'^ESCTMA624311',NULL,'Malignant neoplasm of cervix'),('gynaecological-cancer',1,'^ESCTMA624612',NULL,'Malignant tumor of ovary'),('gynaecological-cancer',1,'^ESCTMA624805',NULL,'Malignant tumor of female genital organ'),('gynaecological-cancer',1,'^ESCTME403541',NULL,'Metastatic malignant neoplasm to lymph nodes of neck'),('gynaecological-cancer',1,'^ESCTME403542',NULL,'Metastasis to cervical lymph nodes'),('gynaecological-cancer',1,'^ESCTME403684',NULL,'Metastatic malignant neoplasm to ovary'),('gynaecological-cancer',1,'^ESCTME403688',NULL,'Metastasis to ovary'),('gynaecological-cancer',1,'^ESCTME404206',NULL,'Metastatic malignant neoplasm to uterine adnexa'),('gynaecological-cancer',1,'^ESCTME475130',NULL,'Metastatic malignant neoplasm to uterine cervix'),('gynaecological-cancer',1,'^ESCTME475131',NULL,'Metastatic malignant neoplasm to cervix uteri'),('gynaecological-cancer',1,'^ESCTME605247',NULL,'Metastasis from malignant tumour of cervix'),('gynaecological-cancer',1,'^ESCTME605248',NULL,'Metastasis from malignant tumor of cervix'),('gynaecological-cancer',1,'^ESCTNE404442',NULL,'Neoplasm of uncertain behaviour of uterine cervix'),('gynaecological-cancer',1,'^ESCTNE404443',NULL,'Neoplasm of uncertain behavior of uterine cervix'),('gynaecological-cancer',1,'^ESCTNE404444',NULL,'Neoplasm of uncertain behavior of cervix uteri'),('gynaecological-cancer',1,'^ESCTNE404445',NULL,'Neoplasm of uncertain behaviour of cervix uteri'),('gynaecological-cancer',1,'^ESCTNE404825',NULL,'Neoplasm of uncertain behavior of ovary'),('gynaecological-cancer',1,'^ESCTNE435657',NULL,'Neoplasm of uterine cervix'),('gynaecological-cancer',1,'^ESCTNE435662',NULL,'Neoplasm of ovary'),('gynaecological-cancer',1,'^ESCTNE801501',NULL,'Neoplasm of low malignant potential behaviour of ovary'),('gynaecological-cancer',1,'^ESCTNE801502',NULL,'Neoplasm of low malignant potential behavior of ovary'),
('gynaecological-cancer',1,'^ESCTOV403687',NULL,'Ovarian metastasis'),('gynaecological-cancer',1,'^ESCTOV417122',NULL,'Overlapping malignant neoplasm of uterine cervix'),('gynaecological-cancer',1,'^ESCTOV417123',NULL,'Overlapping malignant neoplasm of cervix uteri'),('gynaecological-cancer',1,'^ESCTOV431731',NULL,'Ovarian mature cystic teratoma'),('gynaecological-cancer',1,'^ESCTOV435664',NULL,'Ovarian tumour'),('gynaecological-cancer',1,'^ESCTOV435665',NULL,'Ovarian tumor'),('gynaecological-cancer',1,'^ESCTOV624615',NULL,'Ovarian cancer'),('gynaecological-cancer',1,'^ESCTOV699568',NULL,'Ovarian cancer, disseminated'),('gynaecological-cancer',1,'^ESCTOV700463',NULL,'Ovarian cancer stage 4'),('gynaecological-cancer',1,'^ESCTOV700825',NULL,'Ovarian cancer stage 3'),('gynaecological-cancer',1,'^ESCTOV702728',NULL,'Ovarian cancer stage 2'),('gynaecological-cancer',1,'^ESCTOV702951',NULL,'Ovarian cancer stage 1'),('gynaecological-cancer',1,'^ESCTPA786697',NULL,'Patient refused referral to gynecologist'),('gynaecological-cancer',1,'^ESCTPA786700',NULL,'Patient refused referral to gynaecologist'),('gynaecological-cancer',1,'^ESCTPE370768',NULL,'Pelvic lump'),('gynaecological-cancer',1,'^ESCTPM374814',NULL,'PMB - Postmenopausal bleeding'),('gynaecological-cancer',1,'^ESCTPR402715',NULL,'Primary malignant neoplasm of ovary'),('gynaecological-cancer',1,'^ESCTPR402929',NULL,'Primary malignant neoplasm of uterine adnexa'),('gynaecological-cancer',1,'^ESCTPR472843',NULL,'Private referral to gynecologist'),('gynaecological-cancer',1,'^ESCTPR632595',NULL,'Primary malignant neoplasm of left ovary'),('gynaecological-cancer',1,'^ESCTPR632608',NULL,'Primary malignant neoplasm of right ovary'),('gynaecological-cancer',1,'^ESCTPR636302',NULL,'Primary malignant neoplasm of uterine cervix'),('gynaecological-cancer',1,'^ESCTPR699569',NULL,'Primary malignant neoplasm of ovary, with widespread metastatic disease'),('gynaecological-cancer',1,'^ESCTRA716187',NULL,'Raised cancer antigen 125'),('gynaecological-cancer',1,'^ESCTRE472469',NULL,'Referral to gynaecology service'),('gynaecological-cancer',1,'^ESCTRE472472',NULL,'Referral to gynecology service'),('gynaecological-cancer',1,'^ESCTRE595195',NULL,'Referral to obstetrics and gynaecology service'),('gynaecological-cancer',1,'^ESCTRE595196',NULL,'Referral to obstetrics and gynecology service'),('gynaecological-cancer',1,'^ESCTRE595438',NULL,'Referral to obstetrician and gynecologist'),('gynaecological-cancer',1,'^ESCTRE597926',NULL,'Referral to gynecologist'),('gynaecological-cancer',1,'^ESCTRE753131',NULL,'Referral to pediatric gynecology service'),('gynaecological-cancer',1,'^ESCTRE786695',NULL,'Referral to gynaecologist declined by subject'),('gynaecological-cancer',1,'^ESCTRE786696',NULL,'Referral to gynecologist declined by subject'),('gynaecological-cancer',1,'^ESCTSC797919',NULL,'Screening for malignant neoplasm of cervix not done'),('gynaecological-cancer',1,'^ESCTSE403540',NULL,'Secondary malignant neoplasm of lymph nodes of neck'),('gynaecological-cancer',1,'^ESCTSE403686',NULL,'Secondary tumor to ovary'),('gynaecological-cancer',1,'^ESCTSE403689',NULL,'Secondary cancer of ovary'),('gynaecological-cancer',1,'^ESCTSE403690',NULL,'Secondary tumour to ovary'),('gynaecological-cancer',1,'^ESCTSE404205',NULL,'Secondary malignant neoplasm of uterine adnexa'),('gynaecological-cancer',1,'^ESCTSE475132',NULL,'Secondary malignant neoplasm of uterine cervix'),('gynaecological-cancer',1,'^ESCTSE632596',NULL,'Secondary malignant neoplasm of left ovary'),('gynaecological-cancer',1,'^ESCTSE632609',NULL,'Secondary malignant neoplasm of right ovary'),('gynaecological-cancer',1,'^ESCTSU659110',NULL,'Suspected gynecological cancer'),('gynaecological-cancer',1,'^ESCTSU786698',NULL,'Subject declined referral to gynecologist'),('gynaecological-cancer',1,'^ESCTSU786699',NULL,'Subject refused referral to gynecologist'),('gynaecological-cancer',1,'^ESCTSU786701',NULL,'Subject declined referral to gynaecologist'),('gynaecological-cancer',1,'^ESCTSU786702',NULL,'Subject refused referral to gynaecologist'),('gynaecological-cancer',1,'^ESCTT3633184',NULL,'T3 (III): Endometrial tumour with local and/or regional spread as specified in T3a, b, N1 and FIGO IIIA, B, and C below or adnexa (direct extension or metastasis) and/or cancer cells in ascites or peritoneal washings'),('gynaecological-cancer',1,'^ESCTT3633185',NULL,'T3 (III): Endometrial tumor with local and/or regional spread as specified in T3a, b, N1 and FIGO IIIA, B, and C below or adnexa (direct extension or metastasis) and/or cancer cells in ascites or peritoneal washings'),('gynaecological-cancer',1,'^ESCTTH775303',NULL,'Theca steroid producing cell malignant neoplasm of ovary'),('gynaecological-cancer',1,'^ESCTTH775304',NULL,'Theca steroid producing cell malignant tumor of ovary'),('gynaecological-cancer',1,'^ESCTTH775305',NULL,'Theca steroid producing cell malignant tumour of ovary'),('gynaecological-cancer',1,'^ESCTTU435658',NULL,'Tumour of cervix'),('gynaecological-cancer',1,'^ESCTTU435659',NULL,'Tumor of cervix'),('gynaecological-cancer',1,'^ESCTTU435663',NULL,'Tumour of ovary'),('gynaecological-cancer',1,'^ESCTTU435666',NULL,'Tumor of ovary'),('gynaecological-cancer',1,'^ESCTUN535181',NULL,'Undifferentiated carcinoma of ovary'),('gynaecological-cancer',1,'^ESCTUN535182',NULL,'Undifferentiated ovarian cancer'),('gynaecological-cancer',1,'EMISNQQC5',NULL,'QCancer ovarian cancer risk score'),('gynaecological-cancer',1,'EMISNQQC8',NULL,'QCancer cervical cancer risk score'),('gynaecological-cancer',1,'EMISNQQC9',NULL,'QCancer endometrial cancer risk score'),('gynaecological-cancer',1,'EMISNQSU3',NULL,'Suspected gynaecological cancer')

INSERT INTO #AllCodes
SELECT [concept], [version], [code], [description] from #codesemis;


IF OBJECT_ID('tempdb..#TempRefCodes') IS NOT NULL DROP TABLE #TempRefCodes;
CREATE TABLE #TempRefCodes (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, version INT NOT NULL, [description] VARCHAR(255));

-- Read v2 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcr.concept, dcr.[version], dcr.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesreadv2 dcr on dcr.code = rc.MainCode
WHERE CodingType='ReadCodeV2'
AND (dcr.term IS NULL OR dcr.term = rc.Term)
and PK_Reference_Coding_ID != -1;

-- CTV3 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcc.concept, dcc.[version], dcc.[description]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesctv3 dcc on dcc.code = rc.MainCode
WHERE CodingType='CTV3'
and PK_Reference_Coding_ID != -1;

-- EMIS codes with a FK Reference Coding ID
INSERT INTO #TempRefCodes
SELECT FK_Reference_Coding_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID != -1;

IF OBJECT_ID('tempdb..#TempSNOMEDRefCodes') IS NOT NULL DROP TABLE #TempSNOMEDRefCodes;
CREATE TABLE #TempSNOMEDRefCodes (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [version] INT NOT NULL, [description] VARCHAR(255));

-- SNOMED codes
INSERT INTO #TempSNOMEDRefCodes
SELECT PK_Reference_SnomedCT_ID, dcs.concept, dcs.[version], dcs.[description]
FROM SharedCare.Reference_SnomedCT rs
INNER JOIN #codessnomed dcs on dcs.code = rs.ConceptID;

-- EMIS codes with a FK SNOMED ID but without a FK Reference Coding ID
INSERT INTO #TempSNOMEDRefCodes
SELECT FK_Reference_SnomedCT_ID, ce.concept, ce.[version], ce.[description]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID = -1
AND FK_Reference_SnomedCT_ID != -1;

-- De-duped tables
IF OBJECT_ID('tempdb..#CodeSets') IS NOT NULL DROP TABLE #CodeSets;
CREATE TABLE #CodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#SnomedSets') IS NOT NULL DROP TABLE #SnomedSets;
CREATE TABLE #SnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedCodeSets') IS NOT NULL DROP TABLE #VersionedCodeSets;
CREATE TABLE #VersionedCodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

IF OBJECT_ID('tempdb..#VersionedSnomedSets') IS NOT NULL DROP TABLE #VersionedSnomedSets;
CREATE TABLE #VersionedSnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT, [description] VARCHAR(255));

INSERT INTO #VersionedCodeSets
SELECT DISTINCT * FROM #TempRefCodes;

INSERT INTO #VersionedSnomedSets
SELECT DISTINCT * FROM #TempSNOMEDRefCodes;

INSERT INTO #CodeSets
SELECT FK_Reference_Coding_ID, c.concept, [description]
FROM #VersionedCodeSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedCodeSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

INSERT INTO #SnomedSets
SELECT FK_Reference_SnomedCT_ID, c.concept, [description]
FROM #VersionedSnomedSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedSnomedSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

--#endregion

-- >>> Following code sets injected: gynaecological-cancer v1


-- Set the start date
DECLARE @StartDate datetime;
DECLARE @EndDate datetime;
SET @StartDate = '2011-01-01';
SET @EndDate = GETDATE();

--Just want the output, not the messages
SET NOCOUNT ON;


-- Create the gynae cancer cohort========================================================================================================
IF OBJECT_ID('tempdb..#GynaeCohort') IS NOT NULL DROP TABLE #GynaeCohort;
SELECT DISTINCT FK_Patient_Link_ID 
INTO #GynaeCohort
FROM SharedCare.GP_Events
WHERE (
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE Concept = 'gynaecological-cancer' AND Version = 1) OR
  FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE Concept = 'gynaecological-cancer' AND Version = 1)
) AND EventDate >= @StartDate AND EventDate < @EndDate;


-- Create a table with all patients for post COPI and within cohort 2=========================================================================================================================
IF OBJECT_ID('tempdb..#PatientsToInclude') IS NOT NULL DROP TABLE #PatientsToInclude;
SELECT FK_Patient_Link_ID INTO #PatientsToInclude
FROM [SharedCare].[Patient_GP_History]
WHERE FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #GynaeCohort)
GROUP BY FK_Patient_Link_ID
HAVING MIN(StartDate) < '2022-06-01';

IF OBJECT_ID('tempdb..#Patients') IS NOT NULL DROP TABLE #Patients;
SELECT DISTINCT FK_Patient_Link_ID 
INTO #Patients 
FROM #PatientsToInclude;


-- Select event date and skin cancer related codes====================================================================================================================
IF OBJECT_ID('tempdb..#Table') IS NOT NULL DROP TABLE #Table;
SELECT DISTINCT FK_Patient_Link_ID AS PatientId, 
				CONVERT(date, EventDate) AS EventDate, 
				FK_Reference_Coding_ID,
				FK_Reference_SnomedCT_ID
INTO #Table
FROM SharedCare.GP_Events
WHERE (
  FK_Reference_Coding_ID IN (SELECT FK_Reference_Coding_ID FROM #VersionedCodeSets WHERE Concept = 'gynaecological-cancer' AND Version = 1) OR
  FK_Reference_SnomedCT_ID IN (SELECT FK_Reference_SnomedCT_ID FROM #VersionedSnomedSets WHERE Concept = 'gynaecological-cancer' AND Version = 1)
)     AND EventDate < @EndDate
      AND FK_Patient_Link_ID IN (SELECT FK_Patient_Link_ID FROM #Patients);

SELECT DISTINCT PatientId, 
	            EventDate, 
		    CASE
		    WHEN c.MainCode IS NOT NULL THEN c.MainCode
		    ELSE s.ConceptID
		    END AS GynaeCancerRelatedClinicalCode
FROM #Table t
LEFT OUTER JOIN SharedCare.Reference_Coding c ON c.PK_Reference_Coding_ID = t.FK_Reference_Coding_ID
LEFT OUTER JOIN SharedCare.Reference_SnomedCT s ON s.PK_Reference_SnomedCT_ID = t.FK_Reference_SnomedCT_ID
ORDER BY PatientId, EventDate;



