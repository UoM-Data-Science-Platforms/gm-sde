--┌──────────────────────────────┐
--│ Moderate covid vulnerability │
--└──────────────────────────────┘

-- OBJECTIVE: 

-- INPUT: No pre-requisites

--Just want the output, not the messages
SET NOCOUNT ON;

--┌──────────────────────────────┐
--│ Practice system lookup table │
--└──────────────────────────────┘

-- OBJECTIVE: To provide lookup table for GP systems. The GMCR doesn't hold this information
--            in the data so here is a lookup. This was accurate on 27th Jan 2021 and will
--            likely drift out of date slowly as practices change systems. Though this doesn't 
--            happen very often.

-- INPUT: No pre-requisites

-- OUTPUT: A temp table as follows:
-- #PracticeSystemLookup (PracticeId, System)
-- 	- PracticeId - Nationally recognised practice id
--	- System - EMIS, TPP, VISION

IF OBJECT_ID('tempdb..#PracticeSystemLookup') IS NOT NULL DROP TABLE #PracticeSystemLookup;
CREATE TABLE #PracticeSystemLookup (PracticeId nchar(6), System nvarchar(20));
INSERT INTO #PracticeSystemLookup VALUES
('P82001', 'EMIS'),('P82002', 'TPP'),('P82003', 'TPP'),('P82004', 'TPP'),('P82005', 'TPP'),('P82006', 'EMIS'),('P82007', 'TPP'),('P82008', 'TPP'),('P82009', 'EMIS'),('P82010', 'EMIS'),('P82011', 'EMIS'),('P82012', 'EMIS'),('P82013', 'EMIS'),('P82014', 'TPP'),('P82015', 'EMIS'),('P82016', 'EMIS'),('P82018', 'EMIS'),('P82020', 'EMIS'),('P82021', 'EMIS'),('P82022', 'EMIS'),('P82023', 'Vision'),('P82025', 'TPP'),('P82029', 'EMIS'),('P82030', 'EMIS'),('P82031', 'EMIS'),('P82033', 'EMIS'),('P82034', 'EMIS'),('P82036', 'EMIS'),('P82037', 'EMIS'),('P82607', 'EMIS'),('P82609', 'EMIS'),('P82613', 'EMIS'),('P82616', 'EMIS'),('P82624', 'Vision'),('P82625', 'EMIS'),('P82626', 'EMIS'),('P82627', 'EMIS'),('P82629', 'Vision'),('P82633', 'EMIS'),('P82634', 'TPP'),('P82640', 'EMIS'),('P82643', 'EMIS'),('P82652', 'EMIS'),('P82660', 'Vision'),('Y00186', 'EMIS'),('Y02319', 'EMIS'),('Y02790', 'EMIS'),('Y03079', 'EMIS'),('Y03366', 'TPP'),('P83001', 'Vision'),('P83004', 'Vision'),('P83005', 'Vision'),('P83006', 'Vision'),('P83007', 'Vision'),('P83009', 'Vision'),('P83010', 'Vision'),('P83011', 'Vision'),('P83012', 'Vision'),('P83015', 'Vision'),('P83017', 'Vision'),('P83020', 'Vision'),('P83021', 'Vision'),('P83024', 'Vision'),('P83025', 'Vision'),('P83027', 'Vision'),('P83603', 'Vision'),('P83605', 'Vision'),('P83608', 'Vision'),('P83609', 'Vision'),('P83611', 'Vision'),('P83612', 'Vision'),('P83620', 'Vision'),('P83621', 'Vision'),('P83623', 'Vision'),('Y02755', 'Vision'),('P86001', 'EMIS'),('P86002', 'EMIS'),('P86003', 'EMIS'),('P86004', 'EMIS'),('P86005', 'EMIS'),('P86006', 'EMIS'),('P86007', 'EMIS'),('P86008', 'EMIS'),('P86009', 'EMIS'),('P86010', 'EMIS'),('P86011', 'EMIS'),('P86012', 'EMIS'),('P86013', 'EMIS'),('P86014', 'EMIS'),('P86015', 'EMIS'),('P86016', 'EMIS'),('P86017', 'EMIS'),('P86018', 'EMIS'),('P86019', 'EMIS'),('P86021', 'EMIS'),('P86022', 'EMIS'),('P86023', 'EMIS'),('P86026', 'EMIS'),('P86602', 'EMIS'),('P86606', 'EMIS'),('P86608', 'EMIS'),('P86609', 'EMIS'),('P86614', 'EMIS'),('P86619', 'EMIS'),('P86620', 'EMIS'),('P86624', 'EMIS'),('Y00726', 'EMIS'),('Y02718', 'EMIS'),('Y02720', 'EMIS'),('Y02721', 'EMIS'),('Y02795', 'EMIS'),('P84004', 'EMIS'),('P84005', 'EMIS'),('P84009', 'EMIS'),('P84010', 'EMIS'),('P84012', 'EMIS'),('P84014', 'EMIS'),('P84016', 'EMIS'),('P84017', 'EMIS'),('P84018', 'EMIS'),('P84019', 'EMIS'),('P84020', 'EMIS'),('P84021', 'EMIS'),('P84022', 'EMIS'),('P84023', 'EMIS'),('P84024', 'EMIS'),('P84025', 'EMIS'),('P84026', 'EMIS'),('P84027', 'EMIS'),('P84028', 'EMIS'),('P84029', 'EMIS'),('P84030', 'EMIS'),('P84032', 'EMIS'),('P84033', 'EMIS'),('P84034', 'EMIS'),('P84035', 'EMIS'),('P84037', 'EMIS'),('P84038', 'EMIS'),('P84039', 'EMIS'),('P84040', 'EMIS'),('P84041', 'EMIS'),('P84042', 'EMIS'),('P84043', 'EMIS'),('P84045', 'EMIS'),('P84046', 'EMIS'),('P84047', 'EMIS'),('P84048', 'EMIS'),('P84049', 'EMIS'),('P84050', 'EMIS'),('P84051', 'EMIS'),('P84052', 'EMIS'),('P84053', 'EMIS'),('P84054', 'EMIS'),('P84056', 'EMIS'),('P84059', 'EMIS'),('P84061', 'EMIS'),('P84064', 'EMIS'),('P84065', 'EMIS'),('P84066', 'EMIS'),('P84067', 'EMIS'),('P84068', 'EMIS'),('P84070', 'EMIS'),('P84071', 'EMIS'),('P84072', 'EMIS'),('P84074', 'EMIS'),('P84605', 'EMIS'),('P84611', 'EMIS'),('P84616', 'EMIS'),('P84626', 'EMIS'),('P84630', 'EMIS'),('P84635', 'EMIS'),('P84637', 'EMIS'),('P84639', 'EMIS'),('P84640', 'EMIS'),('P84644', 'EMIS'),('P84645', 'EMIS'),('P84650', 'EMIS'),('P84651', 'EMIS'),('P84652', 'EMIS'),('P84663', 'EMIS'),('P84665', 'EMIS'),('P84669', 'EMIS'),('P84672', 'EMIS'),('P84673', 'EMIS'),('P84678', 'EMIS'),('P84679', 'EMIS'),('P84683', 'EMIS'),('P84684', 'EMIS'),('P84689', 'EMIS'),('P84690', 'EMIS'),('Y01695', 'EMIS'),('Y02325', 'EMIS'),('Y02520', 'EMIS'),('Y02849', 'EMIS'),('Y02890', 'EMIS'),('Y02960', 'EMIS'),('P85001', 'EMIS'),('P85002', 'EMIS'),('P85003', 'EMIS'),('P85004', 'EMIS'),('P85005', 'EMIS'),('P85007', 'EMIS'),('P85008', 'EMIS'),('P85010', 'EMIS'),('P85011', 'EMIS'),('P85012', 'EMIS'),('P85013', 'EMIS'),('P85014', 'EMIS'),('P85015', 'EMIS'),('P85016', 'EMIS'),('P85017', 'EMIS'),('P85018', 'EMIS'),('P85019', 'EMIS'),('P85020', 'EMIS'),('P85021', 'EMIS'),('P85022', 'EMIS'),('P85026', 'EMIS'),('P85028', 'EMIS'),('P85601', 'EMIS'),('P85602', 'EMIS'),('P85605', 'EMIS'),('P85606', 'EMIS'),('P85607', 'EMIS'),('P85608', 'EMIS'),('P85610', 'EMIS'),('P85612', 'EMIS'),('P85614', 'EMIS'),('P85615', 'EMIS'),('P85620', 'EMIS'),('P85621', 'EMIS'),('P85622', 'EMIS'),('P89006', 'EMIS'),('Y01124', 'EMIS'),('Y02753', 'EMIS'),('Y02827', 'EMIS'),('Y02875', 'EMIS'),('Y02933', 'EMIS'),('P87002', 'EMIS'),('P87003', 'Vision'),('P87004', 'Vision'),('P87008', 'EMIS'),('P87015', 'Vision'),('P87016', 'EMIS'),('P87017', 'EMIS'),('P87019', 'EMIS'),('P87020', 'Vision'),('P87022', 'Vision'),('P87024', 'EMIS'),('P87025', 'EMIS'),('P87026', 'EMIS'),('P87027', 'EMIS'),('P87028', 'EMIS'),('P87032', 'Vision'),('P87035', 'EMIS'),('P87039', 'Vision'),('P87040', 'Vision'),('P87610', 'Vision'),('P87613', 'EMIS'),('P87618', 'EMIS'),('P87620', 'Vision'),('P87624', 'EMIS'),('P87625', 'EMIS'),('P87627', 'EMIS'),('P87630', 'EMIS'),('P87634', 'EMIS'),('P87639', 'Vision'),('P87648', 'Vision'),('P87649', 'EMIS'),('P87651', 'Vision'),('P87654', 'EMIS'),('P87657', 'Vision'),('P87658', 'EMIS'),('P87659', 'Vision'),('P87661', 'EMIS'),('Y00445', 'Vision'),('Y02622', 'EMIS'),('Y02625', 'EMIS'),('Y02767', 'EMIS'),('P88002', 'EMIS'),('P88003', 'EMIS'),('P88005', 'EMIS'),('P88006', 'EMIS'),('P88007', 'EMIS'),('P88008', 'EMIS'),('P88009', 'EMIS'),('P88011', 'EMIS'),('P88012', 'EMIS'),('P88013', 'EMIS'),('P88014', 'EMIS'),('P88015', 'EMIS'),('P88016', 'EMIS'),('P88017', 'EMIS'),('P88018', 'EMIS'),('P88019', 'EMIS'),('P88020', 'EMIS'),('P88021', 'EMIS'),('P88023', 'EMIS'),('P88024', 'EMIS'),('P88025', 'EMIS'),('P88026', 'EMIS'),('P88031', 'EMIS'),('P88034', 'EMIS'),('P88041', 'EMIS'),('P88042', 'EMIS'),('P88043', 'EMIS'),('P88044', 'EMIS'),('P88606', 'EMIS'),('P88607', 'EMIS'),('P88610', 'EMIS'),('P88615', 'EMIS'),('P88623', 'EMIS'),('P88625', 'EMIS'),('P88632', 'EMIS'),('Y00912', 'EMIS'),('C81077', 'EMIS'),('C81081', 'EMIS'),('C81106', 'EMIS'),('C81615', 'EMIS'),('C81640', 'EMIS'),('C81660', 'EMIS'),('P89002', 'EMIS'),('P89003', 'EMIS'),('P89004', 'EMIS'),('P89005', 'EMIS'),('P89007', 'TPP'),('P89008', 'EMIS'),('P89010', 'EMIS'),('P89011', 'EMIS'),('P89012', 'EMIS'),('P89013', 'EMIS'),('P89014', 'EMIS'),('P89015', 'EMIS'),('P89016', 'EMIS'),('P89018', 'EMIS'),('P89020', 'EMIS'),('P89021', 'EMIS'),('P89022', 'EMIS'),('P89023', 'EMIS'),('P89025', 'EMIS'),('P89026', 'EMIS'),('P89029', 'EMIS'),('P89030', 'EMIS'),('P89602', 'EMIS'),('P89609', 'EMIS'),('P89612', 'EMIS'),('P89613', 'EMIS'),('P89618', 'EMIS'),('Y02586', 'EMIS'),('Y02663', 'EMIS'),('Y02713', 'EMIS'),('Y02936', 'EMIS'),('P91003', 'EMIS'),('P91004', 'EMIS'),('P91006', 'EMIS'),('P91007', 'EMIS'),('P91008', 'EMIS'),('P91009', 'EMIS'),('P91011', 'EMIS'),('P91012', 'EMIS'),('P91013', 'EMIS'),('P91014', 'EMIS'),('P91016', 'EMIS'),('P91017', 'EMIS'),('P91018', 'EMIS'),('P91019', 'EMIS'),('P91020', 'EMIS'),('P91021', 'EMIS'),('P91026', 'EMIS'),('P91029', 'EMIS'),('P91035', 'EMIS'),('P91603', 'EMIS'),('P91604', 'EMIS'),('P91617', 'EMIS'),('P91619', 'EMIS'),('P91623', 'EMIS'),('P91625', 'EMIS'),('P91627', 'EMIS'),('P91629', 'EMIS'),('P91631', 'EMIS'),('P91633', 'EMIS'),('P92001', 'TPP'),('P92002', 'EMIS'),('P92003', 'EMIS'),('P92004', 'EMIS'),('P92005', 'TPP'),('P92006', 'TPP'),('P92007', 'TPP'),('P92008', 'EMIS'),('P92010', 'TPP'),('P92011', 'EMIS'),('P92012', 'TPP'),('P92014', 'EMIS'),('P92015', 'EMIS'),('P92016', 'TPP'),('P92017', 'EMIS'),('P92019', 'EMIS'),('P92020', 'EMIS'),('P92021', 'EMIS'),('P92023', 'EMIS'),('P92024', 'TPP'),('P92026', 'EMIS'),('P92028', 'EMIS'),('P92029', 'TPP'),('P92030', 'Vision'),('P92031', 'TPP'),('P92033', 'EMIS'),('P92034', 'TPP'),('P92035', 'TPP'),('P92038', 'TPP'),('P92041', 'EMIS'),('P92042', 'EMIS'),('P92602', 'EMIS'),('P92605', 'EMIS'),('P92607', 'TPP'),('P92615', 'TPP'),('P92616', 'EMIS'),('P92620', 'EMIS'),('P92621', 'EMIS'),('P92623', 'TPP'),('P92626', 'EMIS'),('P92630', 'EMIS'),('P92633', 'EMIS'),('P92634', 'EMIS'),('P92635', 'Vision'),('P92637', 'EMIS'),('P92639', 'TPP'),('P92642', 'TPP'),('P92646', 'EMIS'),('P92647', 'TPP'),('P92648', 'TPP'),('P92651', 'EMIS'),('P92653', 'TPP'),('Y00050', 'TPP'),('Y02274', 'EMIS'),('Y02321', 'EMIS'),('Y02322', 'EMIS'),('Y02378', 'EMIS'),('Y02885', 'EMIS'),('Y02886', 'EMIS');


-- >>> Codesets required... Inserting the code set code
--
--┌────────────────────┐
--│ Clinical code sets │
--└────────────────────┘

-- OBJECTIVE: To populate temporary tables with the existing clinical code sets.
--            See the [SQL-generation-process.md](SQL-generation-process.md) for more details.

-- INPUT: No pre-requisites

-- OUTPUT: Five temp tables as follows:
--  #AllCodes (Concept, Version, Code)
--  #CodeSets (FK_Reference_Coding_ID, Concept)
--  #SnomedSets (FK_Reference_SnomedCT_ID, FK_SNOMED_ID)
--  #VersionedCodeSets (FK_Reference_Coding_ID, Concept, Version)
--  #VersionedSnomedSets (FK_Reference_SnomedCT_ID, Version, FK_SNOMED_ID)

--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
--!!! DO NOT EDIT THIS FILE MANUALLY !!!
--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

IF OBJECT_ID('tempdb..#AllCodes') IS NOT NULL DROP TABLE #AllCodes;
CREATE TABLE #AllCodes (
  [Concept] [varchar](255) NOT NULL,
  [Version] INT NOT NULL,
  [Code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL
);

IF OBJECT_ID('tempdb..#codesreadv2') IS NOT NULL DROP TABLE #codesreadv2;
CREATE TABLE #codesreadv2 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesreadv2
VALUES ('high-clinical-vulnerability',1,'14Or.','High risk category for developing complications from COVID-19 severe acute respiratory syndrome coronavirus infection (finding)'),('high-clinical-vulnerability',1,'14Or.00','High risk category for developing complications from COVID-19 severe acute respiratory syndrome coronavirus infection (finding)'),('high-clinical-vulnerability',1,'9d44.','Risk of exposure to communicable disease (situation)'),('high-clinical-vulnerability',1,'9d44.00','Risk of exposure to communicable disease (situation)');
INSERT INTO #codesreadv2
VALUES ('moderate-clinical-vulnerability',1,'14Oq.','Moderate risk category for developing complications from COVID-19'),('moderate-clinical-vulnerability',1,'14Oq.00','Moderate risk category for developing complications from COVID-19')

INSERT INTO #AllCodes
SELECT [concept], [version], [code] from #codesreadv2;

IF OBJECT_ID('tempdb..#codesctv3') IS NOT NULL DROP TABLE #codesctv3;
CREATE TABLE #codesctv3 (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesctv3
VALUES ('high-clinical-vulnerability',1,'Y228a','High risk category for developing complications from COVID-19 severe acute respiratory syndrome coronavirus infection');
INSERT INTO #codesctv3
VALUES ('moderate-clinical-vulnerability',1,'Y228b','Moderate risk category for developing complication from coronavirus disease 19 caused by severe acute respiratory syndrome coronavirus 2 infection (finding)')

INSERT INTO #AllCodes
SELECT [concept], [version], [code] from #codesctv3;

IF OBJECT_ID('tempdb..#codessnomed') IS NOT NULL DROP TABLE #codessnomed;
CREATE TABLE #codessnomed (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codessnomed
VALUES ('high-clinical-vulnerability',1,'1300561000000107','High risk category for developing complication from coronavirus disease caused by severe acute respiratory syndrome coronavirus infection (finding)');
INSERT INTO #codessnomed
VALUES ('moderate-clinical-vulnerability',1,'1300571000000100','Moderate risk category for developing complication from coronavirus disease caused by severe acute respiratory syndrome coronavirus infection (finding)')

INSERT INTO #AllCodes
SELECT [concept], [version], [code] from #codessnomed;

IF OBJECT_ID('tempdb..#codesemis') IS NOT NULL DROP TABLE #codesemis;
CREATE TABLE #codesemis (
  [concept] [varchar](255) NOT NULL,
  [version] INT NOT NULL,
	[code] [varchar](20) COLLATE Latin1_General_CS_AS NOT NULL,
	[description] [varchar](255) NULL
) ON [PRIMARY];

INSERT INTO #codesemis
VALUES ('high-clinical-vulnerability',1,'^ESCT1300222','High risk category for developing complications from COVID-19 infection');
INSERT INTO #codesemis
VALUES ('moderate-clinical-vulnerability',1,'^ESCT1300223','Moderate risk category for developing complications from COVID-19 infection')

INSERT INTO #AllCodes
SELECT [concept], [version], [code] from #codesemis;


IF OBJECT_ID('tempdb..#TempRefCodes') IS NOT NULL DROP TABLE #TempRefCodes;
CREATE TABLE #TempRefCodes (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, version INT NOT NULL);

-- Read v2 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcr.concept, dcr.[version]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesreadv2 dcr on dcr.code = rc.MainCode
WHERE CodingType='ReadCodeV2'
and PK_Reference_Coding_ID != -1;

-- CTV3 codes
INSERT INTO #TempRefCodes
SELECT PK_Reference_Coding_ID, dcc.concept, dcc.[version]
FROM [SharedCare].[Reference_Coding] rc
INNER JOIN #codesctv3 dcc on dcc.code = rc.MainCode
WHERE CodingType='CTV3'
and PK_Reference_Coding_ID != -1;

-- EMIS codes with a FK Reference Coding ID
INSERT INTO #TempRefCodes
SELECT FK_Reference_Coding_ID, ce.concept, ce.[version]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID != -1;

IF OBJECT_ID('tempdb..#TempSNOMEDRefCodes') IS NOT NULL DROP TABLE #TempSNOMEDRefCodes;
CREATE TABLE #TempSNOMEDRefCodes (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL, [version] INT NOT NULL);

-- SNOMED codes
INSERT INTO #TempSNOMEDRefCodes
SELECT PK_Reference_SnomedCT_ID, dcs.concept, dcs.[version]
FROM SharedCare.Reference_SnomedCT rs
INNER JOIN #codessnomed dcs on dcs.code = rs.ConceptID;

-- EMIS codes with a FK SNOMED ID but without a FK Reference Coding ID
INSERT INTO #TempSNOMEDRefCodes
SELECT FK_Reference_SnomedCT_ID, ce.concept, ce.[version]
FROM [SharedCare].[Reference_Local_Code] rlc
INNER JOIN #codesemis ce on ce.code = rlc.LocalCode
WHERE FK_Reference_Coding_ID = -1
AND FK_Reference_SnomedCT_ID != -1;

-- De-duped tables
IF OBJECT_ID('tempdb..#CodeSets') IS NOT NULL DROP TABLE #CodeSets;
CREATE TABLE #CodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL);

IF OBJECT_ID('tempdb..#SnomedSets') IS NOT NULL DROP TABLE #SnomedSets;
CREATE TABLE #SnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, concept VARCHAR(255) NOT NULL);

IF OBJECT_ID('tempdb..#VersionedCodeSets') IS NOT NULL DROP TABLE #VersionedCodeSets;
CREATE TABLE #VersionedCodeSets (FK_Reference_Coding_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT);

IF OBJECT_ID('tempdb..#VersionedSnomedSets') IS NOT NULL DROP TABLE #VersionedSnomedSets;
CREATE TABLE #VersionedSnomedSets (FK_Reference_SnomedCT_ID BIGINT NOT NULL, Concept VARCHAR(255), [Version] INT);

INSERT INTO #VersionedCodeSets
SELECT DISTINCT * FROM #TempRefCodes;

INSERT INTO #VersionedSnomedSets
SELECT DISTINCT * FROM #TempSNOMEDRefCodes;

INSERT INTO #CodeSets
SELECT FK_Reference_Coding_ID, c.concept
FROM #VersionedCodeSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedCodeSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

INSERT INTO #SnomedSets
SELECT FK_Reference_SnomedCT_ID, c.concept
FROM #VersionedSnomedSets c
INNER JOIN (
  SELECT concept, MAX(version) AS maxVersion FROM #VersionedSnomedSets
  GROUP BY concept)
sub ON sub.concept = c.concept AND c.version = sub.maxVersion;

-- >>> Following codesets injected: moderate-clinical-vulnerability/high-clinical-vulnerability
-- Finds all patients with one of the clinical codes
IF OBJECT_ID('tempdb..#PatientsWithCode') IS NOT NULL DROP TABLE #PatientsWithCode;
SELECT FK_Patient_Link_ID, Concept, [Version] INTO #PatientsWithCode FROM RLS.[vw_GP_Events] e
INNER JOIN #VersionedCodeSets v on v.FK_Reference_Coding_ID = e.FK_Reference_Coding_ID
WHERE v.Concept in ('moderate-clinical-vulnerability','high-clinical-vulnerability')
UNION
SELECT FK_Patient_Link_ID, Concept, [Version] FROM RLS.[vw_GP_Events] e
INNER JOIN #VersionedSnomedSets v on v.FK_Reference_SnomedCT_ID = e.FK_Reference_SnomedCT_ID
WHERE v.Concept in ('moderate-clinical-vulnerability','high-clinical-vulnerability')
GROUP BY FK_Patient_Link_ID, Concept, [Version];

-- Counts the number of patients for each version of each concept for each clinical system
-- above and below 70
IF OBJECT_ID('tempdb..#PatientsWithCodePerSystem') IS NOT NULL DROP TABLE #PatientsWithCodePerSystem;
SELECT [System], CASE WHEN DATEDIFF(year,Dob,GETDATE()) < 70 THEN 'Under 70' ELSE '70 and over' END AS Age, Concept, [Version], count(*) as [Count] into #PatientsWithCodePerSystem FROM RLS.vw_Patient p
INNER JOIN #PracticeSystemLookup s on s.PracticeId = p.GPPracticeCode
INNER JOIN #PatientsWithCode c on c.FK_Patient_Link_ID = p.FK_Patient_Link_ID
WHERE FK_Reference_Tenancy_ID = 2
AND NOT EXISTS (SELECT * FROM [RLS].vw_Patient_Link WHERE PK_Patient_Link_ID = p.FK_Patient_Link_ID and Deceased = 'Y')
GROUP BY [System], CASE WHEN DATEDIFF(year,Dob,GETDATE()) < 70 THEN 'Under 70' ELSE '70 and over' END, Concept, [Version];

-- Counts the number of patients per system and age
IF OBJECT_ID('tempdb..#PatientsPerSystem') IS NOT NULL DROP TABLE #PatientsPerSystem;
SELECT [System], CASE WHEN DATEDIFF(year,Dob,GETDATE()) < 70 THEN 'Under 70' ELSE '70 and over' END AS Age, count(*) as [Count] into #PatientsPerSystem FROM RLS.vw_Patient p
INNER JOIN #PracticeSystemLookup s on s.PracticeId = p.GPPracticeCode
WHERE FK_Reference_Tenancy_ID = 2
AND NOT EXISTS (SELECT * FROM [RLS].vw_Patient_Link WHERE PK_Patient_Link_ID = p.FK_Patient_Link_ID and Deceased = 'Y')
GROUP BY [System], CASE WHEN DATEDIFF(year,Dob,GETDATE()) < 70 THEN 'Under 70' ELSE '70 and over' END;
select * from #PatientsPerSystem

-- Finds all patients with one of the clinical codes
IF OBJECT_ID('tempdb..#PatientsWithSuppliedCode') IS NOT NULL DROP TABLE #PatientsWithSuppliedCode;
SELECT FK_Patient_Link_ID, SuppliedCode INTO #PatientsWithSuppliedCode FROM RLS.[vw_GP_Events] e
WHERE SuppliedCode IN (SELECT [Code] FROM #AllCodes WHERE Concept in ('moderate-clinical-vulnerability','high-clinical-vulnerability'));
--03:27

IF OBJECT_ID('tempdb..#PatientsWithSuppliedConcept') IS NOT NULL DROP TABLE #PatientsWithSuppliedConcept;
SELECT FK_Patient_Link_ID, Concept, [Version] INTO #PatientsWithSuppliedConcept FROM #PatientsWithSuppliedCode p
INNER JOIN #AllCodes a on a.Code = p.SuppliedCode
GROUP BY FK_Patient_Link_ID, [Concept], [Version];

-- Counts the number of patients for each version of each concept for each clinical system
IF OBJECT_ID('tempdb..#PatientsWithSuppConceptPerSystem') IS NOT NULL DROP TABLE #PatientsWithSuppConceptPerSystem;
SELECT [System], CASE WHEN DATEDIFF(year,Dob,GETDATE()) < 70 THEN 'Under 70' ELSE '70 and over' END AS Age, Concept, [Version], count(*) as [Count] into #PatientsWithSuppConceptPerSystem FROM RLS.vw_Patient p
INNER JOIN #PracticeSystemLookup s on s.PracticeId = p.GPPracticeCode
INNER JOIN #PatientsWithSuppliedConcept c on c.FK_Patient_Link_ID = p.FK_Patient_Link_ID
WHERE FK_Reference_Tenancy_ID = 2
AND NOT EXISTS (SELECT * FROM [RLS].vw_Patient_Link WHERE PK_Patient_Link_ID = p.FK_Patient_Link_ID and Deceased = 'Y')
GROUP BY [System], CASE WHEN DATEDIFF(year,Dob,GETDATE()) < 70 THEN 'Under 70' ELSE '70 and over' END, Concept, [Version];

-- Final table to display the proportion of patients per version of concept for each clinical system
SELECT 
	p.Concept, p.[Version], pps.[System], pps.Age, pps.[Count] as Patients,p.[Count] as PatientsWithConcept, 
	psps.[Count] as PatiensWithConceptFromCode,
	 100 * CAST(p.[Count] AS float)/pps.[Count] as PercentageOfPatients,
	 100 * CAST(psps.[Count] AS float)/pps.[Count] as PercentageOfPatientsFromCode
FROM #PatientsWithCodePerSystem p
INNER JOIN #PatientsPerSystem pps ON pps.[System] = p.[System] and pps.Age = p.Age
INNER JOIN #PatientsWithSuppConceptPerSystem psps ON psps.[System] = p.[System] and psps.Age = p.Age AND psps.Concept = p.Concept AND psps.[Version] = p.[Version]
ORDER BY p.Concept, p.[Version], pps.[System], pps.Age;
