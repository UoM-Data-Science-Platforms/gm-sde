# General

- Consider how this will work in the future because we dont want to rebuild the cohort in every template.sql file
- In each file, rather than SELECT at the end, we probably want to INSERT into another permanent table
- need to list all the refsets used
- need to explain hospital admission categories
- need to explain the gp encounters is a proxy
- explain that benzo includes z-drugs - assuming the only 3 realistically are zopiclone, zolpidem and zaleplon

# 1.patients.template.sql

DONE- Change the "GmPseudo IN..." to pull from the table created in the build cohort script
DONE - Add IMD - likely select distinct "Effective_Snapshot_Date" from SHARED_UK_FACTS_AND_DIMENSIONS_VIEWS."Demography"."fact_Index_Of_Multiple_Deprivation_By_LSOA"
DONE- Add date of death - likely from PRESENTATION.NATIONAL_FLOWS_PCMD."DS1804_Pcmd"

# 2.lifestyle.template.sql

DONE- Maybe check with PI that they're happy with the output format

# 3.comorbidities.template.sql

DONE- Need to define all the comorbidities
DONE- LongTermCon.. table in GP_Record does the first occurrence, but not the last or the number
DONE- let's just give them what's in the GP_Record table in the first instance - if they need more they can ask for it

# 4.outcomes.template.sql

- All essential things are done
- Optional (so only if have time - don't delay data dump) are:
  - continuity of care (but see emails from Charlotte - don't think we can do this as we don't know which clinician they saw)
  - carer type (not really even sure how that is an outcome)
  - carer review
  - missed appointment

# 5.medications.template.sql

- just need to sort out anticholinergics (sedating antihistamines are now included in this) and check prevalence of antidementia
- We now have list of all anticholinergics (see https://www.derbyshiremedicinesmanagement.nhs.uk/assets/Clinical_Guidelines/Formulary_by_BNF_chapter_prescribing_guidelines/BNF_chapter_4/Drugs_on_the_acb_scale.pdf). Here they all are (with ACB type and a year if we already have a code set - the year being when last updated so i.e. 2024 can reuse without checking, 2023 and before probably need SNOMED codes):
  ACB1 Alimemazine
  ACB1 Alprazolam
  ACB1 Alverine
  ACB1 Atenolol
  ACB1 Captopril
  ACB1 Cimetidine
  ACB1 Clorazepate
  ACB1 Codeine
  ACB1 Colchicine
  ACB1 Dextropropoxyphene
  ACB1 Diazepam
  ACB1 Digoxin
  ACB1 Dipyridamole
  ACB1 Disopyramide phosphate
  ACB1 Fentanyl
  ACB1 Furosemide
  ACB1 Hydralazine
  ACB1 Isosorbide
  ACB1 Loperamide
  ACB1 Metoprolol
  ACB1 Morphine
  ACB1 Nifedipine
  ACB1 Prednisone
  ACB1 Quinine
  ACB1 Ranitidine
  ACB1 Theophylline
  ACB1 Timolol
  ACB1 Triamterene
  ACB1 Warfarin

ACB2 Amantadine
ACB2 Belladona alkaloids
ACB2 Cyclobenzprine
ACB2 Cyproheptadine
ACB2 Meperidine
ACB2 Methotrimeprazine
ACB2 Oxcarbazepine
ACB2 Pethidine

ACB3 Atropine
ACB3 Benztropine
ACB3 Clemastine
ACB3 Darifenacin
ACB3 Dicyclomine
ACB3 Diphenhydramine
ACB3 Flavoxate
ACB3 Hydroxyzine
ACB3 Meclozine
ACB3 Orphenadrine
ACB3 Oxybutynin
ACB3 Procyclidine
ACB3 Propantheline
ACB3 Mepyramine
ACB3 Solifenacin
ACB3 Scopolamine
ACB3 Tolterodine
ACB3 Trihexyphenidyl
ACB3 Trospium

ACB1 2022 Beclometasone dipropionate
ACB1 2022 Hydrocortisone
ACB1 2022 Prednisolone
ACB3 2022 Promethazine

ACB1 2024 Bupropion
ACB1 2024 Fluvoxamine
ACB1 2024 Haloperidol
ACB1 2024 Trazodone
ACB2 2024 Carbamazepine
ACB2 2024 Loxapine
ACB2 2024 Pimozide
ACB3 2024 Amitriptyline
ACB3 2024 Amoxapine
ACB3 2024? Chlorpheniramine
ACB3 2024 Chlorpromazine
ACB3 2024 Clomipramine
ACB3 2024 Clozapine
ACB3 2024 Desipramine
ACB3 2024 Doxepin
ACB3 2024 Imipramine
ACB3 2024 Nortriptyline
ACB3 2024 Paroxetine
ACB3 2024 Perphenazine
ACB3 2024 Promazine
ACB3 2024 Trifluoperazine
ACB3 2024 Trimipramine

- Lots need their own code set
- Code far below allows you to quickly copy (from med code set creator) README plus 3 code sets to clipboard for easy creation of med code sets
- Need to check prevalence for anti-dementia (and it's 4 subcomponents) - hopefully gmcr back for this

var drugLowerCase = document.getElementById('input-word').value.toLowerCase();
var drugCapitalCase = drugLowerCase[0].toUpperCase() + drugLowerCase.slice(1);
var otherNames = [...document.querySelectorAll('.potential-word:has(.included)')]
.map((x) => x.childNodes[0].nodeValue.trim())
.sort();
var otherNamesString = otherNames.map((x) => x[0].toUpperCase() + x.slice(1)).join('/');
var dt = new Date().toISOString().substring(0,10);

var snomedCodes = Object.entries(data.snomed.concepts).map(([code, definition]) => {
return `${code}\t${definition}`;
})
.join('\n');

var ctv3Codes = Object.entries(data.ctv3.concepts).map(([code, definition]) => {
return `${code}\t${definition}`;
})
.join('\n');

var readv2Codes = Object.entries(data.readv2.concepts).map(([code, definition]) => {
return `${code}\t${definition}`;
})
.join('\n');

var text = `# ${drugCapitalCase}

Any prescription of ${drugLowerCase}. Other names: ${otherNamesString}.

Code set created from SNOMED searches and then mapped to Read v2, CTV3 and EMIS.

## Prevalence log

By examining the prevalence of codes (number of patients with the code in their record) broken down by clinical system, we can attempt to validate the clinical code sets and the reporting of the conditions. Here is a log for this code set. The prevalence range \`XXX% - XXX%\` suggests that this code set is well defined, but perhaps more frequently used in the TPP practices in GM.

| Date  | Practice system | Population | Patients from ID | Patient from code |
| ----- | --------------- | ---------- | ---------------: | ----------------: |
| ${dt} | EMIS            | xxxxxxx    |                  |                   |
| ${dt} | TPP             | xxxxxxx    |                  |                   |
| ${dt} | Vision          | xxxxxxx    |                  |                   |

## Audit log

- Find_missing_codes last run ${dt}

---

${snomedCodes}

---

${ctv3Codes}

---

${readv2Codes}
`;

copy(text)
