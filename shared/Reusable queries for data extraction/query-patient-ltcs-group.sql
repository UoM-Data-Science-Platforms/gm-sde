--
--┌────────────────────────────────────────┐
--│ Long-term condition groups per patient │
--└────────────────────────────────────────┘

-- OBJECTIVE: To provide the long-term condition group or groups for each patient. Examples
--            of long term condition groups would be: Cardiovascular, Endocrine, Respiratory

-- INPUT: Assumes there exists a temp table as follows:
-- #PatientsWithLTCs (FK_Patient_Link_ID, LTC)
-- Therefore this is run after query-patient-ltcs.sql

-- OUTPUT: A temp table with a row for each patient and ltc group combo
-- #LTCGroups (FK_Patient_Link_ID, LTCGroup)

--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
--!!! DO NOT EDIT THIS FILE MANUALLY - see "node create-ltc-sql.js" !!!
--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

-- Calculate the LTC groups for each patient
IF OBJECT_ID('tempdb..#LTCGroups') IS NOT NULL DROP TABLE #LTCGroups;
SELECT 
  DISTINCT FK_Patient_Link_ID, 
  CASE
    WHEN LTC IN ('atrial fibrillation','coronary heart disease','heart failure','hypertension','peripheral vascular disease','stroke & transient ischaemic attack') THEN 'Cardiovascular'
		WHEN LTC IN ('diabetes','thyroid disorders') THEN 'Endocrine'
		WHEN LTC IN ('chronic liver disease','chronic liver disease and viral hepatitis','constipation (treated)','diverticular disease of intestine','dyspepsia (treated)','inflammatory bowel disease','irritable bowel syndrome','peptic ulcer disease') THEN 'Gastrointestinal'
		WHEN LTC IN ('psoriasis','psoriasis or eczema medcodes','rheumatoid arthritis, other inflammatory polyarthropathies & systematic connective tissue disorders','rheumatoid arthritis, sle') THEN 'Musculoskeletal or Skin'
		WHEN LTC IN ('multiple sclerosis','other neurological conditions','parkinsons disease') THEN 'Neurological'
		WHEN LTC IN ('dementia','depression','schizophrenia (and related non-organic psychosis) or bipolar disorder','schizophrenia (and related non-organic psychosis) or bipolar disorder medcodes','schizophrenia (and related non-organic psychosis) or bipolar disorder prodcodes') THEN 'Psychiatric'
		WHEN LTC IN ('chronic kidney disease') THEN 'Renal or Urological'
		WHEN LTC IN ('asthma (currently treated) medcodes','asthma (currently treated) prodcodes','asthma','asthma diagnosis','bronchiectasis','copd') THEN 'Respiratory'
		WHEN LTC IN ('learning disability') THEN 'Sensory Impairment or Learning Disability'
		WHEN LTC IN ('') THEN 'Substance Abuse'
  END AS LTCGroup INTO #LTCGroups
FROM #PatientsWithLTCs;
